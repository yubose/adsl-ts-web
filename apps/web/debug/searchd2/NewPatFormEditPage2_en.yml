NewPatFormEditPage2:
  viewPort: top
  title: NewPatFormEditPage2
  init:
    # 判断是否签名
    - if:
      - =.Global.formData.newPatientForm.name.data.signatureHippa.signatureNewPatForm
      - actionType: evalObject
        object:
          - ..signatureTime@: =.Global.formData.newPatientForm.name.data.signatureHippa.signatureTime
          - ..temporarySignature@: =.Global.formData.newPatientForm.name.data.signatureHippa.signatureNewPatForm
      - continue

    # 判断显示签名的id是否为空
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =..temporarySignature
              string2: ""
        - continue
        # 非空修改显示的标识,刷新签名区域
        - actionType: evalObject
          object:
            - ..flag@: "block"
            - actionType: builtIn
              funcName: redraw
              viewTag: signatureShowTag

    # 判断是否Name of Recipient/Healthcare Proxy存在
    - actionType: evalObject
      object:
        - if:
          - =.Global.formData.newPatientForm.name.data.signatureHippa.recipientName
          - ..recipientName@: =.Global.formData.newPatientForm.name.data.signatureHippa.recipientName
          - continue
    - actionType: evalObject
      object: .BaseDate.miniWeekGet
    - actionType: evalObject
      object: .BaseDate.getDate
    - if:
      - =.Global.isSignIn
      - actionType: evalObject
        object:
          - ..isPersonal@: "false"
          - ..isSignIn@: "true"
      - actionType: evalObject
        object:
          - ..isPersonal@: "true"
          - ..isSignIn@: "false"
    - ..profile.docAPI.get
    - if:
      - =..profile.docResponse.doc.0
      - actionType: evalObject
        object:
          - ..profile.c@: =..profile.docResponse.doc.0
          - =.builtIn.utils.prepareDoc:
              dataIn:
                doc: =..profile.docResponse.doc.0
              dataOut: NewPatFormEditPage2.profile.patientdocument
      - continue
  isPersonal:
  isSignIn:
    
  profile:
    docResponse: ""
    patientdocument: ""
    document:
      type: .DocType.PatientProfile
      eid: .Global.rootNotebookID
      name:
        # .Global.Profile: ""
        data:
          insurance: 
            insuranceProvider: ""
            policyHolderName: ""
            groupOrPolicy: ""
            memberID: ""
          phone: .Global.currentUser.vertex.uid
          phone2: ""
          avatarUrl: ava.png
          avatar: ""
          gender: ""
          email: ""
          firstName: .Global.currentUser.vertex.name.firstName
          middleName: ""
          lastName: .Global.currentUser.vertex.name.lastName
          birth: ""
          userName: .Global.currentUser.vertex.name.userName
          address: ""
          fullName: .NewPatFormEditPage2.formData.showName
          Address:
            St: ""
            city: ""
            state: ""
            line2: ""
            zip: ""
          name: ""
          relation: ""
        type: .NewPatFormEditPage2.profile.docAPI.store.subtype.mediaType
    docAPI:
      get:
        .DocAPI.get: "" 
        api: rd
        id: .Global.rootNotebookID
        xfname: eid
        type: .DocType.PatientProfile
        obfname: mtime
        dataKey: profile.docResponse
        _nonce: =.Global._nonce 
      
  formData:
    countryCode: "+1"   
    phoneNumber: "8881307128"
    password: "123456"
    code: ""
    sk: ""
    pass: ""
    showName: ""
  indentificationTemp:
    - key: membersID
      value: Members ID
      dataValue: =..billingInfo.membersID
    - key: companyName
      value: Insurance Company Name
      dataValue: =..billingInfo.companyName
    - key: insuredName
      value: Insured Name
      dataValue: =..billingInfo.insuredName
  # 签名文档
  newSign:
    docRes: ""
    docReq:
      type: .DocType.DocumentSignature
      id: .Global.rootNotebookID
      xfname: eid
    document: #DOC
      type: .DocType.DocumentSignature
      name:
        title: ""
        type: ..newSign.document.subtype.mediaType
        data: "" 
      eid: .Global.rootNotebookID
      reid: .Global.formData.newPatientForm.id
      subtype:
        mediaType: "" # mediaType : "image/jpeg"        
    docAPI: # DOCAPI 
      store:
        api: cd
        dataIn: NewPatFormEditPage2.newSign.document 
        dataOut: NewPatFormEditPage2.newSign.docRes

  recipientName: ""

  # 获取暂存的签名的id
  temporarySignature: ""
  # 签名的显示,默认为none
  flag: "none"
  # 是否签名 true 表示未签 false 表示已签
  whetherSignature: ""
  signatureTime: ""
  components:
    - type: view
      style:
        width: '1'
        margin: 'auto'
        display: flex
        flexDirection: column
        justifyContent: center
        fontFamily: "Arial"
      children: 
        - .baseTopBar:
          children:
            - .baseTopMenu:
              children:
                - .AitmedLogo
                - .BaseUserBar
        - .ViewRow:
          style: 
            width: 89.8vw
            height: 4.5vw
            margin: "auto"
            marginTop: "6vw"
            justifyContent: center
          children:
            - .ViewRow:
              style: 
                marginLeft: 5vw
                width: 4vw
                top: 1vw
                height: 2vw
                justifyContent: flex-start
                alignItems: center
              children:
                - type: image
                  path: left_blue_arrow.png
                  style:
                    width: 1.5vw
                    height: 2vw
                  onClick: 
                    - actionType: evalObject
                      object:
                        .Global._nonce@:
                          =.builtIn.math.random: ""
                    - actionType: evalObject
                      object:
                        - .Global.editProfile@: false   
                    
                    - actionType: builtIn
                      funcName: goBack
                      reload: true
                - .Label1:
                  text: "Back"
                  autocomplete: "off"
                  style: 
                    fontSize: .Nfont.h1        
                    color: "#2988e6"
                    fontWeight: 550
                    marginLeft: 0.5vw
                  onClick: 
                    - actionType: evalObject
                      object:
                        .Global._nonce@:
                          =.builtIn.math.random: ""
                    - actionType: evalObject
                      object:
                        - .Global.editProfile@: false   
                    
                    - actionType: builtIn
                      funcName: goBack
                      reload: true
            - type: view
              style:
                marginTop: 1.5vw
                height: 3.5vw
                width: 40vw
                borderBottom: "4px solid #005795"
                borderWidth: 4px
                display: flex
                flexDirection: row
                justifyContent: space-between
              children:  
                - type: label
                  text: "New Patient Forms"
                  style:
                    marginTop: 0.5vw
                    color: "#005795"
                    fontSize: .Nfont.h6
                    fontWeight: 580
                    height: 3vw
                    textAlign: 
                      y: center
                - type: label
                  text: "2/3"
                  style:
                    marginTop: 1vw
                    width: 3vw
                    height: "2vw"
                    borderRadius: 5px
                    backgroundColor: "#1263A8"
                    color: "#ffffff"
                    fontSize: .Nfont.h3
                    fontWeight: 580
                    textAlign: 
                      x: center
                      y: center
        - type: view
          style:
            width: 89.8vw
            height: 39vw
            margin: "auto"
            marginTop: "0.5vw"
          children:
            - type: scrollView
              style:
                width: 89.8vw
                height: 39vw
                marginTop: 0.5vw
              children:
                - type: view
                  style:
                    width: 40vw
                    height: 39vw
                    backgroundColor: "#ffffff"
                    marginTop: 0.1vw
                    margin: auto
                    justifyContent: flex-start
                  children:
                    - .NewFirstTitle:
                      text: Patient Consent Form - HIPPA
                      style:
                        marginTop: "1vw"
                        fontSize: .Nfont.h1
                        textAlign: 
                            x: center
                            y: center
                    - type: view
                      style:
                        width: 40vw
                        backgroundColor: "#ffffff"
                        marginTop: 0.1vw
                        justifyContent: flex-start
                      children:
                        - type: label
                          text: "Please carefully read the following informed consent:"
                          style:
                            # left: "0.07"
                            marginTop: "0.025"
                            fontSize: .Nfont.h0_1
                            fontWeight: "550"
                            color: "#333333"
                        - type: label
                          text: The Department of Health and Human Services has established a “Privacy Rule” to help insure that personal health care information is protected for privacy. The Privacy Rule was also created in order to provide a standard for certain health care providers to obtain their patients’ consent for uses and disclosures of health information about the patient to carry out treatment, payment or health care operations.
                          style:
                            width: "40vw"
                            # left: '0.07'
                            marginTop: '0.02'
                            fontSize: .Nfont.h0_1
                            color: "0x666666"
                        - type: label
                          text: As our patient we want you to know that we respect the privacy of your personal medical records and will do all we can to secure and protect that privacy. We strive to always take reasonable precautions to protect your privacy. When it is appropriate and necessary, we provide the minimum necessary information to only those we feel are in need of your healthcare information and information about treatment, payment or health care operations, in order to provide health care that is in your best interest. 
                          style:
                            width: "40vw"
                            # left: '0.07'
                            marginTop: '0.02'
                            fontSize: .Nfont.h0_1
                            color: "0x666666"
                        - type: label
                          text: We also want you to know that we support your full access to your personal medical records. We may have indirect treatments relationships with you (such as laboratories that only interact with physicians and not patients), and may have to disclose personal health information for purposes of treatment, payment, or health operations, These entities are most often not required to obtain patient consent. 
                          style:
                            width: "40vw"
                            # left: '0.07'
                            marginTop: '0.02'
                            fontSize: .Nfont.h0_1
                            color: "0x666666"
                        - type: label
                          text: You may refuse to consent to the use or disclosure of your personal health information but this must be in writing. Under this law, we have the right to refuse to treat you should you choose to refuse to disclose your Personal Health Information (PIH). If you choose to give consent in this document, at some future time you may request to refuse all or part of your PHI. You may not revoke actions that have already been taken which relied on this or a previously signed consent.
                          style:
                            width: "40vw"
                            # left: '0.07'
                            marginTop: '0.02'
                            fontSize: .Nfont.h0_1
                            color: "0x666666"
                        - type: label
                          text: If your have objections to this form, please ask to speak with out HIPPA Compliance Officer. 
                          style:
                            width: "40vw"
                            # left: '0.07'
                            marginTop: '0.02'
                            fontSize: .Nfont.h0_1
                            color: "0x666666"
                        - type: label
                          text: You have the right to review our privacy notice to request restrictions and revoke consent in writing after you have reviewed our privacy notice.  
                          style:
                            width: "40vw"
                            # left: '0.07'
                            marginTop: '0.02'
                            fontSize: .Nfont.h0_1
                            color: "0x666666"
                        - type: label
                          text: HIPPA Notice of Privacy Practices  
                          style:
                            width: "40vw"
                            # left: '0.07'
                            marginTop: '0.02'
                            fontSize: .Nfont.h0_1
                            color: "#333333"
                            fontWeight: "360"
                        - type: label
                          text: "Signature below is only acknowledgement that you have received this Notice of our Privacy Practices:"
                          style:
                            width: "40vw"
                            # left: '0.07'
                            marginTop: '0.02'
                            fontSize: .Nfont.h0_1
                            color: "0x666666"
                        # - type: label
                        #   text: "Click on the signature box below to finger sign"
                        #   style:
                        #     width: "0.34"
                        #     # left: '0.07'
                        #     marginTop: '0.02'
                        #     fontSize: "15"
                        #     color: "0x666666"
                        #     textAlign: 
                        #       x: center
                    - type: view
                      style:
                        marginTop: 1vw
                        width: 29vw
                        height: "3.5vw"
                        # backgroundColor: "red"
                      children:
                        - type: label
                          text: "Name of Recipient/Healthcare Proxy"
                          style:
                            marginTop: '0.02'
                            fontSize: .Nfont.h0_1
                            color: "#333333"
                            fontWeight: 550
                        - type: textField
                          placeholder: " Enter here"
                          dataKey: recipientName
                          style: 
                            textIndent: 0.5em
                            height: "2.5vw"
                            width: 20vw
                            fontSize: .Nfont.h0_1
                            border: 
                              style: "3"
                            borderRadius: "5"
                            borderColor: "#DEDEDE"
                            
                    - type: view
                      style: 
                        # left: "0.085"
                        marginTop: 1vw
                        width: "40vw"
                        border:
                          style: "1"
                          width: "1"
                          color: "#DEDEDE"
                        # backgroundColor: "red"
                      children:
                        - .VQSecondTitle:
                          text: Signature
                          style: 
                            marginTop: 2vw
                            fontSize: .Nfont.h0_1
                            color: "#333333"
                            fontWeight: 550
                        - .ViewRow:
                          style:
                            justifyContent: space-between
                            alignItems: center
                            width: "30vw"
                          children:
                            - .VQSecondTitle:
                              text: "Click on the signature box below to finger sign"
                              style: 
                                marginTop: 0.5vw
                            - type: button
                              text: "Clear"
                              onClick:
                                - actionType: removeSignature
                                  dataObject: BLOB
                                  dataKey: NewPatFormEditPage2.newSign.document.name.data   
                                  viewTag: signatureTag   
                                - actionType: evalObject
                                  object:
                                    - ..temporarySignature@: ""
                                    - ..signatureTime@: ""
                                    - .Global.formData.newPatientForm.name.data.signatureHippa.whetherSignature@: true
                                # 显示签名区域隐藏
                                - actionType: builtIn
                                  funcName: hide
                                  viewTag: signatureShowTag
                                - actionType: builtIn
                                  funcName: show
                                  viewTag: signatureTag 
                              style:
                                marginTop: 0.5vw
                                width: "4vw"
                                fontSize: .Nfont.h0_1
                                height: '1vw'
                                color: "#E24445"
                                border: 'none'
                                borderRadius: "2"
                                backgroundColor: '0xffffff'
                                textAlign:
                                  y: center
                                  x: center         
                        - type: view
                          style: 
                            marginTop: "0.01"
                            width: "28.9vw"
                            height: "0.2"
                            border:
                              style: "4"
                              width: "1.5"
                              color: "0xDEDEDE"
                          children:
                            - .ViewRow:
                              style:
                                margin: "auto"
                                marginTop: "0.16"
                                width: "24vw"
                              children:
                                - type: label
                                  text: "x"
                                  style:
                                    height: "1vw"
                                - type: label
                                  style:
                                    height: "1vw"
                                    width: "24vw"
                                    borderBottom: "1px solid #666666"
                                    borderWidth: "1px"
                            # 显示暂存的签名
                            - type: image
                              viewTag: signatureShowTag
                              path=func: .builtIn.utils.prepareDocToPath
                              # 传入签名文档的id
                              dataKey: NewPatFormEditPage2.temporarySignature
                              style:
                                # 控制显示
                                display: ..flag
                                left: "0"
                                width: "25.9vw"
                                top: "0"
                                height: "0.15" 
                                zIndex: "100"
                            - type: canvas
                              dataKey: NewPatFormEditPage2.newSign.document.name.data 
                              viewTag: signatureTag    
                              style: 
                                left: "0"
                                width: "25.9vw"
                                top: "0"
                                height: "0.15"
                                overflow: scroll  
                                zIndex: "1000"      
                            
                        - .ViewColumn:
                          style:
                            marginTop: 1vw
                            width: 29vw
                          children:
                            - .ViewRow:
                              style:
                                justifyContent: flex-start
                              children:
                                - .VQSecondTitle: 
                                  text: "Patient Name"
                                - .VQSecondTitle:
                                  dataKey: profile.docResponse.doc.0.name.data.basicInfo.fullName
                                  style:
                                    color: "#333333"
                                    marginLeft: 1vw
                            - .ViewRow:
                              style: 
                                marginTop: 1vw
                                justifyContent: flex-start
                              children:
                                - .VQSecondTitle: 
                                  text: "Date"
                                - .VQSecondTitle:
                                  text=func: .builtIn.string.formatUnixtimeL_en
                                  dataKey: Global.formData.newPatientForm.ctime
                                  style:
                                    color: "#333333"
                                    marginLeft: 1vw

            
            - type: view
              style:
                height: 2.3vw
                left: 15.5vw
                top: 15.5vw
              children:
                - type: image
                  path: Leftbutton.svg
                  style:
                    height: 3vw
                  onClick: 
                    - actionType: evalObject
                      object:
                        - .Global.formData.newPatientForm.name.data.signatureHippa.whetherSignature@: true
                    - goto: NewPatFormEditPage1
                
            - type: view
              style:
                height: 2.3vw
                left: 60.3vw
                top: 15.5vw
              children:
                - type: image
                  path: Rightbutton.svg
                  style:
                    height: 3vw
                    left: 10vw
                    textAlign:
                      x: center
                      y: center
                  onClick:
                    # 签名处理
                    - actionType: saveSignature
                      dataObject: BLOB
                      dataKey: NewPatFormEditPage2.newSign.document.name.data  
                      isEmpty: NewPatFormEditPage2.whetherSignature
                    - actionType: evalObject
                      object:
                        # cd 签名newSign 
                        - =..newSign.docAPI.store: "" 
                        # 存放recipientName和签名的id
                        - if: 
                          - =..whetherSignature
                          - .Global.formData.newPatientForm.name.data.signatureHippa.whetherSignature@: =..whetherSignature
                          - actionType: evalObject
                            object:
                              - .Global.formData.newPatientForm.name.data.signatureHippa.recipientName@: =..recipientName
                              - .Global.formData.newPatientForm.name.data.signatureHippa.signatureTime@: =..newSign.docRes.doc.ctime
                              - .Global.formData.newPatientForm.name.data.signatureHippa.signatureNewPatForm@: =..newSign.docRes.doc.id
                              # 保存签名判断状态
                              - .Global.formData.newPatientForm.name.data.signatureHippa.whetherSignature@: =..whetherSignature
                        - if: 
                          - =.builtIn.string.equal:
                              dataIn:
                                string1: =..temporarySignature
                                string2: ""
                          - continue 
                          - actionType: evalObject
                            object:
                              - .Global.formData.newPatientForm.name.data.signatureHippa.signatureNewPatForm@: =..temporarySignature
                              - .Global.formData.newPatientForm.name.data.signatureHippa.signatureTime@: =..signatureTime
                              # 保存签名判断状态
                              - .Global.formData.newPatientForm.name.data.signatureHippa.whetherSignature@: false
                        # 若未签签名弹出提示框
                        - if: 
                          - =.Global.formData.newPatientForm.name.data.signatureHippa.whetherSignature
                          - actionType: popUp
                            popUpView: warningView
                            wait: true
                          - continue
                    - goto: NewPatFormEditPage3

        - .NewBaseWarningView:
          message: "You haven’t signed the form"
