CreateAppointment:
  init:  
    - ..formData.currentRequest@: =.Global.formData.currentRequest
    - =.builtIn.string.phoneNumberSplit: 
        dataIn: 
          phoneNumber: =.CreateAppointment.formData.currentRequest.name.patientPhoneNumber
          sign: " "
        dataOut: CreateAppointment.formData.phone
    - =..apiRequest.patientProfile.get: ""
    - if: 
      - =.builtIn.string.equal:
          dataIn:
            string1: =.Global.formData.currentRequest.name.visitType
            string2: "Telemedicine"
      - ..formData.subType@: 196616
      - ..formData.subType@: 131080
    - ..apiRequest.changeTime.edgeCreateReq.subtype@: =..formData.subType
  formData:
    currentRequest: ""
    phone: []
    patientId: ""
    FacilityId: ""
    SdateTranslated: ""
    EdateTranslated: ""
    stimeTranslated: ""
    etimeTranslated: ""
    subType: 
    Emailcontent: ""
  apiRequest:
    changeTime:
      edgeCreateResp: ""
      edgeCreateReq:
        type: 40000
        subtype: ""
        evid: .Global.clock.refid
        bvid: .Global.currentUser.vertex.id
        #E8 id
        refid: .Global.formData.currentRequest.id
        stime: .Global.clock.stime
        etime: .Global.clock.etime
        tage: 1
      edgeAPI:
        store:
          api: ce
          dataIn: CreateAppointment.apiRequest.changeTime.edgeCreateReq
          dataOut: CreateAppointment.apiRequest.changeTime.edgeCreateResp
    # 查询邮件需要挂在的edge的id
    relation:
      edgeReq:
        id: []
        type: .EdgeType.Email
        xfname: Evid&Bvid
        maxcount: "1"
        obfname: "ctime"
        _nonce: =.Global._nonce
      edgeRes: ""
      edgeAPI:
        get:
          api: re
          dataIn: CreateAppointment.apiRequest.relation.edgeReq
          dataOut: CreateAppointment.apiRequest.relation.edgeRes
    # 创建邮件doc
    changeEmail:
      docReq:
        type: .DocType.InboxMessage #邮件类型，默认1281
        eid: "" #邮件需要挂在的edge的id，为发送方与接收方之间10002的edge
        name:
          data:
            #邮件内容
            content: ""
            #收件人姓名
            receiverName: ""
            #发送人姓名
            senderName: "automatic-reply@aitmed.com"
            #收件人头像的id
            receiverAvatarId: ""
            #是否带附件
            haveAttachment: false
            #收件人id
            receiverId: ""
          title: "Change Appointment"
          user: .CreateAppointment.formData.currentRequest.bvid
      docRes: ""
      docAPI:
        store:
          api: cd
          dataIn: CreateAppointment.apiRequest.changeEmail.docReq
          dataOut: CreateAppointment.apiRequest.changeEmail.docRes
    patientProfile:
      docReponse: ""
      doc:
        ids:
          - .Global.formData.currentRequest.bvid
          - .Global.formData.currentRequest.evid
        xfname: Bvid
        type: .DocType.PatientProfile #  type: "102401"
        obfname: "ctime"
        maxcount: "1"
        ObjType: 12
        sCondition: "E.type=10000"
        _nonce: =.Global._nonce
      get:
        api: rd
        dataIn: apiRequest.patientProfile.doc
        dataOut: CreateAppointment.apiRequest.patientProfile.docReponse
        
  components:
    - type: view
      style:
        width : "1"
        height: "1"
        margin: auto
      children:
        - type: view
          style:
            background-image: 'linear-gradient(#0063a8, #004371)'   
            height: "1"
            width: "0.16"
          children:
            - .aitLogo:
            - .Menu:
        - .TopBar:
        - .BodyView:
          style: 
            backgroundColor: "#f4f8fa"
            width: "0.84"
            left: '0.16'
            top: "0.07"
            height: "0.93"
          children:
            - type: label
              text: back
              style:
                fontSize: .Nfont.h1
                color: "0x005795"
                fontFamily: "Arial"
                marginLeft: "5vw"
                top: "1vw"
              onClick:
                - actionType: builtIn
                  funcName: goBack
            - type: view
              style:
                height: 46.9vw
                width: "0.4"
                margin: auto
              viewTag: 
              children:
                - type: view
                  style:
                    width: "0.4"
                    height: "0.08"
                    display: flex
                    flexDirection: row
                    justifyContent: space-between
                    alignItems: center
                  children:
                    - type: label
                      text: 'Create an Appointment'
                      style:
                        width: "30vw"
                        marginLeft: 1vw
                        fontSize: 1.2vw
                        fontFamily: "Poppins"
                        textAlign: 
                          y: center
                - type: view
                  style:
                    width: "0.4"
                    height: "0.8"
                    padding: 1px
                  children:
                    - type: view
                      style:
                        width: "0.4"
                        height: "0.8"
                        padding: 1px
                        top: 0
                        backgroundColor: "#ffffff"
                      children:
                        - type: view
                          style:
                            marginTop: "0"
                            width: "0.4"
                            height: "0.32"
                            borderRadius: "6"
                            backgroundColor: "0xffffff"
                          children:
                            - type: view
                              style:
                                width: "0.4"
                                height: "0.35"
                                marginTop: "0"
                                marginLeft: "0.03"
                              children:
                                - type: view
                                  style:
                                    width: "0.3"
                                    height: "0.05"
                                    marginLeft: "0.01"
                                    border: 
                                      style: "2"
                                    borderWidth: "1"
                                    borderColor: "0x2988e6"
                                  children:
                                    - type: label
                                      text: "Appointment info"
                                      style:
                                        fontSize: "0.8vw"
                                        height: "0.05"
                                        display: "inline-block"
                                        lineHeight: "5vh"
                                    - type: image
                                      path: editBlue.svg
                                      style:
                                        float: right
                                        width: "0.01"
                                        marginTop: "0.015"
                                        display: "inline-block"
                                - type: view
                                  style:
                                    width: "0.3"
                                    height: "0.04"
                                    marginLeft: "0.01"
                                    marginTop: "0.015"
                                  children:
                                    - type: label
                                      text: "Date:"
                                      style:
                                        fontSize: '0.8vw'
                                        height: "0.04"
                                        display: "inline-block"
                                        lineHeight: "4vh"
                                    - type: label
                                      text: "02/12/2021"
                                      text=func: .builtIn.string.formatUnixtimeL_en
                                      dataKey: Global.clock.stime
                                      style:
                                        fontSize: '0.8vw'
                                        float: right
                                        height: "0.04"
                                        display: "inline-block"
                                        lineHeight: "4vh"
                                - type: view
                                  style:
                                    width: "0.3"
                                    height: "0.035"
                                    marginLeft: "0.01"
                                  children:
                                    - type: label
                                      text: "Time:"
                                      style:
                                        fontSize: "0.8vw"
                                        height: "0.035"
                                        display: "inline-block"
                                        lineHeight: "3.5vh"
                                    - type: label
                                      text: "9:45am-10:00am"
                                      text=func: .builtIn.date.ShowTimeSpan
                                      dataKey: Global.clock
                                      style:
                                        fontSize: "0.8vw"
                                        float: right
                                        height: "0.035"
                                        display: "inline-block"
                                        lineHeight: "3.5vh"
                                - type: view
                                  style:
                                    width: "0.3"
                                    height: "0.035"
                                    marginLeft: "0.01"
                                  children:
                                    - type: label
                                      text: "Reason for visit:"
                                      style:
                                        fontSize: "0.8vw"
                                        height: "0.035"
                                        display: "inline-block"
                                        lineHeight: "3.5vh"
                                    - type: label
                                      text: "Fever"
                                      dataKey: formData.currentRequest.name.Reason
                                      style:
                                        fontSize: "0.8vw"
                                        float: right
                                        height: "0.035"
                                        display: "inline-block"
                                        lineHeight: "3.5vh"
                                - type: view
                                  style:
                                    width: "0.3"
                                    height: "0.035"
                                    marginLeft: "0.01"
                                  children:
                                    - type: label
                                      text: "Appointment Type: "
                                      style:
                                        fontSize: "0.8vw"
                                        height: "0.035"
                                        display: "inline-block"
                                        lineHeight: "3.5vh"
                                    - type: label
                                      text: "Office visit"
                                      dataKey: formData.currentRequest.name.visitType
                                      style:
                                        fontSize: "0.8vw"
                                        float: right
                                        height: "0.035"
                                        display: "inline-block"
                                        lineHeight: "3.5vh"
                                - type: view
                                  style:
                                    width: "0.3"
                                    height: "0.035"
                                    marginLeft: "0.01"
                                  children:
                                    - type: label
                                      text: "Provider: "
                                      style:
                                        fontSize: "0.8vw"
                                        height: "0.035"
                                        display: "inline-block"
                                        lineHeight: "3.5vh"
                                    - type: label
                                      text: "Aomas Mueller"
                                      dataKey: formData.currentRequest.name.patientName
                                      style:
                                        fontSize: "0.8vw"
                                        float: right
                                        height: "0.035"
                                        display: "inline-block"
                                        lineHeight: "3.5vh"
                                - type: view
                                  style:
                                    width: "0.3"
                                    height: "0.035"
                                    marginLeft: "0.01"
                                  children:
                                    - type: label
                                      text: "Facility: "
                                      style:
                                        fontSize: "0.8vw"
                                        height: "0.035"
                                        display: "inline-block"
                                        lineHeight: "3.5vh"
                                    - type: label
                                      text: "A&C Urgentcare"
                                      dataKey: Global.currentFacility.name.basicInfo.medicalFacilityName
                                      style:
                                        fontSize: "0.8vw"
                                        float: right
                                        height: "0.035"
                                        display: "inline-block"
                                        lineHeight: "3.5vh"
                                
                        - type: view
                          style:
                            width: "0.4"
                            marginTop: "0.01"
                            height: "0.2"
                          children:
                            - type: label
                              text: "Add Patient"
                              style:
                                height: "0.03"
                                color: "0x333333"
                                fontSize: "0.8vw"
                                marginLeft: "0.04"
                            - type: view
                              style:
                                height: "0.08"
                                width: "0.3"
                                marginLeft: "0.04"
                                display: flex
                                flexDirection: row
                                justifyContent: space-between
                                alignItems: center
                              children:
                                - type: view
                                  style:
                                    display: flex
                                    flexDirection: column
                                  children:
                                    - type: label
                                      text: "Patient Name"
                                      style:
                                        height: "0.03"
                                        color: "0x333333"
                                        fontSize: "0.8vw"
                                    - type: textField
                                      dataKey: CreateAppointment.formData.currentRequest.name.patientName
                                      isEditable: false
                                      style:
                                        height: "0.04"
                                        border: 
                                          style: "3"
                                        borderWidth: "1"
                                        borderColor: "0x333333"
                                        borderRadius: "8px" 
                                - type: view
                                  children:
                                    - type: View
                                      style:
                                        display: inline-block
                                      children:   
                                        - type: label
                                          text: "Country"
                                          style:
                                            height: "0.03"
                                            color: "0x333333"
                                            fontSize: "0.8vw"
                                        - type: select
                                          dataKey: formData.phone.0
                                          options:
                                            .CountryCode
                                          style: 
                                            height: "0.04"
                                            border: 
                                              style: "3"
                                            borderWidth: "1"
                                            borderColor: "0x333333" 
                                            borderRadius: "8px" 
                                            textAlign:
                                              x: center
                                    - type: view
                                      style:
                                        marginLeft: "0.01"
                                        display: inline-block
                                      children:   
                                        - type: label
                                          text: "Phone Number"
                                          dataKey:
                                        - type: textField
                                          dataKey: formData.phone.1
                                          isEditable: false
                                          style:
                                            marginTop: "0.01"
                                            height: "0.04"
                                            border: 
                                              style: "3"
                                            borderWidth: "1"
                                            borderColor: "0x333333" 
                                            borderRadius: "8px"  
                                      
                        - type: view
                          style:
                            width: "0.3"
                            marginLeft: "0.07"
                            marginTop: "0.01"
                            height: "0.11"
                          children: 
                            - type: image
                              path: redWarning.svg
                              style: 
                                width: "0.01"
                                display: "inline"
                            - type: label
                              text: " The appointment will be changed from"
                              style:
                                display: "inline"
                                fontSize: "0.8vw"
                            - type: label
                              text: "  " 
                              style:
                                display: "inline"
                                color: "0x69AAD8"
                                fontSize: "0.8vw"
                            - type: label
                              text: " Sara Brown"
                              dataKey: Global.MyProfile.name.data.fullName
                              style:
                                display: "inline"
                                color: "0x69AAD8"
                                fontSize: "0.8vw"
                            - type: label
                              text: "," 
                              style:
                                display: "inline"
                                color: "0x69AAD8"
                                fontSize: "0.8vw"
                            
                            - type: label
                              text=func: .builtIn.string.formatUnixtimeL_en
                              dataKey: Global.clock.stime
                              style:
                                display: "inline"
                                color: "0x69AAD8"
                                fontSize: "0.8vw"
                            - type: label
                              text: "," 
                              style:
                                display: "inline"
                                color: "0x69AAD8"
                                fontSize: "0.8vw"
                            - type: label
                              text=func: .builtIn.string.formatUnixtimeLT_en
                              dataKey: Global.clock.stime
                              style:
                                display: "inline"
                                color: "0x69AAD8"
                                fontSize: "0.8vw"
                            - type: label
                              text: "to"
                              style:
                                display: "inline" 
                                fontSize: "0.8vw"
                            - type: label
                              text=func: .builtIn.string.formatUnixtimeL_en
                              dataKey: Global.clock.etime
                              style:
                                display: "inline"
                                color: "0x69AAD8"
                                fontSize: "0.8vw"
                            - type: label
                              text: "," 
                              style:
                                display: "inline"
                                color: "0x69AAD8"
                                fontSize: "0.8vw"
                            - type: label
                              text=func: .builtIn.string.formatUnixtimeLT_en
                              dataKey: Global.clock.etime
                              style:
                                display: "inline"
                                color: "0x69AAD8"
                                fontSize: "0.8vw"
                            - type: label
                              text: "." 
                              style:
                                display: "inline"
                                color: "0x69AAD8"
                                fontSize: "0.8vw"
                            - type: label
                              text: "Click create to confirm your change."
                              style:
                                display: "inline"
                                fontSize: "0.8vw"
                              # style:
                              #   width: "0.8"
                              #   height: "0.04"
                              #   fontSize: "3.5vw"
                            - type: label
                              text: "There will be an email send to other participants. Please check the Inbox." 
                              style:
                                fontSize: "0.8vw"
                                
                        
                        - type: view
                          style:
                            width: '0.15'
                            margin: auto
                            height: "0.09"
                          children:
                            - type: button
                              viewTag: buttonView
                              text: "Change Appointment"
                              style:
                                width: "0.15"
                                height: "0.05"
                                color: "0xffffff"
                                fontSize: "0.8vw"
                                marginTop: "0.025"
                                textAlign:
                                  x: center
                                lineHeight: "5vh"
                                border: 
                                  style: "3"
                                borderWidth: "1"
                                backgroundColor: "0x2988e6"
                                boxShadow: "0 0 1px 1px #7bb3f2"
                                borderColor: "0x65a9ee"
                                borderRadius: "5"
                              onClick: 
                                - actionType: evalObject
                                  object:
                                    - if:
                                      - =.builtIn.string.equal:
                                          dataIn:
                                            string1: =..formData.currentRequest.evid
                                            string2: =.Global.currentUser.vertex.id
                                      - actionType: evalObject
                                        object:
                                          - ..formData.patientId@: =..formData.currentRequest.bvid
                                          - ..formData.FacilityId@: =..formData.currentRequest.name.facilityId
                                      - actionType: evalObject
                                        object:
                                          - ..formData.patientId@: =..formData.currentRequest.evid
                                          - ..formData.FacilityId@: =..formData.currentRequest.name.facilityId
                                - actionType: evalObject
                                  object:
                                    - .Global.jwt.edge.bvid@: =.Global.currentUser.vertex.id
                                    - =.Global.jwt.edgeAPI.store: ""
                                    - =..apiRequest.changeTime.edgeAPI.store: ""
                                # 发patients
                                - actionType: evalObject
                                  object:
                                    - =.builtIn.array.add:
                                        dataIn:
                                          object: =..apiRequest.relation.edgeReq.id
                                          value: =..formData.patientId
                                    - =.builtIn.array.add:
                                        dataIn:
                                          object: =..apiRequest.relation.edgeReq.id
                                          value: =.Global.currentUser.vertex.id
                                
                                - actionType: evalObject
                                  object: 
                                    - =.builtIn.string.formatUnixtimeL_en:
                                        dataIn:
                                          - =.Global.clock.stime
                                        dataOut: CreateAppointment.formData.SdateTranslated
                                    - =.builtIn.string.formatUnixtimeL_en:
                                        dataIn:
                                          - =.Global.clock.etime
                                        dataOut: CreateAppointment.formData.EdateTranslated
                                    - =.builtIn.string.formatUnixtimeLT_en:
                                        dataIn:
                                          - =.Global.clock.stime
                                        dataOut: CreateAppointment.formData.stimeTranslated
                                    - =.builtIn.string.formatUnixtimeLT_en:
                                        dataIn:
                                          - =.Global.clock.etime
                                        dataOut: CreateAppointment.formData.etimeTranslated
                                - actionType: evalObject
                                  object:
                                    - =.builtIn.string.concat:
                                        dataIn:
                                          - "The appointment will be changed from "
                                          - =.Global.MyProfile.name.data.fullName
                                          - ","
                                          - =..formData.SdateTranslated
                                          - ","
                                          - =..formData.stimeTranslated
                                          - " to "
                                          - =..formData.EdateTranslated
                                          - ","
                                          - =..formData.etimeTranslated
                                          - "."
                                        dataOut: CreateAppointment.formData.Emailcontent
                  
                                    - =..apiRequest.relation.edgeAPI.get: ""
                                    - ..apiRequest.changeEmail.docReq.name.data.receiverName@: =..formData.currentRequest.name.patientName
                                    - ..apiRequest.changeEmail.docReq.name.data.receiverAvatarId@: =..apiRequest.patientProfile.docReponse.doc.0.name.data.basicInfo.avatar
                                    - ..apiRequest.changeEmail.docReq.name.data.receiverId@: =..formData.patientId
                                    - ..apiRequest.changeEmail.docReq.name.data.content@: =..formData.Emailcontent
                                    - ..apiRequest.changeEmail.docReq.eid@: =..apiRequest.relation.edgeRes.edge.0.id
                                    - if:
                                      - =..apiRequest.changeTime.edgeCreateResp.edge.id
                                      - =..apiRequest.changeEmail.docAPI.store: ""
                                      - continue
                                # 发facility
                                - actionType: evalObject
                                  object:
                                    - ..apiRequest.relation.edgeRes.edge@: ""
                                    - ..apiRequest.relation.edgeReq.id@: []
                                    - =.builtIn.array.add:
                                        dataIn:
                                          object: =..apiRequest.relation.edgeReq.id
                                          value: =..formData.FacilityId
                                    - =.builtIn.array.add:
                                        dataIn:
                                          object: =..apiRequest.relation.edgeReq.id
                                          value: =.Global.currentUser.vertex.id
                                - actionType: evalObject
                                  object:
                                    - =..apiRequest.relation.edgeAPI.get: ""
                                    - ..apiRequest.changeEmail.docReq.name.data.receiverName@: =.Global.currentFacility.name.basicInfo.medicalFacilityName
                                    - ..apiRequest.changeEmail.docReq.name.data.receiverAvatarId@: =..apiRequest.facility.response.doc.0.name.data.basicInfo.businessLogo
                                    - ..apiRequest.changeEmail.docReq.name.data.receiverId@: =..formData.FacilityId
                                    - ..apiRequest.changeEmail.docReq.name.data.content@: =..formData.Emailcontent
                                    - ..apiRequest.changeEmail.docReq.eid@: =..apiRequest.relation.edgeRes.edge.0.id
                                    - if:
                                        - =..apiRequest.changeTime.edgeCreateResp.edge.id
                                        - =..apiRequest.changeEmail.docAPI.store: ""
                                        - continue
                                - actionType: popUp
                                  popUpView: successView
                                              

        - .BaseSuccessfulView:
          viewTag: successView
          msg: "change Successfully!"
          onClick:
            - goto:  ProviderSchedule
          style: 
            width: 1
            height: 1
        
        
