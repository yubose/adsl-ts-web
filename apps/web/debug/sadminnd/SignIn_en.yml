SignIn: # 页面名需要对页面内容具有概括

  title: SignIn # Title
  
  pageNumber: "1" # Page Number
  
  init: # Page initialization
    - if:
      - =.Global.currentUser.vertex.sk #.builtIn.SignInOk
      - goto: AdminManagement
      - continue
    # - ..formData.apiData.phoneNumber@: ""
    # - ..formData.phoneNumber@: ""
    # - actionType: builtIn
    #   funcName: hide
    #   viewTag: useUserName
    # - actionType: builtIn
    #   funcName: show
    #   viewTag: usePhoneNumber      

  formData: # Input data here
    checkOk: "false"
    checkMessage: "no message"
    countryCode: "+1"   
    phoneNumber: ""
    password: ""
    code: ""
    sk: ""
    pass: ""
    apiData:
      phoneNumber: ""  
    initFocus: phoneNumberVT # not be used
  
  formDataTemp: # Input data temp here
  verificationCode:
    response: ""
    edge:
      .Edge: ""
      type: 1010
      _nonce: =.Global._nonce
      name:
        phone_number: =..formData.apiData.phoneNumber
    edgeAPI:
      .EdgeAPI: ""
      store:
        api: ce
        dataIn: SignIn.verificationCode.edge
        dataOut: SignIn.verificationCode.response
  apiRequest: # Input data request here
    retrieveVertex:
      response: ""
      vertex:
        .Vertex: ""
        id: =..apiRequest.loginNewDevice.response.edge.deat.user_id
      vertexAPI:
        get:
          api: rv
          dataIn: SignIn.apiRequest.retrieveVertex.vertex
          dataOut: SignIn.apiRequest.retrieveVertex.response
    loginNewDevice:
      response: ""
      edge:
        .Edge: ""
        type: 1040
        _nonce: =.Global._nonce
        name:
          phone_number: =..formData.apiData.phoneNumber
          verification_code: =..formData.code
        deat:
          UserId: ""
          Pk: ""
          Esk: ""
      edgeAPI:
        .EdgeAPI: ""
        store:
          api: ce
          dataIn: SignIn.apiRequest.loginNewDevice.edge
          dataOut: SignIn.apiRequest.loginNewDevice.response
    loginUser:
      response: ""
      edge:
        .Edge: ""
        type: 1030
        _nonce: =.Global._nonce
        bvid: =..apiRequest.loginNewDevice.response.edge.deat.user_id
      edgeAPI:
        .EdgeAPI: ""
        store:
          api: ce
          dataIn: SignIn.apiRequest.loginUser.edge
          dataOut: SignIn.apiRequest.loginUser.response  
  
  style: # Input style fragment here
  
  save:
    - =.builtIn.eccNaCl.decryptAES:
        dataIn:
          key: =..formData.password
          message: =.Global.currentUser.vertex.esk
        dataOut: SignIn.formData.sk  
    - =.builtIn.eccNaCl.skCheck:
        dataIn:
          pk: =.Global.currentUser.vertex.pk
          sk: =..formData.sk
        dataOut: SignIn.formData.pass
    - if:
      - =..formData.pass
      - .Global.currentUser.vertex.sk@: =..formData.sk
      - actionType: popUp
        popUpView: wrongPassword
        wait: true       
  
  check:
    - =.SignIn.apiRequest.loginNewDevice.edgeAPI.store: ""
    - actionType: evalObject
      object: 
        .Global._nonce@: 
          =.builtIn.math.random: ""     
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =..apiRequest.loginNewDevice.response.code
              string2: 1020   #unregistered user signin
        - actionType: popUp
          popUpView: userCannotfind
          wait: true
        - continue
    - if:
      - =.builtIn.string.equal:
          dataIn:
            string1: =..apiRequest.loginNewDevice.response.code
            string2: 0
      - continue
      - actionType: popUp
        popUpView: wrongCode
        wait: true
  
  update: 
    - =.SignIn.apiRequest.loginUser.edgeAPI.store: ""
    - =.SignIn.apiRequest.retrieveVertex.vertexAPI.get: ""
    - .Global.currentUser.vertex@: =..apiRequest.retrieveVertex.response.vertex.0
    - .Global.currentUser.JWT@: =..apiRequest.loginUser.response.jwt
    - =.builtIn.storeCredentials:
        dataIn:
          sk: =.Global.currentUser.vertex.sk
          pk: =.Global.currentUser.vertex.pk
          userId: =.Global.currentUser.vertex.id
          esk: =.Global.currentUser.vertex.esk
    - .Global.currentUser.dataCache.loadingDateTime@: =.Global.currentDateTime
    - .Global.rootNotebookID@: =.Global.currentUser.vertex.deat.rnb64ID
    - .Global.currentUser.dataCache.loadingDateTime@ : =.Global.currentDateTime

  components:
    - .BaseCheckView: ""
      message: "Incorrect Password"
      viewTag: wrongPassword
    - .BaseCheckView: ""
      message: "Incorrect verificationCode"
      viewTag: wrongCode
    - .BaseCheckView: ""
      message: "Cannot Find the User"
      viewTag: userCannotfind
    - type: view
      style:
        width: "1"
        height: "1"
        margin: auto
      children:
        - type: view
          style:
            width: "0.55"
            height: "1"
            top: "0"
            # backgroundColor: "0xf0f0f0"
          children:
            - type: image
              path: background.svg
              style:
                height: "1"
                left: "0"
                top: "0"
            - type: label
              textBoard: 
                - text: Welcome To 
                - br: 
                - text: AiTmed
              style:
                color: "0xffffff"
                textAlign: 
                  x: center
                fontSize: "3.2vw"
                # lineHeight: "4vw"
                marginTop: "0.4"
                # letterSpacing: "0.1vw"
        - type: view
          style:
            left: "0.55"
            # marginTop: "1vw"
            width: "0.45"
            height: "1"
            # border: 
            #   style: "3"
            # borderColor: "0xcdcdcd"
            # box-sizing: border-box
            # backgroundColor: "0xf1f1b8"
            display: flex
            flex-direction: column
            justify-content: center
            align-items: center
          children:
            - type: image
              path: aitmedBlack.svg
              style:
                # marginTop: "0.05"
                width: "6.5vw"
                height: "6.5vw"
            - type: view
              style:
                marginTop: "2vw"
                width: "26.1vw"
                height: "30vw"
                borderRadius: "5"
                boxShadow: "0 0 20px #ecf4f8"
                display: flex
                flex-direction: column
                justify-content: center
                align-items: center
              children:
                # Hello
                - type: view
                  style:
                    width: "15.3vw"
                    display: flex
                    flex-direction: column
                    align-items: center
                  children:
                    - type: label
                      text: Hello!
                      style:
                        width: "15.3vw"
                        height: "2vw"
                        fontSize: "1.5vw"
                        fontWeight: "400"
                        textAlign:
                          y: center
                    - type: label
                      text: Sign In To Continue
                      style:
                        width: "15.3vw"
                        height: "2vw"
                        fontSize: "1vw"
                        textAlign:
                          y: center
                # Phone/Username
                - type: view
                  style:
                    width: "15.3vw"
                    height: "2.6vw"
                    display: flex
                    flex-direction: row
                    align-items: flex-end
                  children:
                    - type: label
                      text: Phone
                      onClick: 
                        - actionType: evalObject
                          object:
                            - ..formData.apiData.phoneNumber@: ""
                            - ..formData.phoneNumber@: ""
                        - actionType: builtIn
                          funcName: hide
                          viewTag: useUserName
                        - actionType: builtIn
                          funcName: show
                          viewTag: usePhoneNumber
                        # - actionType: builtIn
                        #   funcName: redraw
                        #   viewTag: usePhoneNumber
                      style: 
                        fontSize: "0.8vw"
                    - type: label
                      text: /
                      style:
                        width: "0.4vw"
                    - type: label
                      text: Username
                      onClick: 
                        - actionType: evalObject
                          object:
                            - ..formData.apiData.phoneNumber@: ""
                            - ..formData.phoneNumber@: "8888888888"
                            #- ..rvCondition@: "0"
                        - actionType: builtIn
                          funcName: hide
                          viewTag: usePhoneNumber
                        - actionType: builtIn
                          funcName: show
                          viewTag: useUserName
                        # - actionType: builtIn
                        #   funcName: redraw
                        #   viewTag: useUserName
                      style: 
                        fontSize: "0.8vw"             
                # usePhoneNumber
                - type: view
                  viewTag: usePhoneNumber
                  style:
                    marginTop: "0.7vw"
                    width: "15.3vw"
                    height: "auto"
                    isHidden: false
                    display: flex
                    flex-direction: column
                    align-content: center
                  children:
                    # Country Phone
                    - type: view
                      style:
                        width: "15.3vw"
                        height: "auto"
                        display: flex
                        flex-direction: row
                        align-content: flex-start
                      children:
                        - type: label
                          text: "Country"
                          style:
                            width: "3.1vw"
                            fontSize: "0.7vw"
                        - type: label
                          text: "Phone"
                          style:
                            fontSize: "0.7vw"        
                    # Select TextField
                    - type: view
                      style:
                        marginTop: "0.4vw"
                        width: "15.3vw"
                        height: "auto"
                        display: flex
                        flex-direction: row
                        align-content: center
                      children:
                        - type: select
                          contentType: countryCode
                          placeholder: ..formData.countryCode
                          dataKey: formData.countryCode # formData.countryCode : inputValue
                          options:
                            .CountryCode
                          required: "true"
                          style:
                            width: "2.2vw"
                            height: "2.2vw"
                            fontSize: "0.7vw"
                            fontWeight: "500"
                            border: 
                              style: "3"
                            borderColor: "0xc4c4c4"
                            borderWidth: "1"
                            borderRadius: "5"
                            boxSizing: "border-box" 
                            backgroundColor: "0xffffff00"          
                        - type: textField # take users' input
                          viewTag: phoneNumberVT
                          contentType: phoneNumber
                          placeholder: "Your phone number"
                          dataKey: formData.phoneNumber  # users' input will be saved to this key
                          required: "true"
                          onChange:
                            - emit:
                                actions:
                                  - =.builtIn.typeCheck.phoneNumber:
                                      dataIn:
                                        phoneNumber: =..formData.phoneNumber
                                        countryCode: =..formData.countryCode
                                      dataOut: SignIn.formData.checkOk
                                  - if:
                                    - =..formData.checkOk
                                    - continue
                                    - ..formData.checkMessage@: "Unacceptible phone number format example: 888-999-0000"
                          style:
                            marginLeft: "0.4vw"
                            width: "11.8vw"
                            height: "2.2vw"
                            fontSize: "0.8vw"
                            border: 
                              style: "3"
                            borderColor: "0xc4c4c4"
                            borderWidth: "1"
                            borderRadius: "5"
                            boxSizing: "border-box"  
                            textIndent: "0.5em"
                            backgroundColor: "0xffffff00"
                # useUserName
                - type: view
                  viewTag: useUserName
                  style:
                    marginTop: "1vw"
                    width: "15.3vw"
                    height: "auto"
                    display: none
                    flex-direction: column
                    justify-content: flex-end
                    align-content: center
                    isHidden: true
                  children:
                    - type: label
                      text: "Username"
                      style:
                        fontSize: "0.7vw"              
                    - type: textField # take users' input
                      placeholder: Your username
                      dataKey: formData.apiData.phoneNumber ### error! should be "formData.apiData.username"
                      style:
                        marginTop: "0.4vw"
                        textAlign:
                          x: left
                        width: "15.2vw"
                        height: "2.2vw"
                        fontSize: "0.8vw"
                        border: 
                          style: "3"
                        borderColor: "0xc4c4c4"
                        borderWidth: "1"
                        borderRadius: "5"
                        boxSizing: "border-box"
                        backgroundColor: "0xffffff00"
                        textIndent: "0.5em"
                # Password
                - type: view
                  style: 
                    marginTop: "1vw"
                    width: "15.3vw"
                    height: "auto"
                    display: flex
                    flex-direction: column
                    align-content: center
                  children: 
                    - type: label
                      text: "Password"
                      style:
                        fontSize: "0.7vw"  
                    - type: view
                      style:
                        marginTop: "0.4vw"
                        width: "15.2vw"
                        height: "2.2vw"
                        border: '1px solid #000000'
                        borderWidth: "1px"
                        borderRadius: 5px
                        borderColor: "0xc4c4c4"
                      children:
                        - type: textField
                          contentType: password
                          placeholder: "Your password"
                          dataKey: formData.password
                          required: "true"
                          style:
                            height: "2.2vw"
                            fontSize: "0.8vw"
                            border: none                           
                            textAlign:
                                x: left
                                y: center
                            backgroundColor: "0x388ecc00"
                            textIndent: "0.5em"
                            box-sizing: border-box
                            borderRadius: 5px  
                    - type: label
                      text: Forgot Password?
                      onClick:
                        - actionType: popUp
                          popUpView: resetUser  
                      style:
                        align-self: "flex-end"
                        marginTop: "0.4vw"
                        fontSize: "0.7vw"
                        fontWeight: "500"
                        color: "0x235591"
                    - .BaseButton:
                      text: Sign In
                      style:
                        marginTop: "1.2vw"
                      onClick: 
                        - actionType: evalObject
                          object: 
                            =.builtIn.string.concat:
                              dataIn:
                                - =.SignIn.formData.countryCode
                                - " "
                                - =.SignIn.formData.phoneNumber
                              dataOut: SignIn.formData.apiData.phoneNumber  
                        - actionType: evalObject
                          object: 
                            - if: 
                                - =.Global.currentUser.vertex.esk  
                                - actionType: evalObject
                                  object: ..save
                                - continue
                        - actionType: evalObject
                          object:
                            - if:
                                - =.Global.currentUser.vertex.sk
                                - goto: AdminManagement
                                - continue  
                        - actionType: evalObject
                          object: 
                            - if:
                              - =.Global.currentUser.vertex.sk
                              - continue 
                              - =.SignIn.verificationCode.edgeAPI.store : ""
                            - if:
                              - =.Global.currentUser.vertex.sk
                              - continue 
                              - actionType: evalObject
                                object:
                                  - ..formData.code@: =..verificationCode.response.edge.deat.verification_code
                        - actionType: evalObject
                          object: 
                            .Global._nonce@: 
                              =.builtIn.math.random: "" 
                        - actionType: builtIn
                          funcName: redraw
                          viewTag:  inputVerificationCode       
                        - actionType: popUp
                          popUpView: inputVerificationCode                
                # OR
                - type: view
                  style:
                    marginTop: "1vw"
                    width: "15.3vw"
                    height: "auto"
                    display: flex
                    flex-direction: row
                    align-content: center
                    justify-content: space-evenly
                    align-items: center
                  children:
                    - type: view
                      style:
                        height: "0.01vw"
                        width: "6.7vw"
                        backgroundColor: "0xc4c4c4"  
                    - type: label
                      text: OR
                      style:
                        fontSize: "0.55vw"    
                    - type: view
                      style:
                        height: "0.01vw"
                        width: "6.7vw"
                        backgroundColor: "0xc4c4c4"
                # Don't have an account
                - type: view
                  style:
                    marginTop: "1vw"
                    width: "15.2vw"
                    height: "auto"
                    display: flex
                    justifyContent: center
                  children:
                    - type: label
                      text: Don't have an account? 
                      style:
                        fontSize: "0.7vw"
                    - type: label
                      text: Sign Up Now
                      style:
                        marginLeft: "0.4vw"
                        color: "0x235591"
                        fontSize: "0.7vw"
                        fontWeight: "700"                   
                      onClick: 
                        - goto: SignUp          
            # resetUser
            - type: popUp 
              viewTag: resetUser
              style:
                top: "0"
                width: "0.45"
                height: "1" 
                backgroundColor: '0x00000033'
                display: flex
                justify-content: center
                align-items: center
              children:
                - type: view
                  style:
                    marginTop: ""
                    width: "22vw"
                    height: "15vw" 
                    borderRadius: "5"
                    backgroundColor: "0xf8f8f8"
                    display: flex
                    flex-direction: column
                    justify-content: space-evenly
                    align-items: center
                  children:
                    - type: label
                      text: "Forgot password?"
                      style:
                        marginTop: "0.6vw"
                        color: "0x000000"
                        fontSize: "0.9vw"
                        fontWeight: "600"
                        fontFamily: "sans-serif"
                        textAlign:
                          x: center
                          y: center
                    - type: view
                      style:
                        display: flex
                        width: "19.8vw"
                        # height: "4vw"
                        flex-direction: column
                        justify-content: space-around
                        align-items: center
                      children:
                        - type: label
                          text: "When using blockchain technology, there is no way for us at AiTmed to recover your password. It is blockchain-encrypted for your security and privacy."
                          style:
                            fontFamily: "sans-serif"
                            fontSize: "0.8vw"
                            textAlign:
                              x: center
                        - type: label
                          text: "To reset your password, you must create a new account."
                          style:
                            fontFamily: "sans-serif"
                            fontSize: "0.8vw"
                            textAlign:
                              x: center
                        - type: label
                          text: "THIS WILL RESET YOUR ACCOUNT AND DELETE ANY PREVIOUSLY STORED INFORMATION"
                          style:
                            fontFamily: "sans-serif"
                            fontSize: "0.8vw"
                            textAlign:
                              x: center
                        - type: label
                          text: "This action cannot be undone."
                          style:
                            fontFamily: "sans-serif"
                            fontSize: "0.8vw"
                            textAlign:
                              x: center
                    - type: view
                      style:
                        display: flex
                        width: "20vw"
                        height: "3vw"
                        flex-direction: row
                        justify-content: space-around
                        align-items: center
                      children:                        
                        - type: button
                          onClick: 
                            - actionType: popUpDismiss
                              popUpView: resetUser
                          text: Cancel
                          style:
                            .btnCancel:
                              marginTop: "0"         
                        - type: button
                          onClick: 
                            - actionType: popUpDismiss
                              popUpView: resetUser
                            - goto: SignUp
                          text: Continue
                          style:
                            .btnSubmit:
                              marginTop: "0" 
            # inputVerificationCode
            - type: popUp
              viewTag: inputVerificationCode
              style:
                top: "0"
                width: "0.45"
                height: "1" 
                backgroundColor: '0x00000033'
                display: flex
                justify-content: center
                align-items: center 
              children:
                - type: view
                  style:
                    marginTop: ""
                    width: "20vw"
                    height: "12vw" 
                    borderRadius: "5"
                    backgroundColor: "0xf8f8f8"
                    display: flex
                    flex-direction: column
                    justify-content: space-evenly
                    align-items: center
                  children:
                    - type: label
                      text: "Please enter the 6-digit verification code"
                      style:
                        color: "0x000000"
                        fontSize: "0.9vw"
                        height: "6vw"
                        fontFamily: "sans-serif"
                        textAlign:
                          x: center
                          y: center
                    - type: textField
                      contentType: text
                      dataKey: formData.code
                      required: "true"
                      style:
                        color: "0x777777"
                        width: "15vw"
                        height: "2.5vw"
                        backgroundColor: "0xffffff00"
                        fontSize: "1vw"
                        # display: inline
                        border: 
                          style: "3"
                          color: "0xb5b5b8"
                        borderWidth: "1"
                        borderRadius: "5"
                        textAlign:
                          x: center
                          y: center  
                    - type: view
                      style:
                        display: flex
                        width: "20vw"
                        height: "6vw"
                        flex-direction: row
                        justify-content: space-around
                      children:
                        - type: button
                          onClick:
                            - actionType: popUpDismiss
                              popUpView: inputVerificationCode
                          text: Cancel
                          style:
                            .btnCancel:  
                        - type: button
                          text: Submit
                          onClick:
                            - actionType: popUpDismiss
                              popUpView: inputVerificationCode
                            - actionType: evalObject
                              object: ..check
                            - actionType: evalObject
                              object:
                                =.builtIn.eccNaCl.decryptAES:
                                  dataIn:
                                    key: =..formData.password
                                    message: =..apiRequest.loginNewDevice.response.edge.deat.esk
                                  dataOut: SignIn.formData.sk  
                            - actionType: evalObject
                              object:
                                =.builtIn.eccNaCl.skCheck:
                                  dataIn:
                                    pk: =..apiRequest.loginNewDevice.response.edge.deat.pk
                                    sk: =..formData.sk
                                  dataOut: SignIn.formData.pass
                            - actionType: evalObject
                              object:
                                - if:
                                  - =..formData.pass
                                  - .Global.currentUser.vertex.sk@: =..formData.sk
                                  - actionType: popUp
                                    popUpView: wrongPassword
                                    wait: true
                            - actionType: evalObject
                              object: ..update
                            - actionType: evalObject
                              object:
                                - if:
                                  - =.Global.currentUser.vertex.sk 
                                  - goto: AdminManagement
                                  - continue
                          style:
                            .btnSubmit: 
