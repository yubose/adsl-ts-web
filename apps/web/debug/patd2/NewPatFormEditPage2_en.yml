NewPatFormEditPage2:
  title: "New Patient Forms"

  init:
    - .SignInCheck
    # 判断是否签名
    - if:
        - =.Global.formData.newPatientForm.name.data.signatureHippa.whetherSignature
        - continue
        # 非空修改显示的标识,刷新签名区域
        - actionType: evalObject
          object:
            # 签名的时间
            - ..formData.signatureTime@: =.Global.formData.newPatientForm.name.data.signatureHippa.signatureTime
            # 签名的id
            - ..formData.temporarySignature@: =.Global.formData.newPatientForm.name.data.signatureHippa.signatureNewPatForm
            - ..formData.flag@: "block"
    # 判断是否Name of Recipient/Healthcare Proxy存在
    - actionType: evalObject
      object:
        - if:
            - =.Global.formData.newPatientForm.name.data.signatureHippa.recipientName
            - ..formData.recipientName@: =.Global.formData.newPatientForm.name.data.signatureHippa.recipientName
            - continue
  formData:
    doc: ""
    recipientName: ""
    # 获取暂存的签名的id
    temporarySignature: ""
    # 签名的显示,默认为none
    flag: "none"
    # 是否签名 true 表示未签 false 表示已签
    whetherSignature: ""
    signatureTime: ""
  formDataTemp: #Input data temp here, datatemp should not mix with formData

  apiRequest: #Input data request here
    patientForm:
      docReq: ""
      docRes: ""
      docAPI:
        store:
          api: cd
          dataIn: NewPatFormEditPage2.apiRequest.patientForm.docReq
          dataOut: NewPatFormEditPage2.apiRequest.patientForm.docRes
    newSign:
      docRes: ""
      docReq: #DOC
        type: .DocType.DocumentSignature
        eid: .Global.rootNotebookID
        reid: .Global.formData.newPatientForm.id
        name:
          title: ""
          type: ..apiRequest.newSign.docReq.subtype.mediaType
          data: ""
        subtype:
          mediaType: ""
      docAPI: # DOCAPI
        store:
          api: cd
          dataIn: NewPatFormEditPage2.apiRequest.newSign.docReq
          dataOut: NewPatFormEditPage2.apiRequest.newSign.docRes

  components:
    - type: view
      style:
        ..style.formatting:
      children:
        - .BasePublicHeader:
          children:
            - type: view
              style:
                ..style.backLeft:
              children:
                - type: image
                  path: arrowLeftgrey.svg
                  style:
                    ..style.backLeftImg:
                  onClick:
                    - ..event.publicClick
                    - ..event.backClick
            - .BasePublicHeaderTitle:

        - type: view
          style:
            ..style.bodyBox:
          children:
            - type: view
              style:
                ..style.viewBox:
              children:
                - type: view
                  style:
                    ..style.titleBox:
                  children:
                    - type: label
                      text: Patient Consent Form - HIPPA
                      dataKey:
                      style:
                        ..style.titlelabel:
                    - type: label
                      text: "2&nbsp;/&nbsp;2"
                      dataKey:
                      style:
                        ..style.pageNum:
            - type: scrollView
              style:
                ..style.scrollBox:
              children:
                - type: label
                  text: "Please Carefully Read The Following Informed Consent:"
                  dataKey:
                  style:
                    ..style.secondLabel:
                - type: label
                  text: The Department of Health and Human Services has established a "Privacy Rule" to help insure that personal health care information is protected for privacy. The Privacy Rule was also created in order to provide a standard for certain health care providers to obtain their patients' consent for uses and disclosures of health information about the patient to carry out treatment, payment or health care operations.
                  style:
                    ..style.text:
                - type: label
                  text: As our patient we want you to know that we respect the privacy of your personal medical records and will do all we can to secure and protect that privacy. We strive to always take reasonable precautions to protect your privacy. When it is appropriate and necessary, we provide the minimum necessary information to only those we feel are in need of your healthcare information and information about treatment, payment or health care operations, in order to provide health care that is in your best interest.
                  style:
                    ..style.text:
                    marginTop: "0.0258"
                - type: label
                  text: We also want you to know that we support your full access to your personal medical records. We may have indirect treatments relationships with you (such as laboratories that only interact with physicians and not patients), and may have to disclose personal health information for purposes of treatment, payment, or health operations, These entities are most often not required to obtain patient consent.
                  style:
                    ..style.text:
                    marginTop: "0.0258"
                - type: label
                  text: You may refuse to consent to the use or disclosure of your personal health information but this must be in writing. Under this law, we have the right to refuse to treat you should you choose to refuse to disclose your Personal Health Information (PIH). If you choose to give consent in this document, at some future time you may request to refuse all or part of your PHI. You may not revoke actions that have already been taken which relied on this or a previously signed consent.
                  style:
                    ..style.text:
                    marginTop: "0.0258"
                - type: label
                  text: If your have objections to this form, please ask to speak with out HIPPA Compliance Officer.
                  style:
                    ..style.text:
                    marginTop: "0.0258"
                - type: label
                  text: You have the right to review our privacy notice to request restrictions and revoke consent in writing after you have reviewed our privacy notice.
                  style:
                    ..style.text:
                    marginTop: "0.0258"
                - type: label
                  text: "HIPPA Notice Of Privacy Practices"
                  dataKey:
                  style:
                    ..style.secondLabel:
                    marginTop: "0.0197"
                    fontSize: .Nfont.h16
                - type: label
                  text: "Signature below is only acknowledgement that you have received this Notice of our Privacy Practices:"
                  style:
                    ..style.text:
                    marginTop: "0.0098"
                - type: label
                  text: "Name Of Recipient/Healthcare Proxy"
                  dataKey:
                  style:
                    ..style.secondLabel:
                    marginTop: "0.0197"
                - type: textField
                  placeholder: Enter here
                  dataKey: formData.recipientName
                  style:
                    ..style.blockInput:

                - type: label
                  text: "Signature"
                  dataKey:
                  style:
                    ..style.secondLabel:

                - type: view
                  style:
                    ..style.blockBox:
                  children:
                    - type: label
                      text: Click on the signature box below to finger sign
                      dataKey:
                      style:
                        ..style.signTips:
                    - type: label
                      text: Clear
                      dataKey:
                      style:
                        ..style.signClear:
                      onClick:
                        - ..event.signReset

                - type: view
                  style:
                    marginTop: "0.01"
                    height: "0.128"
                    width: "0.9"
                    border:
                      style: "4"
                      color: "0xa9a9a9"
                    borderWidth: "2"
                  children:
                    - type: label
                      text: X
                      style:
                        .SignLabelStyle:
                    - type: canvas
                      dataKey: NewPatFormEditPage2.apiRequest.newSign.docReq.name.data
                      viewTag: signatureTag
                      style:
                        left: "0"
                        width: "0.88"
                        height: "0.128"
                        overflow: scroll
                    - type: image
                      viewTag: signatureShowTag
                      path=func: .builtIn.utils.prepareDocToPath
                      dataKey: NewPatFormEditPage2.formData.temporarySignature
                      style:
                        display: ..formData.flag
                        left: "0"
                        width: "0.88"
                        top: "0"
                        height: "0.128"
                        overflow: scroll
                        zIndex: "1000"

                - type: view
                  style:
                    width: "0.92"
                    height: "auto"
                    overflow: hidden
                  children:
                    - type: view
                      style:
                        ..style.blockBox:
                        marginTop: "0.02216"
                      children:
                        - type: label
                          text: Patient Name
                          style:
                            ..style.blockBoxLeft:
                        - type: label
                          text:
                          dataKey: Global.formData.newPatientForm.name.data.patientInfo.fullName
                          style:
                            ..style.blockBoxRight:
                    - type: view
                      style:
                        ..style.blockBox:
                      children:
                        - type: label
                          text: Date
                          style:
                            ..style.blockBoxLeft:
                        - type: label
                          text=func: .builtIn.string.formatUnixtimeL_en
                          dataKey: Global.formData.newPatientForm.ctime
                          style:
                            ..style.blockBoxRight:
                - type: view
                  style:
                    marginTop: "0.03"

        - type: view
          style:
            ..style.btnBox:
          children:
            - type: button
              text: Done
              dataKey:
              style:
                ..style.btn:
              onClick:
                - ..event.publicClick
                - ..event.btnClick

    - .BaseWarningView:
      viewTag: BaseWarningView
      message: "You haven't signed the form"
  event:
    signReset:
      # 移除签名
      - actionType: removeSignature
        dataObject: BLOB
        dataKey: NewPatFormEditPage2.apiRequest.newSign.docReq.name.data
        viewTag: signatureTag
      # 重置临时签名
      - actionType: evalObject
        object:
          - ..formData.temporarySignature@: ""
          - ..formData.signatureTime@: ""
      # 显示签名区域隐藏
      - actionType: builtIn
        funcName: hide
        viewTag: signatureShowTag
      - actionType: builtIn
        funcName: show
        viewTag: signatureTag
    publicClick:
      # 签名处理
      - actionType: saveSignature
        dataObject: BLOB
        dataKey: NewPatFormEditPage2.apiRequest.newSign.docReq.name.data
        isEmpty: NewPatFormEditPage2.formData.whetherSignature
      - actionType: evalObject
        object:
          - if:
              - =..formData.whetherSignature
              - continue
              - =..apiRequest.newSign.docAPI.store: ""

      - actionType: evalObject
        object:
          - if:
              - =..formData.temporarySignature
              - actionType: evalObject
                object:
                  - .Global.formData.newPatientForm.name.data.signatureHippa.signatureTime@: =..formData.signatureTime
                  - .Global.formData.newPatientForm.name.data.signatureHippa.signatureNewPatForm@: =..formData.temporarySignature
                  - .Global.formData.newPatientForm.name.data.signatureHippa.whetherSignature@: false
                  - ..formData.whetherSignature@: false
              - actionType: evalObject
                object:
                  - .Global.formData.newPatientForm.name.data.signatureHippa.signatureTime@: =..apiRequest.newSign.docRes.doc.ctime
                  - .Global.formData.newPatientForm.name.data.signatureHippa.signatureNewPatForm@: =..apiRequest.newSign.docRes.doc.id
                  - .Global.formData.newPatientForm.name.data.signatureHippa.whetherSignature@: =..formData.whetherSignature

      - actionType: evalObject
        object:
          - .Global.formData.newPatientForm.name.data.signatureHippa.recipientName@: =..formData.recipientName

    btnClick:
      - actionType: evalObject
        object:
          - if:
              - =..formData.whetherSignature
              - actionType: popUp
                popUpView: BaseWarningView
                wait: true
                popUpDismiss: 2000
              - continue
          - ..apiRequest.patientForm.docReq@: =.Global.formData.newPatientForm
          - =.builtIn.array.add:
              dataIn:
                object: =.Global.vaccine
                value: "New Patient Forms"
          # 因函数问题需要加入formData.doc作为中转变量
          - =.builtIn.array.elementUnique:
              dataIn:
                arr: =.Global.vaccine
              dataOut: NewPatFormEditPage2.formData.doc
          - .Global.vaccine@: ""
          - .Global.vaccine@: =..formData.doc
          - =..apiRequest.patientForm.docAPI.store: ""
          - =.builtIn.array.add:
              dataIn:
                object: =.Global.roomInfo.edge.name.finishDoc
                value: "New Patient Forms"
          - .Global.formData.newPatientForm@: =..apiRequest.patientForm.docRes.doc
      - goto: =.Global.formData.selectCategory
    backClick:
      - actionType: builtIn
        funcName: goBack
        reload: true

  style: #Input style fragment here
    formatting:
      margin: "0"
      padding: "0"
      height: "1"
      width: "1"
      overflow: hidden
      boxSizing: border-box

      color: "0x333333"
      fontSize: .Nfont.h16
    bodyBox:
      width: "auto"
      height: "0.84852"
    backLeft:
      marginLeft: "0.04"
      display: "inline-block"
      verticalAlign: middle
      height: "0.055"
      boxSizing: border-box
    backLeftImg:
      marginTop: "0.012"
      height: "0.0295"
    viewBox:
      marginLeft: "0.04"
      height: "auto"
      width: "0.92"
      overflow: hidden

    titleBox:
      marginTop: "0.0270"
      paddingBottom: "1.23vh"
      width: "0.92"
      height: "auto"
      border:
        style: 2
      borderWidth: "1"
      borderColor: "#dedede"
    titlelabel:
      display: "inline-block"
      fontSize: .Nfont.h16
      color: "0x333333"
      width: "0.753125"
      height: "auto"
      fontWeight: "700"
      verticalAlign: top
      lineHeight: "2.95vh"
    pageNum:
      marginLeft: "0.064"
      display: "inline-block"
      height: "0.0221"
      width: "0.1013"
      backgroundColor: "0x2988e6"
      color: "0xffffff"
      fontSize: .Nfont.h14
      fontWeight: "700"
      borderRadius: "3"
      verticalAlign: top
      textAlign:
        x: center
    scrollBox:
      marginLeft: "0.04"
      width: "0.92"
      height: "0.7832"
      boxSizing: border-box
      overflow: scroll
    secondLabel:
      width: "0.92"
      fontSize: .Nfont.h14
      fontWeight: "700"
      color: "0x333333"
      marginTop: "0.0246"
      lineHeight: "2.58vh"
    text:
      marginTop: "0.0172"
      height: "auto"
      width: "0.92"
      fontSize: .Nfont.h14
      lineHeight: "2.58vh"
      wordWrap: break-word
      color: "#333333"
    blockInput:
      marginTop: "0.01"
      height: "0.0369"
      width: "0.92"
      boxSizing: border-box
      border:
        style: 3
      borderRadius: "3"
      borderWidth: "1.5"
      borderColor: "0xdedede"

      fontSize: .Nfont.h14
      color: "0x333333"
      textIndent: "12px"
    blockBox:
      marginTop: "0.01"
      height: "auto"
      width: "0.92"
    blockBoxLeft:
      display: "inline-block"
      width: "auto"
      height: "auto"
      color: "0x666666"
      fontSize: .Nfont.h12
      verticalAlign: middle
    blockBoxRight:
      marginLeft: "0.0373"
      display: "inline-block"
      width: "auto"
      height: "auto"
      color: "0x333333"
      fontSize: .Nfont.h14
      fontWeight: "600"
      verticalAlign: middle
    signTips:
      display: "inline-block"
      color: "#666666"
      fontSize: .Nfont.h12
      verticalAlign: middle
      width: "0.8266"
      height: "auto"
    signClear:
      display: "inline-block"
      fontSize: .Nfont.h14
      color: "#e24445"
      verticalAlign: middle
      width: "auto"
      height: "auto"
    canvasBox:
      marginTop: "0.01"
      height: "0.128"
      width: "0.9"
      border:
        style: "4"
        color: "0xa9a9a9"
      borderWidth: "2"
    btnBox:
      height: "0.0972"
      width: "1"
      backgroundColor: "0xffffff"
      boxSizing: border-box

      boxShadow: "1px 1px 4px 1px #dededf"
      overflow: hidden
      textAlign:
        x: center
    btn:
      marginTop: "0.0123"
      height: "0.0443"
      width: "0.84"
      border:
        style: 1
      borderRadius: "5"
      backgroundColor: "#2988e6"
      color: "#ffffff"
      fontSize: .Nfont.h14
      boxSizing: border-box
      fontWeight: "600"
      textAlign:
        x: center
