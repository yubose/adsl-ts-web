RelatedAppointmentDetail:
  title: Related Appointment
  init:
    - .SignInCheck
    - ..listData.get
    - ..dataObject@: =.Global.currentRleatedRoomInfo.edge
    # 将当前relation appointment赋值给Global.currentRoomInfo以便后续的invite等操作
    - .Global.currentRoomInfo@: =.Global.currentRleatedRoomInfo
    - actionType: evalObject
      object:
        - .Global.formData.tabBarShow@: "none"
        - .Global.formData.isisRelatedApp@: "true"
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =..dataObject.name.visitType
              string2: Telemedicine
        - ..formData.isTelemedicine@: none
        - ..formData.isTelemedicine@: ""
    - if:
        - =.Global.currentFacility.name.data
        - continue
        - actionType: evalObject
          object:
            - ..apiRequest.facility.documentReq.id@: =..dataObject.name.facilityId
            - =..apiRequest.facility.docAPI.get: ""
            - .Global.currentFacility@: =..apiRequest.facility.response.doc.0
    # get all E2 and display all the participants
    - ..apiRequest.appointment_E10.edgeAPI.get
    - if:
        - =..apiRequest.appointment_E10.edgeQueryResp.edge
        - actionType: evalObject
          object:
            - ..formData.participants_others@: ""
            - =.builtIn.array.keepLatestDoc:
                dataIn:
                  docList: =..apiRequest.appointment_E10.edgeQueryResp.edge
                  path: ctime
                dataOut: RelatedAppointmentDetail.apiRequest.appointment_E10.edgeQueryResp.edge
            - =.builtIn.object.extract:
                dataIn:
                  array: =..apiRequest.appointment_E10.edgeQueryResp.edge
                  field: name.role
                dataOut: RelatedAppointmentDetail.formData.roleList
        - continue
    # judge if there are provider in the room or not
    # - if:
    #     - =.builtIn.array.has:
    #         dataIn:
    #           object: =..formData.roleList
    #           value: Provider
    #     - ..formData.participants_provider@: none
    #     - continue
    - =.builtIn.object.extract:
        dataIn:
          array: =..apiRequest.appointment_E10.edgeQueryResp.edge
          field: name
        dataOut: RelatedAppointmentDetail.formData.participants
    # According to the design team, only reserve patient and provider roles in participants
    - =.builtIn.array.removeByName:
        dataIn:
          object: =..formData.participants
          key: role
          name: Location
    - =.builtIn.array.removeByName:
        dataIn:
          object: =..formData.participants
          key: role
          name: Room
    - =.builtIn.array.removeByName:
        dataIn:
          object: =..formData.participants
          key: role
          name: Facility
    # 删去重复显示的provider
    - =.builtIn.array.removeByName:
        dataIn:
          object: =..formData.participants
          key: roleName
          name: =.Global.currentRoomInfo.edge.name.providerName
    - =..apiRequest.financialInfo.docAPI.get: ""
    - if:
        - =.builtIn.utils.judgeAll:
            dataIn:
              value:
                - =.Global.roomInfo.edge.name.fee
                - =..apiRequest.financialInfo.docQueryResp.doc.0.name.data.paymentInfo.fee
              index: "0.00"
        - actionType: evalObject
          object:
            - ..formData.opacity_payStatus@: 0.6
            - ..formData.backgroundColor_status@: "#f4f4f4"
            - ..formData.pointerEvents_payStatus@: none
            - ..formData.display_payStatus@: none
        - continue
    - =..apiRequest.paymentEdge.edgeAPI.get: ""
    - if:
        - =..apiRequest.paymentEdge.edgeResp.edge.0.id
        - actionType: evalObject
          object:
            - ..apiRequest.hasPaidProfile.getDocReq.id@: =..apiRequest.paymentEdge.edgeResp.edge.0.id
            - =..apiRequest.hasPaidProfile.docAPI.get: ""
        - continue
    # 根据进来的入口决定要不要展示 enter virtual room的 button
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.MiddlePage.visitDetialbackPage
              string2: AppointmentHistory
        - ..formData.display_enterVirtalRoom@: none
        - ..formData.display_enterVirtalRoom@: "inline-block"
        # 如果是关联预约，显示原provider名字
    - if:
        - =.Global.currentRoomInfo.edge.name.mainProviderName
        # 如果关联预约的主provider和mainProvider一样，则不用显示mainProvider
        - actionType: evalObject
          object:
            - if:
                - =.builtIn.string.equal:
                    dataIn:
                      string1: =.Global.currentRoomInfo.edge.name.mainProviderName
                      string2: =.Global.currentRoomInfo.edge.name.providerName
                - ..formData.mainProviderDisplay@: none
                - ..formData.mainProviderDisplay@: block
        - ..formData.mainProviderDisplay@: none
  formData:
    # 如果是关联预约，显示原provider名字
    mainProviderDisplay: none
    display_payStatus: ""
    pointerEvents_payStatus: ""
    backgroundColor_status: "#ffffff"
    opacity_payStatus: 1
    display_enterVirtalRoom: "inline-block"
    pageName: ""
    isTelemedicine: none
    participants: []
    roleList: []
    payStatus:
      fontColor: "0x666666"
    # to control the provider of participants is display or not, display default
    participants_provider: ""
    # to control the other roles of participants is display or not, hide default
    participants_others: none
  listData:
    invitees:
      edge: ""
    get:
      .EdgeAPI.get: ""
      api: re
      dataKey: listData.invitees
      id: .Global.roomInfo.edge.id
      type: .EdgeType.InviteInfo
      xfname: refid
      maxcount: "20"
      sCondition: "tage=0"
      _nonce: .Global._nonce
  apiRequest:
    appointment:
      edgeQueryResp: ""
      edgeQueryReq:
        id: .Global.roomInfo.edge.id
        _nonce: =.Global._nonce
      edgeAPI:
        get:
          api: re
          dataIn: RelatedAppointmentDetail.apiRequest.appointment.edgeQueryReq
          dataOut: RelatedAppointmentDetail.apiRequest.appointment.edgeQueryResp
    paymentEdge:
      edgeResp: ""
      edgeIn:
        id: .Global.roomInfo.edge.id
        xfname: refid
        _nonce: .Global._nonce
        type: 1113
        obfname: mtime
        subtype: 1
      edgeAPI:
        get:
          api: re
          dataIn: RelatedAppointmentDetail.apiRequest.paymentEdge.edgeIn
          dataOut: RelatedAppointmentDetail.apiRequest.paymentEdge.edgeResp
    hasPaidProfile:
      getDocResp: ""
      getDocReq:
        id: ""
        xfname: eid
        type: 2001
        obfname: mtime
        _nonce: .Global._nonce
        maxcount: "100"
      docAPI:
        get:
          api: rd
          dataIn: RelatedAppointmentDetail.apiRequest.hasPaidProfile.getDocReq
          dataOut: RelatedAppointmentDetail.apiRequest.hasPaidProfile.getDocResp
    financialInfo:
      docQueryResp: ""
      docQueryReq:
        type: .DocType.FinancialInfo
        id: .Global.roomInfo.edge.id
        xfname: reid
        obfname: mtime
        maxcount: "1"
        _nonce: =.Global._nonce
      docAPI:
        get:
          api: rd
          dataIn: RelatedAppointmentDetail.apiRequest.financialInfo.docQueryReq
          dataOut: RelatedAppointmentDetail.apiRequest.financialInfo.docQueryResp
    facility:
      response: ""
      documentReq:
        id: ""
        xfname: ovid
        type: .DocType.FacilityProfile
        _nonce: .Global._nonce
        obfname: mtime
        maxcount: "1"
      docAPI:
        get:
          api: rd
          dataIn: RelatedAppointmentDetail.apiRequest.facility.documentReq
          dataOut: RelatedAppointmentDetail.apiRequest.facility.response
    # get the E10
    appointment_E10:
      edgeQueryResp: ""
      edgeQueryReq:
        id: .Global.currentRoomInfo.edge.id
        xfname: refid
        type: .EdgeType.InviteInfo
        sCondition: subtype!=0
        _nonce: =.Global._nonce
      edgeAPI:
        get:
          api: re
          dataIn: RelatedAppointmentDetail.apiRequest.appointment_E10.edgeQueryReq
          dataOut: RelatedAppointmentDetail.apiRequest.appointment_E10.edgeQueryResp
    newVideoMessage:
      response: ""
      document:
        eid: =.Global.currentRoom.edge.id
        reid: =.Global.roomInfo.edge.id
        subtype:
          isOnServer: 1
          isZipped: 0
          isBinary: 0
          isEncrypted: 0
          isExtraKeyNeeded: 0
          isEditable: 0
          applicationDataType: 8
          # 7 th bit
          notification: 0
          ringToneNotify: 0
          sendtoSelf: 0
          # 10 bit
          textMessage: 0
          mediaType: 8
        type: 770
        name:
          title: textMessage
          senderId: .Global.currentUser.vertex.id
          senderName: .Global.currentUser.vertex.name.userName
          data:
            text: ""
      docAPI:
        store:
          api: cd
          dataIn: apiRequest.newVideoMessage.document
          dataOut: apiRequest.newVideoMessage.response
  components:
    # - .BaseHeader:
    # - .HeaderLeftBack:
    #   onClick:
    #     - actionType: evalObject
    #       object:
    #         - .Global.formData.isisRelatedApp@: "false"
    #     - actionType: builtIn
    #       funcName: goBack
    #       reload: true
    - .BasePublicHeader:
      children:
        - .BasePublicHeaderLeft:
          leftClick:
            - actionType: evalObject
              object:
                - .Global.formData.isisRelatedApp@: "false"
            - actionType: builtIn
              funcName: goBack
              reload: true
        - .BasePublicHeaderTitle:
    - type: scrollView
      style:
        width: "1"
        height: "0.94"
      children:
        - type: view
          style:
            height: "0.05"
            backgroundColor: "#f0f0f0"
            width: "1"
          children:
            - type: label
              text: Appointment  Info
              style:
                display: "inline-block"
                marginLeft: "0.05"
                color: "0x666666"
                height: "0.05"
                width: "0.48533333"
                lineHeight: 5vh

                fontSize: .Nfont.h14
                fontWeight: "600"
                textAlign:
                  x: left
        - type: view
          style:
            height: "auto"
            width: "0.9"
            marginLeft: "0.05"
            color: "#333333"
          children:
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: Provider Name
                - .PresLabelRight:
                  dataKey: dataObject.name.providerName
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: Visit Type
                - .PresLabelRight:
                  dataKey: dataObject.name.visitType
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: "Reason for Visit"
                - .PresLabelRight:
                  dataKey: dataObject.name.Reason
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: "Date"
                - .PresLabelRight:
                  text=func: .builtIn.string.formatUnixtimeL_en
                  dataKey: dataObject.stime
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: "Time"
                - .PresLabelRight:
                  text=func: .builtIn.date.ShowTimeSpan
                  dataKey: dataObject
            - .PresListView:
              viewTag: locationAndAddress
              style:
                display: ..formData.isTelemedicine
              children:
                - .PresLabelLeft:
                  text: "Location"
                - .PresLabelRight:
                  dataKey: dataObject.name.locationName
            - .PresListView:
              viewTag: locationAndAddress
              style:
                display: ..formData.isTelemedicine
              children:
                - .PresLabelLeft:
                  text: "Address"
            - .PresListView:
              viewTag: locationAndAddress
              style:
                display: ..formData.isTelemedicine
              children:
                - .PresLabelLeft:
                  dataKey: dataObject.name.location
                  style:
                    width: "0.9"
                    fontWeight: "normal"
                    wordBreak: break-word
            - .PresListView:
              viewTag: tag_payStatus
              style:
                display: ..formData.display_payStatus
              children:
                - .PresLabelLeft:
                  text: "Payment Status"
                - .PresLabelRight:
                  text: ""
                  dataKey: apiRequest.hasPaidProfile.getDocResp.doc.0
                  text=func: .builtIn.object.transformStatus
                  style:
                    color: ..formData.payStatus.fontColor
        - type: view
          style:
            marginTop: "0.015"
            height: "0.05"
            backgroundColor: "0xf0f0f0"
            width: "1"
          children:
            - type: label
              text: Medical Info
              style:
                display: "inline-block"
                marginLeft: "0.05"
                color: "0x666666"
                height: "0.05"
                width: "0.48533333"
                lineHeight: 5vh

                fontSize: .Nfont.h14
                fontWeight: "600"
                textAlign:
                  x: left
        - type: view
          style:
            height: "auto"
            width: "1"
          children:
            - type: view
              style:
                marginTop: "0.02"
                width: "1"
                height: "0.16"
              children:
                - type: view
                  # onClick:
                  # - actionType: evalObject
                  #   object:
                  #     - .Global.formData.isRelatedApp@: true
                  # - goto: RequiredForms
                  style:
                    pointerEvents: "none"
                    opacity: ..formData.opacity_payStatus
                    backgroundColor: "#f4f4f4"
                    display: "inline-block"
                    width: "0.28"
                    height: "0.14"
                    marginLeft: "0.05"
                    border:
                      style: 3
                    borderWidth: "1"
                    borderRadius: "10"
                    borderColor: "0xdededf"
                    box-sizing: border-box
                    boxShadow: "0px 0px 6px 0.5px #DEDEDF"
                    textAlign:
                      x: center
                  children:
                    - type: image
                      path: profile.svg
                      style:
                        marginTop: "0.01"
                        height: "0.06"
                    - type: label
                      text: Required Forms
                      style:
                        marginTop: "0.01"
                        height: "auto"
                        width: "0.28"

                        fontSize: .Nfont.h12
                        fontWeight: "600"
                        color: "#333333"
                        textAlign:
                          x: center
                - type: view
                  style:
                    marginLeft: "0.03"
                    display: "inline-block"
                    width: "0.28"
                    height: "0.14"
                    pointerEvents: "none"
                    opacity: ..formData.opacity_payStatus
                    backgroundColor: "#f4f4f4"
                    border:
                      style: 3
                    borderWidth: "1"
                    borderRadius: "10"
                    borderColor: "0xdededf"
                    box-sizing: border-box
                    boxShadow: "0px 0px 6px 0.5px #DEDEDF"
                    textAlign:
                      x: center
                  children:
                    - type: image
                      path: remoteHealth0.svg
                      style:
                        marginTop: "0.01"
                        height: "0.06"
                    - type: label
                      text: Vital Signs
                      style:
                        marginTop: "0.01"
                        height: "auto"
                        width: "0.28"

                        fontSize: .Nfont.h12
                        color: "#333333"
                        fontWeight: "600"
                        textAlign:
                          x: center
                - type: view
                  onClick:
                    - actionType: evalObject
                      object:
                        - .Global.flag.isMeetingPatientchart@: true
                    - goto: PatientChart
                  style:
                    marginLeft: "0.03"
                    display: "inline-block"
                    width: "0.28"
                    height: "0.14"
                    backgroundColor: "#ffffff"
                    border:
                      style: 3
                    borderWidth: "1"
                    borderRadius: "10"
                    borderColor: "0xdededf"
                    box-sizing: border-box
                    boxShadow: "0px 0px 6px 0.5px #DEDEDF"
                    textAlign:
                      x: center
                  children:
                    - type: image
                      path: patientchart.svg
                      style:
                        marginTop: "0.01"
                        height: "0.06"
                    - type: label
                      text: Patient Chart
                      style:
                        marginTop: "0.01"
                        height: "auto"
                        width: "0.28"

                        fontSize: .Nfont.h12
                        color: "#333333"
                        fontWeight: "600"
                        textAlign:
                          x: center

            - type: view
              style:
                width: "auto"
                height: "0.12"
              children:
                - type: view
                  onClick:
                    - actionType: evalObject
                      object:
                        - .Global.formData.isRelatedApp@: true
                    - goto: MedicalDocuments
                  style:
                    width: "0.59"
                    height: "0.1"
                    marginLeft: "0.05"
                    backgroundColor: "#ffffff"
                    border:
                      style: 3
                    borderWidth: "1"
                    borderRadius: "10"
                    borderColor: "0xdededf"
                    box-sizing: border-box
                    boxShadow: "0px 0px 6px 0.5px #DEDEDF"
                    display: "inline-block"
                  children:
                    - type: image
                      path: medical.records.svg
                      style:
                        height: "0.06"
                        marginTop: "0.02"
                        marginLeft: "0.042"
                    - type: view
                      style:
                        width: "0.37"
                        height: "0.06"
                        marginTop: "0.03"
                        marginLeft: "0.0246"
                        display: "inline-block"
                      children:
                        - type: label
                          text: "Medical Documents"
                          dataKey:
                          style:
                            fontSize: .Nfont.h12
                            fontWeight: "600"
                            color: "#333333"
                        - type: label
                          text: view all documents here
                          dataKey:
                          style:
                            fontSize: .Nfont.h12
                            fontWeight: "400"
                            color: "#666666"
                            marginTop: "0.005"

                - type: view
                  viewTag: tag_receipt
                  style:
                    marginLeft: "0.03"
                    width: "0.28"
                    height: "0.1"
                    backgroundColor: "#f4f4f4"
                    pointerEvents: "none"
                    opacity: ..formData.opacity_payStatus
                    border:
                      style: 3
                    borderWidth: "1"
                    borderRadius: "10"
                    borderColor: "0xdededf"
                    box-sizing: border-box
                    boxShadow: "0px 0px 6px 0.5px #DEDEDF"
                    display: "inline-block"
                    textAlign:
                      x: "center"
                  children:
                    - type: image
                      path: paymentYellow.svg
                      style:
                        marginTop: "0.01"
                        height: "0.045"
                    - type: label
                      text: "Receipt"
                      style:
                        height: "auto"
                        width: "0.28"

                        fontSize: .Nfont.h12
                        fontWeight: "600"
                        color: "#333333"
                        textAlign:
                          x: "center"
            # - type: view
            #   onClick:
            #     - goto: MedicalDocuments
            #   style:
            #     marginTop: "0.02"
            #     width: "0.9"
            #     height: "0.14"
            #     backgroundColor: "#ffffff"
            #     border:
            #       style: 3
            #     borderWidth: "1"
            #     borderRadius: "10"
            #     borderColor: "0xdededf"
            #     box-sizing: border-box
            #     boxShadow: "0px 0px 6px 0.5px #DEDEDF"
            #   children:
            #     - type: view
            #       style:
            #         marginLeft: "0.03"
            #         display: "inline-block"
            #         height: "0.14"
            #         width: "0.3"
            #         textAlign:
            #           x: center
            #       children:
            #         - type: image
            #           path: medical.records.svg
            #           style:
            #             marginTop: "0.03"
            #             height: "0.07"
            #     - type: view
            #       style:
            #         display: "inline-block"
            #         height: "0.14"
            #         width: "0.5"
            #       children:
            #         - type: label
            #           text: Medical Documents
            #           style:
            #             marginTop: "0.035"
            #             height: "auto"
            #             width: "0.5"
            #
            #             fontSize: .Nfont.h2
            #             color: "#333333"
            #         - type: label
            #           text: view all documents here
            #           style:
            #             marginTop: "0.01"
            #             height: "auto"
            #             width: "0.5"
            #
            #             fontSize: .Nfont.h12
            #             color: "#333333"
        - type: view
          style:
            marginTop: "0.01"
            height: "0.05"
            backgroundColor: "#f0f0f0"
            width: "1"
          children:
            - type: label
              text: Participants
              style:
                display: "inline-block"
                marginLeft: "0.05"
                color: "0x666666"
                height: "0.05"
                width: "0.72266"
                lineHeight: 5vh

                fontSize: .Nfont.h14
                fontWeight: "600"
                textAlign:
                  x: left
            - type: label
              text: + Invite
              dataKey:
              onClick:
                - actionType: evalObject
                  object:
                    - .Global.formData.pageName@: "AppointmentLobby"
                - goto: ChooseInvite
              style:
                display: "inline-block"
                marginLeft: "0.05"
                height: "0.05"
                width: "auto"
                lineHeight: 5vh

                fontSize: .Nfont.h14
                textDecoration: underline
                fontWeight: "400"
                color: "#2988e6"
                textAlign:
                  x: left
        - type: view
          style:
            marginTop: "0.02"
            height: "auto"
            width: "0.9"
            marginLeft: "0.05"
            color: "#333333"
          children:
            - .PresListView:
              style:
                display: ..formData.participants_provider
              children:
                - .PresLabelLeft:
                  text: Provider
                - .PresLabelRight:
                  dataKey: dataObject.name.providerName
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: Patient
                - .PresLabelRight:
                  dataKey: dataObject.name.patientName
            - .PresListView:
              style:
                display: ..formData.mainProviderDisplay
              children:
                - .PresLabelLeft:
                  text: Provider
                - .PresLabelRight:
                  dataKey: Global.currentRoomInfo.edge.name.mainProviderName
            - type: list
              contentType: listObject
              listObject: ..formData.participants
              iteratorVar: itemObject
              style:
                display: ..formData.participants_others
                width: "0.9"
                margin: "0"
                marginTop: "0"
                height: "auto"
              children:
                - type: listItem
                  itemObject: ""
                  style:
                    width: "0.9"
                    height: "auto"
                    left: "0"
                    marginTop: "0.01"
                    overflow: hidden
                  children:
                    - .PresLabelLeft:
                      dataKey: itemObject.role
                    - .PresLabelRight:
                      dataKey: itemObject.roleName
