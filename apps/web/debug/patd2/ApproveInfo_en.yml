ApproveInfo:
  title: "Appointment Detail"
  init:
    - .SignInCheck
    - ..visitQuestionnaire.docAPI.get
    - ..formData@: =.Global.appoinment.request
    - actionType: evalObject
      object:
        - =.builtIn.array.getListLength:
            dataIn:
              object: =..formData.name.document
            dataOut: ApproveInfo.localDocuLength
    - actionType: evalObject
      object:
        - =.builtIn.array.getListLength:
            dataIn:
              object: =.Global.vaccine
            dataOut: ApproveInfo.globalDocuLength
        - .Global.formData.selectCategory@: ApproveInfo
    - =.builtIn.string.equal:
        dataIn:
          string1: =..localDocuLength
          string2: =..globalDocuLength
        dataOut: ApproveInfo.otherFormRead
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =..localDocuLength
              string2: "0"
        - continue
        - =.builtIn.checkField:
            dataIn:
              contentType: messageHidden
              wait: 100
    - actionType: evalObject
      object:
        - .ApproveInfo.visitQuestionnaireObject.document@: =..docResponse.doc.0
    - =.builtIn.array.transformArray:
        dataIn:
          array: =..formData.name.document
        dataOut: ApproveInfo.formData.name.document
    - =.builtIn.array.transformPage:
        dataIn:
          array: =..formData.name.document
          type: "Edit"
          dataKey: "key"
        dataOut: ApproveInfo.formData1.docList
    - =.builtIn.string.concat:
        dataIn:
          - =..formData.name.duration
          - " min"
        dataOut: ApproveInfo.formData.duration
  inviteInfo:
    edge:
      .Edge: ""
      type: .EdgeType.InviteInfo
      refid: ""
      bvid: .Global.currentUser.vertex.id
      evid: .Global.appoinment.request.bvid
      name:
        phoneNumber: ""
        firstName: ""
        lastName: ""
        name: ""
        hostName: .Global.currentUser.vertex.name.userName
        roomName: ""
        date: ""
    response: ""
    edgeAPI:
      store:
        api: ce
        dataKey: inviteInfo.edge
        dataOut: inviteInfo.response
  flag: "true" # to judge whether the PatientChart and VisitQuestionnaire have been both filled in.
  formData:
    duration: ""
    docList: [] # List 打印的表格
    formList: [] # 用于接收对于doc 列表的转化数据
    cov19Test: ""
    vaccineNum: 0
    vaccineDocNum: 0
    pifzerBioNTech: ""
    moderna: ""
    gotoPage: ""
    NewPatFormEditPage1: ""
    newPatientForm: ""
    pifzerVaccineFirDoseForm: ""
    pifzerVaccineSecDoseForm: ""
    cov19TestNewPatForm: ""
    cov19TestForm: ""
    modernaVaccineFirDoseForm: ""
    modernaVaccineSecDoseForm: ""
  formData1:
    docList: ""
    vaccineNum: 0
    vaccineDocNum: 0
    pifzerBioNTech: ""
    cov19Test: ""
    moderna: ""
  localDocuLength: ""
  globalDocuLength: ""
  otherFormRead: ""
  otherForm: []
  otherFormHid: "true"
  approveRequest:
    edge:
      .Edge: ""
      id: ""
      subtype: 5
      type: 40000
      bvid: .Global.currentUser.vertex.id
      evid: .Global.formData.request.bvid
      refid: ..formData.id
      name:
        roomName: ..formData.name.visitReason
        setting:
          timeSlotBackColor: ..formData.name.blockColor
          timeSlotColor: ..formData.name.fontColor
          patientName: ..formData.name.patientName
          visitReason: ..formData.name.visitReason
          visitType: ..formData.name.visitType
          Reason: ..formData.name.Reason
    # will check the response error code to see if the approve succeed
    response: ""
    edgeAPI:
      .EdgeAPI: ""
      store:
        api: ce
        dataKey: approveRequest.edge
        dataOut: approveRequest.response
  newAppointment:
    response: ""
    edge:
      .Edge: ""
      evid: .Global.formData.request.bvid
      bvid: .Global.currentUser.vertex.id
      id: ""
      refid: "" #the_selected_time_slot_edge.id
      subtype: 2
      type: 40000
      name:
        patientName: .Global.currentUser.vertex.name.userName
        providerName: .Global.formData.request.name.providerName
        visitType: ""
        visitTypeShow: ""
        visitReason: ""
        Reason: "Cold"
        blockColor: ""
        fontColor: ""
        date: ""
        # document
    edgeAPI:
      store:
        api: ce
        dataIn: ApproveInfo.newAppointment.edge
        dataOut: ApproveInfo.newAppointment.response
  data:
    purpose: ""
    anythingElse: ""
    isPrescribed: ""
    isProblems: ""
    problems: ""
    isToEmergency: ""
    toEmergency: ""
    isFamilyHistoryChanges: ""
    familyHistoryChanges: ""
    isNewDrug: ""
    newDrug: ""
    notes: ""
  visitQuestionnaireObject:
    document:
      type: .DocType.VisitQuestionnaire
      eid: .Global.rootNotebookID
      name:
        type: "application/json"
        data:
          purpose: ""
          anythingElse: ""
          isPrescribed: ""
          isProblems: ""
          problems: ""
          isToEmergency: ""
          toEmergency: ""
          isFamilyHistoryChanges: ""
          familyHistoryChanges: ""
          isNewDrug: ""
          newDrug: ""
          notes: ""
    docAPI:
      .DocAPI: ""
      store:
        api: cd
        dataKey: visitQuestionnaireObject.document
        subtype:
          mediaType: "application/json"
  visitQuestionnaire:
    # document:
    docAPI:
      .DocAPI: ""
      get:
        dataKey: docResponse
        id: .Global.rootNotebookID
        xfname: "eid"
        type: .DocType.VisitQuestionnaire
        _nonce: =.Global._nonce
  # subvisitQuestionnaire:
  docResponse:
    doc:
      - type: .DocType.VisitQuestionnaire # - type: "257" # private profile
        eid: .Global.rootNotebookID
        name: ""
    error: ""
    jwt: ""
  save:
    - =.ApproveInfo.approveRequest.edgeAPI.store: ""
  components:
    - .ProgressCheckView: ""
      message: "loading ..."
      viewTag: uploading
    - type: view
      style:
        width: "1"
        height: "0.5"
        left: "0"
        backgroundColor: "0x2988e6"
        top: "0"
      children:
        - .BaseHeader:
        - .CA1label:
          text: "Date & Time selected:"
          style:
            top: "0.1"
            width: "0.485"
            height: "0.035"
            border:
              style: "2"
            borderWidth: "2"
            borderColor: "0xffffff99"
        - .CA1label:
          dataKey: formData.stime
          text=func: .builtIn.string.formatUnixtime_en
          style:
            fontSize: "17"
            top: "0.15"
            fontWeight: "550"
        - .CA1label:
          text: "Type"
          style:
            top: "0.2"
            width: "0.38"
            height: "0.035"
            border:
              style: "2"
            borderWidth: "2"
            borderColor: "0xffffff99"
        - .CA1label:
          dataKey: formData.name.visitType
          style:
            top: "0.24"
            fontSize: "15"
        - .CA1label:
          text: "Duration"
          style:
            top: "0.2"
            left: "0.58"
            width: "0.18"
            height: "0.035"
            border:
              style: "2"
            borderWidth: "2"
            borderColor: "0xffffff99"
        - .CA1label:
          text: "15 min"
          dataKey: formData.duration
          style:
            top: "0.24"
            fontSize: "15"
            left: "0.6"
        - .CA1label:
          text: "Reason for Visit"
          style:
            top: "0.29"
            width: "0.38"
            height: "0.035"
            border:
              style: "2"
            borderWidth: "2"
            borderColor: "0xffffff99"
        - .CA1label:
          dataKey: formData.name.Reason
          style:
            top: "0.33"
            fontSize: "15"
        - .CA1label:
          text: Provider
          style:
            top: "0.29"
            width: "0.38"
            left: "0.58"
            height: "0.035"
            border:
              style: "2"
            borderWidth: "2"
            borderColor: "0xffffff99"
        - .CA1label:
          dataKey: formData.name.providerName
          style:
            top: "0.33"
            fontSize: "15"
            left: "0.6"
        - type: button
          text: "Change details"
          onClick:
            - actionType: builtIn
              funcName: goBack
          style:
            width: "0.5"
            height: "0.05"
            top: "0.4"
            left: "0.25"
            borderRadius: "50"
            color: "0xff0000"
            backgroundColor: "0xffffff"
            border:
              style: "3"
              width: "1"
              color: "0xff0000"
            borderColor: "0xff0000"
            fontSize: "18"

            textAlign:
              x: center
    - type: scrollView
      style:
        top: "0.5"
        height: "0.42"
        width: "1"
        left: "0"
      children:
        - type: view
          style:
            marginTop: "0"
            width: "1"
            left: "0"
            height: "auto"
          children:
            - type: label
              text: Please complete visit questionnaire
              style:
                left: "0.1"
                marginTop: "0.04"
                height: "auto"
                width: "0.9"
                color: "0x2988e6"
                fontSize: "18"
            - type: view
              onClick:
                - goto: VisitQuestionnaire
              style:
                left: "0"
                width: "1"
                marginTop: "0.01"
                height: "0.04"
              children:
                - type: image
                  path:
                    emit:
                      actions:
                        - if:
                            - =.Global.visitQuestionnaireDoc
                            - selectBlueOn.svg
                            - selectOff.svg
                  style:
                    left: "0.1"
                    top: "0"
                    width: "0.055"
                - type: label
                  text: Visit Questionnaire
                  style:
                    left: "0.2"
                    top: "0"
                    width: "0.8"
                    height: "0.035"
                    fontSize: "16"
                    color: "0x2988e6"
                    textAlign:
                      y: center
            - type: list
              contentType: listObject
              listObject: ..formData1.docList
              iteratorVar: itemObject
              style:
                margin: "0"
                marginTop: "0.01"
                left: "0"
                width: "1"
                height: "auto"
              children:
                - type: listItem
                  itemObject: ""
                  style:
                    left: "0"
                    marginTop: "0"
                    width: "1"
                    height: "0.05"
                  children:
                    - type: image
                      path:
                        emit:
                          dataKey:
                            var: itemObject
                          actions:
                            - if:
                                - =.builtIn.array.has:
                                    dataIn:
                                      object: =.Global.vaccine
                                      value: $var.key
                                - selectBlueOn.svg
                                - selectOff.svg
                      style:
                        left: "0.1"
                        top: "0"
                        width: "0.055"
                    - type: label
                      dataKey: itemObject.key
                      onClick:
                        emit:
                          dataKey:
                            var: itemObject
                          actions:
                            - if:
                                - true
                                - goto: $var.pageName
                                - goto: $var.pageName

                      style:
                        top: "0"
                        color: "0x2988e6"
                        fontSize: "16"
                        width: "0.8"
                        left: "0.2"
                        height: "0.035"
                        textAlign:
                          x: left
                          y: center
        - type: view
          style:
            marginTop: "0"
            width: "1"
            left: "0"
            height: "auto"
          children:
            - type: label
              text: Optional Forms
              style:
                left: "0.1"
                top: "0"
                height: "0.06"
                width: "0.9"
                color: "0x2988e6"
                fontSize: "18"
            - type: view
              onClick:
                - goto: PatientChart
              style:
                left: "0"
                width: "1"
                top: "0.045"
                height: "0.035"
              children:
                - type: image
                  path:
                    emit:
                      actions:
                        - if:
                            - =.Global.formData.patientDoc.status.sharePatientChart
                            - selectBlueOn.svg
                            - selectOff.svg
                  style:
                    left: "0.1"
                    top: "0"
                    width: "0.055"
                - type: label
                  text: Patient Chart
                  style:
                    left: "0.2"
                    top: "0"
                    width: "0.4"
                    height: "0.035"
                    fontSize: "16"
                    color: "0x2988e6"
    - type: button
      text: "Approve"
      onClick:
        - actionType: popUp
          popUpView: uploading
        - actionType: evalObject
          object:
            - =.builtIn.array.getListLength:
                dataIn:
                  object: =..formData.name.document
                dataOut: ApproveInfo.formData1.vaccineNum
            - =.builtIn.array.getListLength:
                dataIn:
                  object: =.Global.vaccine
                dataOut: ApproveInfo.formData1.vaccineDocNum
        - actionType: evalObject
          object:
            - if:
                - =.builtIn.string.equal:
                    dataIn:
                      string1: =..formData1.vaccineNum
                      string2: =..formData1.vaccineDocNum
                - continue
                - actionType: popUpDismiss
                  popUpView: uploading
            - if:
                - =.Global.visitQuestionnaireDoc
                - continue
                - actionType: popUpDismiss
                  popUpView: uploading
            - if:
                - =.Global.visitQuestionnaireDoc
                - continue
                - actionType: popUpDismiss
                  popUpView: uploading
        - actionType: evalObject
          object:
            - if:
                - =.builtIn.string.equal:
                    dataIn:
                      string1: =..formData1.vaccineNum
                      string2: =..formData1.vaccineDocNum
                - continue
                - actionType: popUp
                  popUpView: judgeOtherForm
                  wait: true
        - actionType: evalObject
          object:
            - if:
                - =.Global.visitQuestionnaireDoc
                - continue
                - actionType: popUp
                  popUpView: judgeVisitQuestionnaire
                  wait: true

            - if:
                - =.Global.visitQuestionnaireDoc
                - continue
                - actionType: popUp
                  popUpView: judgeVisitQuestionnaire
                  wait: true
            - if:
                - =.Global.visitQuestionnaireDoc
                - actionType: evalObject
                  #we can send notification after this api
                  object:
                    - ..save
                    - if:
                        -
                        -
                - continue
            - if:
                - =.Global.visitQuestionnaireDoc
                - =.builtIn.ecos.shareDoc:
                    dataIn:
                      sourceDoc: =.Global.formData.visitQuestionnaireDoc.doc
                      targetEdgeID: =..formData.id
                - continue
            - if:
                - =.Global.formData.patientDoc.status.sharePatientChart
                - =.builtIn.ecos.shareDoc:
                    dataIn:
                      sourceDoc: =.PatientChart.PatientChartObject
                      targetEdgeID: =..formData.id
                - continue
        # shareDoc newPatientForm文档
        - actionType: evalObject
          object:
            - if:
                - =.Global.formData.newPatientForm.id
                - =.builtIn.ecos.shareDoc:
                    dataIn:
                      sourceDoc: =.Global.formData.newPatientForm
                      targetEdgeID: =..formData.id
                      targetRoomName: "meetingRoom"
                    dataOut: ApproveInfo.formData.newPatientForm
                - continue
            # shareDoc pifzerVaccineFirDoseForm文档
            - if:
                - =.Global.formData.pifzerVaccineFirDoseForm.id
                - =.builtIn.ecos.shareDoc:
                    dataIn:
                      sourceDoc: =.Global.formData.pifzerVaccineFirDoseForm
                      targetEdgeID: =..formData.id
                      targetRoomName: "meetingRoom"
                    dataOut: ApproveInfo.formData.pifzerVaccineFirDoseForm
                - continue
            # pifzerVaccineSecDoseForm
            - if:
                - =.Global.formData.pifzerVaccineSecDoseForm.id
                - =.builtIn.ecos.shareDoc:
                    dataIn:
                      sourceDoc: =.Global.formData.pifzerVaccineSecDoseForm
                      targetEdgeID: =..formData.id
                      targetRoomName: "meetingRoom"
                    dataOut: ApproveInfo.formData.pifzerVaccineSecDoseForm
                - continue
        - actionType: evalObject
          object:
            - if:
                - =.Global.formData.cov19TestNewPatForm.id
                - =.builtIn.ecos.shareDoc:
                    dataIn:
                      sourceDoc: =.Global.formData.cov19TestNewPatForm
                      targetEdgeID: =..formData.id
                      targetRoomName: "meetingRoom"
                    dataOut: ApproveInfo.formData.cov19TestNewPatForm
                - continue
            - if:
                - =.Global.formData.cov19TestForm.id
                - =.builtIn.ecos.shareDoc:
                    dataIn:
                      sourceDoc: =.Global.formData.cov19TestForm
                      targetEdgeID: =..formData.id
                      targetRoomName: "meetingRoom"
                    dataOut: ApproveInfo.formData.cov19TestForm
                - continue
            - if:
                - =.Global.formData.modernaVaccineFirDoseForm.id
                - =.builtIn.ecos.shareDoc:
                    dataIn:
                      sourceDoc: =.Global.formData.modernaVaccineFirDoseForm
                      targetEdgeID: =..formData.id
                      targetRoomName: "meetingRoom"
                    dataOut: ApproveInfo.formData.modernaVaccineFirDoseForm
                - continue
            - if:
                - =.Global.formData.modernaVaccineSecDoseForm.id
                - =.builtIn.ecos.shareDoc:
                    dataIn:
                      sourceDoc: =.Global.formData.modernaVaccineSecDoseForm
                      targetEdgeID: =..formData.id
                      targetRoomName: "meetingRoom"
                    dataOut: ApproveInfo.formData.modernaVaccineSecDoseForm
                - continue
            - =.builtIn.ecos.shareDoc:
                dataIn:
                  sourceDoc: =.Global.Profile
                  targetEdgeID: =..formData.id
        - actionType: evalObject
          object:
            - if:
                - =.Global.visitQuestionnaireDoc
                - actionType: evalObject
                  object:
                    - ..visitQuestionnaireObject.document.name.data@: =..data
                    - =.ApproveInfo.visitQuestionnaireObject.docAPI.store: ""
                - continue
        - actionType: popUpDismiss
          popUpView: uploading
        - actionType: popUp
          popUpView: createSuccessView
      style:
        width: "0.7"
        left: "0.15"
        height: "0.05"
        top: "0.92"
        fontSize: "18"
        color: "0xffffff"
        backgroundColor: "0x2988e6"
        borderRadius: "3"

        textAlign:
          x: center
    - .BaseCheckView: ""
      message: "You have not filled in the Patient Chart"
      viewTag: judgePatientChart
      colorChange: "0x2988e6"
      imgPath: aboutBlue.svg
      children:
        - type: view
          style:
            width: "0.8"
            height: "0.3"
            top: "0.3"
            left: "0.1"
            zIndex: "100"
            backgroundColor: "0xffffff"
            borderRadius: "7"
            border:
              style: "3"
            borderColor: "#f4f8fa"
            borderWidth: "3"
          children:
            - .BaseCheckViewImg:
            - .BaseCheckViewLabel:
            - .BaseCheckViewButton:
              onClick:
                - actionType: popUpDismiss
                  popUpView: ____.viewTag
    - .TipsMultiLine:
      viewTag: judgeVisitQuestionnaire
      message: "You have not filled in the Visit Questionnaire"
    # - .BaseCheckView: ""
    #   message: "You have not filled in the Visit Questionnaire"
    #   viewTag: judgeVisitQuestionnaire
    #   colorChange: "0x2988e6"
    #   imgPath: aboutBlue.svg
    #   children:
    #     - type: view
    #       style:
    #         width: "0.8"
    #         height: "0.3"
    #         top: "0.3"
    #         left: "0.1"
    #         zIndex: "100"
    #         backgroundColor: "0xffffff"
    #         borderRadius: "7"
    #         border:
    #           style: "3"
    #         borderColor: '#f4f8fa'
    #         borderWidth: "3"
    #       children:
    #         - .BaseCheckViewImg:
    #         - .BaseCheckViewLabel:
    #         - .BaseCheckViewButton:
    #           onClick:
    #             - actionType: popUpDismiss
    #               popUpView: ____.viewTag
    - .BaseCheckView: ""
      message: "You have not filled in the other forms"
      viewTag: judgeOtherForm
      colorChange: "0x2988e6"
      imgPath: aboutBlue.svg
      children:
        - type: view
          style:
            width: "0.8"
            height: "0.3"
            top: "0.3"
            left: "0.1"
            zIndex: "100"
            backgroundColor: "0xffffff"
            borderRadius: "7"
            border:
              style: "3"
            borderColor: "#f4f8fa"
            borderWidth: "3"
          children:
            - .BaseCheckViewImg:
            - .BaseCheckViewLabel:
            - .BaseCheckViewButton:
              onClick:
                - actionType: popUpDismiss
                  popUpView: ____.viewTag
    - type: popUp
      viewTag: createSuccessView
      style:
        top: "0"
        left: "0"
        width: "1"
        height: "1"
      children:
        - type: view
          style:
            width: "0.88"
            height: "0.3"
            top: "0.3"
            left: "0.06"
            borderRadius: "20"
            zIndex: "100"
            backgroundColor: "0xeaeaea"
          children:
            - type: label
              text: You have created an appointment successfully
              style:
                .LabelStyle:
                  left: "0"
                  top: "0.08"
                  width: "0.8333"
                  height: "0.05"
                  color: "0x000000"
                  fontSize: "19"
                  display: inline

                  textAlign:
                    x: center
                    y: center
            - type: button
              text: ok
              style:
                width: "0.6"
                left: "0.14"
                height: "0.05"
                top: "0.2"
                fontSize: "20"
                color: "0x000000"
                textAlign:
                  x: center
                border:
                  style: "1"
                  color: "0x000000"
              onClick:
                - goto: WaitingRoom
