MedicalDocuments:
  title: "Medical Documents"
  pageNumber: ""
  init:
    # 登录校验
    - .SignInCheck
    # 清空  Global.DocReference
    - actionType: updateObject
      dataKey: Global.DocReference.document
      dataObject: .EmptyObj

    - actionType: updateObject
      dataKey: Global.formData.providerDoc.diagnosesDoc
      dataObject: .EmptyObj

    - actionType: updateObject
      dataKey: Global.DocReference.Note
      dataObject: .EmptyObj

    # 刷新数据
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    # put time delay to fix get is fast than create problem
    - actionType: evalObject
      object:
        - =.builtIn.utils.setTimer:
            dataIn:
              timeUnix: =.Global.timeDelay
    #这个地方值的来源可能有多个，related， root room
    - .Global.currentRoomInfo@: =.Global.roomInfo
    - if:
        - =.Global.formData.isRelatedApp
        - actionType: evalObject
          object:
            - .Global.formData.tabBarShow@: block
            - ..apiRequest.medicalDocuments.docQueryReq.id@: =.Global.currentRleatedRoomInfo.edge.id
        - ..apiRequest.medicalDocuments.docQueryReq.id@: =.Global.currentRoomInfo.edge.id

    - actionType: evalObject
      object:
        - actionType: evalObject
          async: true
          object:
            - =..apiRequest.medicalDocuments.docAPI.get: ""
            - =..apiRequest.medicalDocumentHistory.docAPI.get: ""
            - =..apiRequest.diagnosesDoc.docAPI.get: ""

    # 如果点击history 获取的是当前预约所有的 related 预约下面的文档， 所以我从global下把当前所有的related 预约的id拿过来
    - actionType: evalObject
      object:
        - ..formData.relatedAppList@: =.Global.currentRoomrelatedAppointment

    # init the doc list
    - ..formData.docList@: =..apiRequest.medicalDocuments.docQueryResp.doc

    - =.builtIn.array.setFormJumpPage:
        dataIn:
          objArry: =..formData.docList
          docFormObj: =.DocumentList
        dataOut: MedicalDocuments.formData.docJumpList

    # history list
    - =.builtIn.array.setFormJumpPage:
        dataIn:
          objArry: =..apiRequest.medicalDocumentHistory.docQueryResp.doc
          docFormObj: =.DocumentList
        dataOut: MedicalDocuments.formData.docJumpHistoryList

    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.formData.tabBarShow
              string2: "block"
        - ..formData.listHeight@: "0.822660"
        - ..formData.listHeight@: "0.8756157"
    - if:
        - =.builtIn.array.judgeListLength:
            dataIn:
              array: =..apiRequest.diagnosesDoc.docResp.doc
              len: 0
        - continue
        - .Global.formData.providerDoc.diagnosesDoc@: =..apiRequest.diagnosesDoc.docResp.doc.0
  apiRequest:
    medicalDocuments:
      docQueryResp: ""
      docQueryReq:
        id: .Global.currentRoomInfo.edge.id
        xfname: reid
        # patient profile need not display in the list and ignore the private document form provider
        sCondition: .DocumentQuery.PatientAllMeetingDocuments
        _nonce: =.Global._nonce
        obfname: ctime
        asc: false
        maxcount: "100"
      docAPI:
        get:
          api: rd
          dataIn: MedicalDocuments.apiRequest.medicalDocuments.docQueryReq
          dataOut: MedicalDocuments.apiRequest.medicalDocuments.docQueryResp
    medicalDocumentHistory:
      docQueryResp: ""
      docQueryReq:
        id: =..formData.relatedAppList
        xfname: Reid
        # patient profile need not display in the list
        sCondition: .DocumentQuery.ProviderAllMeetingDocuments
        obfname: ctime
        asc: false
        _nonce: =.Global._nonce
        maxcount: "100"
      docAPI:
        get:
          api: rd
          dataIn: apiRequest.medicalDocumentHistory.docQueryReq
          dataOut: MedicalDocuments.apiRequest.medicalDocumentHistory.docQueryResp
    diagnosesDoc:
      docResp: ""
      docReq:
        id:
          - =.Global.roomInfo.edge.id
        xfname: "reid"
        type: .DocType.Diagnoses
        obfname: "mtime"
        maxcount: "1"
        _nonce: .Global._nonce
      docAPI:
        .DocAPI: ""
        get:
          api: rd
          dataIn: MedicalDocuments.apiRequest.diagnosesDoc.docReq
          dataOut: MedicalDocuments.apiRequest.diagnosesDoc.docResp
  formData:
    tempData: ""
    tempDataId: ""
    docList: [] # 用于接收处理过的
    docJumpList: []
    docJumpHistoryList: []
    listHeight: "0.8756157"
    documentShow: "block"
    historyShow: "none"
    relatedAppList: ""
  formDataTemp:
    tabTemp:
      - title: Documents
        fontColor: "0x2988e6"
        fontWeight: "500"
        block: "block"
      - title: History
        fontColor: "0x4b4b4b"
        fontWeight: "400"
        block: "none"
    titleData:
      - title: All
        fontColor: "0x2988e6"
        borderColor: "0x2988e6"
        backgroundColor: "0xe6effc"
        tagCategory: "All"
        boxLeft: "0.04"
      - title: "Patient"
        fontColor: "0xf8ae29"
        borderColor: "0xfff4e0"
        backgroundColor: "0xfff4e0"
        tagCategory: classTag
        boxLeft: "0.029"
      - title: "Provider"
        fontColor: "0x30b354"
        borderColor: "0xe4f5e9"
        backgroundColor: "0xe4f5e9"
        tagCategory: classTag
        boxLeft: "0.029"
      - title: Admin
        fontColor: "0x005795"
        borderColor: "0xe9f2fc"
        backgroundColor: "0xe9f2fc"
        tagCategory: classTag
        boxLeft: "0.029"
      # - title: "@Me"
      #   fontColor: "0xfc3a3a"
      #   borderColor: "0xffeaea"
      #   backgroundColor: "0xffeaea"
      #   tagCategory: ""
      #   boxLeft: "0.029"
  components:
    - .BasePublicHeader:
      children:
        - .BasePublicHeaderLeft:
        - .BasePublicHeaderTitle:
        - .BasePublicHeaderRightIcon:
          path: addMed.svg
          onClick:
            - goto: UploadMedicalRecord2
          style:
            height: "0.0246"
    # tab
    - type: view
      style:
        ..style.tabBox:
        display: .Global.formData.tabBarShow
      children:
        - type: list
          viewTag: tabTag
          contentType: listObject
          listObject: ..formDataTemp.tabTemp
          iteratorVar: itemObject
          style:
            ..style.tabList:
          children:
            - type: listItem
              itemObject:
              style:
                ..style.tabListItem:
              onClick:
                - ..event.tabSwitch
              children:
                - type: label
                  dataKey: itemObject.title
                  style:
                    ..style.tabListTitle:
                - type: view
                  style:
                    ..style.tabListLine:
                - type: view
                  viewTag: leftBlockTag
                  style:
                    ..style.tabBar:
    - type: view
      style:
        width: "1"
        height: "auto"
        border:
          style: 2
        borderWidth: "1"
        borderColor: "0xdedede"
        boxSizing: "border-box"
        overflow: hidden
      children:
        - type: list
          viewTag: filterTag
          contentType: listObject
          listObject: ..formDataTemp.titleData
          iteratorVar: itemObject
          style:
            margin: "0"
            axis: horizontal
            width: "1"
            height: "auto"
            boxSizing: "border-box"
            overflow: hidden
          children:
            - type: listItem
              itemObject:
              style:
                width: "0.16"
                height: "auto"
                display: "inline-block"
                marginLeft: itemObject.boxLeft
                boxSizing: "border-box"
                overflow: hidden
              children:
                - type: label
                  dataKey: itemObject.title
                  style:
                    marginTop: "0.02"
                    height: "0.025"
                    width: "0.16"
                    fontSize: .Nfont.h12
                    color: itemObject.fontColor
                    border:
                      style: 3
                    borderColor: itemObject.borderColor
                    backgroundColor: itemObject.backgroundColor
                    fontWeight: "600"
                    boxSizing: "border-box"
                    borderRadius: "3"
                    textAlign:
                      x: center
                      y: center
                  onClick:
                    - ..event.filterClick
        - type: view
          style:
            width: "1"
            height: "0.0198"
            border:
              style: 2
            borderWidth: "1"
            borderColor: "0xdedede"
    # document List
    - type: view
      viewTag: docListTag
      style:
        width: auto
        height: auto
        display: ..formData.documentShow
      children:
        - type: scrollView
          style:
            margin: "0"
            width: "1"
            height: ..formData.listHeight
            overflow: scroll
            boxSizing: "border-box"
            paddingBottom: "0.03"
          children:
            - type: list
              contentType: listObject
              listObject: ..formData.docJumpList
              iteratorVar: itemObject
              style:
                # margin: "0"
                # width: "1"
                # height: ..formData.listHeight
                # overflow: scroll
              children:
                - type: listItem
                  itemObject:
                  style:
                    width: "1"
                    height: "auto"
                    left: "0"
                    marginTop: "0"
                    boxSizing: "border-box"
                    overflow: hidden
                  children:
                    - type: view
                      style:
                        marginTop: "0.0173"
                        marginLeft: "0.04"
                        width: "0.92"
                        height: "auto"
                        overflow: hidden
                      children:
                        - type: label
                          dataKey: itemObject.name.title
                          style:
                            display: "inline-block"
                            width: "0.6986666"
                            height: "auto"
                            fontSize: .Nfont.h16
                            fontWeight: "600"
                            verticalAlign: top
                            wordBreak: break-word
                        - type: view
                          style:
                            marginLeft: "0.058"
                            display: "inline-block"
                            verticalAlign: top
                            width: "0.16"
                            height: "auto"
                          children:
                            - type: label
                              dataKey: itemObject.name.data.classTag.name
                              style:
                                height: "0.025"
                                width: "0.16"
                                fontSize: .Nfont.h12
                                color: itemObject.name.data.classTag.fontColor
                                border:
                                  style: 1
                                backgroundColor: itemObject.name.data.classTag.backgroundColor
                                fontWeight: "600"
                                boxSizing: "border-box"
                                borderRadius: "3"
                                textAlign:
                                  x: center
                                  y: center
                        # - type: view
                        #   style:
                        #     marginLeft: "0.013"
                        #     display: "inline-block"
                        #     verticalAlign: top
                        #     width: "0.16"
                        #     height: "auto"
                        #   children:
                        #     - type: view
                        #       style:
                        #         display: itemObject.name.data.statusTag.display
                        #         width: "auto"
                        #         height: "auto"
                        #       children:
                        #         - type: label
                        #           dataKey: itemObject.name.data.statusTag.name
                        #           style:
                        #             height: "0.025"
                        #             width: "0.16"
                        #             fontSize: .Nfont.h12
                        #             color: itemObject.name.data.statusTag.fontColor
                        #             border:
                        #               style: 1
                        #             backgroundColor: itemObject.name.data.statusTag.backgroundColor
                        #             fontWeight: "600"
                        #             boxSizing: "border-box"
                        #             borderRadius: "3"
                        #             textAlign:
                        #               x: center
                        #               y: center
                    - type: view
                      style:
                        marginTop: "0.001"
                        marginLeft: "0.04"
                        width: "0.92"
                        height: "auto"
                        overflow: hidden
                      children:
                        - type: label
                          dataKey: itemObject.name.user
                          style:
                            display: "inline-block"
                            width: "0.42"
                            height: "auto"
                            fontSize: .Nfont.h14
                            verticalAlign: middle
                            wordBreak: break-word
                            color: "0x666666"
                        - type: label
                          text=func: .builtIn.string.formatUnixtime_en
                          dataKey: itemObject.mtime
                          style:
                            marginLeft: "0.08"
                            display: "inline-block"
                            width: "0.42"
                            height: "auto"
                            fontSize: .Nfont.h12
                            verticalAlign: middle
                            wordBreak: break-word
                            color: "0x999999"
                            textAlign:
                              x: right
                    - type: view
                      style:
                        marginTop: "0.0153"
                        width: "1"
                        height: "0.0013"
                        backgroundColor: "0xdedede"
                    - type: view
                      style:
                        marginTop: "0"
                        height: "0.001"
                  onClick:
                    - emit:
                        dataKey:
                          var: itemObject
                        actions:
                          - ..formData.tempDataId@: $var.id
                    - actionType: evalObject
                      object:
                        - =.builtIn.array.getObjectByArray:
                            dataIn:
                              array: =..formData.docList
                              key: "id"
                              value: =..formData.tempDataId
                            dataOut: MedicalDocuments.formData.tempData

                    - actionType: evalObject
                      object:
                        - .Global.formData.pageName@: MedicalDocuments
                        - .Global.DocReference.document@: ""
                        - .Global.DocReference.document@: =.MedicalDocuments.formData.tempData
                        - .Global.Note@: ""
                        - .Global.Note@: =.Global.DocReference.document
                    - emit:
                        dataKey:
                          var: itemObject
                        actions:
                          - goto: $var.pageName

    # history List
    - type: view
      viewTag: historyTag
      style:
        width: auto
        height: auto
        display: ..formData.historyShow
      children:
        - type: scrollView
          style:
            margin: "0"
            width: "1"
            height: ..formData.listHeight
            overflow: scroll
            boxSizing: "border-box"
            paddingBottom: "0.03"
          children:
            - type: list
              contentType: listObject
              listObject: ..formData.docJumpHistoryList
              iteratorVar: itemObject
              style:
                # margin: "0"
                # width: "1"
                # height: ..formData.listHeight
                # overflow: scroll
              children:
                - type: listItem
                  itemObject:
                  style:
                    width: "1"
                    height: "auto"
                    left: "0"
                    marginTop: "0"
                    boxSizing: "border-box"
                    overflow: hidden
                  children:
                    - type: view
                      style:
                        marginTop: "0.0173"
                        marginLeft: "0.04"
                        width: "0.92"
                        height: "auto"
                        overflow: hidden
                      children:
                        - type: label
                          dataKey: itemObject.name.title
                          style:
                            display: "inline-block"
                            width: "0.6986666"
                            height: "auto"
                            fontSize: .Nfont.h16
                            fontWeight: "600"
                            verticalAlign: top
                            wordBreak: break-word
                        - type: view
                          style:
                            marginLeft: "0.058"
                            display: "inline-block"
                            verticalAlign: top
                            width: "0.16"
                            height: "auto"
                          children:
                            - type: label
                              dataKey: itemObject.name.data.classTag.name
                              style:
                                height: "0.025"
                                width: "0.16"
                                fontSize: .Nfont.h12
                                color: itemObject.name.data.classTag.fontColor
                                border:
                                  style: 1
                                backgroundColor: itemObject.name.data.classTag.backgroundColor
                                fontWeight: "600"
                                boxSizing: "border-box"
                                borderRadius: "3"
                                textAlign:
                                  x: center
                                  y: center
                        # - type: view
                        #   style:
                        #     marginLeft: "0.013"
                        #     display: "inline-block"
                        #     verticalAlign: top
                        #     width: "0.16"
                        #     height: "auto"
                        #   children:
                        #     - type: view
                        #       style:
                        #         display: itemObject.name.data.statusTag.display
                        #         width: "auto"
                        #         height: "auto"
                        #       children:
                        #         - type: label
                        #           dataKey: itemObject.name.data.statusTag.name
                        #           style:
                        #             height: "0.025"
                        #             width: "0.16"
                        #             fontSize: .Nfont.h12
                        #             color: itemObject.name.data.statusTag.fontColor
                        #             border:
                        #               style: 1
                        #             backgroundColor: itemObject.name.data.statusTag.backgroundColor
                        #             fontWeight: "600"
                        #             boxSizing: "border-box"
                        #             borderRadius: "3"
                        #             textAlign:
                        #               x: center
                        #               y: center
                    - type: view
                      style:
                        marginTop: "0.001"
                        marginLeft: "0.04"
                        width: "0.92"
                        height: "auto"
                        overflow: hidden
                      children:
                        - type: label
                          dataKey: itemObject.name.user
                          style:
                            display: "inline-block"
                            width: "0.42"
                            height: "auto"
                            fontSize: .Nfont.h14
                            verticalAlign: middle
                            wordBreak: break-word
                            color: "0x666666"
                        - type: label
                          text=func: .builtIn.string.formatUnixtime_en
                          dataKey: itemObject.mtime
                          style:
                            marginLeft: "0.08"
                            display: "inline-block"
                            width: "0.42"
                            height: "auto"
                            fontSize: .Nfont.h12
                            verticalAlign: middle
                            wordBreak: break-word
                            color: "0x999999"
                            textAlign:
                              x: right
                    - type: view
                      style:
                        marginTop: "0.0153"
                        width: "1"
                        height: "0.0013"
                        backgroundColor: "0xdedede"
                    - type: view
                      style:
                        marginTop: "0"
                        height: "0.001"
                  onClick:
                    - emit:
                        dataKey:
                          var: itemObject
                        actions:
                          - ..formData.tempDataId@: $var.id
                    - actionType: evalObject
                      object:
                        - =.builtIn.array.getObjectByArray:
                            dataIn:
                              array: =..apiRequest.medicalDocumentHistory.docQueryResp.doc
                              key: "id"
                              value: =..formData.tempDataId
                            dataOut: MedicalDocuments.formData.tempData

                    - actionType: evalObject
                      object:
                        - .Global.formData.pageName@: MedicalDocuments
                        - .Global.DocReference.document@: ""
                        - .Global.DocReference.document@: =.MedicalDocuments.formData.tempData
                        - .Global.Note@: ""
                        - .Global.Note@: =.Global.DocReference.document
                    - emit:
                        dataKey:
                          var: itemObject
                        actions:
                          - goto: $var.pageName

  event:
    filterClick:
      - emit:
          dataKey:
            var: itemObject
          actions:
            - =.builtIn.object.setProperty:
                dataIn:
                  obj: =..formDataTemp.titleData
                  label: "title"
                  text: $var.title
                  arr: ["borderColor"]
                  valueArr: $var.fontColor
                  errorArr: ["0x00000000"]
            - =.builtIn.array.filterByTag:
                dataIn:
                  sourceDoc: =..apiRequest.medicalDocuments.docQueryResp.doc
                  tagCategory: $var.tagCategory
                  tagName: $var.title
                dataOut: MedicalDocuments.formData.docList
            - =.builtIn.array.concatArray:
                dataIn:
                  array1: =..formData.docList
                  array2: []
                  sortby: ctime
                  orders: desc
                dataOut: MedicalDocuments.formData.docList
            - =.builtIn.array.setFormJumpPage:
                dataIn:
                  objArry: =..formData.docList
                  docFormObj: =.DocumentList
                dataOut: MedicalDocuments.formData.docJumpList
            # history list
            - =.builtIn.array.filterByTag:
                dataIn:
                  sourceDoc: =..apiRequest.medicalDocumentHistory.docQueryResp.doc
                  tagCategory: $var.tagCategory
                  tagName: $var.title
                dataOut: MedicalDocuments.formData.docJumpHistoryList
            - =.builtIn.array.concatArray:
                dataIn:
                  array1: =..formData.docJumpHistoryList
                  array2: []
                  sortby: ctime
                  orders: desc
                dataOut: MedicalDocuments.formData.docJumpHistoryList
            - =.builtIn.array.setFormJumpPage:
                dataIn:
                  objArry: =..formData.docJumpHistoryList
                  docFormObj: =.DocumentList
                dataOut: MedicalDocuments.formData.docJumpHistoryList
      - actionType: builtIn
        funcName: redraw
        viewTag: filterTag
      - actionType: builtIn
        funcName: redraw
        viewTag: docListTag
      - actionType: builtIn
        funcName: redraw
        viewTag: historyTag
    tabSwitch:
      - emit:
          dataKey:
            var: itemObject
          actions:
            - =.builtIn.object.setProperty:
                dataIn:
                  obj: =..formDataTemp.tabTemp
                  label: "title"
                  text: $var.title
                  arr: ["fontColor", "fontWeight", "block"]
                  valueArr: ["0x2988e6", "500", "block"]
                  errorArr: ["0x4b4b4b", "400", "none"]
            - =.builtIn.object.setProperty:
                dataIn:
                  obj: =..formDataTemp.titleData
                  label: "title"
                  text: "All"
                  arr: ["borderColor"]
                  valueArr: $var.fontColor
                  errorArr: ["0x00000000"]
            - =.builtIn.array.concatArray:
                dataIn:
                  array1: =..apiRequest.medicalDocuments.docQueryResp.doc
                  array2: []
                  sortby: ctime
                  orders: desc
                dataOut: MedicalDocuments.formData.docList
            - =.builtIn.array.setFormJumpPage:
                dataIn:
                  objArry: =..formData.docList
                  docFormObj: =.DocumentList
                dataOut: MedicalDocuments.formData.docJumpList
            # history list
            - =.builtIn.array.concatArray:
                dataIn:
                  array1: =..apiRequest.medicalDocumentHistory.docQueryResp.doc
                  array2: []
                  sortby: ctime
                  orders: desc
                dataOut: MedicalDocuments.formData.docJumpHistoryList
            - =.builtIn.array.setFormJumpPage:
                dataIn:
                  objArry: =..formData.docJumpHistoryList
                  docFormObj: =.DocumentList
                dataOut: MedicalDocuments.formData.docJumpHistoryList

            - ..formData.documentShow@: =..formDataTemp.tabTemp.0.block
            - ..formData.historyShow@: =..formDataTemp.tabTemp.1.block
      - actionType: builtIn
        funcName: redraw
        viewTag: tabTag
      - actionType: builtIn
        funcName: redraw
        viewTag: filterTag
      - actionType: builtIn
        funcName: redraw
        viewTag: docListTag
      - actionType: builtIn
        funcName: redraw
        viewTag: historyTag
  style:
    tabBox:
      height: "auto"
      width: "1"
      overflow: hidden
    tabList:
      width: "1"
      margin: "0"
      axis: horizontal
      height: "auto"
      overflow: hidden
      marginTop: "0.02"
    tabListItem:
      width: "0.5"
      height: "auto"
    tabListTitle:
      color: itemObject.fontColor
      height: "auto"
      width: "0.5"
      fontWeight: itemObject.fontWeight
      textAlign:
        x: center
      fontSize: .Nfont.h16
    tabListLine:
      marginTop: "0.005"
      height: "0.0025" #2.03px
      width: "0.5"
      backgroundColor: "0xdededf"
    tabBar:
      display: itemObject.block
      top: "0.031"
      left: "0.2"
      width: "0.08"
      height: "0.0025"
      backgroundColor: "0x2988e6"
      zIndex: 10
