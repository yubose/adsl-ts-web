AddHealthNetWork:
  title: Add Health Networks
  init:
    - .SignInCheck
    - if:
        - .builtIn.isBrowser
        - ..formData.scanDisplay@: "none"
        - ..formData.scanDisplay@: "block"
  scan:
    document:
      name:
        data: ""
  # 被邀请人的手机区域代码
  countryCode: "+1"
  # 被邀请人的手机号
  phoneNumber: ""
  # 邀请弹框中的信息
  inviteMessage: ""
  formData:
    # 暂存share过后的patient profile以便后续挂hashtag
    patientProfileAfterShare: ""
    providerId: ""
    query10002Scondition: ""
    scanDisplay: ""
  invite:
    edgeRes: ""
    edge:
      type: .EdgeType.InviteInfo #1053
      _handledCode: 1020
      bvid: .Global.currentUser.vertex.id
      _nonce: =.Global._nonce
      subtype: 65536 #0x10000
      name:
        phoneNumber: "" #inviteePhoneNumber  被邀请号码
        inviterPhoneNumber: .Global.currentUser.vertex.uid
        inviteeName: ""
        inviterName: .Global.Profile.name.data.basicInfo.fullName
        inviterAvatar: .Global.Profile.name.data.basicInfo.avatar
        inviteeAvatar: ""
        data:
          phone: ""
    edgeAPI:
      store:
        api: ce
        dataIn: AddHealthNetWork.invite.edge
        dataOut: AddHealthNetWork.invite.edgeRes
  patientProfile:
    docOut: ""
    docIn:
      id: .Global.rootNotebookID
      xfname: eid
      type: .DocType.PatientProfile #  type: "257"
      obfname: "mtime"
      maxcount: "1"
      _nonce: =.Global._nonce
    docAPI:
      get:
        api: rd
        dataIn: AddHealthNetWork.patientProfile.docIn
        dataOut: AddHealthNetWork.patientProfile.docOut
  sendNotification:
    document:
      .Document: ""
      eid: ""
      subtype:
        isOnServer: 1
        isZipped: 0
        isBinary: 0
        isEncrypted: 0
        isExtraKeyNeeded: 0
        isEditable: 0
        applicationDataType: 0
        # 7 th bit
        notification: 1
        ringToneNotify: 0
        sendtoSelf: 0
        # 10 bit
        textMessage: 0
        mediaType: 8
      tage: 5
      type: .DocType.Notification
      name:
        data: ""
        notification:
          title: AiTmed Connection Request
          context: Connection request from patient
          body: Connection request from patient
          onClickLandingPage: NewPatients
          targetApp: =.FirebaseToken.response.edge.evid
    docAPI:
      store:
        api: cd
        dataIn: sendNotification.document
  apiRequest:
    checkConnection:
      getResp:
        edge: []
      connectEdge:
        id: .Global.currentUser.vertex.id
        sfname: '{"result":"E.*", "join": "INNER JOIN Vertex V on V.id = E.evid OR V.id = E.bvid"}'
        xfname: "E.bvid|E.evid"
        sCondition: =..formData.query10002Scondition
        type: 10002
        ObjType: 28
        _nonce: =.Global._nonce
      edgeApi:
        get:
          api: re
          dataIn: apiRequest.checkConnection.connectEdge
          dataOut: AddHealthNetWork.apiRequest.checkConnection.getResp
    getProviderPublicProfile:
      resp: ""
      doc:
        id: =..formData.providerId
        type: .DocType.DoctorPublicProfile
        xfname: ovid
        maxcount: "1"
        obfname: ctime
      docApi:
        get:
          api: rd
          dataIn: apiRequest.getProviderPublicProfile.doc
          dataOut: AddHealthNetWork.apiRequest.getProviderPublicProfile.resp
  components:
    - type: popUp
      viewTag: inviteView
      style:
        left: "0"
        top: "0"
        width: "1"
        height: "1"
        backgroundColor: "0x00000033"
        zIndex: "1000"
      children:
        - type: view
          style:
            left: "0.15"
            top: "0.3"
            width: "0.7"
            height: "0.26"
            backgroundColor: "0xefefef"
            borderRadius: "10"
          children:
            - type: label
              text: Send Invite Link
              style:
                left: "0"
                top: "0.03"
                width: "0.7"
                height: "0.05"
                fontSize: "16"
                fontWeight: "500"
                textAlign:
                  x: center
            - type: label
              text: Send invite link to
              style:
                left: "0"
                top: "0.09"
                width: "0.7"
                height: "0.05"
                fontSize: "13"
                fontWeight: "500"
                textAlign:
                  x: center
            - type: label
              viewTag: inviteLabel
              dataKey: inviteMessage
              style:
                left: "0"
                top: "0.15"
                width: "0.7"
                height: "0.03"
                fontSize: "13"
                fontWeight: "500"
                textAlign:
                  x: center
            - type: button
              text: Cancel
              onClick:
                - actionType: popUpDismiss
                  popUpView: inviteView
              style:
                left: "0"
                top: "0.208"
                width: "0.348"
                height: "0.05"
                borderRadius: "10"
                borderWidth: "0"
                fontSize: "17"
                fontWeight: "500"
                color: "0x3a96f9"
                textAlign:
                  x: center
            - type: button
              text: Confirm
              onClick:
                - actionType: popUpDismiss
                  popUpView: inviteView
                - actionType: evalObject
                  object:
                    # 为解决jwt莫名切换问题，在此处强制切换到当前用户的jwt。
                    - .Global.createjwt.edge.bvid@: =.Global.currentUser.vertex.id
                    - =.Global.createjwt.edgeAPI.store: ""
                    - =.AddHealthNetWork.invite.edgeAPI.store: ""
                    - if:
                      - =.builtIn.string.equal:
                          dataIn:
                            string1: =.AddHealthNetWork.invite.edgeRes.code
                            string2: "1020"
                      - actionType: popUp
                        popUpView: noPhoneNumber
                        popUpDismiss: 2000
                        wait: true
                      - continue
                    - actionType: popUp
                      popUpView: uploading
                    - =.builtIn.ecos.shareDoc:
                        dataIn:
                          sourceDoc: =.Global.Profile
                          targetEdgeID: =.AddHealthNetWork.invite.edgeRes.edge.refid
                        dataOut: AddHealthNetWork.formData.patientProfileAfterShare
                    - if:
                        - =.builtIn.array.judgeListLength:
                            dataIn:
                              array: =..apiRequest.hashTag.docQueryResp.doc
                              len: 0
                        - continue
                        - =.builtIn.ecos.shareDoc:
                            dataIn:
                              sourceDoc: =.Global.formData.hashTag
                              targetEdgeID: =.AddHealthNetWork.invite.edgeRes.edge.refid
                              reid: =..formData.patientProfileAfterShare.doc.id
                    - ..sendNotification.document.fid@: =.Global.prodAPPID
                    - ..sendNotification.document.eid@: =.AddHealthNetWork.invite.edgeRes.edge.refid
                    - =..sendNotification.docAPI.store: ""
                - actionType: popUpDismiss
                  popUpView: uploading
                - actionType: popUp
                  popUpView: finalView
                  wait: 2000
                - actionType: builtIn
                  funcName: goBack
                  reload: true
              style:
                left: "0.352"
                top: "0.208"
                width: "0.348"
                height: "0.05"
                borderRadius: "10"
                borderWidth: "0"
                fontSize: "17"
                fontWeight: "500"
                color: "0x3a96f9"
                textAlign:
                  x: center
            - type: view
              style:
                left: "0"
                top: "0.2"
                width: "0.7"
                height: "0.001"
                backgroundColor: "0xbebebf"
            - type: view
              style:
                left: "0.348"
                top: "0.2"
                width: "0.001"
                height: "0.06"
                backgroundColor: "0xbebebf"
    - .BackgroundColorGray:
      style:
        zIndex: 1000
      viewTag: finalView
      onClick:
        - actionType: popUpDismiss
          popUpView: finalView
        - actionType: builtIn
          funcName: goBack
          reload: true
      children:
        - type: view
          style:
            width: "0.7"
            height: auto
            backgroundColor: "0xe5e5e5"
            borderRadius: "12"
            top: "0.41"
            left: "0.15"
            textAlign:
              x: center
          children:
            - type: image
              path: deleteTrue.svg
              style:
                width: "0.105"
                marginTop: "0.03"
                textAlign:
                  x: center
            - type: label
              text: "Successfully!"
              dataKey:
              style:
                color: "0x4b4b4b"
                fontSize: .Nfont.h2
                width: "0.7"
                textAlign:
                  x: center
                height: auto

                word-break: break-word
                marginTop: "0.01"
            - type: label
              text: "Your invite link has been sent to"
              dataKey:
              style:
                color: "0x4b4b4b"
                fontSize: .Nfont.h1
                width: "0.7"
                textAlign:
                  x: center
                height: auto

                word-break: break-word
                marginTop: "0.01"
            - type: label
              viewTag: inviteLabel
              dataKey: inviteMessage
              style:
                color: "0x000000"
                fontSize: 1vh
                width: "0.7"
                textAlign:
                  x: center
                height: auto

                word-break: break-word
                margin: auto
                marginTop: "0.01"
            - type: view
              style:
                width: "0.01"
                height: "0.02"
    - type: popUp
      viewTag: phoneView
      style:
        left: "0"
        top: "0"
        width: "1"
        height: "1"
        backgroundColor: "0x00000033"
        zIndex: "1000"
      children:
        - type: view
          style:
            left: "0.15"
            top: "0.3"
            width: "0.7"
            height: "0.25"
            backgroundColor: "#FFFFFF"
            borderRadius: "9"
          children:
            - type: label
              text: This phonenumber is already exist
              style:
                left: "0"
                top: "0.15"
                width: "0.7"
                fontSize: "15"
                fontWeight: "550"
                color: "#FF0000"
                textAlign:
                  x: center
            - type: image
              path: close.svg
              onClick:
                - actionType: popUpDismiss
                  popUpView: phoneView
              style:
                top: "0.01"
                left: "0.6"
                width: "0.05"
            - type: image
              path: aboutRed.svg
              style:
                top: "0.05"
                left: "0.25"
                width: "0.2"
    - .BasePublicHeader:
      children:
        - .BasePublicHeaderLeft:
        - .BasePublicHeaderTitle:
    - type: scrollView
      style:
        left: "0"
        width: "1"
        height: "0.9"
        overflow: scrollView
      children:
        - type: view
          style:
            width: "1"
            height: "0.05"
            backgroundColor: "0xf0f0f0"
          children:
            - type: label
              text: Search To Invite
              style:
                marginLeft: "0.04"
                color: "0x666666"
                height: "0.05"
                width: "0.45"
                lineHeight: 5vh

                fontSize: .Nfont.h14
                fontWeight: "600"
                textAlign:
                  x: left
        - type: view
          style:
            marginTop: "0.02"
            height: "auto"
            width: "0.92"
            marginLeft: "0.04"
            border:
              style: 3
              color: "0xDEDEDF"
            borderWidth: "1"
            borderRadius: "5"
          children:
            - type: image
              path: searchBlue.svg
              style:
                top: "0.0075"
                left: "0.02"
                height: "0.025"
            - type: textField
              placeholder: Name, Specialty
              style:
                width: "0.76"
                height: "0.04"
                lineHeight: "4vh"
                verticalAlign: middle
                boxSizing: border-box
                border: none
                marginLeft: "0.1"
              onClick:
                - goto: SearchProvider
        # - type: view
        #   style:
        #     width: "1"
        #     height: "0.05"
        #     marginTop: "0.02"
        #     backgroundColor: "0xf0f0f0"
        #   children:
        #     - type: label
        #       text: Quickly Invite
        #       style:
        #         marginLeft: "0.04"
        #         color: "0x666666"
        #         height: "0.05"
        #         width: "0.45"
        #         lineHeight: 5vh

        #         fontSize: .Nfont.h14
        #         fontWeight: "600"
        #         textAlign:
        #           x: left
        # - type: view
        #   viewTag: phoneNumber
        #   style:
        #     ..style.blockBox:
        #   children:
        #     - type: view
        #       style:
        #         ..style.inlineBox:
        #         marginLeft: "0.04"
        #       children:
        #         - type: label
        #           text: Country
        #           style:
        #             ..style.inlineTitle:
        #         - type: select
        #           dataKey: countryCode
        #           options: .SelectINformationDM.countryCode
        #           style:
        #             ..style.inputBox:
        #     - type: view
        #       style:
        #         ..style.inlineBox:
        #         marginLeft: "0.032"
        #       children:
        #         - type: label
        #           textBoard:
        #             - text: Phone Number
        #             - text: "&nbsp;*"
        #               color: "0xff0000"
        #           style:
        #             ..style.inlineTitle:
        #         - type: textField
        #           placeholder: "000-000-0000"
        #           dataKey: phoneNumber
        #           style:
        #             ..style.inputBox:
        #             width: "0.6933333"

        # - type: button
          # text: Invite
          # style:
          #   ..style.btn:
          # onClick:
          #   - ..event.inviteClick
        - type: view
          style:
            width: "1"
            height: "0.05"
            marginTop: "0.02"
            backgroundColor: "0xf0f0f0"
          children:
            - type: label
              text: More Ways to Invite
              style:
                marginLeft: "0.04"
                color: "0x666666"
                height: "0.05"
                width: "0.45"
                lineHeight: 5vh

                fontSize: .Nfont.h14
                fontWeight: "600"
                textAlign:
                  x: left
        - type: view
          style:
            height: "auto"
            width: "1"
            display: ..formData.scanDisplay
          children:
            - type: view
              style:
                height: "0.08"
                width: "1"
                border:
                  style: 2
                borderColor: "0xf1f1f1"
                borderWidth: "1"
                textAlign:
                  y: center
              children:
                - type: view
                  style:
                    width: auto
                    height: auto
                  children:
                    - type: view
                      style:
                        width: "0.6"
                        left: "0"
                      children:
                        - type: image
                          path: scanConnection.svg
                          style:
                            marginLeft: "0.07"
                            height: "0.035"
                            display: "inline-block"
                            verticalAlign: middle
                        - type: label
                          text: Scan QR Code
                          style:
                            width: "auto"
                            marginLeft: "0.03"
                            fontSize: .Nfont.h16
                            fontWeight: "500"
                            display: "inline-block"

                            verticalAlign: middle
                            textAlign:
                              y: center
                    - type: label
                      text: Scan a friend's QR code
                      style:
                        fontSize: .Nfont.h14

                        marginTop: "0.005"
                        width: "auto"
                        marginLeft: "0.17"
                        color: "0x666666"
          contentType: scan
          onClick:
            - actionType: scanCamera
              dataKey: AddHealthNetWork.scan.document.name.data
            - actionType: evalObject
              object:
                - ..formData.providerId@: =..scan.document.name.data.id
                - ..formData.providerInfo@: ""
                - =..apiRequest.getProviderPublicProfile.docApi.get: ""
                - ..formData.providerInfo@: =..apiRequest.getProviderPublicProfile.resp.doc.0
                - .Global.temporaryId@: =..formData.providerInfo
                - goto: SearchOutProviderInfo

    - .BaseWarningView:
      message: "You cannot add yourself"
      viewTag: selfCheck
    - .TipsMultiLine:
      style:
        zIndex: "100"
      viewTag: phoneInvited
      message: "The phone number is already invited or invites you"
      onClick:
        - actionType: evalObject
          object:
            # to ensure old data can not influence new data
            - ..apiRequest.checkConnection.getResp.edge@: []
        - actionType: popUpDismiss
          popUpView: phoneInvited
    - .BaseWarningView:
      message: "The phone number is wrong"
      viewTag: phoneNumberCheck
    - .TipsOneLine:
      message: "Can't find this phone number"
      viewTag: noPhoneNumber
    - .ProgressCheckView:
      message: "loading ..."
      viewTag: uploading
  event:
    inviteClick:
      - actionType: evalObject #拼接姓名和手机号
        object:
          - =.builtIn.string.concat:
              dataIn:
                - =..countryCode
                - " "
                - =..phoneNumber
              dataOut: AddHealthNetWork.invite.edge.name.phoneNumber
          - .AddHealthNetWork.invite.edge.name.data.phone@: =..invite.edge.name.phoneNumber
          # 拼接出scondition， 用来objtype 查询 是否存在该好友
          - =.builtIn.string.concat:
              dataIn:
                - "V.uid like '%"
                - =..phoneNumber
                - "' AND E.subtype&0xf0000=0x10000 AND E.tage>=0" #
              dataOut: AddHealthNetWork.formData.query10002Scondition
          - =.builtIn.string.concat: #信息
              dataIn:
                - (
                - =..invite.edge.name.phoneNumber
                - )
              dataOut: AddHealthNetWork.inviteMessage
      # 检测手机号的格式是否符合规范
      - actionType: evalObject
        object:
          - if:
              - =.builtIn.string.equal:
                  dataIn:
                    string1: =..countryCode
                    string2: "+965" # Kuwait
              - continue
              - actionType: evalObject
                object:
                  - if:
                      - =.builtIn.string.phoneVerification: #手机号是否符合格式
                          dataIn:
                            phoneNumber: =..phoneNumber
                            countryCode: =..countryCode
                      - continue
                      - actionType: popUp
                        popUpView: phoneNumberCheck
                        wait: true
      #检查是否添加的是否为自己
      - actionType: evalObject
        object:
          - if:
              - =.builtIn.string.equal:
                  dataIn:
                    string1: =..invite.edge.name.phoneNumber
                    string2: =.Global.currentUser.vertex.uid
              - actionType: popUp
                popUpView: selfCheck
                wait: true
              - continue
      - actionType: evalObject
        object:
          .Global._nonce@:
            =.builtIn.math.random: ""
      # 检测是否已经是好友
      - actionType: evalObject
        object:
          - =..apiRequest.checkConnection.edgeApi.get: ""
          - if:
              - =.builtIn.array.judgeListLength:
                  dataIn:
                    array: =..apiRequest.checkConnection.getResp.edge
                    len: 0
              # 如果是空 说明不存在好友关系
              - continue
              - actionType: popUp
                popUpView: phoneInvited
                wait: true
      - actionType: builtIn
        funcName: redraw
        viewTag: inviteLabel
      - actionType: builtIn
        funcName: redraw
        viewTag: phoneNumber
      - actionType: popUp
        popUpView: inviteView
  style:
    blockBox:
      marginTop: "0.0246"
      width: "auto"
      height: "auto"
      oveflow: hidden
    inlineBox:
      display: "inline-block"
      width: "auto"
      height: "auto"
      oveflow: hidden
      verticalAlign: middle
    inlineTitle:
      color: "#333333"
      fontSize: .Nfont.h14
      height: "auto"
      width: "auto"
      fontWeight: "400"

    inputBox:
      marginTop: "0.009852"
      height: "0.0443"
      width: "0.2"
      fontSize: .Nfont.h14
      color: "#333333"
      border:
        style: 3
      borderWidth: "1.5"
      borderColor: "#dededf"
      boxSizing: border-box
      borderRadius: "4"
      textIndent: "8px"

    btn:
      marginTop: "0.0492"
      left: "0.08"
      width: "0.84"
      height: "0.05"
      fontSize: .Nfont.h14
      fontWeight: "600"
      color: "0x5ea6ec"
      backgroundColor: "0xffffff"
      border:
        style: "3"
      borderColor: "0x2988e6"
      borderWidth: "1"
      borderRadius: "5"
      textAlign:
        x: center
