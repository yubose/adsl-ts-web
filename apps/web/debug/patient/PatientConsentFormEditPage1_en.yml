PatientConsentFormEditPage1:
  title: Patient Consent Form - HIPPA
  pageNumber:
  init: #Page initialization
    - .SignInCheck

    # 判断patientConsentForm是否存在,存在显示上次填写的数据,否则显示默认数据
    - if:
        - =.Global.formData.patientConsentForm.id
        - ..apiRequest.patientConsentForm.docReq@: =.Global.formData.patientConsentForm
        - continue

    #  判断是否是第一次填写patientConsentForm
    - if:
        - =.Global.formData.firstPatientConsentForm
        - actionType: evalObject
          object:
            - ..apiRequest.patientConsentForm.docReq.name.data@: =.VaccineFormDM.patientConsentFormDM
            - ..apiRequest.patientConsentForm.docReq.name.data.userInfo@: 
                patientName: =.Global.Profile.name.data.basicInfo.fullName
                participateName: =.Global.formData.participateName
            # 初始化模板之后
            - ..apiRequest.patientConsentForm.docReq.name.data.patientName@: =.Global.Profile.name.data.basicInfo.fullName
            # 发服务器之前
            - =..apiRequest.patientConsentForm.docAPI.store: ""
            - ..apiRequest.patientConsentForm.docReq@: =..apiRequest.patientConsentForm.docResp.doc
        - continue

    # 判断是否签名
    - if:
        - =..apiRequest.patientConsentForm.docReq.name.data.signatureHippa.whetherSignature
        - continue
        # 非空修改显示的标识,刷新签名区域
        - actionType: evalObject
          object:
            # 签名的时间
            - ..formData.signatureTime@: =..apiRequest.patientConsentForm.docReq.name.data.signatureHippa.signatureTime
            # 签名的id
            - ..formData.signatureId@: =..apiRequest.patientConsentForm.docReq.name.data.signatureHippa.signatureId
            - ..formData.flag@: "block"
  formData: #Input data here
    recipientName: ""
    # 获取暂存的签名的id
    signatureId: ""
    # 签名的显示,默认为none
    flag: "none"
    # 是否签名 true 表示未签 false 表示已签
    whetherSignature: ""
    signatureTime: ""

  apiRequest:
    patientConsentForm:
      docResp: ""
      docReq:
        eid: .Global.rootNotebookID
        type: .DocType.PatientConsentForm
        subtype:
          isEncrypted: "1"
          mediaType: "application/json"
        name:
          data: ""
          title: "Patient Consent Form - HIPPA"
          user: .Global.Profile.name.data.basicInfo.fullName
      docAPI:
        .DocAPI: ""
        store:
          api: cd
          dataIn: PatientConsentFormEditPage1.apiRequest.patientConsentForm.docReq
          dataOut: PatientConsentFormEditPage1.apiRequest.patientConsentForm.docResp

    newSign:
      docRes: ""
      docReq: #DOC
        type: .DocType.DocumentSignature
        eid: .Global.rootNotebookID
        reid: .Global.formData.patientConsentForm.id
        name:
          title: ""
          type: ..apiRequest.newSign.docReq.subtype.mediaType
          data: ""
        subtype:
          mediaType: ""
      docAPI: # DOCAPI
        store:
          api: cd
          dataIn: PatientConsentFormEditPage1.apiRequest.newSign.docReq
          dataOut: PatientConsentFormEditPage1.apiRequest.newSign.docRes

  components:
    - .BasePublicHeader:
      children:
        - .BasePublicHeaderLeft:
        - .BasePublicHeaderTitle:
    - type: scrollView
      style:
        ..style.scrollBox:
      children:
        - type: label
          text: "Please carefully read the following informed consent:"
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h16
            fontWeight: "700"
            lineHeight: "2.58vh"

        - type: label
          text: The Department of Health and Human Services has established a “Privacy Rule” to help insure that personal health care information is protected for privacy. The Privacy Rule was also created in order to provide a standard for certain health care providers to obtain their patients' consent for uses and disclosures of health information about the patient to carry out treatment, payment or health care operations.
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - type: label
          text: As our patient we want you to know that we respect the privacy of your personal medical records and will do all we can to secure and protect that privacy. We strive to always take reasonable precautions to protect your privacy. When it is appropriate and necessary, we provide the minimum necessary information to only those we feel are in need of your healthcare information and information about treatment, payment or health care operations, in order to provide health care that is in your best interest.
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - type: label
          text: We also want you to know that we support your full access to your personal medical records. We may have indirect treatments relationships with you (such as laboratories that only interact with physicians and not patients), and may have to disclose personal health information for purposes of treatment, payment, or health operations, These entities are most often not required to obtain patient consent.
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - type: label
          text: You may refuse to consent to the use or disclosure of your personal health information but this must be in writing. Under this law, we have the right to refuse to treat you should you choose to refuse to disclose your Personal Health Information (PIH). If you choose to give consent in this document, at some future time you may request to refuse all or part of your PHI. You may not revoke actions that have already been taken which relied on this or a previously signed consent.
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - type: label
          text: If your have objections to this form, please ask to speak with out HIPPA Compliance Officer.
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - type: label
          text: You have the right to review our privacy notice to request restrictions and revoke consent in writing after you have reviewed our privacy notice.
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - type: label
          text: HIPPA Notice of Privacy Practices
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h16
            fontWeight: "700"

        - type: label
          text: "Signature below is only acknowledgement that you havereceived this Notice of our Privacy Practices:"
          dataKey:
          style:
            marginTop: "0.01"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - .DocPublicStyleFiveBox:
          children:
            - .DocPublicStyleFiveTitle:
              text: "Name of Recipient/Healthcare Proxy"
            - .DocPublicStyleFiveinput:
              dataKey: apiRequest.patientConsentForm.docReq.name.data.signatureHippa.recipientName

        - type: view
          style:
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            overflow: hidden
          children:
            - type: label
              text: "Signature"
              dataKey:
              style:
                ..style.secondLabel:
            - type: view
              style:
                marginTop: "0.01"
                height: "auto"
                width: "0.92"
              children:
                - type: view
                  style:
                    ..style.blockBox:
                    display: inline-block
                  children:
                    - type: label
                      text: Click on the signature box below to finger sign
                      dataKey:
                      style:
                        ..style.signTips:

                    - type: label
                      text: "Clear"
                      style:
                        display: "inline-block"
                        width: "auto"
                        fontSize: .Nfont.h14
                        height: "auto"
                        color: "0xfb5051"
                      onClick:
                        - ..event.clearClick
        - type: view
          style:
            marginLeft: "0.04"
            marginTop: "0.01"
            height: "0.128"
            width: "0.9"
            border:
              style: "4"
              color: "0xa9a9a9"
            borderWidth: "2"
          children:
            - type: label
              text: X
              style:
                .SignLabelStyle:
            - type: canvas
              dataKey: PatientConsentFormEditPage1.apiRequest.newSign.docReq.name.data
              viewTag: signatureTag
              style:
                left: "0"
                width: "0.88"
                height: "0.128"
                overflow: scroll
            # 显示暂存的签名
            - type: image
              viewTag: signatureShowTag
              path=func: .builtIn.utils.prepareDocToPath
              # 传入签名文档的id
              dataKey: PatientConsentFormEditPage1.formData.signatureId
              style:
                # 控制显示
                display: =..formData.flag
                left: "0"
                width: "0.88"
                top: "0"
                height: "0.128"
                overflow: scroll
                zIndex: "1000"

        - type: view
          style:
            marginLeft: "0.04"
            # marginTop: "0.0146"
            width: "0.92"
            height: "auto"
            overflow: hidden
          children:
            - type: view
              viewTag: signatureTimeTag
              style:
                display: ..formData.flag
                marginTop: "0.01"
                height: "auto"
                width: "0.92"
              children:
                - type: label
                  text=func: .builtIn.string.formatUnixtime_en
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.signatureHippa.signatureTime
                  style:
                    display: "inline-block"
                    width: "auto"
                    height: "auto"
                    fontSize: .Nfont.h12
                    color: "0x757575"
                    verticalAlign: middle
                - type: label
                  text: "Digitally Signed"
                  dataKey:
                  style:
                    marginLeft: "0.02"
                    display: "inline-block"
                    width: "auto"
                    height: "auto"
                    fontSize: .Nfont.h12
                    color: "0x757575"
                    verticalAlign: middle
            - type: view
              style:
                width: "0.92"
                height: "auto"
                overflow: hidden
              children:
                - type: view
                  style:
                    ..style.blockBox:
                  children:
                    - type: label
                      text: Patient Name
                      style:
                        ..style.blockBoxLeft:
                    - type: label
                      text:
                      dataKey: apiRequest.patientConsentForm.docReq.name.data.patientName
                      style:
                        ..style.blockBoxRight:
                - type: view
                  style:
                    ..style.blockBox:
                  children:
                    - type: label
                      text: Date
                      style:
                        ..style.blockBoxLeft:
                    - type: label
                      text=func: .builtIn.string.formatUnixtimeL_en
                      dataKey: apiRequest.patientConsentForm.docReq.ctime
                      style:
                        ..style.blockBoxRight:
        - type: view
          style:
            marginTop: "0.03"
    - type: view
      style:
        ..style.btnBox:
      children:
        - type: button
          text: Done
          dataKey:
          style:
            ..style.btn:
          onClick:
            - ..event.publicClick
            - ..event.btnClick

    # 弹窗区域
    - .BaseWarningView:
      viewTag: BaseWarningView
      message: "You haven't signed the form"
  event:
    publicClick:
      # 签名处理
      - actionType: saveSignature
        dataObject: BLOB
        dataKey: PatientConsentFormEditPage1.apiRequest.newSign.docReq.name.data
        isEmpty: PatientConsentFormEditPage1.formData.whetherSignature
      - actionType: evalObject
        object:
          - if:
              - =..formData.whetherSignature
              - continue
              - =..apiRequest.newSign.docAPI.store: ""

      - actionType: evalObject
        object:
          - if:
              - =..formData.signatureId
              - actionType: evalObject
                object:
                  - ..apiRequest.patientConsentForm.docReq.name.data.signatureHippa.signatureTime@: =..formData.signatureTime
                  - ..apiRequest.patientConsentForm.docReq.name.data.signatureHippa.signatureId@: =..formData.signatureId
                  - ..apiRequest.patientConsentForm.docReq.name.data.signatureHippa.whetherSignature@: false
                  - ..formData.whetherSignature@: false
              - actionType: evalObject
                object:
                  - ..apiRequest.patientConsentForm.docReq.name.data.signatureHippa.signatureTime@: =..apiRequest.newSign.docRes.doc.ctime
                  - ..apiRequest.patientConsentForm.docReq.name.data.signatureHippa.signatureId@: =..apiRequest.newSign.docRes.doc.id
                  - ..apiRequest.patientConsentForm.docReq.name.data.signatureHippa.whetherSignature@: =..formData.whetherSignature
    clearClick:
      - actionType: removeSignature
        dataObject: BLOB
        dataKey: PatientConsentFormEditPage1.apiRequest.newSign.docReq.name.data
        viewTag: signatureTag
      - actionType: evalObject
        object:
          - ..formData.signatureId@: ""
          - ..formData.signatureTime@: ""
          - ..formData.flag@: "none"
      - actionType: builtIn
        funcName: redraw
        viewTag: signatureTimeTag
      # 显示签名区域隐藏
      - actionType: builtIn
        funcName: hide
        viewTag: signatureShowTag
      - actionType: builtIn
        funcName: show
        viewTag: signatureTag

    btnClick:
      - actionType: evalObject
        object:
          - if:
              - =..formData.whetherSignature
              - actionType: popUp
                popUpView: BaseWarningView
                wait: true
                popUpDismiss: 2000
              - continue
      - actionType: evalObject
        object:
          - .Global.formData.firstPatientConsentForm@: false
          - =.builtIn.array.add:
              dataIn:
                object: =.Global.vaccine
                value: "Patient Consent Form - HIPPA"
          - =.builtIn.array.elementUnique:
              dataIn:
                arr: =.Global.vaccine
              dataOut: PatientConsentFormEditPage1.formData.doc

      - actionType: evalObject
        object:
          - .Global.vaccine@: ""

      - actionType: evalObject
        object:
          - .Global.vaccine@: =..formData.doc
          - =..apiRequest.patientConsentForm.docAPI.store: ""
          - .Global.formData.patientConsentForm@: =..apiRequest.patientConsentForm.docResp.doc

      - actionType: evalObject
        object:
          .Global._nonce@:
            =.builtIn.math.random: ""
      - actionType: evalObject
        object:
          - =.builtIn.array.add:
              dataIn:
                object: =.Global.roomInfo.edge.name.finishDoc
                value: Patient Consent Form - HIPPA
          - goto: =.Global.formData.selectCategory

  style:
    scrollBox:
      width: "1"
      height: "0.84729"
      boxSizing: "border-box"
      overflow: "scroll"
    btnBox:
      width: "1"
      height: "0.0972"
      boxSizing: "border-box"
      overflow: "scroll"
      backgroundColor: "#ffffff"
      boxShadow: "1px 1px 4px 1px #dededf"
      textAlign:
        x: center
    btn:
      marginTop: "0.0123"
      height: "0.0443"
      width: "0.84"
      border:
        style: 1
      borderRadius: "5"
      backgroundColor: "#2988e6"
      color: "#ffffff"
      fontSize: .Nfont.h14
      boxSizing: border-box
      fontWeight: "600"
      textAlign:
        x: center
    blockBox:
      marginTop: "0.01"
      height: "auto"
      width: "0.92"
    blockBoxLeft:
      display: "inline-block"
      width: "auto"
      height: "auto"
      color: "0x666666"
      fontSize: .Nfont.h12
      verticalAlign: middle
    blockBoxRight:
      marginLeft: "0.0373"
      display: "inline-block"
      width: "auto"
      height: "auto"
      color: "0x333333"
      fontSize: .Nfont.h14
      fontWeight: "600"
      verticalAlign: middle
    secondLabel:
      width: "0.92"
      fontSize: .Nfont.h14
      fontWeight: "700"
      color: "0x333333"
      marginTop: "0.0246"
      lineHeight: "2.58vh"
    signTips:
      display: "inline-block"
      color: "#666666"
      fontSize: .Nfont.h12
      # verticalAlign: middle
      width: "0.834666"
      height: "auto"
