MyActiveProvider:
  title: "Schedule An Appointment"
  init:
    - .SignInCheck
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    - actionType: evalObject
      object:
        - actionType: evalObject
          async: true
          object:
            # 获取所有provider
            - =..apiRequest.proConnections.docAPI.get: ""
            # 获取所有facility
            - =..apiRequest.facilityConnections.docAPI.get: ""
    - .Global.formData.appointment.visitType_AppointmentSearch@: "Telemedicine"
    - ..formData.providerList@: =..apiRequest.proConnections.providerConList.doc
    - ..formData.facilityList@: =..apiRequest.facilityConnections.facilityConList.doc
    # 设置预约方式，以区分通过搜索预约
    - .Global.scheduleType@: providerDirectly

    - =.builtIn.array.getOrReplaceAnArrayItem:
        dataIn:
          strArr: =.Global.formData.currentTabStatusList
          tag: false
        dataOut: MyActiveProvider.formData.currentTab
    - if:
        - =.builtIn.array.has:
            dataIn:
              object: =..formDataTemp.tabList
              value: =..formData.currentTab
        - actionType: evalObject
          object:
            - =.builtIn.object.setProperty:
                dataIn:
                  obj: =..formDataTemp.titleData
                  label: "title"
                  text: =..formData.currentTab
                  arr: ["fontColor", "fontWeight", "block"]
                  valueArr: ["0x2988e6", "500", "block"]
                  errorArr: ["0x4b4b4b", "400", "none"]
                dataOut: MyActiveProvider.formDataTemp.titleData
            - ..formData.providerShow@: =.MyActiveProvider.formDataTemp.titleData.0.block
            - ..formData.facilitiesShow@: =.MyActiveProvider.formDataTemp.titleData.1.block
        - continue
    # 对provider列表进行除重
    - =.builtIn.array.keepLatestDoc:
        dataIn:
          docList: =..formData.providerList
          path: bsig
        dataOut: MyActiveProvider.formData.providerList
    # 根据与何静商量，not remind在此处置为false以便于下一个页面关于admin更改patient profile弹框的弹出判断。
    - .Global.formData.meetingStatus.notRemind@: false
  apiRequest:
    # get all facilitys which provider belongs to
    facility:
      docQueryResp: ""
      docQueryReq:
        ObjType: 12
        id: ""
        xfname: E.bvid|E.evid
        sCondition: "E.type=10002 AND E.tage=1 AND E.subtype&0xff0000=0x30000"
        type: .DocType.FacilityProfile
        _nonce: =.Global._nonce
      docAPI:
        get:
          api: rd
          dataIn: MyActiveProvider.apiRequest.facility.docQueryReq
          dataOut: MyActiveProvider.apiRequest.facility.docQueryResp
    proConnections:
      # get all provider public profile
      providerConList: ""
      docAPI:
        get:
          api: rd
          type: .DocType.DoctorPublicProfile
          xfname: (E.bvid|E.evid)&!(D.ovid)
          id: .Global.currentUser.vertex.id
          ObjType: 12
          obfname: mtime
          dataOut: MyActiveProvider.apiRequest.proConnections.providerConList
          sCondition: E.type=10002 AND E.tage>0 #D.size>10 #accept tage=1
          _nonce: =.Global._nonce
    # 获取所有和patient是好友的facility
    facilityConnections:
      facilityConList: ""
      docQueryReq:
        type: 271361
        xfname: E.bvid|E.evid
        id: .Global.currentUser.vertex.id
        ObjType: 12
        sCondition: E.type=10002 AND E.tage>0 AND E.subtype&0xff0000=0x20000 #accept tage=1
        _nonce: =.Global._nonce
      docAPI:
        get:
          api: rd
          dataIn: MyActiveProvider.apiRequest.facilityConnections.docQueryReq
          dataOut: MyActiveProvider.apiRequest.facilityConnections.facilityConList
          
  formData:
    currentTab: []
    providerList: []
    facilityList: []
    tempData: ""
    providerShow: "block"
    facilitiesShow: "none"
  formDataTemp:
    tabList: ["Providers", "Medical Facilities"]
    titleData:
      - title: Providers
        fontColor: "0x2988e6"
        fontWeight: "500"
        block: "block"
      - title: Medical Facilities
        fontColor: "0x4b4b4b"
        fontWeight: "400"
        block: "none"
  components:
    - .BasePublicHeader:
      children:
        - .BasePublicHeaderLeft:
        - .BasePublicHeaderTitle:
    - type: view
      style:
        width: "1"
        height: "0.07"
        backgroundColor: "0x2988e6"
        overflow: hidden
      children:
        - type: view
          style:
            marginTop: "0.0123"
            marginLeft: "0.05"
            width: "0.9"
            height: "0.04"
            backgroundColor: "0xffffff"
            borderRadius: "8"
            boxSizing: "border-box"
            overflow: hidden
            textAlign:
              y: center
          children:
            - type: view
              style:
                marginLeft: "0.02"
                display: "inline-block"
                height: "0.018"
                verticalAlign: middle
            - type: label
              text: Find A Doctor
              style:
                marginLeft: "0.02"
                verticalAlign: middle
                display: "inline-block"
                fontSize: .Nfont.h14
                border:
                  style: 1
                height: "0.04"
                color: "0x2988e6"
                boxSizing: "border-box"
                width: "0.8"
                lineHeight: "4vh"
              onClick:
                - goto: AppointmentSearch
    - type: view
      style:
        height: "auto"
        width: "1"
        overflow: hidden
      children:
        - type: list
          viewTag: tabTag
          contentType: listObject
          listObject: ..formDataTemp.titleData
          iteratorVar: itemObject
          style:
            width: "1"
            margin: "0"
            axis: horizontal
            height: "auto"
            overflow: hidden
            marginTop: "0.02"
          children:
            - type: listItem
              itemObject:
              style:
                width: "0.5"
                height: "auto"
              children:
                - type: label
                  dataKey: itemObject.title
                  style:
                    color: itemObject.fontColor
                    height: "auto"
                    width: "0.5"
                    fontWeight: itemObject.fontWeight
                    textAlign:
                      x: center
                    fontSize: .Nfont.h16
                - type: view
                  style:
                    marginTop: "0.005"
                    height: "0.0025" #2.03px
                    width: "0.5"
                    backgroundColor: "0xdededf"
                - type: view
                  viewTag: leftBlockTag
                  style:
                    display: itemObject.block
                    top: "0.031"
                    left: "0.2"
                    width: "0.08"
                    height: "0.0025"
                    backgroundColor: "0x2988e6"
                    zIndex: 10
              onClick:
                - emit:
                    dataKey:
                      var: itemObject
                    actions:
                      - ..formData.tempData@: $var.title
                      - =.builtIn.object.setProperty:
                          dataIn:
                            obj: =..formDataTemp.titleData
                            label: "title"
                            text: $var.title
                            arr: ["fontColor", "fontWeight", "block"]
                            valueArr: ["0x2988e6", "500", "block"]
                            errorArr: ["0x4b4b4b", "400", "none"]
                      # 保存当前tab栏状态
                      - =.builtIn.array.getOrReplaceAnArrayItem:
                          dataIn:
                            strArr: =.Global.formData.currentTabStatusList
                            tag: true
                            index: 0
                            value: $var.title
                          dataOut: Global.formData.currentTabStatusList
                - actionType: evalObject
                  object:
                    - if:
                        - =.builtIn.string.equal:
                            dataIn:
                              string1: =..formData.tempData
                              string2: "Medical Facilities"
                        - .Global.scheduleType@: thoughFacility
                        - .Global.scheduleType@: providerDirectly
                    - ..formData.providerShow@: =.MyActiveProvider.formDataTemp.titleData.0.block
                    - ..formData.facilitiesShow@: =.MyActiveProvider.formDataTemp.titleData.1.block
                - actionType: builtIn
                  funcName: redraw
                  viewTag: tabTag
                - actionType: builtIn
                  funcName: redraw
                  viewTag: showVT
    - type: view
      viewTag: showVT
      style:
        width: "1"
        height: "auto"
        marginTop: "0"
        display: ..formData.providerShow
      children:
        # Providers
        - type: scrollView
          style:
            width: "1"
            height: "0.82"
            boxSizing: "border-box"
            paddingBottom: "0.03"
          children:
            - type: list
              viewTag: providersTag
              contentType: listObject
              listObject: ..formData.providerList
              iteratorVar: itemObject
              style:
                # width: "1"
                # height: "0.82"
                # overflow: scroll
              children:
                - type: listItem
                  itemObject: ""
                  style:
                    width: "1"
                    height: "auto"
                    margin: "0"
                    border:
                      style: "2"
                    borderWidth: "1"
                    borderColor: "0xdededf"
                    overflow: hidden
                  onClick:
                    - actionType: updateObject
                      dataKey: Global.ActiveProvider
                      dataObject: itemObject
                    - actionType: evalObject
                      object:
                        .Global._nonce@:
                          =.builtIn.math.random: ""
                    - actionType: evalObject
                      object:
                        # if facilities of provider is more than one, enter the ChooseFacilities page
                        - ..apiRequest.facility.docQueryReq.id@: =.Global.ActiveProvider.bsig
                        - =..apiRequest.facility.docAPI.get: ""
                        - if:
                            - =.builtIn.array.judgeListLength:
                                dataIn:
                                  array: =..apiRequest.facility.docQueryResp.doc
                                  len: 1
                            - actionType: evalObject
                              object:
                                - .Global.currentFacility@: =..apiRequest.facility.docQueryResp.doc.0
                                - goto: MobileContacts3
                            - actionType: evalObject
                              object:
                                - .Global.formData.facilityProfileList@: =..apiRequest.facility.docQueryResp.doc
                                - goto: ChooseFacilities
                  children:
                    - type: view
                      style:
                        marginTop: "0.0198" #16.08px
                        marginLeft: "0.0427" #16.01px
                        height: "auto"
                        width: "0.91"
                      children:
                        - type: view
                          style:
                            verticalAlign: middle
                            display: "inline-block"
                            height: "12vw" #45px
                            width: "12vw" #45px
                            overflow: hidden
                          children:
                            - type: image
                              path: providerImage.svg
                              path=func: .builtIn.utils.prepareDocToPath
                              dataKey: itemObject.name.data.avatar
                              style:
                                height: "12vw" #45px
                                width: "12vw" #45px
                        - type: view
                          style:
                            verticalAlign: middle
                            marginLeft: "0.064"
                            display: "inline-block"
                            height: "auto"
                            width: "0.71"
                            overflow: hidden
                          children:
                            - type: view
                              style:
                                width: "0.71"
                                height: "auto"

                                verticalAlign: middle
                              children:
                                - type: label
                                  dataKey: itemObject.name.data.fullName
                                  style:
                                    display: "inline-block"
                                    verticalAlign: middle
                                    height: "auto"
                                    width: "auto"
                                    fontSize: .Nfont.h16
                                    wordWrap: break-word
                                    fontWeight: "600"
                                - type: label
                                  text: "&nbsp;-&nbsp;"
                                  style:
                                    display: "inline-block"
                                    verticalAlign: middle
                                    height: "auto"
                                    width: "auto"
                                    fontSize: .Nfont.h16
                                    fontWeight: "600"
                                - type: label
                                  dataKey: itemObject.name.data.title
                                  style:
                                    display: "inline-block"
                                    verticalAlign: middle
                                    height: "auto"
                                    width: "auto"
                                    fontSize: .Nfont.h16
                                    wordWrap: break-word
                                    fontWeight: "600"
                            - type: label
                              dataKey: itemObject.name.data.selectedSpecialty.0
                              style:
                                marginTop: "0.005"
                                width: "0.71"
                                height: "auto"
                                fontSize: .Nfont.h14
                                color: "#333333"

                                verticalAlign: middle
                                wordWrap: break-word
                    - type: view
                      style:
                        height: "0.0198" #16.08px
                        width: "1"
    - type: view
      viewTag: showVT
      style:
        width: "1"
        height: "auto"
        marginTop: "0"
        display: ..formData.facilitiesShow
      children:
        # facilitys
        - type: scrollView
          style:
            width: "1"
            height: "0.82"
            margin: "0"
            overflow: scroll
            boxSizing: "border-box"
            paddingBottom: "0.03"
          children:
            - type: list
              viewTag: facilitysTag
              contentType: listObject
              listObject: ..formData.facilityList
              iteratorVar: itemObject
              style:
                # width: "1"
                # height: "0.82"
                # margin: "0"
                # overflow: scroll
              children:
                - type: listItem
                  itemObject: ""
                  style:
                    width: "1"
                    height: "auto"
                    margin: "0"
                    border:
                      style: "2"
                    borderWidth: "1"
                    borderColor: "0xdededf"
                    overflow: hidden
                  onClick:
                    - actionType: updateObject
                      dataKey: Global.currentFacility
                      dataObject: itemObject
                    - goto: ChooseProviders
                  children:
                    - type: view
                      style:
                        marginTop: "0.0198" #16.08px
                        marginLeft: "0.0427" #16.01px
                        height: "auto"
                        width: "0.91"
                      children:
                        - type: view
                          style:
                            verticalAlign: middle
                            display: "inline-block"
                            height: "12vw" #45px
                            width: "12vw" #45px
                            overflow: hidden
                          children:
                            - type: image
                              path: office-building.png
                              path=func: .builtIn.utils.prepareDocToPath
                              dataKey: itemObject.name.data.basicInfo.businessLogo
                              style:
                                height: "12vw" #45px
                                width: "12vw" #45px
                        - type: view
                          style:
                            verticalAlign: middle
                            marginLeft: "0.064"
                            display: "inline-block"
                            height: "auto"
                            width: "0.71"
                            overflow: hidden
                          children:
                            - type: label
                              dataKey: itemObject.name.data.basicInfo.medicalFacilityName
                              style:
                                width: "0.71"
                                height: "auto"
                                fontSize: .Nfont.h16

                                verticalAlign: middle
                                wordWrap: break-word
                                fontWeight: "600"
                            - type: label
                              dataKey: itemObject.name.data.basicInfo.businessType
                              style:
                                marginTop: "0.005"
                                width: "0.71"
                                height: "auto"
                                fontSize: .Nfont.h14
                                color: "#333333"

                                verticalAlign: middle
                                wordWrap: break-word
                    - type: view
                      style:
                        height: "0.0198" #16.08px
                        width: "1" #16.08px
