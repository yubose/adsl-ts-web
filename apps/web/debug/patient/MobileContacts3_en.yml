MobileContacts3:
  title: "Schedule An Appointment"
  init:
    - .SignInCheck

    # 当用户回到这个页面后置空所有已填文档
    # - .ClearDocBeforeCreateMeeting
    # 置空可选文档
    - .Global.optionalForms@: []
    # 置空financial form
    - .Global.formData.patientDoc.financialForm@: ""
    # 置空patient chart
    - .Global.formData.patientChart@: ""
    # 置空 cov19Test
    - .Global.formData.cov19Test@: ""
    #  清空newPatientForm
    - .Global.formData.newPatientForm@: ""
    #  清空cov19TestNewPatForm
    - .Global.formData.cov19TestNewPatForm@: ""
    #  清空cov19TestForm
    - .Global.formData.cov19TestForm@: ""
    # 清空modernaVaccineFirDoseForm
    - .Global.formData.modernaVaccineFirDoseForm@: ""
    # 清空modernaVaccineSecDoseForm
    - .Global.formData.modernaVaccineSecDoseForm@: ""
    #  清空pifzerVaccineFirDoseForm
    - .Global.formData.pifzerVaccineFirDoseForm@: ""
    #  清空pifzerVaccineSecDoseForm
    - .Global.formData.pifzerVaccineSecDoseForm@: ""
    - .Global.formData.fluVaccinationConsentForm@: ""
    #
    - .Global.formData.patientConsentForm@: ""
    - .Global.formData.back_InsuranceCard@: ""
    - .Global.formData.front_IDCard@: ""
    - .Global.formData.front_InsuranceCard@: ""
    - .Global.formData.visitQuestionnaireDoc@: ""
    - .Global.formData.pifzerBioNTech@: ""
    - .Global.formData.moderna@: ""
    - .Global.formData.signature_moderna@: ""
    # 置空已经填完的doc名称数组
    - .Global.vaccine@: []
    # 置空已经填完的doc数组
    - .Global.vaccineDoc@: []

    # 当用户回到这个页面后置空所有状态信息
    # - .ClearStatusBeforeCreateMeeting

    # 将FinancialForm已经填完的状态置空
    - .Global.formData.patientDoc.status.shareFinancialForm@: false
    # 将patient chart已经填完的状态置空
    - .Global.formData.patientDoc.status.sharePatientChart@: false
    # 将visit Questionnaire已经填完的状态置空
    - .Global.visitQuestionnaireDoc@: ""
    - .Global.formData.firstToCov19Test@: true
    - .Global.formData.firstToCov19TestForm@: true
    - .Global.formData.firstToCov19TestNewPatForm@: true
    # 重置firstToNewPatientForm状态
    - .Global.formData.firstToNewPatientForm@: true
    # 重置firstToNewPatientForm状态
    - .Global.formData.firstToPfizerVaccineFirDoseForm@: true
    - .Global.formData.firstToPfizerVaccineSecDose@: true
    # 重置firstToModernaVaccineSecDoseForm状态
    - .Global.formData.firstToModernaVaccineFirDoseForm@: true
    - .Global.formData.firstToModernaVaccineSecDoseForm@: true
    - .Global.formData.firstFluVaccinationConsentForm@: true
    # 重置 firstPatientConsentForm 状态
    - .Global.formData.firstPatientConsentForm@: true
    # 清空会议视频信息
    - .Global.roomInfoDoc.document@: ""

    # 进入新会议前初始化各文档的DM
    - .InitDocDM

    # judge if user from Appointment Search
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.formData.appointment.visitType_AppointmentSearch
              string2: Telemedicine
        - ..formData.visitType@: Telemedicine
        - ..formData.visitType@: Office Visit

    # 如果是从搜索页面进入，则不需要重置日历时间，而是自动代入之前搜索时选择的时间
    - if:
        - =.Global.formData.comeFromSearch
        - actionType: evalObject
          object:
            - .MobileContacts3.calendarDate.month@: =.BaseComponents.calendarDate.month
            - .MobileContacts3.calendarDate.year@: =.BaseComponents.calendarDate.year
            - .MobileContacts3.calendarDate.day@: =.BaseComponents.calendarDate.day
            - .MobileContacts3.calendarDate.monthName@: =.BaseComponents.calendarDate.monthName
            - .MobileContacts3.calendarDate.todayDate@: =.BaseComponents.calendarDate.todayDate
        - actionType: evalObject
          object:
            - .BaseComponents.calendarDate.year@: ""
            - .BaseComponents.calendarDate.month@: ""
            - .BaseComponents.calendarDate.day@: ""
            - .BaseComponents.calendarDate.monthName@: ""
            - .BaseComponents.calendarDate.todayDate@: ""
    - .BaseComponents.calendarDate.flag@: ""
    - .BaseComponents.calendarDate.dayLable@: []
    - .BaseComponents.year@: []
    - .BaseComponents.flag: ""

    #生成年份
    - =.builtIn.date.generateYear:
        dataIn:
          last: 121
          next: 10
        dataOut: BaseComponents.year
    - =.builtIn.date.getYear:
        dataIn:
        dataOut: MobileContacts3.calendarDate.year

    #获取当前时间的unix时间戳
    - =.builtIn.date.getNowLocalUnixTime:
        dataIn: ""
        dataOut: MobileContacts3.formData.currentLocalTime

    # 根据不同的waiting room type类型来给E1的subtype赋值
    - =.builtIn.array.getValueByKey:
        dataIn:
          array: =.AppointmentType
          key1: text
          value: =..formData.visitType
          key2: type
        dataOut: MobileContacts3.formData.currentSubtype
    - =.builtIn.math.add:
        dataIn:
          num1: =..formData.currentSubtype
          num2: 1
        dataOut: MobileContacts3.formData.currentSubtype
    # 根据E1求出E3的值
    - =.builtIn.number.inhx:
        dataIn:
          intHex: =..formData.currentSubtype
          index: 2
          hex: 1
        dataOut: MobileContacts3.formData.E3Subtype
    - =.builtIn.string.concat:
        dataIn:
          - "subtype = "
          - =..formData.E3Subtype
        dataOut: MobileContacts3.apiRequest.E3.edgeQueryReq.sCondition
    - actionType: evalObject
      object:
        - actionType: evalObject
          async: true
          object:
            # 获取当前facility的所有location
            - =..apiRequest.locations.docAPI.get: ""
            - =..apiRequest.E3.edgeAPI.get: ""
            # 获取预约原因
            - =..VisitReason.docAPI.get: ""
    - =.builtIn.array.pushAny:
        dataIn:
          newMessage: =..apiRequest.E3.edgeQueryResp.edge.0.id
          messages: =..apiRequest.getFirstAvail.edge.id
        dataOut: MobileContacts3.apiRequest.getFirstAvail.edge.id
    #设置可预约时间的scondition
    # 这个列表我们筛选出的是离今天最近的有可预约时间的日期，可能是今天，也可能是任何一天， 然后我们拿到日期之后需要刷新日历、并把获取的日期赋值给我们真正想请求的日期
    - =.builtIn.string.concat:
        dataIn:
          - "(etime>"
          - =..formData.currentLocalTime
          - ")"
          - " AND "
          - "subtype="
          - =..formData.currentSubtype
        dataOut: MobileContacts3.formData.getFirstAvailScondition
    - ..apiRequest.getFirstAvail.edge.sCondition@: =..formData.getFirstAvailScondition
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    # 获取最近可预约时间段
    - =.MobileContacts3.apiRequest.getFirstAvail.edgeAPI.get: ""
    - if:
        # 判断有没有查回可预约时间
        - =..apiRequest.getFirstAvail.response.edge.0
        # 如果有，跳转到有预约的那天
        - actionType: evalObject
          object:
            - =.builtIn.date.stampToDay:
                dataIn:
                  timeStamp: =..apiRequest.getFirstAvail.response.edge.0.stime
                dataOut: MobileContacts3.formData.adjacentEdgeTime
            - .MobileContacts3.calendarDate.year@: =.MobileContacts3.formData.adjacentEdgeTime.year
            - .MobileContacts3.calendarDate.month@: =.MobileContacts3.formData.adjacentEdgeTime.month
            - .MobileContacts3.calendarDate.day@: =.MobileContacts3.formData.adjacentEdgeTime.day
        # 如果没有，获取当天时间
        - actionType: evalObject
          object:
            - =.builtIn.date.getMonth:
                dataIn: ""
                dataOut: MobileContacts3.calendarDate.month
            - =.builtIn.date.getYear:
                dataIn: ""
                dataOut: MobileContacts3.calendarDate.year
            - =.builtIn.date.getDate:
                dataIn: ""
                dataOut: MobileContacts3.calendarDate.day
    # 将月份从数字转成名称以便展示
    - =.builtIn.date.transformMonth:
        dataIn:
          month: =..calendarDate.month
        dataOut: MobileContacts3.calendarDate.monthName
    # 生成日历指定的日期
    - =.builtIn.string.concat:
        dataIn:
          - =..calendarDate.year
          - "-"
          - =..calendarDate.month
          - "-"
          - =..calendarDate.day
        dataOut: MobileContacts3.calendarDate.todayDate
    # 获取日历指定日期的时间戳，即最近可预约的时间戳，分别当天0.00和24.00两个时间戳
    - =.builtIn.date.getTimeStampOfDate:
        dataIn:
          date: =..calendarDate.todayDate
        dataOut: MobileContacts3.calendarDate.todayStamp
    # 筛选出真正有预约时间的日期 并作为 query的scondition
    - =.builtIn.string.concat:
        dataIn:
          - "(stime<="
          - =..calendarDate.todayStamp.start
          - " AND "
          - "etime>"
          - =..calendarDate.todayStamp.start
          - " OR "
          - "stime>="
          - =..calendarDate.todayStamp.start
          - " AND "
          - "etime<="
          - =..calendarDate.todayStamp.end
          - " OR "
          - "stime<"
          - =..calendarDate.todayStamp.end
          - " AND "
          - "etime>="
          - =..calendarDate.todayStamp.end
          - ")"
          - " AND "
          - "subtype="
          - =..formData.currentSubtype
        dataOut: MobileContacts3.formData.scheduleScondition
    # 拼接显示日期：如Friday April 29,2022
    - =.builtIn.date.ShowDateByNumber:
        dataIn:
          year: =..calendarDate.year
          month: =..calendarDate.month
          day: =..calendarDate.day
        dataOut: MobileContacts3.selectDate
    # 生成横向具体日期轴
    - =.builtIn.date.miniWeeklyCalendarArray:
        dataIn:
          year: =..calendarDate.year
          month: =..calendarDate.month
          today: =..calendarDate.day
          markDay: =..calendarDate.day
          color: "0x4b4b4b"
          backgroundColor: "0xffffff00"
          todayColor: "0xffffff"
          todayBackgroundColor: "0x2988e6"
          currentDateTime: =..calendarDate.todayDate
          pastTimeColor: "0xbababa"
        dataOut: MobileContacts3.calendarDate.dayLable
    - =.builtIn.array.push:
        dataIn:
          newMessage: =..apiRequest.E3.edgeQueryResp.edge.0.id
          messages: =..schedule.edge.id
        dataOut: MobileContacts3.schedule.edge.id
    # 查询可预约时间
    - =..schedule.get: ""
    # 将office visit原因提取到列表以便后续展示
    - =.builtIn.array.convertToList:
        dataIn:
          array: =..VisitReason.response.doc.0.name.data.reasonForVisit.OfficeVisits
          key: reason
        dataOut: MobileContacts3.formData.officeVisit
    # 用来存放提取出的telemedicine原因提取到列表以便后续展示
    - =.builtIn.array.convertToList:
        dataIn:
          array: =..VisitReason.response.doc.0.name.data.reasonForVisit.Telemedicine
          key: reason
        dataOut: MobileContacts3.formData.telemedicineTemp
    # 默认展示telemedicine的原因
    - ..reasonForVisit@: =..formData.telemedicineTemp
    # 默认将原因列表的第一项作为当前所选择的原因
    - ..reason@: =..reasonForVisit.0
    # 提取fee
    - =.builtIn.array.getByKey:
        dataIn:
          array: =..VisitReason.response.doc.0.name.data.reasonForVisit.Telemedicine
          key1: reason
          value: =..reason
          key2: fee
        dataOut: MobileContacts3.formData.fee
    # 提取duration
    - =.builtIn.array.getByKey:
        dataIn:
          array: =..VisitReason.response.doc.0.name.data.reasonForVisit.Telemedicine
          key1: reason
          value: =..reason
          key2: duration
        dataOut: MobileContacts3.duration
    # 将duration从字符串转为数字类型
    - =.builtIn.string.retainNumber:
        dataIn:
          value: =..duration
        dataOut: MobileContacts3.duration
    # 提取 document
    - =.builtIn.array.getByKey:
        dataIn:
          array: =..VisitReason.response.doc.0.name.data.reasonForVisit.Telemedicine
          key1: reason
          value: =..reason
          key2: document
        dataOut: MobileContacts3.docu
    # 切分可预约时间片
    - =.builtIn.date.splitTime:
        dataIn:
          object2: =..schedule.scheduleList.edge
          timeSlot: =..duration
          year: =..calendarDate.year
          month: =..calendarDate.month
          day: =..calendarDate.day
          isSplitCurrent: true
          delayTime: 1800
        dataOut: MobileContacts3.splitTime
    # 获取当前时间的时间戳
    - =.builtIn.date.getTime:
        dataIn:
        dataOut: MobileContacts3.nowTimeStamp
    - ..formData.locations@: =..apiRequest.locations.docQueryResp.doc.0.name.data.allLocation
    # 获取所有的location name列表以便用户选择office visit的时候展示
    - =.builtIn.array.getListByKey:
        dataIn:
          array: =..formData.locations
          keyId: medicalFacilityName
        dataOut: MobileContacts3.formData.locationNameList
    # 如果是从search入口进入的，则保留之前选择的location
    - if:
        - =.Global.formData.comeFromSearch
        - ..formData.locationName@: =.Global.ActiveLocation.name.data.basicInfo.medicalFacilityName
        - ..formData.locationName@: =..formData.locationNameList.0
    - =.builtIn.array.getByKey:
        dataIn:
          array: =..formData.locations
          key1: medicalFacilityName
          value: =..formData.locationName
          key2: id
        dataOut: MobileContacts3.formData.locationId
    #获取选择的location的profile
    - if:
        - =..formData.locationId
        - actionType: evalObject
          object:
            - ..apiRequest.location.docQueryReq.id@: =..formData.locationId
            - =..apiRequest.location.docAPI.get: ""
            - .Global.ActiveLocation@: =..apiRequest.location.docQueryResp.doc.0
        - continue
    # 控制location区域显示
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =..formData.visitType
              string2: "Office Visit"
        - actionType: evalObject
          object:
            - ..formData.splitTimeHeight@: "0.38"
            - ..formData.flag@: "block"
        - actionType: evalObject
          object:
            - ..formData.splitTimeHeight@: "0.47"
            - ..formData.flag@: "none"
    # 兼容老账户
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.formData.appointment.visitType_AppointmentSearch
              string2: Office Visits
        - .Global.formData.appointment.visitType_AppointmentSearch@: Office Visit
        - continue
    # 如果从搜索入口进入且类型为office visit，则将E1.bvid改成location.id
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.formData.appointment.visitType_AppointmentSearch
              string2: Office Visit
        - actionType: evalObject
          object:
            - =.builtIn.array.removeByValue:
                dataIn:
                  object: =..schedule.edge.id
                  value: =.Global.currentFacility.bsig
            - =.builtIn.array.add:
                dataIn:
                  object: =.MobileContacts3.schedule.edge.id
                  value: =..formData.locationId
            # 根据不同的waiting room type类型来给E1的subtype赋值
            - =.builtIn.array.getValueByKey:
                dataIn:
                  array: =.AppointmentType
                  key1: text
                  value: =.Global.formData.appointment.visitType_AppointmentSearch
                  key2: type
                dataOut: MobileContacts3.formData.currentSubtype
            - =.builtIn.math.add:
                dataIn:
                  num1: =..formData.currentSubtype
                  num2: 1
                dataOut: MobileContacts3.formData.currentSubtype
            # 重新拼接查询语句
            - =.builtIn.string.concat:
                dataIn:
                  - "(stime<="
                  - =..calendarDate.todayStamp.start
                  - " AND "
                  - "etime>"
                  - =..calendarDate.todayStamp.start
                  - " OR "
                  - "stime>="
                  - =..calendarDate.todayStamp.start
                  - " AND "
                  - "etime<="
                  - =..calendarDate.todayStamp.end
                  - " OR "
                  - "stime<"
                  - =..calendarDate.todayStamp.end
                  - " AND "
                  - "etime>="
                  - =..calendarDate.todayStamp.end
                  - ")"
                  - " AND "
                  - "subtype="
                  - =..formData.currentSubtype
                dataOut: MobileContacts3.formData.scheduleScondition
            # 置空时间片
            - .MobileContacts3.splitTime@: []
            # 置空查询的edge
            - ..schedule.scheduleList.edge@: []
            # 清除缓存
            - .Global._nonce@:
                =.builtIn.math.random: ""
            # 重新查询时间片
            - =..schedule.get: ""
            # 将原因列表改成office visit的原因
            - ..reasonForVisit@: =..formData.officeVisit
            - ..reason@: =..reasonForVisit.0
            # 提取duration
            - =.builtIn.array.getByKey:
                dataIn:
                  array: =..VisitReason.response.doc.0.name.data.reasonForVisit.OfficeVisits
                  key1: reason
                  value: =..reason
                  key2: duration
                dataOut: MobileContacts3.duration
            # 提取fee
            - =.builtIn.array.getByKey:
                dataIn:
                  array: =..VisitReason.response.doc.0.name.data.reasonForVisit.OfficeVisits
                  key1: reason
                  value: =..reason
                  key2: fee
                dataOut: MobileContacts3.formData.fee
            # 提取 document
            - =.builtIn.array.getByKey:
                dataIn:
                  array: =..VisitReason.response.doc.0.name.data.reasonForVisit.Telemedicine
                  key1: reason
                  value: =..reason
                  key2: document
                dataOut: MobileContacts3.docu
            - =.builtIn.string.retainNumber:
                dataIn:
                  value: =..duration
                dataOut: MobileContacts3.duration
            - =.builtIn.date.splitTime:
                dataIn:
                  object2: =..schedule.scheduleList.edge
                  timeSlot: =..duration
                  year: =..calendarDate.year
                  month: =..calendarDate.month
                  day: =..calendarDate.day
                  isSplitCurrent: true
                  delayTime: 1800
                dataOut: MobileContacts3.splitTime
        - continue
    # 将从搜索入口进入的状态置为false
    - .Global.formData.comeFromSearch@: false
  splitTime:
    morning: []
    afternoon: []
  # 在Reason for visit下拉框中显示的reason
  reasonForVisit: []
  temporaryInfo: ""
  # 当前所选择的原因
  reason: ""
  duration: ""
  selectDate: ""
  visitType: "Telemedicine"
  docu: []
  clock: ""
  # rv facility vertex
  currentFaciVertex:
    vertexResp: ""
    vertexIn:
      ObjType: 4
      id: ""
      xfname: "E.evid"
      sCondition: "E.type=1100 AND V.type=20"
      _nonce: =.Global._nonce
      maxcount: "1"
      obfname: ctime
    vertexAPI:
      get:
        api: rv
        dataIn: currentFaciVertex.vertexIn
        dataOut: MobileContacts3.currentFaciVertex.vertexResp
  VisitReason:
    response: ""
    document:
      ObjType: 8
      ids:
        - .Global.ActiveProvider.bsig
        - .Global.currentFacility.bsig
      xfname: (bvid,evid)|(evid,bvid)
      sCondition: E.type=10002
      type: .DocType.VisitReason
      obfname: mtime
      name:
        data:
          reasonForVisit:
            Telemedicine: []
            OfficeVisits: []
    docAPI:
      get:
        api: rd
        dataIn: MobileContacts3.VisitReason.document
        dataOut: MobileContacts3.VisitReason.response
  formData:
    # 当前选择的预约类型
    visitType: ""
    # 查询当天可预约的时间的scondition
    scheduleScondition: ""
    # 查询最近预约的scondition
    getFirstAvailScondition: ""
    display:
      adminEditPatientProfile: ""
    # 当前选择的location的id
    locationId: ""
    # 当前选择的location名称
    locationName: ""
    # 所有location组成的列表
    locations: []
    # 所有location name组成的列表
    locationNameList: []
    flag: "none"
    splitTimeHeight: "0.47"
    temporarySplitTime: []
    adjacentEdgeTime: ""
    doctorId: .Global.ActiveProvider.bsig
    rootnootbookInfo:
    rootnootbookId: ""
    # 当前E1对应E3的值
    E3Subtype: ""
    # 当前E1的值
    currentSubtype: "196609"
    currentLocalTime: ""
    isApiRequest:
      id: ""
    nextBtnColor: "0xc1c1c1"
    # 用来存放提取出的office visit reason list以便展示
    officeVisit: ""
    # 用来存放提取出的telemedicine reason list以便展示
    telemedicineTemp: ""
    fee: ""
  checkData:
    check:
      edge: ""
    get:
      edgeAPI.get: ""
      api: re
      dataKey: checkData.check
      id:
        - .Global.ActiveProvider.bsig
        - .Global.ActiveProvider.bsig
      xfname: bvid,evid
      type: 40000
      sCondition: "subtype=196609"
      _nonce: =.Global._nonce
  save:
    - =.MobileContacts3.newAppointment.edgeAPI.store: ""
  schedule:
    response: ""
    scheduleList: ""
    edge:
      type: 40000
      id:
        - .Global.ActiveProvider.bsig
        - .Global.currentFacility.bsig
      sCondition: =..formData.scheduleScondition
      maxcount: "10000"
      xfname: refid,evid,bvid
      obfname: "stime"
      asc: true
      _nonce: =.Global._nonce
    get:
      api: re
      dataIn: MobileContacts3.schedule.edge
      dataOut: MobileContacts3.schedule.scheduleList
  todaySchedule: ""
  calendarDate:
    month: ""
    year: ""
    day: ""
    dayLable: []
    weekLabel:
      - key: SU
      - key: MO
      - key: TU
      - key: WE
      - key: TH
      - key: FR
      - key: SA
    todayDate: "YYYY-MM-DD"
    monthName: ""
    tempDate: ""
    # calendarDate:
    Scondition: ""
    todayStamp: ""

  nowTimeStamp: ""
  apiRequest:
    # 查回最新的E3
    E3:
      edgeQueryResp: ""
      edgeQueryReq:
        id:
          - .Global.currentFacility.bsig
          - .Global.ActiveProvider.bsig
        xfname: bvid,evid
        type: .EdgeType.WaitingRoom
        maxcount: 1
        obfname: mtime
        sCondition: ""
      edgeAPI:
        get:
          api: re
          dataIn: MobileContacts3.apiRequest.E3.edgeQueryReq
          dataOut: MobileContacts3.apiRequest.E3.edgeQueryResp
    hashTagFromRelationProfile:
      docQueryResp: ""
      docQueryReq:
        id: []
        xfname: reid
        maxcount: 1
        obfname: mtime
        type: .DocType.HashTag
        _nonce: .Global._nonce
      docAPI:
        get:
          api: rd
          dataIn: MobileContacts3.apiRequest.hashTagFromRelationProfile.docQueryReq
          dataOut: MobileContacts3.apiRequest.hashTagFromRelationProfile.docQueryResp
    profileFromRelation:
      docQueryResp: ""
      docQueryReq:
        ObjType: 8
        type: .DocType.PatientProfile
        maxcount: 1
        obfname: mtime
        _nonce: .Global._nonce
        id:
          - .Global.currentUser.vertex.id
          - .Global.currentFacility.bsig
        xfname: (E.bvid,E.evid)|(E.evid,E.bvid)
        sConditon: E.type=10002 AND E.tage>0
      docAPI:
        get:
          api: rd
          dataIn: MobileContacts3.apiRequest.profileFromRelation.docQueryReq
          dataOut: MobileContacts3.apiRequest.profileFromRelation.docQueryResp
    clockBvid:
      vertexQueryResp: ""
      vertexQueryReq:
        id: ""
      vertexAPI:
        get:
          api: rv
          dataIn: MobileContacts3.apiRequest.clockBvid.vertexQueryReq
          dataOut: MobileContacts3.apiRequest.clockBvid.vertexQueryResp
    # judge the facility open payment function or not
    openPayment:
      docQueryResp: ""
      docQueryReq:
        ObjType: 8
        id: .Global.currentFacility.bsig
        xfname: E.evid
        type: .DocType.PaymentSettings
        sCondition: E.type=1113
      edgeAPI:
        get:
          api: rd
          dataIn: MobileContacts3.apiRequest.openPayment.docQueryReq
          dataOut: MobileContacts3.apiRequest.openPayment.docQueryResp
    #获取当前选择的location的facility
    location:
      docQueryResp: ""
      docQueryReq:
        id: ""
        xfname: ovid
        type: .DocType.FacilityProfile
        obfname: mtime
        maxcount: "1"
        _nonce: =.Global._nonce
      docAPI:
        get:
          api: rd
          dataIn: MobileContacts3.apiRequest.location.docQueryReq
          dataOut: MobileContacts3.apiRequest.location.docQueryResp
    #获取最近可预约时间段
    getFirstAvail:
      response: ""
      edge:
        type: 40000
        id:
          - .Global.ActiveProvider.bsig
          - .Global.currentFacility.bsig
        sCondition: ""
        maxcount: "1"
        xfname: "evid,bvid,refid"
        obfname: "stime"
        asc: true
        _nonce: =.Global._nonce
      edgeAPI:
        get:
          .EdgeAPI.get: ""
          api: re
          dataIn: MobileContacts3.apiRequest.getFirstAvail.edge
          dataOut: MobileContacts3.apiRequest.getFirstAvail.response
    # rd currentFacilityDoc
    currentFacilityDoc:
      docResp: ""
      docReq:
        id: ""
        obfname: "ctime"
        maxcount: "1"
        xfname: ovid
        type: .DocType.FacilityProfile
        _nonce: =.Global._nonce
      docAPI:
        get:
          api: rd
          dataIn: MobileContacts3.apiRequest.currentFacilityDoc.docReq
          dataOut: MobileContacts3.apiRequest.currentFacilityDoc.docResp
    # get all locations
    locations:
      docQueryResp: ""
      docQueryReq:
        ObjType: 8
        id: .Global.currentFacility.bsig
        type: .DocType.LocationOfFacility
        xfname: E.bvid
        sCondition: E.type=10000
        obfname: ctime
        _nonce: =.Global._nonce
        maxcount: "1"
      docAPI:
        get:
          api: rd
          dataIn: MobileContacts3.apiRequest.locations.docQueryReq
          dataOut: MobileContacts3.apiRequest.locations.docQueryResp
  components:
    - .BasePublicHeader:
      children:
        - .BasePublicHeaderLeft:
        - .BasePublicHeaderTitle:
    - type: view
      style:
        left: "0"
        height: "0.84"
        width: "1"
      children:
        - type: view
          style:
            height: "auto"
            width: "0.9"
            marginLeft: "0.05"
            overflow: hidden
          children:
            - type: view
              style:
                marginTop: "0.02"
                width: "0.9"
                height: "auto"
              children:
                - type: label
                  text: Appointment Type
                  style:
                    height: "auto"
                    width: "0.9"
                    color: "0x474747"
                    fontWeight: "600"
                    fontSize: .Nfont.h14
                - type: select
                  options: .SelectINformationDM.VisitType
                  dataKey: formData.visitType
                  style:
                    marginTop: "0.01"
                    width: "0.9"
                    height: "0.04"
                    boxSizing: "border-box"
                    borderWidth: "1"
                    border:
                      style: 3
                    borderColor: "0xdededf"
                    borderRadius: "5"
                    backgroundColor: "0xffffff"
                    textIndent: "8px"
                    fontSize: .Nfont.h14
                  onChange:
                    - actionType: evalObject
                      object:
                        # 置空以避免旧数据干扰
                        - ..duration@: ""
                        - ..reason@: ""
                        - if:
                            - =.builtIn.string.equal:
                                dataIn:
                                  string1: =..formData.visitType
                                  string2: "Telemedicine"
                            - actionType: evalObject
                              object:
                                # 默认展示telemedicine的原因
                                - ..reasonForVisit@: =..formData.telemedicineTemp
                                # 默认将原因列表的第一项作为当前所选择的原因
                                - ..reason@: =..reasonForVisit.0
                                # 提取fee
                                - =.builtIn.array.getByKey:
                                    dataIn:
                                      array: =..VisitReason.response.doc.0.name.data.reasonForVisit.Telemedicine
                                      key1: reason
                                      value: =..reason
                                      key2: fee
                                    dataOut: MobileContacts3.formData.fee
                                # 提取duration
                                - =.builtIn.array.getByKey:
                                    dataIn:
                                      array: =..VisitReason.response.doc.0.name.data.reasonForVisit.Telemedicine
                                      key1: reason
                                      value: =..reason
                                      key2: duration
                                    dataOut: MobileContacts3.duration
                                # 将duration从字符串转为数字类型
                                - =.builtIn.string.retainNumber:
                                    dataIn:
                                      value: =..duration
                                    dataOut: MobileContacts3.duration
                                # 提取 document
                                - =.builtIn.array.getByKey:
                                    dataIn:
                                      array: =..VisitReason.response.doc.0.name.data.reasonForVisit.Telemedicine
                                      key1: reason
                                      value: =..reason
                                      key2: document
                                    dataOut: MobileContacts3.docu
                                - =.builtIn.array.removeByValue:
                                    dataIn:
                                      object: =..schedule.edge.id
                                      value: =..formData.locationId
                                - =.builtIn.array.add:
                                    dataIn:
                                      object: =..schedule.edge.id
                                      value: =.Global.currentFacility.bsig
                                - =.builtIn.array.removeByIndex:
                                    dataIn:
                                      object: =..apiRequest.E3.edgeQueryReq.id
                                      index: 0
                                - =.builtIn.array.push:
                                    dataIn:
                                      newMessage: =.Global.currentFacility.bsig
                                      messages: =..apiRequest.E3.edgeQueryReq.id
                                    dataOut: MobileContacts3.apiRequest.E3.edgeQueryReq.id
                            - actionType: evalObject
                              object:
                                - ..reasonForVisit@: =..formData.officeVisit
                                - ..reason@: =..reasonForVisit.0
                                - =.builtIn.array.getByKey:
                                    dataIn:
                                      array: =..VisitReason.response.doc.0.name.data.reasonForVisit.OfficeVisits
                                      key1: reason
                                      value: =..reason
                                      key2: fee
                                    dataOut: MobileContacts3.formData.fee
                                # 提取duration
                                - =.builtIn.array.getByKey:
                                    dataIn:
                                      array: =..VisitReason.response.doc.0.name.data.reasonForVisit.OfficeVisits
                                      key1: reason
                                      value: =..reason
                                      key2: duration
                                    dataOut: MobileContacts3.duration
                                - =.builtIn.string.retainNumber:
                                    dataIn:
                                      value: =..duration
                                    dataOut: MobileContacts3.duration
                                # 提取 document
                                - =.builtIn.array.getByKey:
                                    dataIn:
                                      array: =..VisitReason.response.doc.0.name.data.reasonForVisit.OfficeVisits
                                      key1: reason
                                      value: =..reason
                                      key2: document
                                    dataOut: MobileContacts3.docu
                                - =.builtIn.array.removeByValue:
                                    dataIn:
                                      object: =..schedule.edge.id
                                      value: =.Global.currentFacility.bsig
                                - =.builtIn.array.add:
                                    dataIn:
                                      object: =.MobileContacts3.schedule.edge.id
                                      value: =..formData.locationId
                                - =.builtIn.array.removeByIndex:
                                    dataIn:
                                      object: =..apiRequest.E3.edgeQueryReq.id
                                      index: 0
                                - =.builtIn.array.push:
                                    dataIn:
                                      newMessage: =..formData.locationId
                                      messages: =..apiRequest.E3.edgeQueryReq.id
                                    dataOut: MobileContacts3.apiRequest.E3.edgeQueryReq.id
                        - =.builtIn.array.getByKey:
                            dataIn:
                              array: =..formData.locations
                              key1: medicalFacilityName
                              value: =..formData.locationName
                              key2: id
                            dataOut: MobileContacts3.formData.locationId
                        # 根据不同的waiting room type类型来给E1的subtype赋值
                        - =.builtIn.array.getValueByKey:
                            dataIn:
                              array: =.AppointmentType
                              key1: text
                              value: =..formData.visitType
                              key2: type
                            dataOut: MobileContacts3.formData.currentSubtype
                        - =.builtIn.math.add:
                            dataIn:
                              num1: =..formData.currentSubtype
                              num2: 1
                            dataOut: MobileContacts3.formData.currentSubtype
                        - =.builtIn.string.concat:
                            dataIn:
                              - "(stime<="
                              - =..calendarDate.todayStamp.start
                              - " AND "
                              - "etime>"
                              - =..calendarDate.todayStamp.start
                              - " OR "
                              - "stime>="
                              - =..calendarDate.todayStamp.start
                              - " AND "
                              - "etime<="
                              - =..calendarDate.todayStamp.end
                              - " OR "
                              - "stime<"
                              - =..calendarDate.todayStamp.end
                              - " AND "
                              - "etime>="
                              - =..calendarDate.todayStamp.end
                              - ")"
                              - " AND "
                              - "subtype="
                              - =..formData.currentSubtype
                            dataOut: MobileContacts3.formData.scheduleScondition
                        - .MobileContacts3.splitTime@: []
                        - ..schedule.scheduleList.edge@: []
                        - =.builtIn.number.inhx:
                            dataIn:
                              intHex: =..formData.currentSubtype
                              index: 2
                              hex: 1
                            dataOut: MobileContacts3.formData.E3Subtype
                        - =.builtIn.string.concat:
                            dataIn:
                              - "subtype = "
                              - =..formData.E3Subtype
                            dataOut: MobileContacts3.apiRequest.E3.edgeQueryReq.sCondition
                        - =..apiRequest.E3.edgeAPI.get: ""
                        - =.builtIn.array.removeByIndex:
                            dataIn:
                              object: =..schedule.edge.id
                              index: 0
                        - =.builtIn.array.push:
                            dataIn:
                              newMessage: =..apiRequest.E3.edgeQueryResp.edge.0.id
                              messages: =..schedule.edge.id
                            dataOut: MobileContacts3.schedule.edge.id
                        - .Global._nonce@:
                            =.builtIn.math.random: ""
                        - =..schedule.get: ""
                        - =.builtIn.date.splitTime:
                            dataIn:
                              object2: =..schedule.scheduleList.edge
                              timeSlot: =..duration
                              year: =..calendarDate.year
                              month: =..calendarDate.month
                              day: =..calendarDate.day
                              isSplitCurrent: true
                              delayTime: 1800
                            dataOut: MobileContacts3.splitTime
                        - ..clock.bvid@: ""
                        - if:
                            - =..clock.bvid
                            - ..formData.nextBtnColor@: "0x2988e6"
                            - ..formData.nextBtnColor@: "0xc1c1c1"
                        # 控制location区域显示
                        - if:
                            - =.builtIn.string.equal:
                                dataIn:
                                  string1: =..formData.visitType
                                  string2: "Office Visit"
                            - actionType: evalObject
                              object:
                                - ..formData.splitTimeHeight@: "0.38"
                                - ..formData.flag@: "block"
                            - actionType: evalObject
                              object:
                                - ..formData.splitTimeHeight@: "0.47"
                                - ..formData.flag@: "none"
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: locationTag
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: splitTimeTag
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: nextBtn
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: reasonForVisitTag
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: durationTag
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: feeTag
            - type: view
              viewTag: locationTag
              style:
                marginTop: "0.02"
                width: "0.9"
                height: "auto"
                display: ..formData.flag
              children:
                - type: label
                  text: Location
                  style:
                    height: "auto"
                    width: "0.9"
                    color: "0x474747"
                    fontSize: .Nfont.h14
                - type: select
                  dataKey: formData.locationName
                  options: ..formData.locationNameList
                  onChange:
                    - actionType: evalObject
                      object:
                        .Global._nonce@:
                          =.builtIn.math.random: ""
                    - actionType: evalObject
                      object:
                        - =.builtIn.array.removeByValue:
                            dataIn:
                              object: =..schedule.edge.id
                              value: =..formData.locationId
                        - =.builtIn.array.removeByValue:
                            dataIn:
                              object: =..schedule.edge.id
                              value: =.Global.currentFacility.bsig
                        - =.builtIn.array.getByKey:
                            dataIn:
                              array: =..formData.locations
                              key1: medicalFacilityName
                              value: =..formData.locationName
                              key2: id
                            dataOut: MobileContacts3.formData.locationId
                        - =.builtIn.array.add:
                            dataIn:
                              object: =..schedule.edge.id
                              value: =..formData.locationId
                        - .MobileContacts3.splitTime@: []
                        - ..schedule.scheduleList.edge@: []
                        - .Global._nonce@:
                            =.builtIn.math.random: ""
                        - =..schedule.get: ""
                        - =.builtIn.date.splitTime:
                            dataIn:
                              object2: =..schedule.scheduleList.edge
                              timeSlot: =..duration
                              year: =..calendarDate.year
                              month: =..calendarDate.month
                              day: =..calendarDate.day
                              isSplitCurrent: true
                              delayTime: 1800
                            dataOut: MobileContacts3.splitTime
                        - ..clock.bvid@: ""
                        - if:
                            - =..clock.bvid
                            - ..formData.nextBtnColor@: "0x2988e6"
                            - ..formData.nextBtnColor@: "0xc1c1c1"
                        # 控制location区域显示
                        - if:
                            - =.builtIn.string.equal:
                                dataIn:
                                  string1: =..formData.visitType
                                  string2: "Office Visit"
                            - actionType: evalObject
                              object:
                                - ..formData.splitTimeHeight@: "0.38"
                                - ..formData.flag@: "block"
                            - actionType: evalObject
                              object:
                                - ..formData.splitTimeHeight@: "0.47"
                                - ..formData.flag@: "none"
                        #获取选择的location的profile
                        - if:
                            - =..formData.locationId
                            - actionType: evalObject
                              object:
                                - ..apiRequest.location.docQueryReq.id@: =..formData.locationId
                                - =..apiRequest.location.docAPI.get: ""
                                - .Global.ActiveLocation@: ""
                                - .Global.ActiveLocation@: =..apiRequest.location.docQueryResp.doc.0
                            - continue
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: locationTag
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: splitTimeTag
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: nextBtn
                  style:
                    marginTop: "0.01"
                    width: "0.9"
                    height: "0.04"
                    boxSizing: "border-box"
                    border:
                      style: 3
                    borderColor: "0xdededf"
                    borderRadius: "5"
                    borderWidth: "1"
                    backgroundColor: "0xffffff"
                    textIndent: "8px"
            - type: view
              style:
                marginTop: "0.02"
                width: "0.9"
                height: "auto"
              children:
                - type: view
                  style:
                    display: "inline-block"
                    width: "0.4"
                    height: "auto"
                  children:
                    - type: label
                      text: Reason for Visit
                      style:
                        fontWeight: "600"

                        height: "auto"
                        width: "0.4"
                        color: "0x474747"
                        fontSize: .Nfont.h14
                    - type: select
                      dataKey: reason
                      options: ..reasonForVisit
                      viewTag: reasonForVisitTag
                      style:
                        fontSize: .Nfont.h14
                        marginTop: "0.01"
                        width: "0.4"
                        height: "0.04"
                        boxSizing: "border-box"
                        border:
                          style: 3
                        borderColor: "0xdededf"
                        borderRadius: "5"
                        borderWidth: "1"
                        backgroundColor: "0xffffff"
                        textIndent: "8px"
                      onChange:
                        - actionType: evalObject
                          object:
                            - if:
                                - =.builtIn.string.equal:
                                    dataIn:
                                      string1: =..formData.visitType
                                      string2: "Telemedicine"
                                - actionType: evalObject
                                  object:
                                    - =.builtIn.array.getByKey:
                                        dataIn:
                                          array: =..VisitReason.response.doc.0.name.data.reasonForVisit.Telemedicine
                                          key1: reason
                                          value: =..reason
                                          key2: duration
                                        dataOut: MobileContacts3.duration
                                    - =.builtIn.string.retainNumber:
                                        dataIn:
                                          value: =..duration
                                        dataOut: MobileContacts3.duration
                                    - =.builtIn.array.getByKey:
                                        dataIn:
                                          array: =..VisitReason.response.doc.0.name.data.reasonForVisit.Telemedicine
                                          key1: reason
                                          value: =..reason
                                          key2: document
                                        dataOut: MobileContacts3.docu
                                    # 提取fee
                                    - =.builtIn.array.getByKey:
                                        dataIn:
                                          array: =..VisitReason.response.doc.0.name.data.reasonForVisit.Telemedicine
                                          key1: reason
                                          value: =..reason
                                          key2: fee
                                        dataOut: MobileContacts3.formData.fee
                                - actionType: evalObject
                                  object:
                                    - =.builtIn.array.getByKey:
                                        dataIn:
                                          array: =..VisitReason.response.doc.0.name.data.reasonForVisit.OfficeVisits
                                          key1: reason
                                          value: =..reason
                                          key2: duration
                                        dataOut: MobileContacts3.duration
                                    - =.builtIn.string.retainNumber:
                                        dataIn:
                                          value: =..duration
                                        dataOut: MobileContacts3.duration
                                    - =.builtIn.array.getByKey:
                                        dataIn:
                                          array: =..VisitReason.response.doc.0.name.data.reasonForVisit.OfficeVisits
                                          key1: reason
                                          value: =..reason
                                          key2: document
                                        dataOut: MobileContacts3.docu
                                    # 提取fee
                                    - =.builtIn.array.getByKey:
                                        dataIn:
                                          array: =..VisitReason.response.doc.0.name.data.reasonForVisit.OfficeVisits
                                          key1: reason
                                          value: =..reason
                                          key2: fee
                                        dataOut: MobileContacts3.formData.fee
                            - .MobileContacts3.splitTime@: []
                            - =.builtIn.date.splitTime:
                                dataIn:
                                  object2: =..schedule.scheduleList.edge
                                  timeSlot: =..duration
                                  year: =..calendarDate.year
                                  month: =..calendarDate.month
                                  day: =..calendarDate.day
                                  isSplitCurrent: true
                                  delayTime: 1800
                                dataOut: MobileContacts3.splitTime
                            - ..clock.bvid@: ""
                            - if:
                                - =..clock.bvid
                                - ..formData.nextBtnColor@: "0x2988e6"
                                - ..formData.nextBtnColor@: "0xc1c1c1"
                        - actionType: builtIn
                          funcName: redraw
                          viewTag: durationTag
                        - actionType: builtIn
                          funcName: redraw
                          viewTag: splitTimeTag
                        - actionType: builtIn
                          funcName: redraw
                          viewTag: nextBtn
                        - actionType: builtIn
                          funcName: redraw
                          viewTag: feeTag
                - type: view
                  style:
                    marginLeft: "0.05"
                    display: "inline-block"
                    width: "0.25"
                    height: "auto"
                  children:
                    - type: label
                      text: Duration
                      style:
                        fontWeight: "600"

                        height: "auto"
                        width: "auto"
                        color: "0x474747"
                        fontSize: .Nfont.h14
                    - type: label
                      viewTag: durationTag
                      textBoard:
                        - text:
                          dataKey: duration
                        - text: "&nbsp;min"
                      isEditable: "false"
                      style:
                        marginTop: "0.01"
                        width: "0.2"
                        height: "0.04"
                        boxSizing: "border-box"
                        border:
                          style: 3
                        borderColor: "0xdededf"
                        fontSize: .Nfont.h14
                        borderRadius: "5"
                        borderWidth: "1"
                        backgroundColor: "0xfafafa"
                        color: "0x4d4d4d"
                        textAlign:
                          x: center
                          y: center
                - type: view
                  style:
                    # marginLeft: "0.05"
                    display: "inline-block"
                    width: "0.2"
                    height: "auto"
                  children:
                    - type: label
                      text: Fee
                      style:
                        fontWeight: "600"

                        height: "auto"
                        width: "0.2"
                        color: "0x474747"
                        fontSize: .Nfont.h14
                    - type: label
                      viewTag: feeTag
                      text: ""
                      text=func: .builtIn.string.dollarFormat
                      dataKey: formData.fee
                      isEditable: "false"
                      style:
                        marginTop: "0.01"
                        width: "0.2"
                        height: "0.04"
                        boxSizing: "border-box"
                        border:
                          style: 3
                        borderColor: "0xdededf"
                        borderRadius: "5"
                        backgroundColor: "0xfafafa"
                        fontSize: .Nfont.h14
                        borderWidth: "1"
                        # backgroundColor: "0xffffff"
                        color: "0x4d4d4d"
                        textAlign:
                          x: center
                          y: center

        - type: view
          viewTag: setSchedule
          style:
            marginTop: "0.01"
            height: "auto"
            width: "1"
            backgroundColor: "0xe9f2fc"
            overflow: hidden
          children:
            - type: view
              style:
                marginTop: "0.01"
                marginLeft: "0.05"
                height: "0.04"
                width: "0.9"
              children:
                - type: select
                  dataKey: calendarDate.monthName
                  options: .BaseComponents.month
                  style:
                    verticalAlign: "middle"
                    display: "inline-block"
                    width: "0.15"
                    height: "0.03"
                    boxSizing: "border-box"
                    border:
                      style: 1
                    color: "0x474747"
                    fontSize: .Nfont.h1
                    backgroundColor: "0xe9f2fc"
                  onChange:
                    - actionType: evalObject
                      object:
                        - .BaseComponents.calendarDate.monthName@: =..calendarDate.monthName
                        - .BaseComponents.calendarDate.year@: =..calendarDate.year
                        - =.builtIn.date.transformMonth:
                            dataIn:
                              month: =.BaseComponents.calendarDate.monthName
                              flag: 2
                            dataOut: MobileContacts3.calendarDate.month
                        - .BaseComponents.calendarDate.day@: 1
                        - =.builtIn.date.miniWeeklyCalendarArray:
                            dataIn:
                              year: =..calendarDate.year
                              month: =..calendarDate.month
                              today: 33
                              markDay: 1
                              color: "0x4b4b4b"
                              backgroundColor: "0xffffff00"
                              todayColor: "0xffffff"
                              todayBackgroundColor: "0x2988e6"
                              currentDateTime: =..calendarDate.todayDate
                              pastTimeColor: "0xbababa"
                            dataOut: MobileContacts3.calendarDate.dayLable
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: setSchedule
                - type: select
                  dataKey: calendarDate.year
                  options: .BaseComponents.year
                  style:
                    verticalAlign: "middle"
                    display: "inline-block"
                    marginLeft: "0.02"
                    width: "0.15"
                    height: "0.03"
                    boxSizing: "border-box"
                    border:
                      style: 1
                    color: "0x474747"
                    fontSize: .Nfont.h1
                    backgroundColor: "0xe9f2fc"
                  onChange:
                    - actionType: evalObject
                      object:
                        - .BaseComponents.calendarDate.year@: =..calendarDate.year
                        - =.builtIn.date.transformYear:
                            dataIn:
                              year: =..calendarDate.year
                            dataOut: MobileContacts3.calendarDate.year
                        - =.builtIn.date.miniWeeklyCalendarArray:
                            dataIn:
                              year: =..calendarDate.year
                              month: 1
                              today: 33
                              markDay: 1
                              color: "0x4b4b4b"
                              backgroundColor: "0xffffff00"
                              todayColor: "0xffffff"
                              todayBackgroundColor: "0x2988e6"
                              currentDateTime: =..calendarDate.todayDate
                              pastTimeColor: "0xbababa"
                            dataOut: MobileContacts3.calendarDate.dayLable
                    - actionType: evalObject
                      object:
                        - .MobileContacts3.calendarDate.month@: 1
                    - actionType: evalObject
                      object:
                        - =.builtIn.date.transformMonth:
                            dataIn:
                              month: =..calendarDate.month
                            dataOut: MobileContacts3.calendarDate.monthName
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: setSchedule
                - type: label
                  dataKey: MobileContacts3.selectDate
                  style:
                    verticalAlign: "middle"
                    display: "inline-block"

                    height: "auto"
                    width: "0.57"
                    color: "0x474747"
                    fontSize: .Nfont.h1
                    textAlign:
                      x: right

            - type: view
              style:
                marginTop: "0.01"
                height: "auto"
                width: "1"
              children:
                - type: view
                  style:
                    display: "inline-block"
                    height: "0.08"
                    width: "0.1"
                    textAlign:
                      x: center
                    boxSizing: "border-box"
                  children:
                    - type: image
                      path: leftDate.svg
                      style:
                        marginTop: "0.02"
                        height: "0.05"
                        width: "0.1"
                      onClick:
                        - actionType: evalObject
                          object:
                            - =.builtIn.date.LastWeek:
                                dataIn:
                                  year: =..calendarDate.dayLable.0.year
                                  month: =..calendarDate.dayLable.0.month
                                  day: =..calendarDate.dayLable.0.day
                                dataOut: MobileContacts3.calendarDate.tempDate
                            - =.builtIn.date.miniWeeklyCalendarArray:
                                dataIn:
                                  year: =..calendarDate.tempDate.year
                                  month: =..calendarDate.tempDate.month
                                  today: =..calendarDate.day
                                  markDay: =..calendarDate.tempDate.day
                                  color: "0x4b4b4b"
                                  backgroundColor: "0xffffff00"
                                  todayColor: "0xffffff"
                                  todayBackgroundColor: "0x2988e6"
                                  currentDateTime: =..calendarDate.todayDate
                                  pastTimeColor: "0xbababa"
                                dataOut: MobileContacts3.calendarDate.dayLable
                        - actionType: evalObject
                          object:
                            - ..calendarDate.year@: =..calendarDate.tempDate.year
                            - ..calendarDate.month@: =..calendarDate.tempDate.month
                            - =.builtIn.date.transformMonth:
                                dataIn:
                                  month: =..calendarDate.month
                                dataOut: MobileContacts3.calendarDate.monthName
                        - actionType: builtIn
                          funcName: redraw
                          viewTag: setSchedule
                - type: view
                  style:
                    display: "inline-block"
                    height: "0.08"
                    width: "0.8"
                    boxSizing: "border-box"
                    marginLeft: "0"
                    # backgroundColor: "pink"
                  children:
                    - type: list
                      contentType: listObject
                      listObject: ..calendarDate.dayLable
                      iteratorVar: itemObject
                      viewTag: calendarColor
                      style:
                        axis: horizontal
                        width: "0.8"
                        height: "0.08"
                        boxSizing: "border-box"
                      children:
                        - type: listItem
                          itemObject: ""
                          style:
                            marginLeft: "0.004"
                            width: auto
                            height: "0.08"
                            boxSizing: "border-box"
                            backgroundColor: itemObject.backgroundColor
                            borderRadius: "22px 22px 22px 22px"
                            overflow: hidden
                            textAlign:
                              x: center
                          onClick:
                            - actionType: evalObject
                              object:
                                - ..temporaryInfo@: =..calendarDate
                                - ..formData.temporarySplitTime@: =..splitTime
                            - emit:
                                dataKey:
                                  var: itemObject
                                actions:
                                  - .MobileContacts3.splitTime@: []
                                  - .MobileContacts3.splitTime@: []
                                  - ..calendarDate.year@: $var.year
                                  - ..calendarDate.month@: $var.month
                                  - ..calendarDate.day@: $var.day
                                  - =.builtIn.date.ShowDateByNumber:
                                      dataIn:
                                        year: =..calendarDate.year
                                        month: =..calendarDate.month
                                        day: =..calendarDate.day
                                      dataOut: MobileContacts3.selectDate
                                  - =.builtIn.date.transformMonth:
                                      dataIn:
                                        month: =..calendarDate.month
                                      dataOut: MobileContacts3.calendarDate.monthName
                                  - =.builtIn.string.concat:
                                      dataIn:
                                        - =..calendarDate.year
                                        - "-"
                                        - =..calendarDate.month
                                        - "-"
                                        - $var.day
                                      dataOut: MobileContacts3.calendarDate.todayDate
                                  - =.builtIn.date.getTimeStampOfDate:
                                      dataIn:
                                        date: =..calendarDate.todayDate
                                      dataOut: MobileContacts3.calendarDate.todayStamp
                                  - =.builtIn.date.miniWeeklyCalendarArray:
                                      dataIn:
                                        year: $var.year
                                        month: $var.month
                                        today: $var.day
                                        markDay: $var.day
                                        color: "0x4b4b4b"
                                        backgroundColor: "0xffffff00"
                                        todayColor: "0xffffff"
                                        todayBackgroundColor: "0x2988e6"
                                        pastTimeColor: "0xbababa"
                                        currentDateTime: =..calendarDate.todayDate
                                      dataOut: MobileContacts3.calendarDate.dayLable
                                  - =.builtIn.string.concat:
                                      dataIn:
                                        - "(stime<="
                                        - =..calendarDate.todayStamp.start
                                        - " AND "
                                        - "etime>"
                                        - =..calendarDate.todayStamp.start
                                        - " OR "
                                        - "stime>="
                                        - =..calendarDate.todayStamp.start
                                        - " AND "
                                        - "etime<="
                                        - =..calendarDate.todayStamp.end
                                        - " OR "
                                        - "stime<"
                                        - =..calendarDate.todayStamp.end
                                        - " AND "
                                        - "etime>="
                                        - =..calendarDate.todayStamp.end
                                        - ")"
                                        - " AND "
                                        - "subtype="
                                        - =..formData.currentSubtype
                                      dataOut: MobileContacts3.formData.scheduleScondition
                            - actionType: evalObject
                              object:
                                - if:
                                    - =.builtIn.math.greater:
                                        dataIn:
                                          num1: =.MobileContacts3.calendarDate.todayStamp.end
                                          num2: =.MobileContacts3.nowTimeStamp
                                    - continue
                                    - actionType: popUp
                                      popUpView: dateCheck
                                      wait: true
                                - ..schedule.scheduleList.edge@: []
                            - actionType: evalObject
                              object:
                                .Global._nonce@:
                                  =.builtIn.math.random: ""
                            - actionType: evalObject
                              object:
                                # - if:
                                #     - =.builtIn.string.equal:
                                #         dataIn:
                                #           string1: =.Global.scheduleType
                                #           string2: thoughFacility
                                #     - actionType: evalObject
                                #       object:
                                #         - =.builtIn.array.add:
                                #             dataIn:
                                #               object: =..schedule.edge.id
                                #               value: =.Global.ActiveFacility.bsig
                                #         - ..schedule.edge.xfname@: evid,bvid
                                #     - continue
                                - =..schedule.get: ""
                            - actionType: evalObject
                              object:
                                - .MobileContacts3.splitTime@: []
                            - actionType: evalObject
                              object:
                                - =.builtIn.date.splitTime:
                                    dataIn:
                                      object2: =..schedule.scheduleList.edge
                                      timeSlot: =..duration
                                      year: =..calendarDate.year
                                      month: =..calendarDate.month
                                      day: =..calendarDate.day
                                      isSplitCurrent: true
                                      delayTime: 1800
                                    dataOut: MobileContacts3.splitTime
                                - if:
                                    - =.MobileContacts3.splitTime.0.stime
                                    - continue
                                    - actionType: popUp
                                      popUpView: noAvailableTag
                                      wait: true
                            - actionType: evalObject
                              object:
                                - ..clock.bvid@: ""
                                - if:
                                    - =..clock.bvid
                                    - ..formData.nextBtnColor@: "0x2988e6"
                                    - ..formData.nextBtnColor@: "0xc1c1c1"
                            - actionType: builtIn
                              funcName: redraw
                              viewTag: splitTimeTag
                            - actionType: builtIn
                              funcName: redraw
                              viewTag: setSchedule
                            - actionType: builtIn
                              funcName: redraw
                              viewTag: nextBtn
                          children:
                            - type: label
                              dataKey: itemObject.weekDay
                              style:
                                marginTop: "0.01"
                                width: "0.108"
                                color: itemObject.color
                                fontSize: .Nfont.h1
                                textAlign:
                                  x: center
                            - type: label
                              dataKey: itemObject.day
                              style:
                                marginTop: "0.01"
                                width: "0.108"
                                height: "0.045"
                                color: itemObject.color
                                fontSize: .Nfont.h2
                                borderRadius: "80"
                                textAlign:
                                  x: center

                - type: view
                  style:
                    display: "inline-block"
                    height: "0.08"
                    width: "0.1"
                    textAlign:
                      x: center
                    boxSizing: "border-box"
                  children:
                    - type: image
                      path: rightDate.svg
                      style:
                        marginTop: "0.02"
                        height: "0.05"
                        width: "0.1"
                      onClick:
                        - actionType: evalObject
                          object:
                            - =.builtIn.date.NextWeek:
                                dataIn:
                                  year: =..calendarDate.dayLable.6.year
                                  month: =..calendarDate.dayLable.6.month
                                  day: =..calendarDate.dayLable.6.day
                                dataOut: MobileContacts3.calendarDate.tempDate
                            - =.builtIn.date.miniWeeklyCalendarArray:
                                dataIn:
                                  year: =..calendarDate.tempDate.year
                                  month: =..calendarDate.tempDate.month
                                  today: =..calendarDate.day
                                  currentDateTime: =..calendarDate.todayDate
                                  markDay: =..calendarDate.tempDate.day
                                  color: "0x4b4b4b"
                                  backgroundColor: "0xffffff00"
                                  todayColor: "0xffffff"
                                  todayBackgroundColor: "0x2988e6"
                                  pastTimeColor: "0xbababa"
                                dataOut: MobileContacts3.calendarDate.dayLable
                        - actionType: evalObject
                          object:
                            - ..calendarDate.year@: =..calendarDate.tempDate.year
                            - ..calendarDate.month@: =..calendarDate.tempDate.month
                            - =.builtIn.date.transformMonth:
                                dataIn:
                                  month: =..calendarDate.month
                                dataOut: MobileContacts3.calendarDate.monthName
                        - actionType: builtIn
                          funcName: redraw
                          viewTag: setSchedule
            - type: view
              style:
                marginTop: "0.02"

        - type: scrollView
          style:
            marginLeft: "0.035"
            width: "0.95"
            boxSizing: "border-box"
          children:
            - type: list
              viewTag: splitTimeTag
              androidGrid: true
              contentType: listObject
              listObject: ..splitTime
              iteratorVar: itemObject
              style:
                width: "0.95"
                margin: "0"
                height: ..formData.splitTimeHeight
                boxSizing: "border-box"

                # overflow: scroll
              children:
                - type: listItem
                  itemObject: ""
                  style:
                    marginLeft: "0.015"
                    display: "inline-block"
                    width: "0.28"
                    height: "auto"
                    # top: "0.02"
                    # marginTop: "0.02"
                  children:
                    - type: label
                      dataKey: itemObject.showTime
                      style:
                        width: "0.28"
                        marginTop: "0.02"
                        height: "0.05"
                        lineHeight: "5vh"
                        boxSizing: "border-box"
                        border:
                          style: 3
                        borderWidth: "1"
                        borderColor: "0xdededf"
                        borderRadius: "5"
                        # color: "0x474747"
                        color: itemObject.fontColor
                        fontSize: .Nfont.h14
                        backgroundColor: itemObject.backgroundColor
                        textAlign:
                          x: center
                      onClick:
                        - emit:
                            dataKey:
                              var: itemObject
                            actions:
                              - ..clock@: $var
                              - .Global.clock@: $var
                        - actionType: evalObject
                          object:
                            # 获取当前的时间戳
                            - =.builtIn.date.getTime:
                                dataIn:
                                dataOut: MobileContacts.nowTimeStamp
                            - if:
                                # 如果所选时间比当前时间晚，则弹框
                                - =.builtIn.math.greater:
                                    dataIn:
                                      num1: =..clock.stime
                                      num2: =..nowTimeStamp
                                - continue
                                - actionType: popUp
                                  popUpView: check
                                  wait: true
                        - actionType: evalObject
                          object:
                            - =.builtIn.object.setProperty:
                                dataIn:
                                  obj: =..splitTime
                                  label: "showTime"
                                  text: =..clock.showTime
                                  arr: ["backgroundColor", "fontColor"]
                                  valueArr: ["0x2988e6", "0xffffff"]
                                  errorArr: ["0xffffff", "0x474747"]
                                dataOut: MobileContacts3.splitTime
                        - actionType: evalObject
                          object:
                            - if:
                                - =..clock.bvid
                                - ..formData.nextBtnColor@: "0x2988e6"
                                - ..formData.nextBtnColor@: "0xc1c1c1"
                        - actionType: builtIn
                          funcName: redraw
                          viewTag: splitTimeTag
                        - actionType: builtIn
                          funcName: redraw
                          viewTag: nextBtn
    - .NextButtonView:
      style:
        boxShadow: "0px 1px 10px #dbdfe3"
        backgroundColor: "0xffffff"
        overflow: hidden
      children:
        - type: button
          text: Next
          viewTag: nextBtn
          style:
            marginTop: "0.025"
            marginLeft: "0.08"
            width: "0.84"
            height: "0.04"
            backgroundColor: ..formData.nextBtnColor
            border:
              style: 3
            borderColor: ..formData.nextBtnColor
            borderRadius: "2"

            fontSize: .Nfont.h14
            color: "0xffffff"
            textAlign:
              x: center
          onClick:
            - actionType: evalObject
              object:
                .Global._nonce@:
                  =.builtIn.math.random: ""
            - actionType: evalObject
              object:
                # 如果没有clock.bvid,则表明没有选择时间直接点击了next
                - if:
                    - =..clock.bvid
                    - continue
                    - actionType: popUp
                      popUpView: timeWarning
                      wait: true
            - actionType: popUp
              popUpView: uploading
            - actionType: evalObject
              object:
                - .Global.formData.appointment.docu@: []
                - .Global.formData.appointment.selectDate@: =..selectDate
                - .Global.formData.appointment.duration@: =..duration
                - .Global.formData.appointment.docu@: =..docu
                - .Global.formData.appointment.reason@: =..reason
                - ..apiRequest.clockBvid.vertexQueryReq.id@: =..clock.bvid
                - =..apiRequest.clockBvid.vertexAPI.get: ""
                # 判断 e1的bvid是facility还是location，20是facility，21是location
                - if:
                    - =.builtIn.string.equal:
                        dataIn:
                          string1: =..apiRequest.clockBvid.vertexQueryResp.vertex.0.type
                          string2: 21
                    # 如果clock.bvid是location，则找出它的facility
                    - actionType: evalObject
                      object:
                        - ..currentFaciVertex.vertexIn.id@: =..clock.bvid
                        - =..currentFaciVertex.vertexAPI.get: ""
                        - ..apiRequest.currentFacilityDoc.docReq.id@: =..currentFaciVertex.vertexResp.vertex.0.id
                        - =..apiRequest.currentFacilityDoc.docAPI.get: ""
                        - .Global.currentFacility@: =..apiRequest.currentFacilityDoc.docResp.doc.0
                    - continue
                - .Global.formData.fee@: =..formData.fee
            - actionType: popUpDismiss
              popUpView: uploading
            - actionType: evalObject
              object:
                # 查询10002上的patient profile
                - =..apiRequest.profileFromRelation.docAPI.get: ""
                - ..apiRequest.hashTagFromRelationProfile.docQueryReq.id@: []
                - =.builtIn.array.pushAny:
                    dataIn:
                      newMessage: =..apiRequest.profileFromRelation.docQueryResp.doc.0.id
                      messages: =..apiRequest.hashTagFromRelationProfile.docQueryReq.id
                    dataOut: MobileContacts3.apiRequest.hashTagFromRelationProfile.docQueryReq.id
                - =.builtIn.array.pushAny:
                    dataIn:
                      newMessage: =.Global.currentUser.vertex.id
                      messages: =..apiRequest.hashTagFromRelationProfile.docQueryReq.id
                    dataOut: MobileContacts3.apiRequest.hashTagFromRelationProfile.docQueryReq.id
                # 查询10002上profile的hashtag
                - =..apiRequest.hashTagFromRelationProfile.docAPI.get: ""
                - if:
                    - =.Global.formData.hashTag.id
                    - actionType: evalObject
                      object:
                        - if:
                            - =.builtIn.array.judgeListLength:
                                dataIn:
                                  array: =..apiRequest.hashTagFromRelationProfile.docQueryResp.doc
                                  len: 0
                            - continue
                            - actionType: evalObject
                              object:
                                - if:
                                    - =.builtIn.math.greater:
                                        dataIn:
                                          num1: =.Global.formData.hashTag.name.data.hashTime
                                          num2: =..apiRequest.hashTagFromRelationProfile.docQueryResp.doc.0.name.data.hashTime
                                    - continue
                                    - actionType: popUp
                                      popUpView: updateView
                                      wait: true
                    - actionType: evalObject
                      object:
                        - if:
                            - =.builtIn.array.judgeListLength:
                                dataIn:
                                  array: =..apiRequest.hashTagFromRelationProfile.docQueryResp.doc
                                  len: 0
                            - continue
                            - actionType: popUp
                              popUpView: updateView
                              wait: true
                - =.builtIn.date.getTime:
                    dataIn:
                    dataOut: MobileContacts.nowTimeStamp
                - if:
                    - =.builtIn.math.greater:
                        dataIn:
                          num1: =..clock.stime
                          num2: =..nowTimeStamp
                    - continue
                    - actionType: popUp
                      popUpView: check
                      wait: true
                # 把当前所选的visit type赋值给Global中
                - .Global.formData.appointment.visitType@: =..formData.visitType
            - goto: CreateAppointmentToProvider
    - .BackgroundColorGray:
      viewTag: timeWarning
      onClick:
        - actionType: popUpDismiss
          popUpView: timeWarning
      children:
        - type: view
          style:
            width: "0.4"
            height: "0.14"
            backgroundColor: "0xe5e5e5"
            borderRadius: "12"
            top: "0.43"
            left: "0.3"
            textAlign:
              x: center
          children:
            - type: image
              path: aboutRed.svg
              style:
                width: "0.105"
                marginTop: "0.025"
            - type: label
              text: "Please select an appointment time"
              dataKey:
              style:
                color: "0x555555"
                fontSize: .Nfont.h0

                width: "0.35"
                marginLeft: "0.025"
                marginTop: "0.009"
                textAlign:
                  x: center

    - .BackgroundColorGray:
      viewTag: noAvailableTag
      onClick:
        - actionType: evalObject
          object:
            - ..calendarDate@: =..temporaryInfo
            - ..temporaryInfo@: ""
            - =.builtIn.date.ShowDateByNumber:
                dataIn:
                  year: =..calendarDate.year
                  month: =..calendarDate.month
                  day: =..calendarDate.day
                dataOut: MobileContacts3.selectDate
            - ..splitTime@: =..formData.temporarySplitTime
            - ..formData.temporarySplitTime@: []
        - actionType: popUpDismiss
          popUpView: noAvailableTag
      children:
        - type: view
          style:
            width: "0.51"
            height: auto
            backgroundColor: "0xe5e5e5"
            borderRadius: "12"
            top: "0.41"
            left: "0.24"
            textAlign:
              x: center
          children:
            - type: image
              path: aboutRed.svg
              style:
                width: "0.105"
                marginTop: "0.03"
                textAlign:
                  x: center
            # - type: label
            #   text: "There is no appointment available"
            #   dataKey:
            #   style:
            #     color: "0x555555"
            #     fontSize: .Nfont.h1
            #     width: "0.43"
            #     height: auto
            #
            #     margin: auto
            #     word-break: break-word
            #     marginTop: "0.01"
            - type: label
              text: "There is no appointment available"
              dataKey:
              style:
                color: "0x555555"
                fontSize: .Nfont.h1

                width: "0.43"
                marginLeft: "0.04"
                marginTop: "0.009"
                textAlign:
                  x: center
            - type: view
              style:
                width: "0.01"
                height: "0.015"

    - .BackgroundColorGray:
      viewTag: dateCheck
      onClick:
        - actionType: evalObject
          object:
            - ..calendarDate@: =..temporaryInfo
            - ..temporaryInfo@: ""
            - =.builtIn.date.ShowDateByNumber:
                dataIn:
                  year: =..calendarDate.year
                  month: =..calendarDate.month
                  day: =..calendarDate.day
                dataOut: MobileContacts3.selectDate
            - ..splitTime@: =..formData.temporarySplitTime
            - ..formData.temporarySplitTime@: []
        - actionType: popUpDismiss
          popUpView: dateCheck
      children:
        - type: view
          style:
            width: "0.51"
            height: auto
            backgroundColor: "0xe5e5e5"
            borderRadius: "12"
            top: "0.41"
            left: "0.24"
            textAlign:
              x: center
          children:
            - type: image
              path: aboutRed.svg
              style:
                width: "0.105"
                marginTop: "0.03"
                textAlign:
                  x: center
            - type: label
              text: "Please don't Choose the past time"
              dataKey:
              style:
                color: "0x555555"
                fontSize: .Nfont.h1
                width: "0.43"
                height: auto

                marginLeft: "0.04"
                textAlign:
                  x: center
                word-break: break-word
                marginTop: "0.01"
            - type: view
              style:
                width: "0.01"
                height: "0.015"

    - type: view
      viewTag: tipsView
      style:
        width: "1"
        height: "1"
        backgroundColor: "0xffffff00"
        top: "0"
      onClick:
        - actionType: popUpDismiss
          popUpView: tipsView
      children:
        - type: view
          style:
            left: "0.15"
            top: "0.35"
            width: "0.72"
            height: "auto"
            backgroundColor: "0xe9e9e9"
            borderRadius: "10"
            margin: auto
            marginTop: "0.025"
            textAlign:
              x: left
            overflow: hidden
          children:
            - type: label
              text: Tips
              style:
                marginTop: "0.02"
                color: "0x2988e6"
                width: "0.72"
                height: "auto"
                textAlign:
                  x: center

                fontSize: .Nfont.h2
            - type: label
              text: "1. Choose type of appointment"
              style:
                marginLeft: "0.1"
                marginTop: "0.02"
                color: "0x4d4d4d"
                width: "auto"
                height: "auto"

                fontSize: .Nfont.h14
            - type: label
              text: "2. Choose reason for your visit"
              style:
                marginLeft: "0.1"
                marginTop: "0.02"
                color: "0x4d4d4d"
                width: "auto"
                height: "auto"

                fontSize: .Nfont.h14
            - type: label
              text: "3. Select a time"
              style:
                marginLeft: "0.1"
                marginTop: "0.02"
                color: "0x4d4d4d"
                width: "auto"
                height: "auto"

                fontSize: .Nfont.h14
            - type: view
              style:
                marginTop: "0.04"
    - .ProgressCheckView:
      message: "loading ..."
      viewTag: uploading
    - .SoftTips:
      message: Please don't select the past time
      viewTag: check
    - type: popUp
      viewTag: updateView
      viewText: "View"
      viewButton:
        - actionType: evalObject
          object:
            - .Global.formData.sourceProfile@: ""
            - .Global.formData.targetProfile@: ""
            - .Global.formData.hashTagFromtargetProfile@: ""
            - .Global.formData.sourceProfile@: =.Global.Profile
            - .Global.formData.targetProfile@: =..apiRequest.profileFromRelation.docQueryResp.doc.0
            - .Global.formData.hashTagFromtargetProfile@: =..apiRequest.hashTagFromRelationProfile.docQueryResp.doc.0
            - .Global.MiddlePage.updatePatientProfilePage@: "CreateAppointmentToProvider"
        - goto: ComparisonProfile
      style:
        top: "0"
        left: "0"
        width: "1"
        height: "1"
        backgroundColor: "0x00000066"
        zIndex: "50"
        textAlign:
          y: center
      children:
        - type: view
          style:
            width: "0.7"
            marginLeft: "0.15"
            backgroundColor: "0xE6E6E6"
            borderRadius: "14px"
            overflow: hidden
          children:
            - type: label
              # text: ___.message
              textBoard:
                - text: "Facility Name"
                  dataKey: Global.currentFacility.name.data.basicInfo.medicalFacilityName
                  color: "#2988e6"
                - text: " has updated your demographics. Please review to confirm. You could save a copy for your future use"
              style:
                width: "0.576"
                height: "auto"
                marginLeft: "0.062"
                marginTop: "0.027"
                fontSize: .Nfont.h14

                color: "0x333333"
                lineHeight: "2.58vh"
            - type: view
              style:
                height: "0.027"
                width: "0.7"
                border:
                  style: 2
                  color: "0x919192"
                borderWidth: "1"
            - type: view
              style:
                width: "0.7"
                boxSizing: border-box
                textAlign:
                  x: center
              children:
                - type: button
                  text: ____.viewText
                  style:
                    color: "0x007AFF"
                    fontWeight: "850"
                    backgroundColor: "0xE6E6E6"
                    # display: inline-block
                    width: "0.349"
                    fontSize: .Nfont.h14
                    borderRadius: "0 0 14px 0"
                    height: "0.054"
                    border:
                      style: "1"
                  onClick: ____.viewButton
