ProviderNoteSelect:
  title: Provider Notes

  init:
    - .SignInCheck
    # 如果是会议的参与者，不显示medical recommendation
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.currentUser.vertex.id
              string2: =.Global.currentRoomInfo.edge.name.providerId
        - continue
        - =.builtIn.array.removeByName:
            dataIn:
              object: =..dataTemp.Notes
              key: title
              name: Medical Recommendation
    - .Global.formData.blockPastTime@: "false"
    - .Global.formData.lastPage@: ProviderNoteSelect
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    # 清空 Global.prescriptionDrug
    - actionType: updateObject
      dataKey: Global.prescriptionDrug
      dataObject: .ProviderNoteSelect.formData.prescriptionDrug
    # 清空 Global.formData.pageName
    - actionType: updateObject
      dataKey: Global.formData.pageName
      dataObject: .EmptyObj
    # 清空 Global.prescriptionArray
    - actionType: updateObject
      dataKey: Global.prescriptionArray
      dataObject: []
    # 清空 providerDoc.evaluation
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.evaluation
      dataObject: .EmptyObj
    # 清空 providerDoc.prescription
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.prescription
      dataObject: .EmptyObj
    # 清空 providerDoc.absentNote
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.absentNote
      dataObject: .EmptyObj
    # 清空 providerDoc.blankNote
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.blankNote
      dataObject: .EmptyObj
    # 清空 providerDoc.workStatusForm
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.workStatusForm
      dataObject: .EmptyObj
    # 清空 providerDoc.pROne
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.pROne
      dataObject: .EmptyObj
    # 清空 providerDoc.pRTwo
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.pRTwo
      dataObject: .EmptyObj
    # 清空 providerDoc.dWCFormRFA
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.dWCFormRFA
      dataObject: .EmptyObj
    # 清空 providerDoc.progressReport
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.progressReport
      dataObject: .EmptyObj
    # 清空 providerDoc.initialEvaluationReport
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.initialEvaluationReport
      dataObject: .EmptyObj
    # 清空 providerDoc.surgeryAuthorization
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.surgeryAuthorization
      dataObject: .EmptyObj
    # 清空 providerDoc.medicalRecord
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.medicalRecord
      dataObject: .EmptyObj
    # 清空 providerDoc.patientConsentForm
    - actionType: updateObject
      dataKey: Global.formData.providerDoc.patientConsentForm
      dataObject: .EmptyObj
    - actionType: updateObject
      dataKey: Global.formData.unPageName
      dataObject: .EmptyObj
    - actionType: evalObject
      object:
        - if:
            - =.builtIn.string.equal:
                dataIn:
                  string1: =.Global.formData.providerTitle
                  string2: ""
            - actionType: evalObject
              object:
                - =.builtIn.string.concat:
                    dataIn:
                      - =.Global.MyProfile.name.data.fullName
                      - " - "
                      - =.Global.MyProfile.name.data.title
                    dataOut: Global.formData.providerTitle
            - continue

    - actionType: evalObject
      object:
        - actionType: evalObject
          async: true
          object:
            - =..apiRequest.diagnosesDoc.docAPI.get: ""
            - =..apiRequest.superbillDoc.docAPI.get: ""
    - if:
        - =.builtIn.array.judgeListLength:
            dataIn:
              array: =..apiRequest.diagnosesDoc.docResp.doc
              len: 0
        - .Global.formData.providerDoc.diagnosesDoc@: ""
        - .Global.formData.providerDoc.diagnosesDoc@: =..apiRequest.diagnosesDoc.docResp.doc.0

    - if:
        - =.builtIn.array.judgeListLength:
            dataIn:
              array: =..apiRequest.superbillDoc.docResp.doc
              len: 0
        - actionType: evalObject
          object:
            - .Global.formData.superbillComplete@: false
            - ..dataTemp.Notes.0.pageName@: SelectSuperbill
            - .Global.formData.providerDoc.superbillDoc@: ""
        - actionType: evalObject
          object:
            - .Global.formData.superbillComplete@: true
            - ..dataTemp.Notes.0.pageName@: SuperbillReview
            - .Global.formData.providerDoc.superbillDoc@: =..apiRequest.superbillDoc.docResp.doc.0

    - actionType: evalObject
      object:
        - if:
            - =.Global.formData.isFirstRecommendation
            - ..dataTemp.Notes.1.pageName@: MedicalRecommendation
            - actionType: evalObject
              object:
                - if:
                    - =.builtIn.number.typeIsValid:
                        dataIn:
                          docType: =.Global.formData.providerDoc.recommendationDoc.type
                          localArr: [1]
                          binaryArr: [1]
                    - actionType: evalObject
                      object:
                        - .Global.Note@: =.Global.formData.providerDoc.recommendationDoc
                        - ..dataTemp.Notes.1.pageName@: RecommendationShared
                    - actionType: evalObject
                      object:
                        - ..dataTemp.Notes.1.pageName@: SelectRecommendation

    # 处理patientid
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.roomInfo.edge.evid
              string2: =.Global.roomInfo.edge.name.providerId
        - .Global.formData.auditLog.patientId@: =.Global.roomInfo.edge.bvid
        - .Global.formData.auditLog.patientId@: =.Global.roomInfo.edge.evid

  dataTemp:
    checkArr:
      ["RecommendationShared", "SelectRecommendation", "SuperbillReview"]
    Notes:
      - title: Superbill
        pageName: SelectSuperbill
      - title: Medical Recommendation
        pageName: MedicalRecommendation
      - title: Progress Report
        pageName: ProgressReport
      - title: Initial Evaluation Report
        pageName: InitEvalReport
      - title: Blank Note/Form
        pageName: BlankNote
      - title: PR-1
        pageName: PROne
      - title: PR-2
        pageName: PRTwo
      - title: Work Status Form
        pageName: WorkStatusForm
      - title: Absence / Excuse Note
        pageName: AbsentNote
      - title: DWC Form RFA
        pageName: DWCFormRFA
      - title: Evaluation Note
        pageName: EvaluationNote
      - title: Prescription (Rx)
        pageName: Prescription
      - title: Surgery Authorization
        pageName: SurgeryAuthorization
      # 2022年7月21日 暂时注释等待产品逻辑
      # - title: Patient Consent Form - HIPPA
      #   pageName: PatientConsentForm

  formData:
    currentPageName: ""
    prescriptionDrug:
      RXcui: ""
      dosage: ""
      drugCode: ""
      genericName: ""
      name: "Search"
      route: ""
      strength: ""
    formatTemplate:
      absentNote: ""
      blankNote: ""
      dWCFormRFA: ""
      evaluation: ""
      initialEvaluationReport: ""
      medicalRecord: ""
      pROne: ""
      pRTwo: ""
      patientConsentForm: ""
      prescription: ""
      progressReport: ""
      surgeryAuthorization: ""
      workStatusForm: ""
  apiRequest:
    diagnosesDoc:
      docResp: ""
      docReq:
        id:
          - =.Global.currentRoom.edge.id
          - =.Global.roomInfo.edge.id
        xfname: "eid,reid"
        type: .DocType.Diagnoses
        obfname: "mtime"
        maxcount: "1"
        _nonce: .Global._nonce
      docAPI:
        .DocAPI: ""
        get:
          api: rd
          dataIn: ProviderNoteSelect.apiRequest.diagnosesDoc.docReq
          dataOut: ProviderNoteSelect.apiRequest.diagnosesDoc.docResp
    superbillDoc:
      docResp: ""
      docReq:
        id:
          - =.Global.roomInfo.edge.id
        xfname: "reid"
        type: .DocType.Superbill
        obfname: "mtime"
        maxcount: "1"
        _nonce: .Global._nonce
      docAPI:
        .DocAPI: ""
        get:
          api: rd
          dataIn: ProviderNoteSelect.apiRequest.superbillDoc.docReq
          dataOut: ProviderNoteSelect.apiRequest.superbillDoc.docResp
  components:
    - .BasePublicHeader:
      children:
        - .BasePublicHeaderLeft:
        - .BasePublicHeaderTitle:
    - type: view
      style:
        width: "1"
        height: "0.1"
        overflow: hidden
        boxShadow: "0px 0px 5px #0000001a"
      children:
        - type: button
          text: Add Document
          onClick:
            - goto: UploadMedicalRecord2
          style:
            marginTop: "0.02"
            borderRadius: "5"
            width: "0.88"
            height: "0.06"
            marginLeft: "0.06"
            border:
              style: 3
            borderColor: "0x2986e3"
            color: "0x2986e3"
            borderWidth: "1"
            fontSize: .Nfont.h16
            backgroundColor: "0xffffff"

            textAlign:
              x: center
              y: center
        - type: image
          path: addDoc.svg
          style:
            top: "0.035"
            left: "0.25"
            height: "0.03"
            zIndex: 10

    - type: scrollView
      style:
        height: "0.845"
        boxSizing: "border-box"
        overflow: scroll
        paddingBottom: "0.03"
      children:
        - type: list
          viewTag: listDataTag
          contentType: listObject
          listObject: ..dataTemp.Notes
          iteratorVar: itemObject
          style:
            width: "1"
            margin: "0"
            height: "auto"
          children:
            - type: listItem
              itemObject:
              style:
                marginTop: "0.01"
                width: "0.9"
                marginLeft: "0.05"
                height: "auto"
                left: "0"
              children:
                - type: label
                  style:
                    # top: "0.01"
                    height: "0.08"
                    left: "0.01"
                    width: "0.88"
                    fontSize: .Nfont.h16
                    boxShadow: "0px 0px 5px 1.5px #DEDEDF"
                    border:
                      style: "3"
                    borderWidth: "1"
                    borderColor: "0xDEDEDF"
                    borderRadius: "5"

                    textAlign:
                      x: center
                      y: center
                  dataKey: itemObject.title
                  onClick:
                    - emit:
                        dataKey:
                          var: itemObject
                        actions:
                          - ..formData.currentPageName@: $var.pageName
                    - actionType: evalObject
                      object:
                        - if:
                            - =.builtIn.array.has:
                                dataIn:
                                  object: =..dataTemp.checkArr
                                  value: =..formData.currentPageName
                            - actionType: popUp
                              popUpView: warnDialogueTag
                              wait: true
                            - continue
                    - emit:
                        dataKey:
                          var: itemObject
                        actions:
                          - if:
                              - true
                              - goto: $var.pageName
                              - goto: $var.pageName
    # 弹窗
    - .warnDialogue:
      viewTag: warnDialogueTag
      leftButton:
        - actionType: popUpDismiss
          popUpView: warnDialogueTag
      rightButton:
        - actionType: popUpDismiss
          popUpView: warnDialogueTag
        - actionType: evalObject
          object:
            - goto: =.ProviderNoteSelect.formData.currentPageName
