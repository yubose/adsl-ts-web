AddPatient:
  # api
  # 1. 获取profile 没用 已删除
  # 2. Get 1053 没用 已删除
  # 3.获取好友邀请 没用已删除
  init:
    - .SignInCheck
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    - =.builtIn.string.concat:
        dataIn:
          - =.Global.MyProfile.name.data.fullName
          - " - "
          - =.Global.MyProfile.name.data.title
        dataOut: AddPatient.invite.edge.name.inviterName
  title: Add Patient
  board:
    - key: boardScan.svg
      value1: Scan QR Code
      value2: Scan a friend's QR code
    - key: mobileContacts.svg
      value1: Mobile Contacts
      value2: Add from mobile address book
  countryCode: "+1"
  firstName: ""
  lastName: ""
  phoneNumber: ""
  inviteMessage: ""
  save:
    - =.AddPatient.invite.edgeAPI.store: ""
  flag: ""
  data: ""
  flagExist: ""
  invited:
    inviteList:
      edge: ""
    edgeReq:
      type: .EdgeType.InviteInfo
      xfname: bvid
      id: .Global.currentUser.vertex.id
      maxcount: "10000"
      _nonce: =.Global._nonce
      obfname: ctime
      sCondition: subtype=65536 AND tage=0
    edgeAPI:
      get:
        api: re
        dataIn: AddPatient.invited.edgeReq
        dataOut: AddPatient.invited.inviteList
      delete:
        api: dx
        dataIn: AddPatient.dataObject
  sendNotification:
    document:
      .Document: ""
      eid: =.AddPatient.invite.response.edge.refid
      subtype:
        isOnServer: 1
        isZipped: 0
        isBinary: 0
        isEncrypted: 0
        isExtraKeyNeeded: 0
        isEditable: 0
        applicationDataType: 0
        # 7 th bit
        notification: 1
        ringToneNotify: 0
        sendtoSelf: 0
        # 10 bit
        textMessage: 0
        mediaType: 8
      type: .DocType.Notification
      tage: 5
      name:
        data: ""
        notification:
          title: AiTmed Connection Request
          context: Connection request from provider
          body: Connection request from provider
          onClickLandingPage: NewConnections
          targetApp: =.Global.prodAPPID
    docAPI:
      store:
        api: cd
        dataIn: sendNotification.document
  formData:
    phoneNumber: ""
    checkOk: ""
    query10002Scondition: ""
  invite:
    edge:
      type: .EdgeType.InviteInfo
      bvid: .Global.currentUser.vertex.id
      _nonce: =.Global._nonce
      subtype: 65536
      name:
        specialty: .Global.MyProfile.name.data.specialty.0.specialty
        inviterAvatar: .Global.MyProfile.name.data.avatar
        phoneNumber: ""
        inviterPhoneNumber: .Global.currentUser.vertex.uid
        inviteeName: ""
        inviterName: ""
        facilityName: "" #when provider add patient this maybe error info
        data:
          phone: ""
    # response for the notification
    response: ""
    edgeAPI:
      store:
        api: ce
        dataIn: AddPatient.invite.edge
        dataOut: AddPatient.invite.response
  apiRequest:
    # 获取patient profile以获取patient fullName，以放在audit log中。
    patientProfile:
      docQueryResp: ""
      docQueryReq:
        id:
        xfname: ovid
        _nonce: =.Global._nonce
        type: .DocType.PatientProfile
        maxcount: 1
        obfname: mtime
      docAPI:
        get:
          api: rd
          dataIn: AddPatient.apiRequest.patientProfile.docQueryReq
          dataOut: AddPatient.apiRequest.patientProfile.docQueryResp
    checkConnection:
      getResp:
        edge: []
      connectEdge:
        id: .Global.currentUser.vertex.id
        sfname: '{"result":"E.*", "join": "INNER JOIN Vertex V on V.id = E.evid OR V.id = E.bvid AND E.tage>0 "}'
        xfname: "E.bvid|E.evid"
        sCondition: =..formData.query10002Scondition
        type: 10002
        ObjType: 28
        _nonce: =.Global._nonce
      edgeApi:
        get:
          api: re
          dataIn: apiRequest.checkConnection.connectEdge
          dataOut: AddPatient.apiRequest.checkConnection.getResp

  components:
    - .BasePublicHeader:
      children:
        - .BasePublicHeaderLeft:
        - .BasePublicHeaderTitle:
    - type: scrollView
      style:
        ..style.scrollBox:
      children:
        - type: view
          style:
            ..style.segmentationBox:
          children:
            - type: label
              text: Quickly Invite
              style:
                ..style.titleLabel:
        - type: view
          viewTag: phoneNumber
          style:
            ..style.blockBox:
          children:
            - type: view
              style:
                ..style.inlineBox:
                marginLeft: "0.04"
              children:
                - type: label
                  text: Country
                  style:
                    ..style.inlineTitle:
                - type: select
                  dataKey: countryCode
                  options: .SelectINformationDM.CountryCode
                  style:
                    ..style.inputBox:
            - type: view
              style:
                ..style.inlineBox:
                marginLeft: "0.032"
              children:
                - type: label
                  textBoard:
                    - text: Phone Number
                    - text: "&nbsp;*"
                      color: "0xff0000"
                  style:
                    ..style.inlineTitle:
                - type: textField
                  viewTag: phoneNumber
                  placeholder: "000-000-0000"
                  dataKey: phoneNumber
                  style:
                    ..style.inputBox:
                    width: "0.6933333"

        - type: button
          text: Invite
          style:
            ..style.btn:
          onClick:
            - ..event.inviteClick
    - type: popUp
      viewTag: inviteView
      message: "Send Invite Link To"
      style:
        top: "0"
        left: "0"
        width: "1"
        height: "1"
        backgroundColor: "0x00000066"
        zIndex: "50"
        textAlign:
          y: center
      leftButton:
        - actionType: popUpDismiss
          popUpView: inviteView
      rightButton:
        - actionType: evalObject
          object:
            - =..invited.edgeAPI.get: ""
        - actionType: evalObject
          object:
            # notification change jwt logic
            - ..invite.edge.facilityName@: =.Global.currentFacility.name.basicInfo.medicalFacilityName
            - =.AddPatient.invite.edgeAPI.store: ""
            - ..apiRequest.patientProfile.docQueryReq.id@: =..invite.response.edge.evid
            - =..apiRequest.patientProfile.docAPI.get: ""
            - ..sendNotification.document.fid@: =.Global.patdAPPID
            - ..sendNotification.document.eid@: =.AddPatient.invite.response.edge.refid
            - =..sendNotification.docAPI.store: ""
            # add patient log
            - =.builtIn.utils.createAuditLog:
                dataIn:
                  actionTypeCode: =.ActionTypeCode.add
                  recordTypeCode: =.EInboxSubtype.PatientProvider
                  eid: =.Global.formData.currentFacility.relationEdge.id
                  user: =.Global.MyProfile.name.data.fullName
                  userId: =.Global.currentUser.vertex.id
                  targetUser: =..apiRequest.patientProfile.docQueryResp.doc.0.name.data.basicInfo.fullName
                  targetUserId: =..invite.response.edge.evid
                  accessPort: provider
        - actionType: popUpDismiss
          popUpView: inviteView
        - actionType: popUp
          popUpView: success
          wait: 2000
        - actionType: builtIn
          funcName: goBack
          reload: true
      children:
        - type: view
          style:
            width: "0.75"
            marginLeft: "0.125"
            backgroundColor: "0xE6E6E6"
            borderRadius: "14px"
          children:
            - type: label
              text: ___.message
              style:
                width: "0.616"
                marginLeft: "0.052"
                marginTop: "0.029"
                fontWeight: "600"
                fontSize: .Nfont.h14

                color: "0x4B4B4B"
                textAlign:
                  x: center
            - type: view
              style:
                marginTop: "0.02"
                width: "0.75"
                textAlign:
                  x: center
              children:
                - type: view
                  children:
                    - type: label
                      text: Send Invite Link To
                      style:
                        fontSize: .Nfont.h14
                        display: inline-block
                    - type: label
                      dataKey: invite.edge.name.phoneNumber
                      style:
                        marginLeft: "0.032"
                        color: "0x0D7AFF"
                        fontSize: .Nfont.h14
                        display: inline-block

            - type: view
              style:
                height: "0.02"
                border:
                  style: 2
                  color: "0x919192"
                borderWidth: "1"
                width: "0.75"
            - type: view
              style:
                width: "0.75"
              children:
                - type: button
                  text: "Cancel"
                  style:
                    color: "0x007AFF"
                    backgroundColor: "0xE6E6E6"
                    display: inline-block
                    width: "0.374"
                    borderRadius: "0 0 0 14px"
                    fontSize: .Nfont.h14
                    height: "0.054"
                    border:
                      style: "1"
                  onClick: ____.leftButton
                - type: view
                  style:
                    width: "0.002"
                    backgroundColor: "0x919192"
                    display: inline-block
                    height: "0.054"
                    zIndex: "50"
                - type: button
                  text: "Confirm"
                  style:
                    color: "0x007AFF"
                    fontWeight: "800"
                    backgroundColor: "0xE6E6E6"
                    display: inline-block
                    width: "0.374"
                    fontSize: .Nfont.h14
                    borderRadius: "0 0 14px 0"
                    height: "0.054"
                    border:
                      style: "1"
                  onClick: ____.rightButton

    - .BaseCheckView:
      viewTag: phoneRepeat
      message: "The phone number is already added"
      colorChange: "0x2988e6"
      imgPath: aboutBlue.svg
      children:
        - type: view
          style:
            width: "0.8"
            height: "0.3"
            top: "0.3"
            left: "0.1"
            zIndex: "100"
            backgroundColor: "0xffffff"
            borderRadius: "7"
            border:
              style: "3"
            borderColor: "#f4f8fa"
            borderWidth: "3"
          children:
            - .BaseCheckViewImg:
            - .BaseCheckViewLabel:
            - .BaseCheckViewButton:
              onClick:
                - actionType: updateObject
                  dataKey: AddConnect.apiRequest.checkConnection.getResp
                  dataObject: []
                - actionType: popUpDismiss
                  popUpView: ____.viewTag

    - .BaseWarningView:
      message: "You cannot add yourself"
      viewTag: selfCheck

    - .BaseWarningView:
      message: "This patient has been invited."
      viewTag: phoneInvited

    - .BaseWarningView:
      message: "The phone number is wrong"
      viewTag: phoneNumberCheck

    - .BackgroundColorGray:
      viewTag: success
      style:
        zIndex: 10000
      children:
        - type: view
          style:
            width: "0.4"
            height: "auto"
            backgroundColor: "0xe5e5e5"
            borderRadius: "12"
            top: "0.43"
            left: "0.3"
            textAlign:
              x: center
          children:
            - type: image
              path: deleteTrue.svg
              style:
                width: "0.105"
                marginTop: "0.025"
            - type: label
              text: "Invite Successfully!"
              dataKey:
              style:
                color: "0x555555"
                fontSize: .Nfont.h12

                word-break: break-word
                width: "0.35"
                marginLeft: "0.025"
                marginTop: "0.009"
                textAlign:
                  x: center
            - type: view
              style:
                width: "0.01"
                height: "0.02"

    - .BaseCheckView:
      message: "Please Check Your Firsr Name and Last Name"
      viewTag: checkNameView
      colorChange: "0x2988e6"
      imgPath: aboutBlue.svg
      children:
        - type: view
          style:
            width: "0.8"
            height: "0.3"
            top: "0.3"
            left: "0.1"
            zIndex: "100"
            backgroundColor: "0xffffff"
            borderRadius: "7"
            border:
              style: "3"
            borderColor: "#f4f8fa"
            borderWidth: "3"
          children:
            - .BaseCheckViewImg:
            - .BaseCheckViewLabel:
            - .BaseCheckViewButton:
              onClick:
                - actionType: popUpDismiss
                  popUpView: ____.viewTag
    - .BaseCheckView:
      message: "Please Check Your Phone Number"
      viewTag: checkPhoneView
      colorChange: "0x2988e6"
      imgPath: aboutBlue.svg
      children:
        - type: view
          style:
            width: "0.8"
            height: "0.3"
            top: "0.3"
            left: "0.1"
            zIndex: "100"
            backgroundColor: "0xffffff"
            borderRadius: "7"
            border:
              style: "3"
            borderColor: "#f4f8fa"
            borderWidth: "3"
          children:
            - .BaseCheckViewImg:
            - .BaseCheckViewLabel:
            - .BaseCheckViewButton:
              onClick:
                - actionType: popUpDismiss
                  popUpView: ____.viewTag
  event:
    inviteClick:
      - actionType: evalObject
        object:
          - actionType: evalObject
            object:
              .Global._nonce@:
                =.builtIn.math.random: ""
          # put checkConnection.getResp to empty so that even the get value is empty , the old data is not exist.
          - ..apiRequest.checkConnection.getResp.edge@: []
          # - ..apiRequest.checkConnection.getResp@: "" #1/28: not successfully make getResp to be empty, if first invite an invited user, still remain edge in getResp
          - =.builtIn.string.concat:
              dataIn:
                - =..countryCode
                - " "
                - =..phoneNumber
              dataOut: AddPatient.invite.edge.name.phoneNumber
          - =.builtIn.string.concat:
              dataIn:
                - =..countryCode
                - " "
                - =..phoneNumber
              dataOut: AddPatient.invite.edge.name.data.phone
          - =.builtIn.string.concat:
              dataIn:
                - "V.uid like '%"
                - =..phoneNumber
                - "' AND E.tage>=0" #
              dataOut: AddPatient.formData.query10002Scondition
          - =.builtIn.string.concat:
              dataIn:
                - (
                - =..invite.edge.name.phoneNumber
                - )
              dataOut: AddPatient.inviteMessage
      # 检测手机是否符合规范
      - actionType: evalObject
        object:
          - if:
              - =.builtIn.string.equal:
                  dataIn:
                    string1: =..countryCode
                    string2: "+965" # Kuwait
              - continue
              - actionType: evalObject
                object:
                  - if:
                      - =.builtIn.string.phoneVerification: #手机号是否符合格式
                          dataIn:
                            phoneNumber: =..phoneNumber
                            countryCode: =..countryCode
                      - continue
                      - actionType: popUp
                        popUpView: phoneNumberCheck
                        wait: true

      #检查是否添加的是否为自己
      - actionType: evalObject
        object:
          - if:
              - =.builtIn.string.equal:
                  dataIn:
                    string1: =..invite.edge.name.phoneNumber
                    string2: =.Global.currentUser.vertex.uid
              - actionType: popUp
                popUpView: selfCheck
                wait: true
              - continue
      # 检测是否已经成为好友
      - actionType: evalObject
        object:
          - .AddPatient.apiRequest.checkConnection.getResp.edge@: [] #1/28: before check, clear edge, otherwise may keep popup 'already invited user'
          - =..apiRequest.checkConnection.edgeApi.get: ""
          - if:
              - =.builtIn.array.judgeListLength:
                  dataIn:
                    array: =..apiRequest.checkConnection.getResp.edge
                    len: 0
              # 如果是空 说明不存在好友关系
              - continue
              - actionType: popUp
                popUpView: phoneInvited
                wait: true
                popUpDismiss: 2000

      - actionType: builtIn
        funcName: redraw
        viewTag: inviteView
      - actionType: popUp
        popUpView: inviteView
        wait: true
  style:
    scrollBox:
      width: "1"
      height: "0.94"
      overflow: scroll
    segmentationBox:
      width: "1"
      height: "auto"
      backgroundColor: "0xf0f0f0"
    titleLabel:
      marginLeft: "0.04"
      color: "0x666666"
      height: "0.05"
      width: "auto"
      lineHeight: 5vh

      fontSize: .Nfont.h14
      fontWeight: "600"
    blockBox:
      marginTop: "0.0246"
      width: "auto"
      height: "auto"
      oveflow: hidden
    inlineBox:
      display: "inline-block"
      width: "auto"
      height: "auto"
      oveflow: hidden
      verticalAlign: middle
    inlineTitle:
      color: "#333333"
      fontSize: .Nfont.h14
      height: "auto"
      width: "auto"
    inputBox:
      marginTop: "0.009852"
      height: "0.0443"
      width: "0.2"
      fontSize: .Nfont.h14
      color: "#333333"
      border:
        style: 3
      borderWidth: "1.5"
      borderColor: "#dededf"
      boxSizing: border-box
      borderRadius: "4"
      textIndent: "8px"

    btn:
      marginTop: "0.0492"
      left: "0.08"
      width: "0.84"
      height: "0.05"
      fontSize: .Nfont.h14
      fontWeight: "600"
      color: "0x5ea6ec"
      backgroundColor: "0xffffff"
      border:
        style: "3"
      borderColor: "0x2988e6"
      borderWidth: "1"
      borderRadius: "5"
      textAlign:
        x: center
