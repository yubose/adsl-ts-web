AvailableProfileOffice:
  pageNumber: "170"
  title: "Available Profile"
  init:
    - .SignInCheck
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    - =.builtIn.utils.setTimer:
        dataIn:
          timeUnix: 1000
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.currentUser.vertex.id
              string2: =.Global.currentFacility.id
        - ..getSchedule.get
        - actionType: evalObject
          object:
            # 获取所有的location
            # - .Global.createjwt.edge.bvid@: =.Global.currentFacility.id
            # - =.Global.createjwt.edgeAPI.store: ""
            - =..fac_RootNotebook.edgeAPI.get: ""
            - =..locationAll.docAPI.get: ""
            # 获取返回的列表中第一个location
            - ..midLocation@: =..locationAll.docResp.doc.0
            # 把 address name 放到数组里面， 方便下拉框展示
            - =.builtIn.array.selectOneToArr:
                dataIn:
                  arr: =..midLocation.name.data.allLocation
                  key: "medicalFacilityName"
                dataOut: AvailableProfileOffice.addressName
            - ..formData.name.setting.Address@: =..addressName.0
            # 根据第一个name的名字去匹配第一个id
            - =.builtIn.array.matchInArray:
                dataIn:
                  arr: =..midLocation.name.data.allLocation
                  value: =..addressName.0
                  key: medicalFacilityName
                  key1: "id"
                dataOut: AvailableProfileOffice.locationId
            #  获取当前默认选中的location的schedule
            - =.builtIn.array.add:
                dataIn:
                  object: =..getScheduleOfficeVisit.edgeReq.id
                  value: =..locationId
            - .Global.locationId@: =..locationId
            - =..getScheduleOfficeVisit.get: ""
            - ..getSchedule.schedule@: =..getScheduleOfficeVisit.schedule
    # location 不可能为空 所以暂时注释  2021/12/15 如果一个月之后(2022/1/15)没问题可以删除该段代码
    # - if:
    #     - =.builtIn.string.equal:
    #         dataIn:
    #           string1: =..locationId
    #           string2: ""
    #     - actionType: evalObject
    #       object:
    #         - ..getScheduleOfficeVisit.edgeReq.id@: []
    #         - ..locationId@: =.Global.currentFacility.id
    #         - .Global.locationId@: =.Global.currentFacility.id
    #         - =.builtIn.array.add:
    #             dataIn:
    #               object: =..addressName
    #               value: =.Global.currentFacility.name.basicInfo.medicalFacilityName
    #         - ..formData.name.setting.Address@: =.Global.currentFacility.name.basicInfo.medicalFacilityName
    #         - =.builtIn.array.add:
    #             dataIn:
    #               object: =..getScheduleOfficeVisit.edgeReq.id
    #               value: =.Global.currentUser.vertex.id
    #         - =.builtIn.array.add:
    #             dataIn:
    #               object: =..getScheduleOfficeVisit.edgeReq.id
    #               value: =..locationId
    #         - =..getScheduleOfficeVisit.get: ""
    #         - ..getSchedule.schedule@: =..getScheduleOfficeVisit.schedule
    #     - continue
    # - actionType: evalObject
    #   object:
    #     - ..formData@: ..getSchedule.schedule.edge.0
    # - ..formData.name.setting.Address@: =.Global.currentFacility.name.basicInfo.medicalFacilityName
    - if:
        - =..getSchedule.schedule.edge.0
        - continue
        - =.builtIn.checkField:
            dataIn:
              contentType: messageHidden
              wait: 100
    - if:
        - =..getSchedule.schedule.edge.0
        - ..buttonText@: "Update Now"
        - ..buttonText@: "Create Now"
    - actionType: updateObject
      dataKey: Global.currentSchdule
      dataObject: .EmptyObj
    - actionType: evalObject
      object:
        - ..midSchedule@: =..getSchedule.schedule.edge.0
        - =.builtIn.array.WeekSchedule:
            dataIn:
              planObject: =..midSchedule.name.setting.day
            dataOut: AvailableProfileOffice.day
  getSchedule:
    schedule:
      edge: ""
    get:
      .EdgeAPI.get: ""
      api: re
      dataKey: AvailableProfileOffice.getSchedule.schedule
      type: 40000
      # id: .Global.currentUser.vertex.id
      id:
        - .Global.currentFacility.id
        - .Global.currentUser.vertex.id
      sCondition: "subtype=131075"
      # sCondition: "subtype=196611"
      xfname: "bvid,evid"
      maxcount: "1"
      obfname: "ctime"
      _nonce: =.Global._nonce
  locationId: ""
  midLocation: ""
  midSchedule: ""
  weekLabel:
    - key: Sunday
    - key: Monday
    - key: Tuesday
    - key: Wednesday
    - key: Thursday
    - key: Friday
    - key: Saturday
  locationAll: # 把所有的location 信息，在schedule那边显示
    docResp: "" # get到的值
    docIn: # for geting all of the location
      type: .DocType.LocationOfFacility
      id: =.AvailableProfileOffice.fac_RootNotebook.edge.edge.0.id
      xfname: eid
      obfname: mtime
      maxcount: "1"
      name:
        data:
          allLocation:
    docAPI:
      .DocAPI: ""
      get:
        api: rd
        dataIn: AvailableProfileOffice.locationAll.docIn
        dataOut: AvailableProfileOffice.locationAll.docResp

  fac_RootNotebook:
    edgeReq:
      id: .Global.currentFacility.id
      xfname: bvid
      type: 10000
    edge: ""
    edgeAPI:
      get:
        api: re
        dataIn: AvailableProfileOffice.fac_RootNotebook.edgeReq
        dataOut: AvailableProfileOffice.fac_RootNotebook.edge
  getScheduleOfficeVisit:
    edgeReq:
      type: 40000
      id:
        - .Global.currentUser.vertex.id
        # - .Global.currentFacility.id
      sCondition: "subtype=131075"
      # sCondition: "subtype=196611"
      xfname: "evid,bvid"
      maxcount: "1"
      obfname: "ctime"
      _nonce: =.Global._nonce
    schedule:
      edge:
        ""
        # name:
        #   setting:
        #     day: []
    get:
      .EdgeAPI.get: ""
      api: re
      dataIn: AvailableProfileOffice.getScheduleOfficeVisit.edgeReq
      dataOut: AvailableProfileOffice.getScheduleOfficeVisit.schedule
  formData:
    name:
      setting:
        Address: ""
  addressName: []
  buttonText: ""
  day: ""
  components:
    - .BaseHeader:
    - .HeaderLeftButton:
      onClick:
        - goto: ScheduleProfile
    - type: view
      style:
        left: "0"
        width: "1"
        top: "0.1"
        height: "0.05"
      children:
        - type: button
          text: "Telemedicine"
          style:
            width: "0.25"
            backgroundColor: "0xffffff"
            border: "none"
            left: "0.2"
            height: "0.05"
            top: "0"
            textAlign:
              x: center
          onClick:
            - goto: AvailableProfileTelemedicine
        - type: button
          text: "Office Visits"
          style:
            width: "0.25"
            backgroundColor: "0xffffff"
            border:
              style: "2"
            borderWidth: "1"
            borderColor: "#0088e2"
            left: "0.55"
            height: "0.05"
            top: "0"
            textAlign:
              x: center
    - type: scrollView
      style:
        left: "0"
        top: "0.15"
        width: "1"
        height: "0.7"
        overflow: scroll
      children:
        - type: view
          style:
            marginTop: "0"
            left: "0"
            width: "1"
            height: "auto"
          children:
            - type: view
              style:
                marginTop: "0"
                left: "0"
                width: "1"
                height: "auto"
              children:
                - type: view
                  style:
                    left: "0"
                    marginTop: "0"
                    height: "auto"
                    # border:
                    #   style: "2"
                    # borderWidth: "2"
                    # borderColor: "#bfbfbf"
                  children:
                    - type: view
                      style:
                        width: "1"
                        height: "auto"
                        left: "0"
                        marginTop: "0"
                        # border:
                        #   style: "2"
                        # borderWidth: "2"
                        # borderColor: "#bfbfbf"
                      children:
                        - type: view
                          style:
                            width: "0.98"
                            height: "0.1"
                            left: "0"
                            marginTop: "0"
                            # border:
                            #   style: "2"
                            # borderWidth: "2"
                            # borderColor: "#bfbfbf"
                          children:
                            - type: view
                              style:
                                left: "0"
                                marginTop: "0"
                                height: "0.05"
                                width: "1"
                                backgroundColor: "0xf0f0f0"
                              children:
                                - type: label
                                  text: Address
                                  style:
                                    width: "0.95"
                                    height: "0.05"
                                    marginTop: "0"
                                    left: "0.05"
                                    color: "#4B4B4B"
                                    textAlign:
                                      y: center
                                    fontFamily: "Arial"
                                    fontSize: .Nfont.h14
                                    fontWeight: "600"
                                    backgroundColor: "#F0F0F0"
                            - type: view
                              style:
                                marginTop: "0.005"
                                left: "0.05"
                                width: "0.9"
                                height: "auto"
                              children:
                                - type: select
                                  dataKey: formData.name.setting.Address
                                  options: ..addressName
                                  onChange:
                                    - actionType: evalObject
                                      object:
                                        - .Global._nonce@:
                                            =.builtIn.math.random: ""
                                        - ..getScheduleOfficeVisit.edgeReq.id@:
                                            []
                                        - ? ..getScheduleOfficeVisit.schedule.edge@
                                          : []
                                        - ..dayOfficeVisit@: []
                                        - =.builtIn.array.add:
                                            dataIn:
                                              object: =..getScheduleOfficeVisit.edgeReq.id
                                              value: =.Global.currentUser.vertex.id
                                        - =.builtIn.array.matchInArray:
                                            dataIn:
                                              arr: =..midLocation.name.data.allLocation
                                              value: =..formData.name.setting.Address
                                              key: medicalFacilityName
                                              key1: "id"
                                            dataOut: AvailableProfileOffice.locationId
                                    - actionType: evalObject
                                      object:
                                        - =.builtIn.array.add:
                                            dataIn:
                                              object: =..getScheduleOfficeVisit.edgeReq.id
                                              value: =..locationId
                                    - actionType: evalObject
                                      object:
                                        - .Global.locationId@: =..locationId
                                        - .Global.address@: =..formData.name.setting.Address
                                    - actionType: evalObject
                                      object:
                                        # 把id置空， 再重新添加选择的location的id，再get
                                        - =..getScheduleOfficeVisit.get: ""
                                        - ..getSchedule.schedule@: =..getScheduleOfficeVisit.schedule
                                        - =.builtIn.array.WeekSchedule:
                                            dataIn:
                                              planObject: =..getSchedule.schedule.edge.0.name.setting.day
                                            dataOut: AvailableProfileOffice.day
                                    - actionType: evalObject
                                      object:
                                        - if:
                                            - =..getSchedule.schedule.edge.0
                                            - ..buttonText@: "Update Now"
                                            - ..buttonText@: "Create Now"
                                        - if:
                                            - =..getScheduleOfficeVisit.schedule.edge.0.id
                                            - actionType: builtIn
                                              funcName: hide
                                              viewTag: messageTag
                                            - actionType: builtIn
                                              funcName: show
                                              viewTag: messageTag
                                    - actionType: evalObject
                                      object:
                                        - actionType: builtIn
                                          funcName: redraw
                                          viewTag: buttontext
                                    - actionType: builtIn
                                      funcName: redraw
                                      viewTag: officeTag2
                                    - actionType: evalObject
                                      object:
                                        - actionType: builtIn
                                          funcName: redraw
                                          viewTag: officeTag3
                                    - actionType: evalObject
                                      object:
                                        - actionType: builtIn
                                          funcName: redraw
                                          viewTag: officeTag1
                                  style:
                                    marginTop: "0"
                                    left: "0.05"
                                    width: "0.8"
                                    height: "0.04"
                                    border:
                                      style: "3"
                                    borderWidth: "1"
                                    borderColor: "0xefefef"
                        - type: view
                          style:
                            left: "0"
                            marginTop: "0"
                            height: "0.05"
                            width: "1"
                            backgroundColor: "0xf0f0f0"
                          children:
                            - type: label
                              text: "Available Days"
                              style:
                                width: "0.95"
                                height: "0.05"
                                marginTop: "0"
                                left: "0.05"
                                color: "#4B4B4B"
                                textAlign:
                                  y: center
                                fontFamily: "Arial"
                                fontSize: .Nfont.h14
                                fontWeight: "600"
                                backgroundColor: "#F0F0F0"
                                # textIndent: "2em"
                        - type: list
                          viewTag: officeTag1
                          contentType: listObject
                          listObject: ..day # to dataObject to enumerate the list
                          iteratorVar: itemObject
                          style:
                            # marginTop:  "0.05"
                            left: "0"
                            width: "1"
                            height: "auto"
                            marginTop: "0"
                          children:
                            - type: listItem
                              itemObject: ""
                              style:
                                marginTop: "0"
                                height: "auto"
                                left: "0"
                                width: "1"
                                # border:
                                #   style: "2"
                                # borderBottom: "1px solid #DEDEDF"
                                # borderColor: "0xDEDEDF6f"
                                # borderWidth: "1"
                              children:
                                - type: label
                                  dataKey: itemObject.weekDay
                                  style:
                                    left: "0.05"
                                    width: "0.24"
                                    marginTop: "0.01"
                                    height: "0.04"
                                    fontWeight: "500"
                                    fontSize: .Nfont.h16
                                - type: label
                                  dataKey: itemObject.info
                                  style:
                                    left: "0.05"
                                    width: "0.4"
                                    marginTop: "0"
                                    height: "auto"
                                    fontSize: .Nfont.h14
                                - type: view
                                  style:
                                    width: "1"
                                    height: "0.001"
                                    marginTop: "0"
                                    backgroundColor: "0xDEDEDF6f"
                        - type: view
                          style:
                            left: "0"
                            marginTop: "0"
                            height: "auto"
                            width: "1"
                          children:
                            - type: view
                              style:
                                left: "0"
                                marginTop: "0"
                                height: "0.05"
                                width: "1"
                                backgroundColor: "0xf0f0f0"
                              children:
                                - type: label
                                  text: "Duration"
                                  style:
                                    width: "0.95"
                                    height: "0.05"
                                    marginTop: "0"
                                    left: "0.05"
                                    color: "#4B4B4B"
                                    textAlign:
                                      y: center
                                    fontFamily: "Arial"
                                    fontSize: .Nfont.h14
                                    fontWeight: "600"
                                    backgroundColor: "#F0F0F0"
                            - type: view
                              style:
                                width: "1"
                                height: "0.04"
                                marginTop: "0.01"
                              children:
                                - .PatientChartShowTitle:
                                  style:
                                    width: "0.4"
                                    marginLeft: "0.05"
                                    verticalAlign: middle
                                    display: "inline-block"
                                  text: "Duration: (weeks)"
                                - type: label
                                  viewTag: officeTag2
                                  style:
                                    width: "0.5"
                                    verticalAlign: middle
                                    fontSize: .Nfont.h2
                                    display: "inline-block"
                                    textAlign:
                                      x: right
                                  dataKey: getSchedule.schedule.edge.0.name.setting.forwardRepeatWeeks

                            - type: view
                              viewTag: officeTag3
                              style:
                                marginTop: "0.01"
                                width: "1"
                                height: "0.04"
                              children:
                                - .PatientChartShowTitle:
                                  text: "Start Day:"
                                  style:
                                    width: "0.55"
                                    marginLeft: "0.05"
                                    verticalAlign: middle
                                    display: "inline-block"
                                - type: label
                                  dataKey: getSchedule.schedule.edge.0.name.setting.startDate
                                  style:
                                    display: "inline-block"
                                    # marginTop: "0.015"
                                    width: "0.35"
                                    fontSize: .Nfont.h2
                                    verticalAlign: middle
                                    textAlign:
                                      x: right
                            # - type: view
                            #   style:
                            #     marginTop: "0.01"
                            #     left: "0.05"
                            #     width: "0.9"
                            #     height: "0.04"
                            #   children:
                            #     - .PatientChartShowTitle:
                            #       text: "End Day:"
                            #       style:
                            #         width: "0.6"
                            #     - type: label
                            #       dataKey: formData.name.setting.endDate
                            #       style:
                            #         top: "0.01"
                            #         left: "0.5"
                            #         width: "0.4"
                            #         height: "0.02"
                            #         textAlign:
                            #           x: right
                    # - type: view
                    #   style:
                    #     width: "0.98"
                    #     # height: "0.2"
                    #     left: "0"
                    #     marginTop: "0.01"
                    #     # border:
                    #     #   style: "2"
                    #     # borderWidth: "2"
                    #     # borderColor: "#bfbfbf"
                    #   children:
                    #     - type: view
                    #       style:
                    #         left: "0"
                    #         marginTop: "0"
                    #         height: "0.05"
                    #         width: "1"
                    #         backgroundColor: "0xf0f0f0"
                    #       children:
                    #         - type: label
                    #           text: Blocked off days
                    #           style:
                    #             width: "0.95"
                    #             height: "0.05"
                    #             top: "0"
                    #             left: "0.05"
                    #             color: "#4B4B4B"
                    #             textAlign:
                    #               y: center
                    #             fontFamily: "Arial"
                    #             fontSize: .Nfont.h14
                    #             fontWeight: "600"
                    #             backgroundColor: "#F0F0F0"
                    #     - type: view
                    #       style:
                    #         marginTop: "0.01"
                    #         left: "0.05"
                    #         width: "0.9"
                    #         height: "0.04"
                    #       children:
                    #         - .PatientChartShowTitle:
                    #           text: "Blocked"
                    #           style:
                    #             width: "0.6"
                    #         - type: select
                    #           dataKey: formData.name.setting.blockDays
                    #           options:
                    #             ..formData.name.setting.blockDays
                    #           style:
                    #             top: "0.01"
                    #             left: "0.62"
                    #             width: "0.28"
                    #             height: "0.03"
                    #             textAlign:
                    #               x: right
                    #     # - type: list
                    #     #   contentType: listObject
                    #     #   listObject: ..formData.name.setting.blockDays # to dataObject to enumerate the list
                    #     #   iteratorVar: itemObject
                    #     #   style:
                    #     #     margin: "0"
                    #     #     marginTop: "0.01"
                    #     #     left: "0.3"
                    #     #     width: "0.4"
                    #     #     height: "auto"
                    #     #   children:
                    #     #     - type: listItem
                    #     #       itemObject: ""
                    #     #       style:
                    #     #         width: "0.4"
                    #     #         height: "0.04"
                    #     #       children:
                    #     #         - type: label
                    #     #           dataKey: itemObject
                    #     #           style:
                    #     #             top: "0.005"
                    #     #             fontSize: "15"
                    #     #             height: "0.03"

                    #     - type: view
                    #       style:
                    #         marginTop: "0.02"
                    #         left: "0.05"
                    #         width: "0.9"
                    #         height: "0.04"
                    #       children:
                    #         - .PatientChartShowTitle:
                    #           text: "Block Government holiday"
                    #           style:
                    #             width: "0.6"
                    #         - type: image
                    #           path:
                    #             emit:
                    #               actions:
                    #                 - if:
                    #                   - =.AvailableProfileTelemedicine.formData.name.setting.governmentHolidays
                    #                   - checkbox.svg
                    #                   - dontselect.png
                    #           style:
                    #             top: "0.01"
                    #             left: "0.8"
                    #             height: "0.02"
                    #         # - .PatientChartShowData:
                    #         #   style:
                    #         #     width: "0.2"
                    #         #   dataKey: formData.name.setting.governmentHolidays
                    #     - type: view
                    #       style:
                    #         marginTop: "0.02"
                    #         left: "0.05"
                    #         width: "0.9"
                    #         height: "0.04"
                    #       children:
                    #         - .PatientChartShowTitle:
                    #           text: "Block business holiday"
                    #         # - .PatientChartShowData:
                    #         #   style:
                    #         #     width: "0.1"
                    #         #   dataKey: formData.name.setting.businessHolidays
                    #         - type: image
                    #           path:
                    #             emit:
                    #               actions:
                    #                 - if:
                    #                   - =.AvailableProfileTelemedicine.formData.name.setting.businessHolidays
                    #                   - checkbox.svg
                    #                   - dontselect.png
                    #           style:
                    #             top: "0.01"
                    #             left: "0.8"
                    #             height: "0.02"

    - type: view
      style:
        top: "0.9"
        width: "1"
        height: "0.1"
        # isHidden: true
        backgroundColor: "0xffffff"
      children:
        - type: button
          dataKey: buttonText
          style:
            width: "0.7"
            height: "0.05"
            left: "0.15"
            border: "none"
            FontSize: "18"
            backgroundColor: "0x2988e6"
            color: "0xffffff"
            textAlign:
              x: center
          onClick:
            - actionType: evalObject
              object:
                - .Global.setSchedule.scheduleTypeNumber@: 131075
                - .Global.setSchedule.scheduleType@: "Office Visits"
                - if:
                    - =.AvailableProfileOffice.getSchedule.schedule.edge.0.id
                    - .Global.currentSchdule@: =..getSchedule.schedule.edge.0
                    - .AvailableProfileOffice.test@: "123"
                - if:
                    - =.builtIn.string.equal:
                        dataIn:
                          string1: =.Global.currentUser.vertex.id
                          string2: =.Global.currentFacility.id
                    - continue
                    - .Global.address@: =.AvailableProfileOffice.formData.name.setting.Address
            - goto: CreateAvailability
    - type: view
      contentType: messageHidden
      viewTag: messageTag
      style:
        top: "0.25"
        left: "0"
        width: "1"
        height: "0.7"
        # zIndex: "20"
        isHidden: true
        backgroundColor: "0xffffff"
        # zIndex: "10"
      children:
        - type: view
          style:
            left: "0"
            top: "0"
            width: "1"
            height: "0.7"
            backgroundColor: "0xffffffff"
        - type: label
          text: You should create availability settings first, Please click the following button to create availability settings
          style:
            top: "0.05"
            left: "0.1"
            width: "0.8"
            fontSize: "19"
            textAlign:
              x: center
        - type: button
          viewTag: buttontext
          dataKey: buttonText
          style:
            width: "0.7"
            top: "0.23"
            height: "0.05"
            left: "0.15"
            border: "none"
            fontSize: "18"
            backgroundColor: "0x2988e6"
            color: "0xffffff"
            textAlign:
              x: center
          onClick:
            - actionType: evalObject
              object:
                - .Global.setSchedule.scheduleTypeNumber@: 131075
                - .Global.setSchedule.scheduleType@: "Office Visits"
                - if:
                    - =.builtIn.string.equal:
                        dataIn:
                          string1: =.Global.currentUser.vertex.id
                          string2: =.Global.currentFacility.id
                    - continue
                    - .Global.address@: =.AvailableProfileOffice.formData.name.setting.Address

            - goto: CreateAvailability
