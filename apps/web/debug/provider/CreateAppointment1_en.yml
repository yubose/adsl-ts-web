CreateAppointment1:
  title: "Create Appointment"
  pageNumber: "1960"
  init:
    - .SignInCheck
    - =.builtIn.string.concat:
        dataIn:
          - =..selectDate
          - " at "
          - =.Global.clock.showTime
        dataOut: CreateAppointment1.selectDate
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.formData.appointment.visitType
              string2: "Telemedicine"
        - ..newAppointment.edge.name.fontColor@: "#30b354"
        - ..newAppointment.edge.name.fontColor@: "#ffc02d"
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.formData.appointment.visitType
              string2: "Telemedicine"
        - ..newAppointment.edge.name.blockColor@: "#e4f5e9"
        - ..newAppointment.edge.name.blockColor@: "#fff7e3"
    - if:
        - .Global.middleInformation.PatientVisitInfo.phoneNumber.1
        - actionType: evalObject
          object:
            - ..formData.patientName@: =.Global.middleInformation.PatientVisitInfo.name.data.basicInfo.fullName
            - ..formData.patientPhoneNumber@: =.Global.middleInformation.PatientVisitInfo.phoneNumber.1
        - continue
    - ..middleData@: =.Global.middleInformation.PatientVisitInfo
    # - if:
    #   - .Global.middleInformation.PatientVisitInfo
    #   - continue
    #   - newAppointment.edge.name.patientName@: =..patient.name

  selectDate: .Global.formData.appointment.selectDate
  formData:
    middleData:
      phoneNumber: []
    patientName: ""
    patientPhoneNumber: ""
  invite:
    response: ""
    edge:
      type: .EdgeType.InviteInfo
      refid: ""
      # bvid: .Global.currentUser.vertex.id
      # bvid: .Global.currentFacility.id
      bvid: .Global.clock.bvid
      evid: .Global.currentUser.vertex.id
      _nonce: =.Global._nonce
      # evid: "NzczFCtoRgYkcD3yEvGhRA=="
      name:
        phoneNumber: ""
        firstName: .Global.currentUser.vertex.name.firstName
        lastName: .Global.currentUser.vertex.name.lastName
        name: .Global.MyProfile.name.data.fullName
        hostName: ""
        roomName: ""
        date: ""
    edgeAPI:
      # .EdgeAPI: ""
      store:
        api: ce
        dataIn: CreateAppointment1.invite.edge
        dataOut: CreateAppointment1.invite.response

  inviteInfo:
    response:
      edge:
    store:
      .EdgeAPI.get: ""
      api: ce
      dataIn: inviteInfo.edge
      dataOut: CreateAppointment1.inviteInfo.response
    delete:
      api: dx
      dataIn: CreateAppointment1.inviteInfo.response.edge
      # dataOut: CreateAppointment1.inviteInfo.response
    edge:
      type: .EdgeType.InviteInfo
      refid: ""
      bvid: .Global.currentUser.vertex.id
      # bvid: .Global.currentFacility.id
      _nonce: "=.Global._nonce"
      # evid: "NzczFCtoRgYkcD3yEvGhRA=="
      name:
        phoneNumber: ..formData.patientPhoneNumber
        firstName: ""
        lastName: ""
        name: ""
        hostName: .Global.MyProfile.name.data.fullName
        roomName: ""
        date: ""

  newAppointment:
    response: ""
    edge:
      .Edge: ""
      evid: ..inviteInfo.response.edge.evid
      subtype: .Global.E2Subtype
      bvid: .Global.currentUser.vertex.id
      stime:
      etime:
      tage: 86400
      type: 40000
      name:
        duration: ""
        patientName: ..formData.patientName #"" #病人名字
        patientPhoneNumber: ..formData.patientPhoneNumber
        visitType: .Global.formData.appointment.visitType # visitType 用于判定
        visitTypeShow: .Global.formData.appointment.visitType # visitType 用于显示 ，避免和判定冲突
        providerName: .Global.MyProfile.name.data.fullName # 医生名字
        facilityId: .Global.clock.bvid # facility id
        visitReason: "" # 看病原因
        blockColor: "" #背景色
        fontColor: "" #字体颜色
        Reason: .Global.formData.appointment.selectData.reason # 看病原因的拼接，用于展示
        document: [] # 看病原因要填写的vaccin
        providerId: =.Global.currentUser.vertex.id
    edgeAPI:
      .EdgeAPI: ""
      store:
        api: ce
        dataIn: newAppointment.edge
        dataOut: CreateAppointment1.newAppointment.response
  sendNotification:
    document:
      .Document: ""
      eid: =..newAppointment.response.edge.id
      subtype:
        isOnServer: 1
        isZipped: 0
        isBinary: 0
        isEncrypted: 0
        isExtraKeyNeeded: 0
        isEditable: 0
        applicationDataType: 0
        # 7 th bit
        notification: 1
        ringToneNotify: 0
        sendtoSelf: 0
        # 10 bit
        textMessage: 0
        mediaType: 8
      type: .DocType.Notification
      tage: 5
      name:
        data: ""
        #        senderId: ".Global.currentUser.vertex.id"
        #        senderName: ".Global.currentUser.vertex.name.userName"
        #        data:
        #          text: ''
        notification:
          title: Create Appoint From Provider
          context: Appointment request from provider #need change
          body: Appointment request from provider #need change
          landingPage: AppointmentRequest
          targetApp: =.FirebaseToken.response.edge.evid
    docAPI:
      store:
        api: cd
        dataIn: sendNotification.document
  apiRequest: #Input data request here
    approveAppointment:
      response: ""
      edge:
        bvid: .Global.currentUser.vertex.id
        evid: ""
        refid: ""
        type: 40000
        subtype: 5
      edgeAPI:
        .EdgeAPI: ""
        store:
          api: ce
          dataIn: apiRequest.approveAppointment.edge
          dataOut: apiRequest.approveAppointment.response
    inviteFacility:
      response: ""
      edge:
        bvid: .Global.currentUser.vertex.id
        evid: .Global.clock.bvid
        refid: ""
        type: 40000
        subtype: 10
      edgeAPI:
        .EdgeAPI: ""
        store:
          api: ce
          dataIn: apiRequest.inviteFacility.edge
          dataOut: apiRequest.inviteFacility.response

  # newTextMessage:
  #   document:
  #     eid: "=..newAppointment.response.id"
  #     subtype:
  #       isOnServer: 1
  #       isZipped: 0
  #       isBinary: 0
  #       isEncrypted: 0
  #       isExtraKeyNeeded: 0
  #       isEditable: 0
  #       applicationDataType: 0
  #       # 7 th bit
  #       notification: 1
  #       ringToneNotify: 1
  #       sendtoSelf: 1
  #       # 10 bit
  #       textMessage: 0
  #       mediaType: 8
  #     type: 769
  #     name:
  #       title: textMessage
  #       senderId: ".Global.currentUser.vertex.id"
  #       senderName: ".Global.currentUser.vertex.name.userName"
  #       data:
  #         text: ''
  #       notification:
  #         landingPage: AppointmentRequest
  #         targetApp: =.FirebaseToken.edge.evid
  # docAPI:
  #   store:
  #     api: cd
  #     dataIn: newTextMessage.document
  components:
    - .ProgressCheckView: ""
      message: "loading ..."
      viewTag: uploading
    - type: view
      style:
        width: "1"
        height: "0.55"
        left: "0"
        backgroundColor: "0x2988e6"
        top: "0"
      children:
        - type: button
          text: =..title
          style:
            left: "0.2"
            width: "0.6"
            fontWeight: 300
            height: "0.1"
            fontSize: "20"
            color: "0xffffffff"
            textAlign:
              x: center
            backgroundColor: "0x2988e6"
            border:
              style: "1"
        - .CA1label:
          text: "Date & Time selected:"
          style:
            top: "0.08"
            width: "0.485"
            height: "0.035"
            border:
              style: "2"
              color: "0xffffff"
        - .CA1label:
          dataKey: selectDate
          style:
            fontSize: .Nfont.h1
            top: "0.125"
            fontWeight: "600"
        - .CA1label:
          text: "Type"
          style:
            top: "0.17"
            width: "0.38"
            height: "0.035"
            border:
              style: "2"
              width: "1.5"
              color: "0xffffff"
        - .CA1label:
          dataKey: Global.formData.appointment.visitType
          style:
            top: "0.21"
            fontSize: "19"
        - .CA1label:
          text: "Duration"
          style:
            top: "0.17"
            left: "0.6"
            width: "0.18"
            height: "0.035"
            border:
              style: "2"
              width: "1.5"
              color: "0xffffff"
        - .CA1label:
          dataKey: Global.formData.appointment.selectData.duration
          style:
            top: "0.21"
            fontSize: "19"
            left: "0.6"
        - .CA1label:
          text: "Reason for Visit"
          style:
            top: "0.26"
            width: "0.38"
            height: "0.035"
            border:
              style: "2"
              width: "1.5"
              color: "0xffffff"
        - .CA1label:
          dataKey: Global.formData.appointment.selectData.reason
          style:
            top: "0.3"
            fontSize: "19"
        - .CA1label:
          text: "Location"
          style:
            left: "0.1"
            top: "0.34"
            width: "0.38"
            height: "0.035"
            border:
              style: "2"
              width: "1.5"
              color: "0xffffff"
        - type: textView
          isEditable: "false"
          placeholder:
          dataKey: Global.currentFacility.name.basicInfo.location
          style:
            top: "0.4"
            width: "0.8"
            left: "0.1"
            height: "0.075"
            color: "0xffffff"
            backgroundColor: "0x2988e6"
            border:
              style: "1"
          # children:
          #   - .CA1label:
          #     dataKey: Global.currentFacility.name.basicInfo.location
          #     style:
          #       top: "0"
          #       left: "0"
          #       height: "0.1"

          # top: '0.3'
          # fontSize: '19'
          # left: "0.6"
          # width: "0.4"
        - type: button
          text: "Change details"
          onClick:
            - actionType: builtIn
              funcName: goBack
          style:
            width: "0.5"
            height: "0.05"
            top: "0.48"
            left: "0.25"
            borderRadius: "50"
            color: "0xff0000"
            backgroundColor: "0xffffff"
            border:
              style: "3"
              width: "1"
              color: "0xff0000"
            borderColor: "0xff0000"
            fontSize: "18"
            fontFamily: "Arial"
            textAlign:
              x: center
    - .HeaderLeftTextButton:
      onClick:
        - actionType: evalObject
          object:
            - ..formData.patientName@: ""
            - ..formData.patientPhoneNumber@: ""
            - .Global.middleInformation.PatientVisitInfo.phoneNumber.1@:
            - .Global.middleInformation.PatientVisitInfo.name.data.fullName@: ""
        - actionType: builtIn
          funcName: goBack
    - type: view
      style:
        top: "0.54"
        height: "0.4"
        width: "1"
        left: "0"
      children:
        - .CA1label:
          text: "Add Patient"
          style:
            top: "0.025"
            left: "0.305"
            width: "0.35"
            color: "#929292"
            height: "0.035"
            textIndent: 15px
            fontSize: "18"
            border:
              style: "2"
        - type: button
          text: "Patient List"
          onClick:
            - goto: PatientList
          style:
            width: "0.25"
            height: "0.033"
            top: "0.025"
            left: "0.7"
            color: "#388FCD"
            backgroundColor: "0xffffff"
            border:
              style: "3"
              color: "0x388fcd"
            borderWidth: "1"
            borderRadius: "10"
            fontSize: .Nfont.h14
            fontFamily: "Arial"
            textAlign:
              x: center
        - .CA1label:
          text: name
          style:
            color: "0x000000"
            left: "0.15"
            fontSize: .Nfont.h12
            top: "0.08"
        - .CA1textfield:
          placeholder: "Enter here"
          dataKey: formData.patientName
          style:
            top: "0.1"
        - type: select
          placeholder:
          dataKey: formData.middleData.phoneNumber.0
          options: .SelectINformationDM.CountryCode
          style:
            top: "0.18"
            left: "0.15"
            width: "0.18"
            height: "0.045"
            border:
              style: 2
            borderColor: "#dfdfdf"
        - .CA1label:
          text: "Phone #"
          style:
            color: "0x000000"
            left: "0.15"
            fontSize: .Nfont.h12
            top: "0.16"
        - .CA1textfield:
          placeholder: "xxx-xxx-xxxx"
          dataKey: formData.patientPhoneNumber
          style:
            top: "0.18"
            left: "0.35"
            width: "0.5"
        - type: button
          text: "Create Apponitment"
          onClick:
            - actionType: popUp
              popUpView: uploading
            - actionType: evalObject
              object:
                - =.builtIn.string.retainNumber:
                    dataIn:
                      value: =.Global.formData.appointment.selectData.duration
                    dataOut: CreateAppointment1.newAppointment.edge.name.duration
                # - ..inviteInfo.edge.name.phoneNumber@: =..formData.patientPhoneNumber
                # - ..inviteInfo.edge.name.name@: =..formData.patientName
                # - =..inviteInfo.store: ""
                # - ..newAppointment.edge.evid@: =..inviteInfo.response.edge.evid
                # - =..inviteInfo.delete: ""
                - ..newAppointment.edge.evid@: =.Global.middleInformation.PatientVisitInfo.bsig
                - =.builtIn.string.concat:
                    dataIn:
                      - =.Global.formData.appointment.selectData.reason
                    dataOut: CreateAppointment1.newAppointment.edge.name.visitReason
                # - .Global.jwt.edge.bvid@: =.Global.clock.bvid
                # - =.Global.jwt.edgeAPI.store: ""
                - ..newAppointment.edge.stime@: ""
                - ..newAppointment.edge.etime@: ""
                - ..newAppointment.edge.refid@: ""
                - ..newAppointment.edge.subtype@: ""
            - actionType: evalObject
              object:
                - ..newAppointment.edge.name.patientName@: =..formData.patientName
                - ..newAppointment.edge.name.document@: =.Global.formData.appointment.selectData.docu
                - ..newAppointment.edge.stime@: =.Global.clock.stime
                - ..newAppointment.edge.subtype@: =.Global.E2Subtype
                - ..newAppointment.edge.etime@: =.Global.clock.etime
                - ..newAppointment.edge.refid@: =.Global.clock.refid

            - actionType: evalObject
              object:
                #建立E2
                - =..newAppointment.edgeAPI.store: ""
                - .CreateAppointment1.apiRequest.approveAppointment.edge@: =.CreateAppointment1.newAppointment.response.edge
                - .CreateAppointment1.apiRequest.approveAppointment.edge.refid@: =.CreateAppointment1.newAppointment.response.edge.id
                - .CreateAppointment1.apiRequest.approveAppointment.edge.id@: ""
                - .CreateAppointment1.apiRequest.approveAppointment.edge.tage@: 0
                - .CreateAppointment1.apiRequest.approveAppointment.edge.subtype@: 5
                #建立E5
                - =.CreateAppointment1.apiRequest.approveAppointment.edgeAPI.store: ""
                - .CreateAppointment1.apiRequest.inviteFacility.edge.refid@: =.CreateAppointment1.newAppointment.response.edge.id
                #建立E10，邀请facility
                - =.CreateAppointment1.apiRequest.inviteFacility.edgeAPI.store: ""
            - actionType: evalObject
              object:
                - ..formData.patientName@: ""
                - ..formData.patientPhoneNumber@: ""
                - .Global.middleInformation.PatientVisitInfo.phoneNumber.1@:
                - .Global.middleInformation.PatientVisitInfo.name.data.fullName@: ""
            - actionType: popUpDismiss
              popUpView: uploading
            - actionType: popUp
              popUpView: finalView
              wait: true
          style:
            width: "0.7"
            left: "0.15"
            height: "0.05"
            top: "0.35"
            fontSize: "18"
            color: "0xffffff"
            backgroundColor: "0x2988e6"
            borderRadius: "3"
            fontFamily: "Arial"
            textAlign:
              x: center
    - .BaseCheckView:
      message: "Successfully!"
      viewTag: finalView
      colorChange: "0x30b354"
      imgPath: popUpSuccess.svg
      children:
        - type: view
          style:
            width: "0.8"
            height: "0.3"
            top: "0.3"
            left: "0.1"
            zIndex: "100"
            backgroundColor: "0xffffff"
            borderRadius: "7"
            border:
              style: "3"
            borderColor: "#f4f8fa"
            borderWidth: "3"
          children:
            - .BaseCheckViewImg:
            - .BaseCheckViewLabel:
            - .BaseCheckViewButton:
              onClick:
                - actionType: popUpDismiss
                  popUpView: ____.viewTag
                - goto: AppointmentSchedule
