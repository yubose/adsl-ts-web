AddConnect:
  init:
    - .SignInCheck
    - ..connection.docAPI.get
    # concat invite name with fullName and title
    - =.builtIn.string.concat:
        dataIn:
          - =.Global.MyProfile.name.data.fullName
          - " - "
          - =.Global.MyProfile.name.data.title
        dataOut: AddConnect.invite.edge.name.inviterName
    - if:
        - .builtIn.isBrowser
        - ..formData.scanDisplay@: "none"
        - ..formData.scanDisplay@: "block"

  title: Add Connection
  countryCode: "+1"
  firstName: ""
  lastName: ""
  phoneNumber: ""
  inviteMessage: ""
  save:
    - =.AddConnect.invite.edgeAPI.store: ""
  invite:
    edge:
      .Edge: ""
      type: .EdgeType.InviteInfo
      bvid: .Global.currentUser.vertex.id
      subtype: .EInboxSubtype.ProviderProvider
      name:
        phoneNumber: ""
        inviterPhoneNumber: .Global.currentUser.vertex.uid
        inviteeName: ""
        inviterName: ""
        inviterPk: .Global.currentUser.vertex.pk
        inviterCategory: "Provider"
        inviteeCategory: "Select option"
        specialty: .Global.MyProfile.name.data.specialty.0.specialty
        inviterAvatar: .Global.MyProfile.name.data.avatar
        data:
          phone: ""
        # profile: .Global.MyProfile
    edgeAPI:
      .EdgeAPI: ""
      store:
        api: ce
        dataIn: invite.edge
  # get all provider profile
  connection: #provider & provider
    connectionList:
      edge: ""
    docAPI:
      get:
        api: rd
        type: .DocType.DoctorProfile
        xfname: (E.bvid|E.evid)&!(D.ovid)
        id: .Global.currentUser.vertex.id
        ObjType: 12
        dataKey: connection.connectionList
        sCondition: E.type=10002 AND E.tage>0 AND E.subtype in (196624,196608,262144,327680)
        _nonce: =.Global._nonce
  scan:
    document:
      name:
        data: ""
  flag: ""
  flagExist: ""
  formData:
    query10002Scondition: ""
    providerId: ""
    providerInfo: ""
    scanDisplay: ""
  apiRequest:
    getProviderPublicProfile:
      resp: ""
      doc:
        id: =..formData.providerId
        type: .DocType.DoctorPublicProfile
        xfname: ovid
        maxcount: "1"
        obfname: ctime
      docApi:
        get:
          api: rd
          dataIn: apiRequest.getProviderPublicProfile.doc
          dataOut: AddConnect.apiRequest.getProviderPublicProfile.resp
    checkConnection:
      getResp:
        edge: []
      connectEdge:
        id: .Global.currentUser.vertex.id
        sfname: '{"result":"E.*", "join": "INNER JOIN Vertex V on V.id = E.evid OR V.id = E.bvid"}'
        xfname: "E.bvid|E.evid"
        sCondition: =..formData.query10002Scondition
        type: 10002
        ObjType: 28
        _nonce: =.Global._nonce
      edgeApi:
        get:
          api: re
          dataIn: apiRequest.checkConnection.connectEdge
          dataOut: AddConnect.apiRequest.checkConnection.getResp
  components:
    - type: popUp
      viewTag: inviteView
      style:
        left: "0"
        top: "0"
        width: "1"
        height: "1"
        backgroundColor: "0x00000033"
        zIndex: "1000"
      children:
        - type: view
          style:
            left: "0.15"
            top: "0.3"
            width: "0.7"
            height: "0.25"
            backgroundColor: "0xefefef"
            borderRadius: "10"
          children:
            - type: label
              text: Send Invite Link
              style:
                left: "0"
                top: "0.05"
                width: "0.7"
                height: "0.05"
                fontSize: .Nfont.h16
                fontWeight: "500"
                textAlign:
                  x: center
            - type: label
              text: Send invite link to
              style:
                left: "0"
                top: "0.1"
                width: "0.7"
                height: "0.05"
                fontSize: "13"
                fontWeight: "500"
                textAlign:
                  x: center
            - type: label
              viewTag: inviteLabel
              dataKey: inviteMessage
              style:
                left: "0"
                top: "0.15"
                width: "0.7"
                fontSize: "13"
                fontWeight: "500"
                textAlign:
                  x: center
            - type: view
              style:
                left: "0"
                top: "0.18"
                width: "0.7"
                height: "0.003"
                backgroundColor: "0xbebebf"
            - type: view
              style:
                left: "0.348"
                top: "0.18"
                width: "0.004"
                height: "0.07"
                backgroundColor: "0xbebebf"
            - type: button
              text: Cancel
              onClick:
                - actionType: popUpDismiss
                  popUpView: inviteView
              style:
                left: "0"
                top: "0.19"
                width: "0.348"
                height: "0.06"
                borderRadius: "10"
                borderWidth: "0"
                fontSize: "17"
                fontWeight: "500"
                color: "0x3a96f9"
                textAlign:
                  x: center
            - type: button
              text: Confirm
              onClick:
                - actionType: evalObject
                  object: ..save
                - actionType: popUpDismiss
                  popUpView: inviteView
                - actionType: popUp
                  popUpView: finalView
                  wait: 2000
                - actionType: builtIn
                  funcName: goBack
                  reload: true
              style:
                left: "0.352"
                top: "0.19"
                width: "0.348"
                height: "0.06"
                borderRadius: "10"
                borderWidth: "0"
                fontSize: "17"
                fontWeight: "500"
                color: "0x3a96f9"
                textAlign:
                  x: center
    - type: popUp
      viewTag: finalView
      style:
        left: "0"
        top: "0"
        width: "1"
        height: "1"
        backgroundColor: "0x00000033"
        zIndex: "1000"
      children:
        - type: view
          style:
            left: "0.15"
            top: "0.29"
            width: "0.7"
            height: "0.26"
            backgroundColor: "0xefefef"
            borderRadius: "10"
          children:
            - type: image
              path: popUpSuccess.svg
              style:
                top: "0"
                height: "0.15"
                width: "0.15"
                left: "0.275"
            - type: label
              text: Success!
              style:
                left: "0"
                top: "0.125"
                width: "0.7"
                height: "0.05"
                fontSize: "23"
                fontWeight: "350"
                textAlign:
                  x: center
            - type: label
              text: Your invite link has been sent to
              style:
                left: "0"
                top: "0.18"
                width: "0.7"
                fontSize: "15"
                fontWeight: "330"
                textAlign:
                  x: center
            - type: label
              viewTag: inviteLabel
              dataKey: inviteMessage
              style:
                left: "0"
                top: "0.22"
                width: "0.7"
                height: auto
                fontSize: "13"
                fontWeight: "500"
                textAlign:
                  x: center
    # - .BaseHeader:
    # - .HeaderLeftButton:
    - .BasePublicHeader:
      children:
        - .BasePublicHeaderLeft:
        - .BasePublicHeaderTitle:
    - type: scrollView
      style:
        left: "0"
        # top: "0.1"
        width: "1"
        height: "0.9"
        overflow: scroll

      children:
        # search
        - type: view
          style:
            width: "1"
            height: "0.05"
            backgroundColor: "0xf0f0f0"
          children:
            - type: label
              text: Search to Invite
              style:
                marginLeft: "0.04"
                color: "0x666666"
                height: "0.05"
                width: "0.45"
                lineHeight: 5vh

                fontSize: .Nfont.h14
                fontWeight: "600"
                textAlign:
                  x: left
        - type: view
          style:
            marginTop: "0.02"
            height: "0.054"
            width: "0.92"
            marginLeft: "0.04"
            border:
              style: 3
              color: "0xDEDEDF"
            borderRadius: "5"
            boxSizing: border-box
            borderWidth: "1.5"
          children:
            - type: image
              path: searchBlue.svg
              style:
                marginLeft: "0.02"
                display: "inline-block"
                height: "0.025"
                verticalAlign: middle
            - type: textField
              placeholder: Name, specialty
              style:
                width: "0.8"
                height: "0.05"

                fontSize: .Nfont.h14
                verticalAlign: middle
                display: inline-block
                boxSizing: border-box
                border: none
                marginLeft: "0.01"
              onClick:
                - goto: SearchProvider

        #Quickly Invite
        - type: view
          style:
            width: "1"
            height: auto
            marginTop: "0.02"
            backgroundColor: "0xf0f0f0"
          children:
            - type: label
              text: Quickly Invite
              style:
                marginLeft: "0.04"
                color: "0x666666"
                height: "0.05"
                width: "0.45"
                lineHeight: 5vh

                fontSize: .Nfont.h14
                fontWeight: "600"
                textAlign:
                  x: left

        - type: view
          style:
            width: "1"
            height: auto
          children:
            - type: view
              style:
                marginTop: "0.014"
                marginLeft: "0.04"
                display: inline-block
              children:
                - type: label
                  text: Country
                  style:
                    fontSize: .Nfont.h14
                    fontWeight: "400"
                - type: select
                  dataKey: countryCode
                  options: .SelectINformationDM.CountryCode
                  style:
                    fontSize: .Nfont.h14
                    width: "0.2"
                    marginTop: "0.01"
                    boxSizing: "border-box"
                    height: "0.054"
                    textIndent: "10px"
                    border:
                      style: "3"
                    borderColor: "0xDEDEDF"
                    borderWidth: "1.5"
                    borderRadius: "5"
            - type: view
              style:
                marginTop: "0.014"
                marginLeft: "0.027"
                display: inline-block
              children:
                - type: label
                  textBoard:
                    - text: Phone Number
                    - text: "&nbsp;*"
                      color: "0xff0000"
                  style:
                    fontSize: .Nfont.h14
                    fontWeight: "400"
                - type: textField
                  placeholder: "000-000-0000"
                  dataKey: phoneNumber
                  style:
                    borderRadius: "5"
                    marginTop: "0.01"
                    width: "0.693"
                    height: "0.054"
                    border:
                      style: "3"
                    borderColor: "0xdededf"
                    borderWidth: "1.5"
                    boxSizing: "border-box"
                    textIndent: "10px"

                    fontSize: .Nfont.h12
                    fontWeight: "450"
                # textAlign:
                #   x: center
            - type: view
              style:
                marginTop: "0.017"
                marginLeft: "0.04"
              children:
                - type: label
                  text: Category
                  style:
                    fontSize: .Nfont.h14
                    fontWeight: "400"
                - type: select
                  dataKey: invite.edge.name.inviteeCategory
                  options: .SelectINformationDM.category
                  onChange:
                    - actionType: evalObject
                      object:
                        - if:
                            - =.builtIn.string.equal:
                                dataIn:
                                  string1: =..invite.edge.name.inviteeCategory
                                  string2: "Provider"
                            - ..invite.edge.subtype@: =.EInboxSubtype.ProviderProvider
                            - continue
                        - if:
                            - =.builtIn.string.equal:
                                dataIn:
                                  string1: =..invite.edge.name.inviteeCategory
                                  string2: "Friend"
                            - ..invite.edge.subtype@: =.EInboxSubtype.ProviderProvider
                            - continue
                        - if:
                            - =.builtIn.string.equal:
                                dataIn:
                                  string1: =..invite.edge.name.inviteeCategory
                                  string2: "Medical Staff"
                            - ..invite.edge.subtype@: =.EInboxSubtype.ProviderStaff
                            - continue
                        - if:
                            - =.builtIn.string.equal:
                                dataIn:
                                  string1: =..invite.edge.name.inviteeCategory
                                  string2: "Colleague"
                            - ..invite.edge.subtype@: =.EInboxSubtype.ProviderStaff
                            - continue
                  style:
                    width: "0.92"
                    marginTop: "0.01"
                    height: "0.054"

                    fontSize: .Nfont.h14
                    textIndent: "10px"
                    borderRadius: "5"
                    borderWidth: "1.5"
                    border:
                      style: "3"
                    borderColor: "0xdededf"
            - type: button
              text: Invite
              onClick:
                - actionType: evalObject
                  object:
                    - if:
                        - =.builtIn.string.equal:
                            dataIn:
                              string1: =..invite.edge.name.inviteeCategory
                              string2: "Select option"
                        - actionType: popUp
                          popUpView: selectCheck
                          wait: true
                        - continue
                - actionType: evalObject
                  object:
                    - =.builtIn.string.concat:
                        dataIn:
                          - =..countryCode
                          - " "
                          - =..phoneNumber
                        dataOut: AddConnect.invite.edge.name.phoneNumber
                    - .AddConnect.invite.edge.name.data.phone@: =.AddConnect.invite.edge.name.phoneNumber
                    - =.builtIn.string.concat:
                        dataIn:
                          - (
                          - =..invite.edge.name.phoneNumber
                          - )
                        dataOut: AddConnect.inviteMessage
                    # 拼接出scondition， 用来objtype 查询 是否存在该好友
                    - =.builtIn.string.concat:
                        dataIn:
                          - "V.uid like '%"
                          - =..phoneNumber
                          - "' AND E.tage>=0"
                        dataOut: AddConnect.formData.query10002Scondition
                #检查手机号是否正确
                - actionType: evalObject
                  object:
                    - if:
                        - =.builtIn.string.equal:
                            dataIn:
                              string1: =..countryCode
                              string2: "+965" # Kuwait
                        - continue
                        - actionType: evalObject
                          object:
                            - if:
                                - =.builtIn.string.phoneVerification: #手机号是否符合格式
                                    dataIn:
                                      phoneNumber: =..phoneNumber
                                      countryCode: =..countryCode
                                - continue
                                - actionType: popUp
                                  popUpView: phoneNumberCheck
                                  wait: true
                #检查是否添加的是否为自己
                - actionType: evalObject
                  object:
                    - if:
                        - =.builtIn.string.equal:
                            dataIn:
                              string1: =..invite.edge.name.phoneNumber
                              string2: =.Global.currentUser.vertex.uid
                        - actionType: popUp
                          popUpView: selfCheck
                          wait: true
                        - continue
                - actionType: evalObject
                  object:
                    - =..apiRequest.checkConnection.edgeApi.get: ""
                    - if:
                        - =.builtIn.array.judgeListLength:
                            dataIn:
                              array: =..apiRequest.checkConnection.getResp.edge
                              len: 0
                        # 如果是空 说明不存在好友关系
                        - continue
                        - actionType: popUp
                          popUpView: phoneRepeat
                          wait: true
                - actionType: builtIn
                  funcName: redraw
                  viewTag: inviteLabel
                - actionType: builtIn
                  funcName: redraw
                  viewTag: phoneNumber
                - actionType: popUp
                  popUpView: inviteView
                  wait: true
              style:
                left: "0.04"
                width: "0.92"
                marginTop: "0.024"
                height: "0.047"
                fontSize: ".Nfont.h14"
                fontWeight: "600"
                color: "0x5ea6ec"
                backgroundColor: "0xffffff"
                border:
                  style: "3"
                  color: "#2988e6"
                borderWidth: "1.5"
                borderRadius: "5"
                textAlign:
                  x: center
        - type: view
          style:
            width: "1"
            marginTop: "0.038"
            height: "0.05"
            backgroundColor: "0xf0f0f0"
          children:
            - type: label
              text: More Ways to Invite
              style:
                marginLeft: "0.04"
                color: "0x666666"
                height: "0.05"
                width: "0.45"
                lineHeight: 5vh

                fontSize: .Nfont.h14
                fontWeight: "600"
                textAlign:
                  x: left
        - type: view
          style:
            width: "1"
            height: "auto"
            display: ..formData.scanDisplay
          children:
            - type: view
              style:
                height: "0.08"
                width: "1"
                border:
                  style: 2
                borderColor: "0xf1f1f1"
                borderWidth: "1"
                textAlign:
                  y: center
              children:
                - type: view
                  style:
                    width: auto
                    height: auto
                  children:
                    - type: view
                      style:
                        width: "0.6"
                        left: "0"
                      children:
                        - type: image
                          path: scan.svg
                          style:
                            marginLeft: "0.07"
                            height: "0.035"
                            display: "inline-block"
                            verticalAlign: middle
                        - type: label
                          text: Scan QR Code
                          style:
                            width: "auto"
                            marginLeft: "0.03"
                            fontSize: .Nfont.h16
                            fontWeight: "500"
                            display: "inline-block"

                            verticalAlign: middle
                            textAlign:
                              y: center
                    - type: label
                      text: Scan a friend's QR code
                      style:
                        fontSize: .Nfont.h14

                        marginTop: "0.005"
                        width: "auto"
                        marginLeft: "0.17"
                        color: "0x666666"

          onClick:
            - actionType: evalObject
              object:
                - actionType: scanCamera
                  dataKey: AddConnect.scan.document.name.data
                - actionType: evalObject
                  object:
                    - ..formData.providerId@: =..scan.document.name.data.id
                    - ..formData.providerInfo@: ""
                    - =..apiRequest.getProviderPublicProfile.docApi.get: ""
                    - ..formData.providerInfo@: =..apiRequest.getProviderPublicProfile.resp.doc.0
                    - .Global.temporaryId@: =..formData.providerInfo
                    - goto: SearchOutProviderInfo

    - .BaseMessageWarnPopup:
      message: "You cannot add yourself"
      viewTag: selfCheck
    - .BaseCheckView:
      viewTag: nameErrorView
      message: "You haven't filled in your first name and last name"
      colorChange: "0x2988e6"
      imgPath: aboutBlue.svg
      children:
        - type: view
          style:
            width: "0.8"
            height: "0.3"
            top: "0.3"
            left: "0.1"
            zIndex: "100"
            backgroundColor: "0xffffff"
            borderRadius: "7"
            border:
              style: "3"
            borderColor: "#f4f8fa"
            borderWidth: "3"
          children:
            - .BaseCheckViewImg:
            - .BaseCheckViewLabel:
            - .BaseCheckViewButton:
              onClick:
                - actionType: popUpDismiss
                  popUpView: ____.viewTag
    - .BaseCheckView:
      viewTag: phoneRepeat
      message: "The phone number is already added or invited"
      colorChange: "0x2988e6"
      imgPath: aboutBlue.svg
      children:
        - type: view
          style:
            width: "0.8"
            height: "0.3"
            top: "0.3"
            left: "0.1"
            zIndex: "100"
            backgroundColor: "0xffffff"
            borderRadius: "7"
            border:
              style: "3"
            borderColor: "#f4f8fa"
            borderWidth: "3"
          children:
            - .BaseCheckViewImg:
            - .BaseCheckViewLabel:
            - .BaseCheckViewButton:
              onClick:
                - actionType: updateObject
                  dataKey: AddConnect.apiRequest.checkConnection.getResp
                  dataObject: []
                - actionType: popUpDismiss
                  popUpView: ____.viewTag
    - .TipsOneLine:
      message: "The phone number is wrong"
      viewTag: phoneNumberCheck
    - .TipsOneLine:
      message: "Please select one category"
      viewTag: selectCheck
