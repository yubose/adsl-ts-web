AppointmentRequest: #xdpage:13
  title: "Appointment Request"
  viewPort: top
  init:
    - .SignInCheck
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    - ..requestList.get
    - actionType: evalObject #android use calendar init
      object:
        - .BaseComponents.calendarDate.year@: ""
        - .BaseComponents.calendarDate.month@: ""
        - .BaseComponents.calendarDate.day@: ""
        - .BaseComponents.calendarDate.monthName@: ""
        - .BaseComponents.calendarDate.todayDate@: ""
        - .BaseComponents.calendarDate.flag@: ""
        - .BaseComponents.calendarDate.dayLable@: []
        - .BaseComponents.year@: []
        - .BaseComponents.flag: ""
    - actionType: evalObject #android use calendar init
      object: .BaseComponents.getDate
    - actionType: evalObject #android use calendar init
      object: .BaseComponents.getShow
    - actionType: evalObject
      object:
        - ..todayDate@: =.BaseComponents.calendarDate.todayDate
    - actionType: evalObject
      object:
        - =.builtIn.date.getMonth:
            dataIn:
            dataOut: AppointmentRequest.calendarDate.month
        - =.builtIn.date.getYear:
            dataIn:
            dataOut: AppointmentRequest.calendarDate.year
        - =.builtIn.date.getDate:
            dataIn:
            dataOut: AppointmentRequest.calendarDate.day
    - actionType: evalObject
      object:
        - =.builtIn.date.calendarArray:
            dataIn:
              year: =.AppointmentRequest.calendarDate.year
              month: =.AppointmentRequest.calendarDate.month
              today: =.AppointmentRequest.calendarDate.day
            dataOut: AppointmentRequest.calendarDate.dayLable
        - =.builtIn.date.transformMonth:
            dataIn:
              month: =.AppointmentRequest.calendarDate.month
            dataOut: AppointmentRequest.calendarDate.monthName
        - =.builtIn.date.ShowDateByNumber:
            dataIn:
              year: =.AppointmentRequest.calendarDate.year
              month: =.AppointmentRequest.calendarDate.month
              day: =.AppointmentRequest.calendarDate.day
              formatType: "Y-M-D"
            dataOut: AppointmentRequest.calendarDate.todayDate
    - if:
        - ..todayDate
        - continue
        - ..todayDate@: =.AppointmentRequest.calendarDate.todayDate
    - actionType: evalObject
      object:
        - if:
            - =.builtIn.string.equal:
                dataIn:
                  string1: =..formData.currentVisitType
                  string2: "Office Visits"
            - actionType: builtIn
              funcName: show
              viewTag: selectTag
            - actionType: builtIn
              funcName: hide
              viewTag: selectTag
    - actionType: evalObject
      object:
        - =..getRootNoteBook.get: ""
        - ..locationAll.docIn.id@: =..getRootNoteBook.response.edge.0.id
        - =..locationAll.docAPI.get: ""
        - =.builtIn.array.selectOneToArr:
            dataIn:
              arr: =..locationAll.docResp.doc.0.name.data.allLocation
              key: "medicalFacilityName"
            dataOut: AppointmentRequest.addressName
  approvePatientReq:
    - =.AppointmentRequest.approveRequest.edgeAPI.store: ""
  apiRequest:
    #邮件结构
    email:
      docResp: ""
      #发送邮件请求
      docReq:
        #邮件类型，默认1281
        type: .DocType.InboxMessage
        #邮件所挂载的edge(10002)
        eid: .Global.rootNotebookID
        name:
          data:
            #邮件内容
            content: ""
            #收件人姓名
            receiverName: ""
            #发送人姓名
            senderName: .Global.MyProfile.name.data.fullName
            #收件人头像的id
            receiverAvatarId: ""
            #是否带附件
            haveAttachment: false
          #邮件标题
          title: "Appointment Reject"
          #发件人头像的id
          user: .Global.MyProfile.name.data.avatar
          type: "application/json"
      docAPI:
        store:
          api: cd
          dataIn: AppointmentRequest.apiRequest.email.docReq
          dataOut: AppointmentRequest.apiRequest.email.docResp
    #邮件挂载的edge(10002)
    relation:
      edgeReq:
        type: .EdgeType.Email
        id:
          - .Global.currentUser.vertex.id
        xfname: Bvid,Evid
        maxcount: "1"
        obfname: ctime
      edgeResp: ""
      edgeAPI:
        get:
          api: re
          dataIn: AppointmentRequest.apiRequest.relation.edgeReq
          dataOut: AppointmentRequest.apiRequest.relation.edgeResp
  inbox:
    edgeRes: ""
    edgeReq:
      id: []
      xfname: "bvid,evid"
      type: .EdgeType.Email
    edgeAPI:
      get:
        api: re
        dataIn: AppointmentRequest.inbox.edgeReq
        dataOut: AppointmentRequest.inbox.edgeRes
  getRootNoteBook:
    response:
    edge:
      id: .Global.currentFacility.id
      xfname: "bvid"
      type: "10000"
      _nonce: =.Global._nonce
    get:
      api: re
      dataIn: getRootNoteBook.edge
      dataOut: getRootNoteBook.response
  isContact: # 判断是否为好友
    response: ""
    edge:
      id: []
      xfname: evid,bvid
      type: 10002
      _nonce: =.Global._nonce
    edgeAPI:
      get:
        api: re
        dataIn: AppointmentRequest.isContact.edge
        dataOut: AppointmentRequest.isContact.response
  accept: #如果不是好友，直接成为好友
    response: ""
    edge:
      type: .EdgeType.Accept
      evid: .Global.currentUser.vertex.id
      name: ""
      refid: ""
    edgeAPI:
      store:
        api: ce
        dataIn: AppointmentRequest.accept.edge
        dataOut: AppointmentRequest.accept.response
  getPatientProfile:
    response: ""
    docIn:
      type: 102401
      id: .Global.appoinment.request.id
      xfname: eid
    docOut: ""
    docAPI:
      get:
        api: rd
        dataIn: AppointmentRequest.getPatientProfile.docIn
        dataOut: AppointmentRequest.getPatientProfile.docOut
  invite: #发送邀请
    response: ""
    edge:
      # .Edge: ""
      type: .EdgeType.InviteInfo
      bvid: .Global.currentUser.vertex.id
      _nonce: =.Global._nonce
      subtype: 65536
      name:
        phoneNumber: ""
        inviterPhoneNumber: .Global.currentUser.vertex.uid
        inviteeName: ""
        inviterName: .Global.currentUser.vertex.name.userName
        data:
          phone: ""
    edgeAPI:
      .EdgeAPI: ""
      store:
        api: ce
        dataIn: AppointmentRequest.invite.edge
        dataOut: AppointmentRequest.invite.response
      get:
        api: re
        id: .Global.currentUser.vertex.id
        xfname: bvid
        type: 1053
        _nonce: =.Global._nonce
        dataKey: data
  locationAll: # 把所有的location 信息，在schedule那边显示
    docResp: "" # get到的值
    docIn: # for geting all of the location
      type: .DocType.LocationOfFacility
      id: ""
      xfname: eid
      obfname: mtime
      maxcount: "1"
      name:
        data:
          allLocation:
    docAPI:
      .DocAPI: ""
      get:
        api: rd
        dataIn: AppointmentRequest.locationAll.docIn
        dataOut: AppointmentRequest.locationAll.docResp
  todayDate: ""
  addressName: []
  flag: ""
  requestList:
    requestData:
      edge: []
    edge:
      id:
        - .Global.currentFacility.id
        - .Global.currentUser.vertex.id
      maxcount: "10000"
      ObjType: 20
      xfname: "(,E.evid)&(,E2.evid)"
      obfname: "stime"
      sCondition: "E2.type=40000 AND E2.subtype in (196609,131073) AND E.type = 40000 AND E.subtype in (131074,196610)"
      asc: true
      _nonce: =.Global._nonce
    get:
      .EdgeAPI.get: ""
      api: re
      dataOut: requestList.requestData
      dataIn: requestList.edge
  approve:
    e2id: "" #refid
  formData:
    currentVisitType: ""
    locationHidden: true
  calendarDate:
    month: ""
    year: ""
    day: ""
    monthName: ""
    dayLable: []
    todayDate: ""
  newEmail: #email
    response: ""
    edge:
      .Edge: ""
      type: .EdgeType.Email
      subtype: 5
      name:
        title: ""
        folderID: ""
        isStar: false
        isDraft: false
        isRead: false
        receiveName: ""
        senderName: ""
      bvid: .Global.currentUser.vertex.id
      evid: ""
      refid: ""
    edgeAPI:
      store:
        api: ce
        dataKey: AppointmentRequest.newEmail.edge
        dataOut: AppointmentRequest.newEmail.response
  newInboxMessage:
    document:
      eid: ""
      type: .DocType.InboxMessage
      name:
        title: "message"
        type: "application/json"
        data:
          content: "I'm very sorry that your appointment has been rejected "
    docAPI:
      .DocAPI: ""
      store:
        api: cd
        dataKey: newInboxMessage.document
        subtype:
          mediaType: "application/json"
  components:
    - .ProgressCheckView: ""
      message: "loading ..."
      viewTag: uploading
    - .BaseHeader:
    - .HeaderLeftButton:
    - .HeaderRightImg:
      onClick:
        - actionType: evalObject
          object:
            - if:
                - =..flag
                - actionType: evalObject
                  object:
                    - actionType: builtIn
                      funcName: hide
                      viewTag: setRequest
                    - ..flag@: false
                - actionType: evalObject
                  object:
                    - actionType: builtIn
                      funcName: show
                      viewTag: setRequest
                    - ..flag@: true
      path: screen.png
    - type: scrollView
      style:
        left: "0"
        width: "1"
        height: "0.9"
        top: "0.1"
        overflow: scroll
      children:
        - type: view
          viewTag: setRequest
          style:
            backgroundColor: "#F0F0F0"
            width: "1"
            height: "0.06"
            display: none
            left: "0"
            marginTop: "0"
          children:
            - type: select
              options:
                - All Request
                - Telemedicine
                - Office Visits
              dataKey: formData.currentVisitType
              onChange:
                - actionType: evalObject
                  object:
                    .Global._nonce@:
                      =.builtIn.math.random: ""
                - actionType: evalObject
                  object:
                    - if:
                        - =.builtIn.string.equal:
                            dataIn:
                              string1: =..formData.currentVisitType
                              string2: "Office Visits"
                        - ..requestList.edge.sCondition@: "E2.type=40000 AND E2.subtype in (131073) AND E.type = 40000 AND E.subtype=131074"
                        - continue
                    - if:
                        - =.builtIn.string.equal:
                            dataIn:
                              string1: =..formData.currentVisitType
                              string2: "Telemedicine"
                        - actionType: evalObject
                          object:
                            - ..requestList.edge.sCondition@: "E2.type=40000 AND E2.subtype in (196609) AND E.type = 40000 AND E.subtype=196610"
                            - ..requestList.edge.id.0@: =.Global.currentFacility.id
                        - continue
                    - if:
                        - =.builtIn.string.equal:
                            dataIn:
                              string1: =..formData.currentVisitType
                              string2: "All Request"
                        - actionType: evalObject
                          object:
                            - ..requestList.edge.sCondition@: "E2.type=40000 AND E2.subtype in (196609,131073) AND E.type = 40000 AND E.subtype in (196610,131074)"
                            - ..requestList.edge.id.0@: =.Global.currentFacility.id
                        - continue
                    - ..requestList.requestData.edge@: []
                    - =..requestList.get: ""
                - actionType: evalObject
                  object:
                    - if:
                        - =.builtIn.string.equal:
                            dataIn:
                              string1: =..formData.currentVisitType
                              string2: "Office Visits"
                        - actionType: builtIn
                          funcName: show
                          viewTag: selectTag
                        - actionType: builtIn
                          funcName: hide
                          viewTag: selectTag
                    - if:
                        - =.builtIn.string.equal:
                            dataIn:
                              string1: =..formData.currentVisitType
                              string2: "Office Visits"
                        - ..formData.locationHidden@: false
                        - ..formData.locationHidden@: true
                - actionType: builtIn
                  funcName: redraw
                  viewTag: dataTag
              style:
                color: "#4B4B4B"
                top: "0.02"
                textAlign:
                  y: center
                fontSize: "15"
                width: "0.3"
                height: "0.03"
                left: "0.05"
                backgroundColor: "0xffffff"
                fontFamily: "Arial"
            - type: select
              dataKey: requestAddress
              viewTag: selectTag
              onChange:
                - actionType: evalObject
                  object:
                    - actionType: evalObject
                      object:
                        .Global._nonce@:
                          =.builtIn.math.random: ""
                    - =.builtIn.array.matchInArray:
                        dataIn:
                          arr: =..locationAll.docResp.doc.0.name.data.allLocation
                          value: =..requestAddress
                          key: medicalFacilityName
                          key1: "id"
                        dataOut: AppointmentRequest.requestLocationId
                    - ..requestList.edge.id.0@: =..requestLocationId
                    - ..requestList.edge.sCondition@: "E2.type=40000 AND E2.subtype in (131073) AND E.type = 40000 AND E.subtype=131074"
                    - ..requestList.requestData.edge@: []
                    - =..requestList.get: ""
                - actionType: builtIn
                  funcName: redraw
                  viewTag: dataTag
              options: ..addressName
              style:
                color: "#4B4B4B"
                backgroundColor: "0xffffff"
                top: "0.02"
                textAlign:
                  y: center
                fontSize: "15"
                width: "0.3"
                height: "0.03"
                left: "0.65"
                fontFamily: "Arial"
                isHidden: =..formData.locationHidden
        - type: scrollView
          style:
            left: "0"
            marginTop: "0"
            width: "1"
            height: "0.81"
            overflow: scroll
          children:
            - type: list
              iteratorVar: itemObject
              listObject: ..requestList.requestData.edge
              contentType: listObject
              viewTag: dataTag
              style:
                left: "0"
                marginTop: "0"
                width: "1"
                height: "0.81"
                overflow: scroll
              children:
                - type: listItem
                  itemObject: ""
                  style:
                    left: "0"
                    width: "1"
                    height: "0.15"
                    borderBottom: "1px solid #dededf"
                    borderWidth: "1"
                  children:
                    - type: label
                      text: "9:30~9:45AM"
                      dataKey: itemObject.stime
                      text=func: .builtIn.string.formatUnixtime_en
                      style:
                        left: "0.05"
                        top: "0.02"
                        width: "0.44"
                        height: "0.025"
                        color: "0x4b4b4b"
                        fontSize: "15"
                        textAlign:
                          x: left
                        border:
                          style: "1"
                    - type: label
                      dataKey: itemObject.name.duration
                      style:
                        top: "0.025"
                        left: "0.47"
                        width: "0.05"
                        height: "0.025"
                        fontSize: "1.5vh"
                        color: "0x4b4b4b"
                        textAlign:
                          x: right
                    - type: label
                      text: "min"
                      style:
                        top: "0.025"
                        left: "0.52"
                        width: "0.1"
                        height: "0.025"
                        fontSize: "1.5vh"
                        color: "0x4b4b4b"
                        textAlign:
                          x: left
                    - type: label
                      dataKey: itemObject.name.visitTypeShow
                      text: "Telemedicine"
                      style:
                        top: "0.025"
                        left: "0.7"
                        width: "0.25"
                        height: "0.025"
                        fontSize: "1.5vh"
                        color: itemObject.name.fontColor
                        textAlign:
                          x: right
                    - type: label
                      dataKey: itemObject.name.patientName
                      style:
                        left: "0.05"
                        top: "0.06"
                        width: "0.45"
                        height: "0.03"
                        fontSize: "2.0vh"
                        color: "0x1b8ec9"
                        textAlign:
                          x: left
                        border:
                          style: "1"
                        overflow: hidden
                        whiteSpace: nowrap
                        textOverflow: ellipsis
                    - type: label
                      dataKey: itemObject.name.visitReason
                      text: ""
                      style:
                        left: "0.7"
                        top: "0.06"
                        width: "0.25"
                        height: "0.03"
                        textAlign:
                          x: right
                        color: "0x4b4b4b"
                        fontSize: "2.0vh"
                    - type: label
                      onClick:
                        - actionType: updateObject # updateObject(dataKey, dataObject, dataObjectKey)
                          dataKey: Global.appointmnetRequest
                          dataObject: itemObject
                        - emit:
                            dataKey:
                              var: itemObject
                            actions:
                              - if:
                                  - true
                                  - .Global.roomInfo.edge.id@: $var.id
                                  - .Global.roomInfo.edge.id@: $var.id
                        - goto: "VisitQuestionnaire"
                      text: Visit Questionnaire
                      style:
                        left: "0.66"
                        top: "0.11"
                        width: "0.3"
                        height: "0.025"
                        fontSize: .Nfont.h12
                        color: "0xd10114"
                        backgroundColor: "0xffffff"
                        textAlign:
                          x: right
                        border:
                          style: "1"
                        textDecoration: "underline"
                    - type: button
                      onClick:
                        - actionType: popUp
                          popUpView: uploading
                        - actionType: updateObject # updateObject(dataKey, dataObject, dataObjectKey)
                          dataKey: Global.appoinment.request
                          dataObject: itemObject

                        - actionType: evalObject
                          object:
                            - ..isContact.edge.id@: []
                            - ..isContact.edge.response@: "" #clear old data
                            - =.builtIn.array.add:
                                dataIn:
                                  object: =..isContact.edge.id
                                  value: =.Global.appoinment.request.bvid #patient id
                            - =.builtIn.array.add:
                                dataIn:
                                  object: =..isContact.edge.id
                                  value: =.Global.appoinment.request.evid #provider id
                        - actionType: evalObject
                          object:
                            - =..isContact.edgeAPI.get: ""
                        - actionType: evalObject
                          object:
                            .Global._nonce@:
                              =.builtIn.math.random: ""
                        - actionType: evalObject
                          object:
                            - if:
                                - =..isContact.response.edge.0
                                - goto: AgreeRequest
                                - actionType: evalObject
                                  object:
                                    # provider -> patient 1053
                                    - .Global.createjwt.edge.bvid@: =.Global.currentUser.vertex.id #change provider jwt
                                    - =.Global.createjwt.edgeAPI.store: ""
                                    - ..invite.edge.name.phoneNumber@: =.Global.appoinment.request.name.patientPhoneNumber
                                    - ..invite.edge.name.data.phone@: =.Global.appoinment.request.name.patientPhoneNumber
                                    - =..invite.edgeAPI.store: ""
                                    # patient -> provider accept
                                    - .Global.createjwt.edge.bvid@: =.Global.appoinment.request.bvid #change patient jwt
                                    - =.Global.createjwt.edgeAPI.store: ""
                                    - ..accept.edge.bvid@: =.Global.appoinment.request.bvid
                                    - ..accept.edge.name@: =.invite.response.edge.name
                                    - ..accept.edge.refid@: =.invite.response.edge.id #id get from 1053
                                    - =..accept.edgeAPI.store: ""
                                    - .Global.createjwt.edge.bvid@: =.Global.currentUser.vertex.id #change provider jwt
                                    - =.Global.createjwt.edgeAPI.store: ""
                                    # get patient profile
                                    - ..getPatientProfile.docIn.id@: =.Global.appoinment.request.id
                                    - =..getPatientProfile.docAPI.get: ""
                                    - =..isContact.edgeAPI.get: ""
                                    - =.builtIn.ecos.shareDoc:
                                        dataIn:
                                          sourceDoc: =..getPatientProfile.docOut.doc.0
                                          targetEdgeID: =..isContact.response.edge.0.id
                        - goto: AgreeRequest
                        # 创建一条新边 E5 , refid = E2 subtype=5  然后把E2的subtype设置成6 创建meetingRoom
                      text: "Approve"
                      style:
                        left: "0.05"
                        top: "0.1"
                        width: "0.2"
                        height: "0.035"
                        fontSize: .Nfont.h14
                        backgroundColor: "0x2fb355"
                        color: "0xffffff"
                        textAlign:
                          x: center
                        border:
                          style: "3"
                        borderColor: "0x5bc377"
                        borderRadius: "5"
                        borderWidth: "1"
                    - type: button
                      onClick:
                        - actionType: updateObject # updateObject(dataKey, dataObject, dataObjectKey)
                          dataKey: Global.appoinment.request
                          dataObject: itemObject
                        - actionType: popUp
                          popUpView: DenyView
                          wait: true
                      text: "Deny"
                      style:
                        left: "0.28"
                        top: "0.1"
                        width: "0.2"
                        height: "0.035"
                        fontSize: .Nfont.h14
                        backgroundColor: "0xfd3a3a"
                        color: "0xffffff"
                        textAlign:
                          x: center
                        border:
                          style: "3"
                        borderColor: "0x00000033"
                        borderRadius: "5"
                        borderWidth: "1"
    - type: popUp
      message: "Appointment Reject"
      viewTag: DenyView
      style:
        left: "0"
        width: "1"
        top: "0"
        height: "1"
        backgroundColor: "0x00000033"
        zIndex: "1000"
      children:
        - type: view
          style:
            left: "0.1"
            width: "0.8"
            top: "0.41"
            height: "0.19"
            backgroundColor: "0xe5e5e5"
            border:
              style: "5"
            borderWidth: "1"
            borderRadius: "10"
            boxShadow: "0px 0px 0px 1px #d8d8db"
            overflow: hidden
          children:
            - type: label
              text: ___.message
              style:
                marginTop: "0.02"
                width: "0.8"
                height: "0.02"
                fontSize: "4.2vw"
                fontWeight: "600"
                color: "0x000000"
                backgroundColor: "0xe5e5e5"
                textAlign:
                  x: center
                  y: center
            - type: textView
              placeholder: "Enter the reason here"
              dataKey: apiRequest.email.docReq.name.data.content
              style:
                marginTop: "0.02"
                backgroundColor: "0xffffff"
                height: "0.06"
                width: "0.7"
                left: "0.05"
                border:
                  style: "1"
                borderRadius: "3"
                boxShadow: "0px 0px 0px 2px #DEDEDF"
            - type: view
              style:
                marginTop: "0.01"
                width: "0.8"
                height: "0.001"
                backgroundColor: "0xcccccc"
            - type: view
              style:
                width: "0.81"
                height: "0.054"
              children:
                - type: label
                  text: Cancel
                  style:
                    top: "0"
                    left: "0"
                    width: "0.4"
                    height: "0.054"
                    color: "0x0074ff"
                    fontSize: "4.5vw"
                    textAlign:
                      x: center
                      y: center
                  onClick:
                    - actionType: popUpDismiss
                      popUpView: DenyView
                - type: view
                  style:
                    top: "0"
                    left: "0.41"
                    width: "0.001"
                    height: "0.054"
                    backgroundColor: "0xcccccc"
                - type: label
                  text: Send
                  style:
                    top: "0"
                    left: "0.42"
                    width: "0.4"
                    height: "0.054"
                    color: "0x0074ff"
                    fontSize: "4.5vw"
                    textAlign:
                      x: center
                      y: center
                  onClick:
                    - actionType: evalObject
                      object:
                        - =.builtIn.array.add:
                            dataIn:
                              object: =..apiRequest.relation.edgeReq.id
                              value: =.Global.appoinment.request.bvid
                        - =..apiRequest.relation.edgeAPI.get: ""
                        - ..apiRequest.email.docReq.eid@: =..apiRequest.relation.edgeResp.edge.0.id
                        - ..apiRequest.email.docReq.name.data.receiverName@: =.Global.appoinment.request.name.patientName
                        - ..apiRequest.email.docReq.name.data.receiverAvatarId@: =.Global.appoinment.request.name.patientAvatarId
                        - =..apiRequest.email.docAPI.store: ""
                    - goto: DisagreeRequest
