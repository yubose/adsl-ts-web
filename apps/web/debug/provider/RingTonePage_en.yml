RingTonePage:
  pageNumber: "190"
  init:
    - .SignInCheck
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    - actionType: updateObject
      dataKey: Global.roomInfoDoc.document
      dataObject: .EmptyObj
    # 清空 providerDiagnosis.pROne
    - actionType: updateObject
      dataKey: Global.formData.providerDiagnosis.pROne
      dataObject: .EmptyObj
    # 清空 providerDiagnosis.pRTwo
    - actionType: updateObject
      dataKey: Global.formData.providerDiagnosis.pRTwo
      dataObject: .EmptyObj
    # 清空 providerDiagnosis.progressReport
    - actionType: updateObject
      dataKey: Global.formData.providerDiagnosis.progressReport
      dataObject: .EmptyObj
    # 清空 providerDiagnosis.progressReport
    - actionType: updateObject
      dataKey: Global.formData.providerDiagnosis.initialEvaluationReport
      dataObject: .EmptyObj
    # - ..dataObject@: =.Global.roomInfo.edge
    #change jwt
    - .Global.createjwt.edge.bvid@: =.Global.currentUser.vertex.id
    - =.Global.createjwt.edgeAPI.store: ""

    # get roomInfo
    - actionType: evalObject
      object:
        - =.builtIn.ecos.getEdge:
            dataIn:
              edgeId: =.Global.ecosDocObj.doc.0.eid
            dataOut: Global.ecosEdgeObj
        - .Global.roomInfo.edge@: =.Global.ecosEdgeObj

    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    # get currentRoom fo into 
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.roomInfo.edge.bvid
              string2: =.Global.currentUser.vertex.id
        - .Global.currentRoom.edge@: =.Global.roomInfo.edge
        - actionType: evalObject
          object:
            - if:
                - =.builtIn.string.equal:
                    dataIn:
                      string1: =.Global.roomInfo.edge.evid
                      string2: =.Global.currentUser.vertex.id
                - .Global.currentRoom.edge@: =.Global.roomInfo.edge
                - actionType: evalObject
                  object:
                    - =..apiRequest.accessRoomInfo.edgeAPI.get: ""
                    - .Global.currentRoom.edge@: =..apiRequest.accessRoomInfo.response.edge.0

    #patient&provider profile
    - actionType: evalObject
      object:
        - ..formData.providerId@: =.Global.currentUser.vertex.id
        - =..patientProfile.get: ""
    - .Global.currentMeetingPatientProfile@: ""
    - .Global.currentMeetingPatientProfile@: =..patientProfile.docReponse.doc.0.name.data
    - =.builtIn.phoneService.minRingtoneVibrate
  # tony 3/18/22 discussed with Austin don't need to switch facility in ringTone page need more debug and discussing
  # `.Global.roomInfo.edge.name.facilityId` is not the `.Global.currentFacility.id`
  #   # facility
  #   - .RingTonePage.facilityId@: =.Global.roomInfo.edge.name.facilityId
  #   # 获取fac
  #   - =.builtIn.array.getObjectByArray:
  #       dataIn:
  #         array: =.Global.organizations
  #         key: "id"
  #         value: =.RingTonePage.facilityId
  #       dataOut: Global.currentFacility
  #   - actionType: evalObject
  #     object:
  #       - =..apiRequest.currentFacilityDoc.docAPI.get: ""
  #       - .Global.currentFacilityDoc@:  =..apiRequest.currentFacilityDoc.docResp.doc.0
  #       - .Global.formData.location@: =.Global.currentFacility
  #       - .Global.dashboardName@: =.Global.currentFacility.name.basicInfo.medicalFacilityName        
  # facilityId: ""
  formData:
    providerId: ""
  patientProfile:
    docReponse: ""
    doc:
      ids:
        - .Global.roomInfo.edge.name.providerId
        - .Global.roomInfo.edge.bvid
        - .Global.roomInfo.edge.evid
      xfname: (!D.ovid) & E.Bvid
      type: .DocType.PatientProfile #  type: "102401"
      obfname: "ctime"
      maxcount: "1"
      ObjType: 12
      sCondition: "E.type=10000"
      _nonce: =.Global._nonce
    get:
      api: rd
      dataIn: patientProfile.doc
      dataOut: RingTonePage.patientProfile.docReponse
  selfRoomInfo:
    response: ""
    edge:
      id:
        - .Global.currentUser.vertex.id
        - =.Global.roomInfo.edge.id
      xfname: bvid,refid
      type: 40000
      sCondition: "subtype=0"
      _nonce: =.Global._nonce
    get:
      api: re
      dataIn: selfRoomInfo.edge
      dataOut: RingTonePage.selfRoomInfo.response
  apiRequest:
    currentFacilityDoc:
      docResp: ""
      docReq:
        id: =.Global.currentFacility.id
        xfname: ovid
        obfname: "mtime"
        maxcount: "1"
        type: .DocType.FacilityProfile
        _nonce: =.Global._nonce
      docAPI:
        get:
          api: rd
          dataIn: apiRequest.currentFacilityDoc.docReq
          dataOut: RingTonePage.apiRequest.currentFacilityDoc.docResp
    # get self E10
    accessRoomInfo:
      response: ""
      edge:
        type: .EdgeType.InviteInfo
        id:
          - .Global.currentUser.vertex.id
          - .Global.roomInfo.edge.id
        xfname: "bvid|evid,refid"
      edgeAPI:
        .EdgeAPI: ""
        get:
          api: re
          dataIn: apiRequest.accessRoomInfo.edge
          dataOut: apiRequest.accessRoomInfo.response
    #开始会议的tag
    startMeetingTag:
      docCreateResp: ""
      docCreateReq:
        type: .DocType.GroupBitOrTage
        tage: 128
        eid: .Global.currentRoom.edge.id
        reid: .Global.roomInfo.edge.id
        name:
          data: ""
      docAPI:
        store:
          api: cd
          dataIn: RingTonePage.apiRequest.startMeetingTag.docCreateReq
          dataOut: RingTonePage.apiRequest.startMeetingTag.docCreateResp          
    newVideoMessage:
      response: ""
      document:
        eid: =.Global.currentRoom.edge.id
        reid: =.Global.roomInfo.edge.id
        subtype:
          isOnServer: 1
          isZipped: 0
          isBinary: 0
          isEncrypted: 0
          isExtraKeyNeeded: 0
          isEditable: 0
          applicationDataType: 8
          # 7 th bit
          notification: 1
          ringToneNotify: 1
          sendtoSelf: 0
          # 10 bit
          textMessage: 0
          mediaType: 8
        type: 770
        name:
          title: textMessage
          senderId: .Global.currentUser.vertex.id
          senderName: .Global.currentUser.vertex.name.userName
          data:
            text: ""
          notification:
            title: New Message From a Doctor
            context: click to open the chat page
            body: click to open the chat page
            onClickLandingPage: ChatPage
            targetApp: =.FirebaseToken.response.edge.evid
      docAPI:
        store:
          api: cd
          dataIn: apiRequest.newVideoMessage.document
          dataOut: apiRequest.newVideoMessage.response
  sendNotification:
    document:
      .Document: ""
      eid: ""
      subtype:
        isOnServer: 1
        isZipped: 0
        isBinary: 0
        isEncrypted: 0
        isExtraKeyNeeded: 0
        isEditable: 0
        applicationDataType: 0
        # 7 th bit
        notification: 1
        ringToneNotify: 1
        sendtoSelf: 0
        # 10 bit
        textMessage: 0
        mediaType: 8
      type: .DocType.Notification
      tage: 5
      name:
        data: ""
        #        senderId: ".Global.currentUser.vertex.id"
        #        senderName: ".Global.currentUser.vertex.name.userName"
        #        data:
        #        AiTmed: ''
        notification:
          title: Aitmed Connection Rejected
          context: Connection request rejected
          body: Connection request rejected
          #landingPage: InboxDashboard
          targetApp: =.FirebaseToken.response.edge.evid
          popUpPage: RingTonePage
    docAPI:
      store:
        api: cd
        dataIn: sendNotification.document
  selfNumber: "0"
  roomInfo:
    response: ""
    edge:
      # .Global.VideoChatObjStore.reference.edge: ""
      id: ..emptyId # create a new edge
      bvid: .Global.currentUser.vertex.id # always current userId
      evid: ..emptyId
      name: ..dataObject.name
      refid: ..dataObject.id
      type: 40000 # may from 1053, need to be override
      subtype: 0
      _nonce: =.Global._nonce
    edgeAPI:
      .EdgeAPI: ""
      store:
        api: ce
        dataIn: roomInfo.edge # return result should updated to roomInfo.edge as well
        dataOut: roomInfo.response

  components:
    - type: view
      style:
        left: "0"
        top: "0"
        width: "1"
        height: "1"
        # backgroundColor: "0x000000"
        backgroundColor: "0xffffff"
      children:
        - type: image
          path: aitmedLogoBlack.svg # waitingroom.png
          style:
            left: "0.25"
            top: "0.2"
            width: "0.5"
            height: "0.8"
            position: "fixed"
            # objectFit: "none!important"
        # - type: label
        #   contentType: hidden # passwordHidden
        #   viewTag: waitForOtherTag
        #   text: "Waiting for others to join"
        #   #viewTag: needHidden
        #   style:
        #     left: "0"
        #     top: "0.4"
        #     width: "1"
        #     height: "0.04"
        #     fontSize: .Nfont.h16
        #     fontStyle: bold
        #     color: "0x000000"
        #     textAlign:
        #       x: center
        - type: view
          style:
            left: "0"
            top: "0.9"
            width: "1"
            height: "0.1"
            border:
              style: "5"
            backgroundColor: "0x000000"
            position: "fixed"
          children:
            - type: image
              path: pickup_phone.png
              onClick:
                - =.builtIn.phoneService.stopVibrate
                - =.builtIn.phoneService.stopRingtone
                - actionType: evalObject
                  object:
                    # get deat: roomId&token
                    - if:
                        - =.Global.roomInfoDoc.document.deat.roomID
                        - continue
                        - actionType: evalObject
                          object:
                            - =..apiRequest.newVideoMessage.docAPI.store: ""
                            - .Global.roomInfoDoc.document@: =..apiRequest.newVideoMessage.response.doc
                    # 如果已经打过tag，则不再重复创建
                    - if:
                        - =.builtIn.number.typeIsValid:
                            dataIn:
                              docType: =.Global.roomInfo.edge.tage
                              localArr: [8]
                              binaryArr: [1]
                        - continue
                        # 建立开始会议的tag
                        - =..apiRequest.startMeetingTag.docAPI.store: ""
                - goto: VideoChat
                # - goto: VideoChat
                    # - .Global.VideoChatObjStore.reference.edge@: =..dataObject
                # - goto: VideoChat
                # - actionType: popUp
                #   popUpView: confirmView
                # - actionType: builtIn
                #   funcName: disconnectMeeting
              style:
                left: "0.20"
                top: "0.0185"
                width: "0.13"
                # height: "0.05"
                backgroundColor: "0xd81e06"
                border:
                  style: "3"
                  width: "1"
                # borderWidth: "0.0001px"
                borderRadius: "100"
            - type: image
              path: hangUp.svg
              onClick:
                - =.builtIn.phoneService.stopVibrate
                - =.builtIn.phoneService.stopRingtone
                - actionType: builtIn
                  funcName: goBack
                  reload: false
                # - goto: AppointmentLobby
                # - actionType: popUp
                #   popUpView: confirmView
                # - actionType: builtIn
                #   funcName: disconnectMeeting
              style:
                left: "0.66"
                top: "0.0185"
                width: "0.13"
                # height: "0.05"
                backgroundColor: "0xd81e06"
                border:
                  style: "3"
                  width: "1"
                # borderWidth: "0.0001px"
                borderRadius: "100"
