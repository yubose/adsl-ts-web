RingTonePage:
  pageNumber: "190"
  init:
    - .SignInCheck
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    # - actionType: updateObject
    #   dataKey: Global.roomInfoDoc.document
    #   dataObject: .EmptyObj
    # - ..dataObject@: =.Global.roomInfo.edge
    #change jwt
    # - .Global.createjwt.edge.bvid@: =.Global.currentUser.vertex.id
    # - =.Global.createjwt.edgeAPI.store: ""

    # get roomInfo
    - actionType: evalObject
      object:
        - =.builtIn.ecos.getEdge:
            dataIn:
              edgeId: =.Global.ecosDocObj.doc.0.eid
            dataOut: Global.ecosEdgeObj
        - .RingTonePage.roomInfo.edge@: =.Global.ecosEdgeObj

    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    # get currentRoom fo into
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.RingTonePage.roomInfo.edge.bvid
              string2: =.Global.currentUser.vertex.id
        - .RingTonePage.currentRoom.edge@: =.RingTonePage.roomInfo.edge
        - actionType: evalObject
          object:
            - if:
                - =.builtIn.string.equal:
                    dataIn:
                      string1: =.RingTonePage.roomInfo.edge.evid
                      string2: =.Global.currentUser.vertex.id
                - .RingTonePage.currentRoom.edge@: =.RingTonePage.roomInfo.edge
                - actionType: evalObject
                  object:
                    - =..apiRequest.accessRoomInfo.edgeAPI.get: ""
                    - .RingTonePage.currentRoom.edge@: =..apiRequest.accessRoomInfo.response.edge.0
    # get all E10 and display all the participants
    - ..apiRequest.appointment_E10.edgeAPI.get
    - if:
        - =.builtIn.array.judgeListLength:
            dataIn:
              array: =..apiRequest.appointment_E10.edgeQueryResp.edge
              len: 0
        - continue
        - ..formData.participants_others@: ""
    - =.builtIn.object.extract:
        dataIn:
          array: =..apiRequest.appointment_E10.edgeQueryResp.edge
          field: name
        dataOut: RingTonePage.formData.participants
    # According to the design team, only reserve patient and provider roles in participants
    - =.builtIn.array.removeByName:
        dataIn:
          object: =..formData.participants
          key: role
          name: Location
    - =.builtIn.array.removeByName:
        dataIn:
          object: =..formData.participants
          key: role
          name: Room
    - =.builtIn.array.removeByName:
        dataIn:
          object: =..formData.participants
          key: role
          name: Facility
    - =.builtIn.object.extract:
        dataIn:
          array: =..formData.participants
          field: roleName
        dataOut: RingTonePage.formData.participantsName
    - if:
        - =.builtIn.array.judgeListLength:
            dataIn:
              array: =.RingTonePage.formData.participantsName
              len: 0
        - continue
        - ..formData.participants_others@: ""
    #patient&provider profile
    - actionType: evalObject
      object:
        - ..formData.providerId@: =.Global.currentUser.vertex.id
        - =..patientProfile.get: ""
    - .RingTonePage.currentMeetingPatientProfile@: ""
    - .RingTonePage.currentMeetingPatientProfile@: =..patientProfile.docReponse.doc.0.name.data

    #meet time format
    - =.builtIn.string.formatUnixtimeLT_en:
        dataIn:
          - =.RingTonePage.currentRoom.edge.stime
        dataOut: RingTonePage.formData.stimeTranslated
    - =.builtIn.string.formatUnixtimeLT_en:
        dataIn:
          - =.RingTonePage.currentRoom.edge.etime
        dataOut: RingTonePage.formData.etimeTranslated
    - =.builtIn.string.concat:
        dataIn:
          - Your
          - =..formData.stimeTranslated
          - "-"
          - =..formData.etimeTranslated
        dataOut: RingTonePage.formData.time
    - =.builtIn.phoneService.minRingtoneVibrate:
        dataIn:
          delayTime: 50000
          actions:
            - =.builtIn.phoneService.stopVibrate
            - =.builtIn.phoneService.stopRingtone
            - =.builtIn.string.concat:
                dataIn:
                  - =.RingTonePage.formData.time
                  - appointment invitation was no answer
                dataOut: RingTonePage.sendNotification.document.name.notification.context
            - ..sendNotification.document.name.notification.title@: The participant did not answer
            # - ..sendNotification.document.name.notification.context@: The participant did not answer
            - ..sendNotification.document.name.notification.body@: The participant did not answer
            - ..sendNotification.document.fid@: =.Global.patdAPPID
            - ..sendNotification.document.eid@: =.RingTonePage.roomInfo.edge.id
            - =..sendNotification.docAPI.store: ""
            - actionType: builtIn
              funcName: goBack
              reload: false

  # tony 3/18/22 discussed with Austin don't need to switch facility in ringTone page need more debug and discussing
  # `.Global.roomInfo.edge.name.facilityId` is not the `.Global.currentFacility.id`
  #   # facility

  facilityId: ""
  roomInfo:
    edge: ""
  currentRoom:
    edge: ""
  currentMeetingPatientProfile: ""
  formData:
    providerId: ""
    stimeTranslated: ""
    etimeTranslated: ""
    time: ""
    participants_others: "none"
    participants: []
    participantsName: []
  patientProfile:
    docReponse: ""
    doc:
      ids:
        - =.RingTonePage.roomInfo.edge.name.providerId
        - =.RingTonePage.roomInfo.edge.bvid
        - =.RingTonePage.roomInfo.edge.evid
      xfname: (!D.ovid) & E.Bvid
      type: .DocType.PatientProfile #  type: "102401"
      obfname: "ctime"
      maxcount: "1"
      ObjType: 12
      sCondition: "E.type=10000"
      _nonce: =.Global._nonce
    get:
      api: rd
      dataIn: patientProfile.doc
      dataOut: RingTonePage.patientProfile.docReponse
  selfRoomInfo:
    response: ""
    edge:
      id:
        - .Global.currentUser.vertex.id
        - =.RingTonePage.roomInfo.edge.id
      xfname: bvid,refid
      type: 40000
      sCondition: "subtype=0"
      _nonce: =.Global._nonce
    get:
      api: re
      dataIn: selfRoomInfo.edge
      dataOut: RingTonePage.selfRoomInfo.response
  apiRequest:
    relation:
      edgeQueryResp: ""
      edgeQueryReq:
        id:
          - =.Global.currentUser.vertex.id
          - =.Global.currentFacility.id
        xfname: (bvid,evid)|(evid,bvid)
        type: 10002
        obfname: mtime
        sCondition: tage>0
        _nonce: =.Global._nonce
      edgeAPI:
        get:
          api: re
          dataIn: apiRequest.relation.edgeQueryReq
          dataOut: RingTonePage.apiRequest.relation.edgeQueryResp
    currentFacilityDoc:
      docResp: ""
      docReq:
        id: =.Global.currentFacility.id
        xfname: ovid
        obfname: "mtime"
        maxcount: "1"
        type: .DocType.FacilityProfile
        _nonce: =.Global._nonce
      docAPI:
        get:
          api: rd
          dataIn: apiRequest.currentFacilityDoc.docReq
          dataOut: RingTonePage.apiRequest.currentFacilityDoc.docResp
    # get self E10
    accessRoomInfo:
      response: ""
      edge:
        type: .EdgeType.InviteInfo
        id:
          - .Global.currentUser.vertex.id
          - =.RingTonePage.roomInfo.edge.id
        xfname: "bvid|evid,refid"
      edgeAPI:
        .EdgeAPI: ""
        get:
          api: re
          dataIn: apiRequest.accessRoomInfo.edge
          dataOut: apiRequest.accessRoomInfo.response
    appointment_E10:
      edgeQueryResp: ""
      edgeQueryReq:
        id: =.RingTonePage.roomInfo.edge.id
        xfname: refid
        type: .EdgeType.InviteInfo
        sCondition: subtype!=0
        _nonce: =.Global._nonce
      edgeAPI:
        get:
          api: re
          dataIn: RingTonePage.apiRequest.appointment_E10.edgeQueryReq
          dataOut: RingTonePage.apiRequest.appointment_E10.edgeQueryResp
    #开始会议的tag
    startMeetingTag:
      docCreateResp: ""
      docCreateReq:
        type: .DocType.GroupBitOrTage
        tage: 128
        eid: =.RingTonePage.currentRoom.edge.id
        reid: =.RingTonePage.roomInfo.edge.id
        name:
          data: ""
      docAPI:
        store:
          api: cd
          dataIn: RingTonePage.apiRequest.startMeetingTag.docCreateReq
          dataOut: RingTonePage.apiRequest.startMeetingTag.docCreateResp
    newVideoMessage:
      response: ""
      document:
        eid: =.RingTonePage.currentRoom.edge.id
        reid: =.RingTonePage.roomInfo.edge.id
        subtype:
          isOnServer: 1
          isZipped: 0
          isBinary: 0
          isEncrypted: 0
          isExtraKeyNeeded: 0
          isEditable: 0
          applicationDataType: 8
          # 7 th bit
          notification: 1
          ringToneNotify: 1
          sendtoSelf: 0
          # 10 bit
          textMessage: 0
          mediaType: 8
        type: 770
        name:
          title: textMessage
          senderId: .Global.currentUser.vertex.id
          senderName: .Global.currentUser.vertex.name.userName
          data:
            text: ""
          notification:
            title: New Message From a Doctor
            context: click to open the chat page
            body: click to open the chat page
            onClickLandingPage: ChatPage
            targetApp: =.FirebaseToken.response.edge.evid
      docAPI:
        store:
          api: cd
          dataIn: apiRequest.newVideoMessage.document
          dataOut: apiRequest.newVideoMessage.response
  sendNotification:
    document:
      .Document: ""
      eid: ""
      subtype:
        isOnServer: 1
        isZipped: 0
        isBinary: 0
        isEncrypted: 0
        isExtraKeyNeeded: 0
        isEditable: 0
        applicationDataType: 0
        # 7 th bit
        notification: 1
        ringToneNotify: 0
        sendtoSelf: 0
        # 10 bit
        textMessage: 1
        mediaType: 8
      type: .DocType.Notification
      tage: 2
      name:
        data: ""
        notification:
          title: The participant has declined
          context: The participant has declined
          body: The participant has declined
          # landingPage: RingTonePage
          # onClickLandingPage: RingTonePage
          #targetApp: =.FirebaseToken.response.edge.evid
    docAPI:
      store:
        api: cd
        dataIn: sendNotification.document
  selfNumber: "0"
  # roomInfo:
  #   response: ""
  #   edge:
  #     # .Global.VideoChatObjStore.reference.edge: ""
  #     id: ..emptyId # create a new edge
  #     bvid: .Global.currentUser.vertex.id # always current userId
  #     evid: ..emptyId
  #     name: ..dataObject.name
  #     refid: ..dataObject.id
  #     type: 40000 # may from 1053, need to be override
  #     subtype: 0
  #     _nonce: =.Global._nonce
  #   edgeAPI:
  #     .EdgeAPI: ""
  #     store:
  #       api: ce
  #       dataIn: roomInfo.edge # return result should updated to roomInfo.edge as well
  #       dataOut: roomInfo.response

  components:
    - type: view
      style:
        ..style.content:
      children:
        - type: view
          style:
            height: auto
            width: "0.92"
          children:
            - type: view
              style:
                ..style.cardView:
              children:
                - type: view
                  style:
                    ..style.cardHeader:
                - type: image
                  path: aitmedLogoBlack.svg # waitingroom.png
                  onClick:
                    - actionType: evalObject
                      object:
                        - =.builtIn.string.equal:
                            dataIn:
                              string1: =..apiRequest.appointment_E10.edgeQueryResp
                              string2: ""
                  style:
                    ..style.cardImg:
                - type: view
                  style:
                    ..style.cardContent:
                  children:
                    - type: view
                      style:
                        ..style.cardListView:
                      children:
                        - type: label
                          text: "Date&Time"
                          style:
                            ..style.cardListLeft:
                        - type: view
                          style:
                            ..style.cardListRight:
                          children:
                            - type: view
                              style:
                                width: auto
                              children:
                                - type: label
                                  text=func: .builtIn.string.formatUnixtimeL_en
                                  dataKey: RingTonePage.roomInfo.edge.stime
                                  style:
                                    width: auto
                                    display: "inline-block"
                                    fontWeight: "600"
                                    height: auto
                                - type: label
                                  text=func: .builtIn.date.ShowTimeSpan
                                  dataKey: RingTonePage.roomInfo.edge
                                  style:
                                    width: auto
                                    display: "inline-block"
                                    marginLeft: "0.01"
                                    fontWeight: "600"
                                    height: auto
                    - type: view
                      style:
                        ..style.cardListView:
                      children:
                        - type: label
                          text: "Reason for Visit"
                          style:
                            ..style.cardListLeft:
                            width: "0.3"
                        - type: label
                          dataKey: RingTonePage.roomInfo.edge.name.Reason
                          style:
                            ..style.cardListRight:
                            width: "0.53"
                    - type: view
                      style:
                        ..style.cardListView:
                      children:
                        - type: label
                          text: "Provider Name"
                          style:
                            ..style.cardListLeft:
                            width: "0.3"
                        - type: label
                          dataKey: RingTonePage.roomInfo.edge.name.providerName
                          style:
                            ..style.cardListRight:
                            width: "0.53"
                    - type: view
                      style:
                        ..style.cardListView:
                      children:
                        - type: label
                          text: "Patient Name"
                          style:
                            ..style.cardListLeft:
                            width: "0.3"
                        - type: label
                          dataKey: RingTonePage.roomInfo.edge.name.patientName
                          style:
                            ..style.cardListRight:
                            width: "0.53"
                    - type: view
                      style:
                        ..style.cardListView:
                        display: ..formData.participants_others
                      children:
                        - type: label
                          text: "Participants"
                          style:
                            ..style.cardListLeft:
                            width: "0.3"
                    - type: view
                      style:
                        ..style.cardListView:
                      children:
                        - type: label
                          dataKey: formData.participantsName
                          style:
                            ..style.cardListLeft:
                            width: "0.83"
                            fontWeight: "600"
                            display: ..formData.participants_others
            - type: view
              style:
                width: "0.92"
              children:
                - type: label
                  text: Connecting…
                  dataKey:
                  style:
                    width: "0.92"
                    fontSize: .Nfont.h16
                    textAlign:
                      x: center
                    marginTop: "0.0468"
    - type: view
      style:
        left: "0"
        top: "0.851"
        width: "1"
        height: "0.149"
        backgroundColor: "0xF0F2F4"
        border:
          style: "5"
        textAlign:
          x: center
      children:
        - type: view
          style:
            width: auto
            height: auto
          children:
            - type: view
              style:
                display: inline-block
              children:
                - type: image
                  path: hangUp.png
                  onClick:
                    - =.builtIn.phoneService.stopVibrate
                    - =.builtIn.phoneService.stopRingtone
                    - =.builtIn.string.concat:
                        dataIn:
                          - =.RingTonePage.formData.time
                          - appointment invitation has been declined
                        dataOut: RingTonePage.sendNotification.document.name.notification.context
                    - ..sendNotification.document.fid@: =.Global.patdAPPID
                    - ..sendNotification.document.eid@: =.RingTonePage.roomInfo.edge.id
                    - =..sendNotification.docAPI.store: ""
                    - actionType: builtIn
                      funcName: goBack
                      reload: false
                    # - goto: RingTonePage
                    # - actionType: popUp
                    #   popUpView: confirmView
                    # - actionType: builtIn
                    #   funcName: disconnectMeeting
                  style:
                    borderRadius: "100"
                    width: "0.13"
                - type: label
                  text: Decline
                  style:
                    fontSize: .Nfont.h16
                    fontWeight: "600"

            - type: view
              style:
                display: inline-block
                marginLeft: "0.2533"
              children:
                - type: image
                  path: pickup_phone.png
                  onClick:
                    - .Global.currentRoom.edge@: =.RingTonePage.currentRoom.edge
                    - .Global.roomInfo.edge@: =.RingTonePage.roomInfo.edge
                    - .Global.currentMeetingPatientProfile@: =.RingTonePage.currentMeetingPatientProfile
                    - actionType: updateObject
                      dataKey: Global.roomInfoDoc.document
                      dataObject: .EmptyObj
                    - =.builtIn.phoneService.stopVibrate
                    - =.builtIn.phoneService.stopRingtone
                    - actionType: evalObject
                      object:
                        # get deat: roomId&token
                        - if:
                            - =.Global.roomInfoDoc.document.deat.roomID
                            - continue
                            - actionType: evalObject
                              object:
                                - =..apiRequest.newVideoMessage.docAPI.store: ""
                                - .Global.roomInfoDoc.document@: =..apiRequest.newVideoMessage.response.doc
                        # 如果已经打过tag，则不再重复创建
                        - if:
                            - =.builtIn.number.typeIsValid:
                                dataIn:
                                  docType: =.Global.roomInfo.edge.tage
                                  localArr: [8]
                                  binaryArr: [1]
                            - continue
                            # 建立开始会议的tag
                            - =..apiRequest.startMeetingTag.docAPI.store: ""

                    - .RingTonePage.facilityId@: =.Global.roomInfo.edge.name.facilityId
                    # 获取fac
                    - =.builtIn.array.getObjectByArray:
                        dataIn:
                          array: =.Global.organizations
                          key: "id"
                          value: =.RingTonePage.facilityId
                        dataOut: Global.currentFacility
                    
                    # 获取 自己和当前facility之间的边
                    - actionType: evalObject
                      object:
                        - =..apiRequest.relation.edgeAPI.get: ""
                        - .Global.formData.currentFacility.relationEdge@: =..apiRequest.relation.edgeQueryResp.edge.0
                        - =..apiRequest.currentFacilityDoc.docAPI.get: ""
                        - .Global.currentFacilityDoc@: =..apiRequest.currentFacilityDoc.docResp.doc.0
                        - .Global.formData.location@: =.Global.currentFacility
                        - .Global.dashboardName@: =.Global.currentFacility.name.basicInfo.medicalFacilityName
                    - goto: VideoChat
                    # - goto: VideoChat
                    # - .Global.VideoChatObjStore.reference.edge@: =..dataObject
                    # - goto: VideoChat
                    # - actionType: popUp
                    #   popUpView: confirmView
                    # - actionType: builtIn
                    #   funcName: disconnectMeeting
                  style:
                    borderRadius: "100"
                    width: "0.13"
                - type: label
                  text: Accept
                  style:
                    fontSize: .Nfont.h16
                    fontWeight: "600"

  style:
    content:
      left: "0"
      top: "0"
      width: "1"
      height: "0.851"
      backgroundColor: "0xF0F2F4"
      textAlign:
        x: center
        y: center
    cardView:
      width: "0.92"
      backgroundColor: "0xffffff"
      boxShadow: "1px 1px 4px 1px #dededf"
      borderRadius: "10"
      paddingBottom: "0.02"
      overflow: hidden
      textAlign:
        x: left
    cardHeader:
      marginTop: "0"
      width: "0.92"
      height: "0.01478"
      backgroundColor: "0x3890CE"
    cardImg:
      width: "0.12277"
      marginTop: "0.0098"
      marginLeft: "0.045"
    cardContent:
      width: "0.83"
      marginLeft: "0.045"
      height: "auto"

    cardListView:
      width: "0.83"

      marginTop: "0.0123"
    cardListLeft:
      fontSize: .Nfont.h14
      display: "inline-block"
      width: "0.256"
    cardListRight:
      fontSize: .Nfont.h14
      display: "inline-block"
      fontWeight: "600"
      width: "0.574"
      textAlign:
        x: right
