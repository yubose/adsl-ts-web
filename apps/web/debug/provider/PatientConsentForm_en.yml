PatientConsentForm:
  title: Patient Consent Form - HIPPA
  pageNumber:
  init: #Page initialization
    - .SignInCheck

    - if:
        #判断是否从ProviderMacros回来，需要复现之前已填的数据
        - =.Global.formData.providerDoc.patientConsentForm.id
        - actionType: evalObject
          object:
            - ..apiRequest.patientConsentForm.docReq@: =.Global.formData.providerDoc.patientConsentForm
        - actionType: evalObject
          object:
            #页面进入时就创建文档
            - =.PatientConsentForm.apiRequest.patientConsentForm.docAPI.store: ""
            # 将创建的文档数据重新给note 进行update
            - ..apiRequest.patientConsentForm.docReq@: =..apiRequest.patientConsentForm.docResp.doc

    # 判断是否签名
    - if:
        - =..apiRequest.patientConsentForm.docReq.name.data.whetherSign
        - continue
        # 非空修改显示的标识,刷新签名区域
        - actionType: evalObject
          object:
            # 签名的时间
            - ..formData.signatureTime@: =.PatientConsentForm.apiRequest.patientConsentForm.docReq.name.data.signatureTime
            # 签名的id
            - ..formData.temporarySignature@: =.PatientConsentForm.apiRequest.patientConsentForm.docReq.name.data.signatureId
            - ..formData.flag@: "block"

  formData: #Input data here
    flag: "none"
    whetherSign: ""
    temporarySignature: ""
    signatureTime: ""
  formDataTemp: ""

  apiRequest: #Input data request here
    patientConsentForm:
      docResp: ""
      docReq:
        eid: .Global.currentRoom.edge.id
        reid: ""
        type: .DocType.PatientConsentForm
        name:
          data:
            classTag:
              name: Provider
              fontColor: "0x30b354"
              backgroundColor: "0xe4f5e9"
              display: block
            statusTag:
              name: Private
              fontColor: "0x4c5264"
              backgroundColor: "0xececee"
              display: block
            facilityInfo:
              facilityAvatarID: .Global.currentFacilityDoc.name.data.basicInfo.businessLogo
              facilityName: .Global.currentFacilityDoc.name.data.basicInfo.medicalFacilityName
              address: .Global.currentFacilityDoc.name.data.basicInfo.location
              email: .Global.currentFacilityDoc.name.data.basicInfo.email
              phoneNumber: .Global.currentFacilityDoc.name.data.basicInfo.phoneNumber
              fax: .Global.currentFacilityDoc.name.data.basicInfo.fax
              website: .Global.currentFacilityDoc.name.data.basicInfo.website
            patientInfo:
              examDate: .Global.roomInfo.edge.stime
              patientName: .Global.currentMeetingPatientProfile.basicInfo.fullName
              dob: .Global.currentMeetingPatientProfile.basicInfo.dateOfBirth
              phone: .Global.currentMeetingPatientProfile.basicInfo.phone
              email: .Global.currentMeetingPatientProfile.contactInfo.email
              address: .Global.currentMeetingPatientProfile.contactInfo.address.fullAddress
            signatureId: ""
            signatureTime: ""
            whetherSign: "true"
            proxyInfo: ""
          title: "Patient Consent Form - HIPPA"
          user: .Global.formData.providerTitle
      docAPI:
        store:
          api: cd
          dataIn: PatientConsentForm.apiRequest.patientConsentForm.docReq
          dataOut: PatientConsentForm.apiRequest.patientConsentForm.docResp

    newSign:
      docRes: ""
      docReq: #DOC
        type: .DocType.DocumentSignature
        name:
          title: ""
          type: ..apiRequest.newSign.docReq.subtype.mediaType
          data: ""
        eid: .Global.rootNotebookID
        subtype:
          mediaType: ""
      docAPI: # DOCAPI
        store:
          api: cd
          dataIn: PatientConsentForm.apiRequest.newSign.docReq
          dataOut: PatientConsentForm.apiRequest.newSign.docRes
  style: #Input style fragment here

  components:
    - .BasePublicHeader:
      children:
        - .BasePublicHeaderLeft:
        - .BasePublicHeaderTitle:
        - .BasePublicHeaderRightText:
          onClick:
            # 签名处理
            - actionType: saveSignature
              dataObject: BLOB
              dataKey: PatientConsentForm.apiRequest.newSign.docReq.name.data
              isEmpty: PatientConsentForm.formData.whetherSign
            # 保存签名
            - actionType: evalObject
              object:
                - ..apiRequest.newSign.docReq.reid@: =.PatientConsentForm.apiRequest.patientConsentForm.docReq.id

            - actionType: evalObject
              object:
                - if:
                    - =..formData.whetherSign
                    - continue
                    - =..apiRequest.newSign.docAPI.store: ""

            - actionType: evalObject
              object:
                - if:
                    - =..formData.temporarySignature
                    - actionType: evalObject
                      object:
                        - ..apiRequest.patientConsentForm.docReq.name.data.signatureTime@: =..formData.signatureTime
                        - ..apiRequest.patientConsentForm.docReq.name.data.signatureId@: =..formData.temporarySignature
                        - ..apiRequest.patientConsentForm.docReq.name.data.whetherSign@: false
                        - ..formData.whetherSign@: false
                    - actionType: evalObject
                      object:
                        - ..apiRequest.patientConsentForm.docReq.name.data.signatureTime@: =..apiRequest.newSign.docRes.doc.ctime
                        - ..apiRequest.patientConsentForm.docReq.name.data.signatureId@: =..apiRequest.newSign.docRes.doc.id
                        - ..apiRequest.patientConsentForm.docReq.name.data.whetherSign@: =..formData.whetherSign
            - actionType: evalObject
              object:
                - =.PatientConsentForm.apiRequest.patientConsentForm.docAPI.store: ""
                - .Global.formData.providerDoc.patientConsentForm@: =..apiRequest.patientConsentForm.docResp.doc
                - goto: ProviderMacros
    - type: scrollView
      style:
        width: "1"
        height: "0.846"
        overflow: scroll
        fontFamily: "Arial"
      children:
        - type: view
          style:
            marginLeft: "0.04"
            marginTop: "0.0246"
            height: "auto"
            width: "0.92"
          children:
            - type: image
              path: office-building.svg
              path=func: =.builtIn.utils.prepareDocToPath
              dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.facilityAvatarID
              style:
                verticalAlign: middle
                display: "inline-block"
                height: "0.0578"
                width: "5.78vh"
            - type: view
              style:
                verticalAlign: middle
                marginLeft: "0.08"
                display: "inline-block"
                height: "auto"
                width: "0.71"
                overflow: hidden
              children:
                - type: label
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.facilityName
                  style:
                    width: "0.71"
                    height: "auto"
                    fontSize: .Nfont.h20
                    fontWeight: "600"
                    fontFamily: "Arial"
                    verticalAlign: middle
                    wordWrap: break-word
                - type: label
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.address
                  style:
                    marginTop: "0.0110"
                    width: "0.71"
                    height: "auto"
                    fontSize: .Nfont.h14
                    color: "0x666666"
                    fontFamily: "Arial"
                    verticalAlign: middle
                    wordWrap: break-word
        - type: view
          style:
            marginLeft: "0.04"
            marginTop: "0.00738"
            width: "0.92"
            height: "auto"
            overflow: hidden
          children:
            - .DocPublicStyleOneBox:
              children:
                - .DocPublicStyleOneLeft:
                  text: Email
                - .DocPublicStyleOneRight:
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.email
            - .DocPublicStyleOneBox:
              children:
                - .DocPublicStyleOneLeft:
                  text: Website
                - .DocPublicStyleOneRight:
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.website
            - .DocPublicStyleOneBox:
              children:
                - .DocPublicStyleOneLeft:
                  text: "Main #"
                - .DocPublicStyleOneRight:
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.phoneNumber
            - .DocPublicStyleOneBox:
              children:
                - .DocPublicStyleOneLeft:
                  text: "Fax #"
                - .DocPublicStyleOneRight:
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.fax

        - .DocPublicLine:
        - type: view
          style:
            marginLeft: "0.04"
            marginTop: "0.00738"
            width: "0.92"
            height: "auto"
            overflow: hidden
          children:
            - .DocPublicStyleTwoBox:
              children:
                - .DocPublicStyleTwoLeft:
                  text: Exam Date
                - .DocPublicStyleTwoRight:
                  text=func: .builtIn.string.formatUnixtime_en
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.patientInfo.examDate
            - .DocPublicStyleTwoBox:
              children:
                - .DocPublicStyleTwoLeft:
                  text: Patient Name
                - .DocPublicStyleTwoRight:
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.patientInfo.patientName
            - .DocPublicStyleTwoBox:
              children:
                - .DocPublicStyleTwoLeft:
                  text: Date of Birth
                - .DocPublicStyleTwoRight:
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.patientInfo.dob
            - .DocPublicStyleTwoBox:
              children:
                - .DocPublicStyleTwoLeft:
                  text: "Phone #"
                - .DocPublicStyleTwoRight:
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.patientInfo.phone
            - .DocPublicStyleTwoBox:
              children:
                - .DocPublicStyleTwoLeft:
                  text: "Email"
                - .DocPublicStyleTwoRight:
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.patientInfo.email
            - .DocPublicStyleTwoBox:
              children:
                - .DocPublicStyleTwoLeft:
                  text: "Patient Address"
            - .DocPublicStyleTwoBox:
              children:
                - .DocPublicStyleTwoLeft:
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.patientInfo.address
                  style:
                    height: "auto"
                    width: "0.92"
                    fontSize: .Nfont.h14
                    wordWrap: break-word
                    color: "0x333333"
                    fontWeight: "600"
        - .DocPublicLine:
        - type: label
          text: The Department of Health and Human Services has established a “Privacy Rule” to help insure that personal health care information is protected for privacy. The Privacy Rule was also created in order to provide a standard for certain health care providers to obtain their patients' consent for uses and disclosures of health information about the patient to carry out treatment, payment or health care operations.
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - type: label
          text: As our patient we want you to know that we respect the privacy of your personal medical records and will do all we can to secure and protect that privacy. We strive to always take reasonable precautions to protect your privacy. When it is appropriate and necessary, we provide the minimum necessary information to only those we feel are in need of your healthcare information and information about treatment, payment or health care operations, in order to provide health care that is in your best interest.
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - type: label
          text: We also want you to know that we support your full access to your personal medical records. We may have indirect treatments relationships with you (such as laboratories that only interact with physicians and not patients), and may have to disclose personal health information for purposes of treatment, payment, or health operations, These entities are most often not required to obtain patient consent.
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - type: label
          text: You may refuse to consent to the use or disclosure of your personal health information but this must be in writing. Under this law, we have the right to refuse to treat you should you choose to refuse to disclose your Personal Health Information (PIH). If you choose to give consent in this document, at some future time you may request to refuse all or part of your PHI. You may not revoke actions that have already been taken which relied on this or a previously signed consent.
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - type: label
          text: If your have objections to this form, please ask to speak with out HIPPA Compliance Officer.
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - type: label
          text: You have the right to review our privacy notice to request restrictions and revoke consent in writing after you have reviewed our privacy notice.
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - type: label
          text: HIPPA Notice of Privacy Practices
          dataKey:
          style:
            marginTop: "0.0246"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            fontWeight: "600"

        - type: label
          text: "Signature below is only acknowledgement that you havereceived this Notice of our Privacy Practices:"
          dataKey:
          style:
            marginTop: "0.01"
            marginLeft: "0.04"
            width: "0.92"
            height: "auto"
            color: "0x333333"
            fontSize: .Nfont.h14
            lineHeight: "2.58vh"

        - .DocPublicStyleFiveBox:
          children:
            - .DocPublicStyleFiveTitle:
              text: "Name of Recipient/Healthcare Proxy"
            - .DocPublicStyleFiveinput:
              style:
                height: "0.0541"
              dataKey: apiRequest.patientConsentForm.docReq.name.data.proxyInfo

        - .DocPublicLine:
        - type: view
          style:
            marginLeft: "0.04"
            marginTop: "0.03"
            width: "0.92"
            height: "auto"
            overflow: hidden
          children:
            - type: label
              text: Signature
              style:
                width: "0.92"
                height: "auto"
                color: "0x333333"
                fontSize: .Nfont.h14
                fontWeight: "600"
            - type: view
              style:
                marginTop: "0.01"
                height: "auto"
                width: "0.92"
              children:
                - type: label
                  text: "Click on the signature box below to finger sign"
                  style:
                    display: "inline-block"
                    width: "0.8266"
                    fontSize: .Nfont.h14
                    height: "auto"
                    color: "0x333333"
                    textAlign:
                      x: left
                - type: label
                  text: "Clear"
                  style:
                    display: "inline-block"
                    width: "auto"
                    fontSize: .Nfont.h14
                    height: "auto"
                    color: "0xfb5051"
                  onClick:
                    - actionType: removeSignature
                      dataObject: BLOB
                      dataKey: PatientConsentForm.apiRequest.newSign.docReq.name.data
                      viewTag: signatureTag
                    - actionType: evalObject
                      object:
                        - ..formData.temporarySignature@: ""
                        - ..formData.signatureTime@: ""
                        - ..formData.flag@: "none"
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: signatureTimeTag
                    # 显示签名区域隐藏
                    - actionType: builtIn
                      funcName: hide
                      viewTag: signatureShowTag
                    - actionType: builtIn
                      funcName: show
                      viewTag: signatureTag
        - type: view
          style:
            marginLeft: "0.04"
            marginTop: "0.01"
            height: "0.128"
            width: "0.9"
            border:
              style: "4"
              color: "0xa9a9a9"
            borderWidth: "2"
          children:
            - type: label
              text: X
              style:
                .SignLabelStyle:
            - type: canvas
              dataKey: PatientConsentForm.apiRequest.newSign.docReq.name.data
              viewTag: signatureTag
              style:
                left: "0"
                width: "0.88"
                height: "0.128"
                overflow: scroll
            # 显示暂存的签名
            - type: image
              viewTag: signatureShowTag
              path=func: .builtIn.utils.prepareDocToPath
              # 传入签名文档的id
              dataKey: PatientConsentForm.formData.temporarySignature
              style:
                # 控制显示
                display: =..formData.flag
                left: "0"
                width: "0.88"
                top: "0"
                height: "0.128"
                overflow: scroll
                zIndex: "1000"

        - type: view
          style:
            marginLeft: "0.04"
            marginTop: "0.0146"
            width: "0.92"
            height: "auto"
            overflow: hidden
          children:
            - type: view
              viewTag: signatureTimeTag
              style:
                display: ..formData.flag
                marginTop: "0.01"
                height: "auto"
                width: "0.92"
              children:
                - type: label
                  text=func: .builtIn.string.formatUnixtime_en
                  dataKey: apiRequest.patientConsentForm.docReq.name.data.signatureTime
                  style:
                    display: "inline-block"
                    width: "auto"
                    height: "auto"
                    fontSize: .Nfont.h12
                    color: "0x757575"
                    verticalAlign: middle
                - type: label
                  text: "Digitally Signed"
                  dataKey:
                  style:
                    marginLeft: "0.02"
                    display: "inline-block"
                    width: "auto"
                    height: "auto"
                    fontSize: .Nfont.h12
                    color: "0x757575"
                    verticalAlign: middle
            - type: view
              style:
                marginTop: "0.01"
                width: "auto"
                height: "auto"
              children:
                - type: label
                  text: Date
                  style:
                    display: "inline-block"
                    width: "auto"
                    height: "auto"
                    color: "0x666666"
                    fontSize: .Nfont.h12
                - type: label
                  text=func: .builtIn.string.formatUnixtimeL_en
                  dataKey: apiRequest.patientConsentForm.docReq.ctime
                  style:
                    marginLeft: "0.0373"
                    display: "inline-block"
                    width: "auto"
                    height: "auto"
                    color: "0x333333"
                    fontSize: .Nfont.h12
                    fontWeight: "600"
        - type: view
          style:
            marginTop: "0.03"
    - .BasePublicFooter:
      children:
        - type: view
          style:
            height: auto
            width: "auto"
          children:
            - .DocButtonPrivate:
              onClick:
                # 签名处理
                - actionType: saveSignature
                  dataObject: BLOB
                  dataKey: PatientConsentForm.apiRequest.newSign.docReq.name.data
                  isEmpty: PatientConsentForm.formData.whetherSign

                # 保存签名
                - actionType: evalObject
                  object:
                    # 签名reid指向 doc 的id
                    - ..apiRequest.newSign.docReq.reid@: =.PatientConsentForm.apiRequest.patientConsentForm.docReq.id

                - actionType: evalObject
                  object:
                    - if:
                        - =..formData.whetherSign
                        - continue
                        - =..apiRequest.newSign.docAPI.store: ""

                #  指定 eid 和 reid
                - actionType: evalObject
                  object:
                    - ..apiRequest.patientConsentForm.docReq.eid@: =.Global.currentRoom.edge.id
                    - ..apiRequest.patientConsentForm.docReq.reid@: =.Global.roomInfo.edge.id

                # 签名处理
                - actionType: evalObject
                  object:
                    - if:
                        - =..formData.temporarySignature
                        - actionType: evalObject
                          object:
                            - ..apiRequest.patientConsentForm.docReq.name.data.signatureTime@: =..formData.signatureTime
                            - ..apiRequest.patientConsentForm.docReq.name.data.signatureId@: =..formData.temporarySignature
                            - ..apiRequest.patientConsentForm.docReq.name.data.whetherSign@: false
                            - ..formData.whetherSign@: false
                        - actionType: evalObject
                          object:
                            - ..apiRequest.patientConsentForm.docReq.name.data.signatureTime@: =..apiRequest.newSign.docRes.doc.ctime
                            - ..apiRequest.patientConsentForm.docReq.name.data.signatureId@: =..apiRequest.newSign.docRes.doc.id
                            - ..apiRequest.patientConsentForm.docReq.name.data.whetherSign@: =..formData.whetherSign

                #  修改type
                - actionType: evalObject
                  object:
                    - =.builtIn.number.inhx:
                        dataIn:
                          intHex: =..apiRequest.patientConsentForm.docReq.type
                          index: 1
                          hex: 0
                        dataOut: PatientConsentForm.apiRequest.patientConsentForm.docReq.type

                # 保存newNote
                - actionType: evalObject
                  object:
                    - =..apiRequest.patientConsentForm.docAPI.store: ""
                    - =.builtIn.array.add:
                        dataIn:
                          object: =.Global.currentMeetingDoc
                          value: =..apiRequest.patientConsentForm.docResp.doc
                - actionType: evalObject
                  object:
                    .Global._nonce@:
                      =.builtIn.math.random: ""

                - actionType: evalObject
                  object:
                    - goto: ProviderNoteSelect

            - .DocButtonRelease:
              onClick:
                # 签名处理
                - actionType: saveSignature
                  dataObject: BLOB
                  dataKey: PatientConsentForm.apiRequest.newSign.docReq.name.data
                  isEmpty: PatientConsentForm.formData.whetherSign

                # 保存签名
                - actionType: evalObject
                  object:
                    # 签名reid指向 doc 的id
                    - ..apiRequest.newSign.docReq.reid@: =.PatientConsentForm.apiRequest.patientConsentForm.docReq.id

                - actionType: evalObject
                  object:
                    - if:
                        - =..formData.whetherSign
                        - continue
                        - =..apiRequest.newSign.docAPI.store: ""

                #  指定 eid 和 reid
                - actionType: evalObject
                  object:
                    - ..apiRequest.patientConsentForm.docReq.eid@: =.Global.currentRoom.edge.id
                    - ..apiRequest.patientConsentForm.docReq.reid@: =.Global.roomInfo.edge.id

                # 签名处理
                - actionType: evalObject
                  object:
                    - if:
                        - =..formData.temporarySignature
                        - actionType: evalObject
                          object:
                            - ..apiRequest.patientConsentForm.docReq.name.data.signatureTime@: =..formData.signatureTime
                            - ..apiRequest.patientConsentForm.docReq.name.data.signatureId@: =..formData.temporarySignature
                            - ..apiRequest.patientConsentForm.docReq.name.data.whetherSign@: false
                            - ..formData.whetherSign@: false
                        - actionType: evalObject
                          object:
                            - ..apiRequest.patientConsentForm.docReq.name.data.signatureTime@: =..apiRequest.newSign.docRes.doc.ctime
                            - ..apiRequest.patientConsentForm.docReq.name.data.signatureId@: =..apiRequest.newSign.docRes.doc.id
                            - ..apiRequest.patientConsentForm.docReq.name.data.whetherSign@: =..formData.whetherSign

                - actionType: evalObject
                  object:
                    - if:
                        - =.PatientConsentForm.formData.whetherSign
                        - actionType: popUp
                          popUpView: BaseWarningView
                          wait: true
                          popUpDismiss: 2000
                        - continue

                #  修改type
                - actionType: evalObject
                  object:
                    - =.builtIn.number.inhx:
                        dataIn:
                          intHex: =..apiRequest.patientConsentForm.docReq.type
                          index: 1
                          hex: 1
                        dataOut: PatientConsentForm.apiRequest.patientConsentForm.docReq.type

                - actionType: evalObject
                  object:
                    # 更新文档状态
                    - ..apiRequest.patientConsentForm.docReq.name.data.statusTag.name@: "Released"
                    - ..apiRequest.patientConsentForm.docReq.name.data.statusTag.fontColor@: "0x2988e6"
                    - ..apiRequest.patientConsentForm.docReq.name.data.statusTag.backgroundColor@: "0xdfedfc"

                - actionType: evalObject
                  object:
                    - =..apiRequest.patientConsentForm.docAPI.store: ""
                    - =.builtIn.array.add:
                        dataIn:
                          object: =.Global.currentMeetingDoc
                          value: =..apiRequest.patientConsentForm.docResp.doc
                - actionType: evalObject
                  object:
                    .Global._nonce@:
                      =.builtIn.math.random: ""

                - actionType: evalObject
                  object:
                    - goto: ProviderNoteSelect

    - .BaseWarningView:
      message: "You haven't signed the form"
