RelatedAppointmentDetail:
  title: Related Appointment
  init:
    - .SignInCheck
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    - ..listData.get
    # 这个地方只是用来看的 所有不需要太多的处理
    - ..dataObject@: =.Global.currentRleatedRoomInfo.edge
    # 将当前relation appointment赋值给Global.currentRoomInfo以便后续的invite等操作
    - .Global.currentRoomInfo@: =.Global.currentRleatedRoomInfo
    # 控制 medical document 的 bar不展示
    - actionType: evalObject
      object:
        - .Global.formData.tabBarShow@: "none"
        - .Global.formData.isisRelatedApp@: "true"
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =..dataObject.name.visitType
              string2: Telemedicine
        - ..formData.isTelemedicine@: none
        - ..formData.isTelemedicine@: ""
    - =..patientProfile.get: ""
    - .Global.currentMeetingPatientProfile@: ""
    - .Global.currentMeetingPatientProfile@: =..patientProfile.docReponse.doc.0.name.data
    - =..apiRequest.financialInfo.docAPI.get: ""
    - ..apiRequest.appointment_E10.edgeAPI.get
    - if:
        - =..apiRequest.appointment_E10.edgeQueryResp.edge
        - actionType: evalObject
          object:
            - ..formData.participants_others@: ""
            - =.builtIn.array.keepLatestDoc:
                dataIn:
                  docList: =..apiRequest.appointment_E10.edgeQueryResp.edge
                  path: ctime
                dataOut: RelatedAppointmentDetail.apiRequest.appointment_E10.edgeQueryResp.edge
            - =.builtIn.object.extract:
                dataIn:
                  array: =..apiRequest.appointment_E10.edgeQueryResp.edge
                  field: name.role
                dataOut: RelatedAppointmentDetail.formData.roleList
        - continue
    - =.builtIn.object.extract:
        dataIn:
          array: =..apiRequest.appointment_E10.edgeQueryResp.edge
          field: name
        dataOut: RelatedAppointmentDetail.formData.participants
    # According to the design team, only reserve patient and provider roles in participants
    - =.builtIn.array.removeByName:
        dataIn:
          object: =..formData.participants
          key: role
          name: Location
    - =.builtIn.array.removeByName:
        dataIn:
          object: =..formData.participants
          key: role
          name: Room
    - =.builtIn.array.removeByName:
        dataIn:
          object: =..formData.participants
          key: role
          name: Facility
    # 删去重复显示的provider
    - =.builtIn.array.removeByName:
        dataIn:
          object: =..formData.participants
          key: roleName
          name: =.Global.currentRoomInfo.edge.name.providerName
    - actionType: builtIn
      funcName: redraw
      viewTag: participants
    - ..apiRequest.patientProfile.docQueryReq.id@: =.Global.currentRleatedRoomInfo.edge.evid
    - =..apiRequest.patientProfile.docAPI.get: ""
    # 如果金额为0.00，隐藏Payment Status状态栏
    - if:
        - =.builtIn.utils.judgeAll:
            dataIn:
              value:
                - =.Global.currentRleatedRoomInfo.edge.name.fee
                - =..apiRequest.financialInfo.docQueryResp.doc.0.name.data.paymentInfo.fee
              index: "0.00"
        - ..formData.display_payStatus@: none
        - continue
    # 如果是关联预约，显示原provider名字
    - if:
        - =.Global.currentRoomInfo.edge.name.mainProviderName
        # 如果关联预约的主provider和mainProvider一样，则不用显示mainProvider
        - actionType: evalObject
          object:
            - if:
                - =.builtIn.string.equal:
                    dataIn:
                      string1: =.Global.currentRoomInfo.edge.name.mainProviderName
                      string2: =.Global.currentRoomInfo.edge.name.providerName
                - ..formData.mainProviderDisplay@: none
                - ..formData.mainProviderDisplay@: block
        - ..formData.mainProviderDisplay@: none
  listData:
    invitees:
      edge: ""
    get:
      .EdgeAPI.get: ""
      api: re
      dataKey: listData.invitees
      id: .Global.roomInfo.edge.id
      type: .EdgeType.InviteInfo
      xfname: refid
      maxcount: "20"
      # sCondition: "tage=0 AND ctime>UNIX_TIMESTAMP()-7200"
      sCondition: "tage=0"
      _nonce: .Global._nonce
  formData:
    # 如果是关联预约，显示原provider名字
    mainProviderDisplay: none
    # control location and address display or not
    isTelemedicine: none
    display_payStatus: ""
    pointerEvents_payStatus: ""
    backgroundColor_status: "#ffffff"
    opacity_payStatus: 1
    participants: []
    payStatus:
      fontColor: "0x666666"
  apiRequest:
    patientProfile:
      docQueryResp: ""
      docQueryReq:
        id: ""
        xfname: ovid
        obfname: mtime
        maxcount: "1"
        _nonce: .Global._nonce
        type: .DocType.PatientProfile
      docAPI:
        get:
          api: rd
          dataIn: RelatedAppointmentDetail.apiRequest.patientProfile.docQueryReq
          dataOut: RelatedAppointmentDetail.apiRequest.patientProfile.docQueryResp
    # get the E10
    appointment_E10:
      edgeQueryResp: ""
      edgeQueryReq:
        id: .Global.currentRoomInfo.edge.id
        xfname: refid
        type: .EdgeType.InviteInfo
        sCondition: subtype!=0
        _nonce: =.Global._nonce
      edgeAPI:
        get:
          api: re
          dataIn: RelatedAppointmentDetail.apiRequest.appointment_E10.edgeQueryReq
          dataOut: RelatedAppointmentDetail.apiRequest.appointment_E10.edgeQueryResp
    # get self E10
    accessRoomInfo:
      response: ""
      edge:
        type: .EdgeType.InviteInfo
        id:
          - .Global.currentUser.vertex.id
          - .Global.roomInfo.edge.id
        xfname: "bvid|evid,refid"
      edgeAPI:
        get:
          api: re
          dataIn: apiRequest.accessRoomInfo.edge
          dataOut: apiRequest.accessRoomInfo.response
    paymentEdge:
      edgeResp: ""
      edgeIn:
        id: .Global.roomInfo.edge.id
        xfname: refid
        _nonce: .Global._nonce
        type: 1113
        obfname: mtime
        subtype: 1
      edgeAPI:
        get:
          api: re
          dataIn: RelatedAppointmentDetail.apiRequest.paymentEdge.edgeIn
          dataOut: RelatedAppointmentDetail.apiRequest.paymentEdge.edgeResp
    hasPaidProfile:
      getDocResp: ""
      getDocReq:
        id: ""
        xfname: eid
        type: 2001
        obfname: mtime
        _nonce: .Global._nonce
        maxcount: "100"
      docAPI:
        get:
          api: rd
          dataIn: RelatedAppointmentDetail.apiRequest.hasPaidProfile.getDocReq
          dataOut: RelatedAppointmentDetail.apiRequest.hasPaidProfile.getDocResp
    financialInfo:
      docQueryResp: ""
      docQueryReq:
        type: .DocType.FinancialInfo
        id: .Global.roomInfo.edge.id
        xfname: reid
        obfname: mtime
        maxcount: "1"
        _nonce: =.Global._nonce
      docAPI:
        get:
          api: rd
          dataIn: RelatedAppointmentDetail.apiRequest.financialInfo.docQueryReq
          dataOut: RelatedAppointmentDetail.apiRequest.financialInfo.docQueryResp
  patientProfile:
    # get all patient profile
    docReponse: ""
    doc:
      ids:
        - .Global.roomInfo.edge.name.providerId
        - .Global.roomInfo.edge.bvid
        - .Global.roomInfo.edge.evid
      xfname: (!D.ovid) & E.Bvid
      type: .DocType.PatientProfile #  type: "102401"
      obfname: "ctime"
      maxcount: "1"
      ObjType: 12
      sCondition: "E.type=10000"
      _nonce: =.Global._nonce
    get:
      api: rd
      dataIn: patientProfile.doc
      dataOut: RelatedAppointmentDetail.patientProfile.docReponse
  components:
    - .BasePublicHeader:
      children:
        - .BasePublicHeaderLeft:
          leftClick:
            - actionType: evalObject
              object:
                - .Global.formData.isisRelatedApp@: "false"
            - actionType: builtIn
              funcName: goBack
              reload: true
        - .BasePublicHeaderTitle:
    - type: scrollView
      style:
        width: "1"
        height: "0.94"
      children:
        - type: view
          style:
            height: "0.05"
            backgroundColor: "#f0f0f0"
            width: "1"
          children:
            - type: label
              text: Appointment  Info
              style:
                display: "inline-block"
                marginLeft: "0.05"
                color: "0x666666"
                height: "0.05"
                width: "0.48533333"
                lineHeight: 5vh

                fontSize: .Nfont.h14
                fontWeight: "600"
                textAlign:
                  x: left
        - type: view
          style:
            height: "auto"
            width: "0.9"
            marginLeft: "0.05"
            color: "0x4b4b4b"
          children:
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: Patient Name
                - .PresLabelRight:
                  dataKey: apiRequest.patientProfile.docQueryResp.doc.0.name.data.basicInfo.fullName
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: Visit Type
                - .PresLabelRight:
                  dataKey: dataObject.name.visitType
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: "Reason for Visit"
                - .PresLabelRight:
                  dataKey: dataObject.name.visitReason
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: "Date"
                - .PresLabelRight:
                  text=func: .builtIn.string.formatUnixtimeL_en
                  dataKey: dataObject.stime
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: "Time"
                - .PresLabelRight:
                  text=func: .builtIn.date.ShowTimeSpan
                  dataKey: dataObject
            - .PresListView:
              viewTag: locationAndAddress
              style:
                display: ..formData.isTelemedicine
              children:
                - .PresLabelLeft:
                  text: "Location"
                - .PresLabelRight:
                  dataKey: dataObject.name.locationName
            - .PresListView:
              viewTag: locationAndAddress
              style:
                display: ..formData.isTelemedicine
              children:
                - .PresLabelLeft:
                  text: "Address"
            - .PresListView:
              viewTag: locationAndAddress
              style:
                display: ..formData.isTelemedicine
              children:
                - .PresLabelLeft:
                  dataKey: dataObject.name.location
                  style:
                    width: "0.9"
                    fontWeight: "normal"
                    wordBreak: break-word
            - .PresListView:
              viewTag: tag_payStatus
              style:
                display: ..formData.display_payStatus
              children:
                - .PresLabelLeft:
                  text: "Payment Status"
                - .PresLabelRight:
                  text: ""
                  dataKey: apiRequest.hasPaidProfile.getDocResp.doc.0
                  text=func: .builtIn.object.transformStatus
                  style:
                    color: ..formData.payStatus.fontColor
        - type: view
          style:
            marginTop: "0.015"
            height: "0.05"
            backgroundColor: "0xf0f0f0"
            width: "1"
          children:
            - type: label
              text: Medical Info
              style:
                display: "inline-block"
                marginLeft: "0.05"
                color: "0x666666"
                height: "0.05"
                width: "0.48533333"
                lineHeight: 5vh

                fontSize: .Nfont.h14
                fontWeight: "600"
                textAlign:
                  x: left
        - type: view
          style:
            height: "auto"
            width: "0.9"
            marginLeft: "0.05"
          children:
            - type: view
              style:
                marginTop: "0.02"
                height: "0.14"
                width: "0.9"
              children:
                - type: view
                  # onClick:
                  #   - goto: VitalSigns
                  style:
                    # display: "inline-block"
                    # width: "0.26"
                    # marginLeft: "0.03"
                    # height: "0.12"
                    # backgroundColor: "#ffffff"
                    # border:
                    #   style: 3
                    # borderWidth: "1"
                    # borderRadius: "10"
                    # borderColor: "0xdededf"
                    # box-sizing: border-box
                    # boxShadow: "0px 0px 6px 0.5px #DEDEDF"
                    # textAlign:
                    #   x: center

                    # 根据翟成珏要求，不能点击的按钮变灰
                    marginLeft: "0.03"
                    display: "inline-block"
                    width: "0.26"
                    height: "0.12"
                    border:
                      style: 3
                    borderWidth: "1"
                    borderRadius: "10"
                    borderColor: "0xdededf"
                    box-sizing: border-box
                    boxShadow: "0px 0px 6px 0.5px #DEDEDF"
                    textAlign:
                      x: center
                    backgroundColor: "#f4f4f4"
                    pointerEvents: none
                    opacity: 0.6
                  children:
                    - type: image
                      path: remoteHealth.svg
                      style:
                        marginTop: "0.01"
                        height: "0.05"
                    - type: label
                      text: Vital Signs
                      style:
                        marginTop: "0.01"
                        height: "auto"
                        width: "0.26"

                        fontSize: .Nfont.h12
                        color: "0x333333"
                        fontWeight: "600"
                        textAlign:
                          x: center
                - type: view
                  onClick:
                    - goto: PatientChart
                  style:
                    marginLeft: "0.03"
                    display: "inline-block"
                    width: "0.26"
                    height: "0.12"
                    backgroundColor: "0xffffff"
                    border:
                      style: 3
                    borderWidth: "1"
                    borderRadius: "10"
                    borderColor: "0xdededf"
                    box-sizing: border-box
                    boxShadow: "0px 0px 6px 0.5px #DEDEDF"
                    textAlign:
                      x: center
                  children:
                    - type: image
                      path: patientChart.svg
                      style:
                        marginTop: "0.01"
                        height: "0.05"
                    - type: label
                      text: Patient Chart
                      style:
                        marginTop: "0.01"
                        height: "auto"
                        width: "0.26"

                        fontSize: .Nfont.h12
                        color: "0x333333"
                        fontWeight: "600"
                        textAlign:
                          x: center
                - type: view
                  style:
                    marginLeft: "0.03"
                    display: "inline-block"
                    width: "0.26"
                    height: "0.12"
                    border:
                      style: 3
                    borderWidth: "1"
                    borderRadius: "10"
                    borderColor: "0xdededf"
                    box-sizing: border-box
                    boxShadow: "0px 0px 6px 0.5px #DEDEDF"
                    textAlign:
                      x: center
                    backgroundColor: "#f4f4f4"
                    pointerEvents: none
                    opacity: 0.6
                  children:
                    - type: image
                      path: providerNotes.svg
                      style:
                        marginTop: "0.01"
                        height: "0.05"
                    - type: label
                      text: Provider Notes
                      style:
                        marginTop: "0.01"
                        height: "auto"
                        width: "0.26"

                        fontSize: .Nfont.h12
                        color: "0x333333"
                        fontWeight: "600"
                        textAlign:
                          x: center
            - type: view
              style:
                height: "0.14"
                width: "0.9"
              children:
                - type: view
                  onClick:
                    - actionType: evalObject
                      object:
                        - .Global.formData.isRelatedApp@: true
                    - goto: ProviderNotes
                  style:
                    display: "inline-block"
                    width: "0.55"
                    marginLeft: "0.03"
                    height: "0.12"
                    backgroundColor: "0xffffff"
                    border:
                      style: 3
                    borderWidth: "1"
                    borderRadius: "10"
                    borderColor: "0xdededf"
                    box-sizing: border-box
                    boxShadow: "0px 0px 6px 0.5px #DEDEDF"
                  children:
                    - type: view
                      style:
                        marginLeft: "0.03"
                        display: "inline-block"
                        height: "0.12"
                        verticalAlign: middle
                        textAlign:
                          x: center
                      children:
                        - type: image
                          path: medicalRecords.svg
                          style:
                            marginTop: "0.03"
                            height: "0.05"
                    - type: view
                      style:
                        display: "inline-block"
                        height: "0.12"
                        width: "auto"
                        marginLeft: "0.01"
                        verticalAlign: middle
                        overflow: hidden
                      children:
                        - type: label
                          text: "Medical Documents"
                          dataKey:
                          style:
                            marginTop: "0.033251"
                            height: "auto"

                            fontSize: .Nfont.h12
                            color: "0x333333"
                            fontWeight: "600"
                        - type: label
                          text: view all documents here
                          dataKey:
                          style:
                            marginTop: "0.01"
                            height: "auto"

                            fontSize: .Nfont.h12
                            color: "0x666666"

                - type: view
                  style:
                    marginLeft: "0.03"
                    width: "0.26"
                    height: "0.12"
                    backgroundColor: "#f4f4f4"
                    pointerEvents: none
                    opacity: 0.6
                    border:
                      style: 3
                    borderWidth: "1"
                    borderRadius: "10"
                    borderColor: "0xdededf"
                    box-sizing: border-box
                    boxShadow: "0px 0px 6px 0.5px #DEDEDF"
                    display: "inline-block"
                    textAlign:
                      x: "center"
                  # onClick:
                  #   - goto: PaymentReceipt
                  children:
                    - type: image
                      path: paymentYellow.svg
                      style:
                        marginTop: "0.01"
                        width: "0.1"
                        height: "0.05"
                    - type: label
                      text: "Receipt"
                      style:
                        height: "auto"
                        width: "0.26"

                        fontSize: .Nfont.h12
                        color: "0x4b4b4b"
                        textAlign:
                          x: center

        - type: view
          style:
            marginTop: "0.01"
            height: "0.05"
            backgroundColor: "#f0f0f0"
            width: "1"
          children:
            - type: label
              text: Participants
              style:
                display: "inline-block"
                marginLeft: "0.05"
                color: "0x666666"
                height: "0.05"
                width: "0.72266"
                lineHeight: 5vh

                fontSize: .Nfont.h14
                fontWeight: "600"
                textAlign:
                  x: left
            - type: label
              text: + Invite
              dataKey:
              onClick:
                - actionType: evalObject
                  object:
                    - .Global.formData.pageName@: "AppointmentLobby"
                - goto: ChooseInvite
              style:
                display: "inline-block"
                marginLeft: "0.05"
                height: "0.05"
                width: "auto"
                lineHeight: 5vh

                textDecoration: underline
                fontSize: .Nfont.h14
                fontWeight: "400"
                color: "#2988e6"
                textAlign:
                  x: left
        - type: view
          style:
            marginTop: "0.02"
            height: "auto"
            width: "0.9"
            marginLeft: "0.05"
            color: "0x4b4b4b"
          children:
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: Provider
                - .PresLabelRight:
                  dataKey: dataObject.name.providerName
            - .PresListView:
              children:
                - .PresLabelLeft:
                  text: Patient
                - .PresLabelRight:
                  dataKey: apiRequest.patientProfile.docQueryResp.doc.0.name.data.basicInfo.fullName
            - .PresListView:
              style:
                display: ..formData.mainProviderDisplay
              children:
                - .PresLabelLeft:
                  text: Provider
                - .PresLabelRight:
                  dataKey: Global.currentRoomInfo.edge.name.mainProviderName
            - type: list
              contentType: listObject
              listObject: ..formData.participants
              iteratorVar: itemObject
              style:
                display: ..formData.participants_others
                width: "0.9"
                margin: "0"
                marginTop: "0"
                height: "auto"
              children:
                - type: listItem
                  itemObject: ""
                  style:
                    width: "0.9"
                    height: "auto"
                    left: "0"
                    marginTop: "0.01"
                    overflow: hidden
                  children:
                    - .PresLabelLeft:
                      dataKey: itemObject.role
                    - .PresLabelRight:
                      dataKey: itemObject.roleName
