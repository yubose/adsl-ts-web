FinancialResponsibility: #xd page
  title: Financial Responsibility
  init:
    - .SignInCheck
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    - actionType: evalObject
      object:
        - .BaseComponents.calendarDate.year@: ""
        - .BaseComponents.calendarDate.month@: ""
        - .BaseComponents.calendarDate.day@: ""
        - .BaseComponents.calendarDate.monthName@: ""
        - .BaseComponents.calendarDate.todayDate@: ""
        - .BaseComponents.calendarDate.flag@: ""
        - .BaseComponents.calendarDate.dayLable@: []
        - .BaseComponents.year@: []
        - .BaseComponents.flag: ""
        #生成年份
        - =.builtIn.date.generateYear:
            dataIn:
              last: 80
              next: 10
            dataOut: BaseComponents.year
        - =.builtIn.string.phoneNumberSplit:
            dataIn:
              phoneNumber: =.Global.roomInfo.edge.name.fee
              sign: "$"
            dataOut: FinancialResponsibility.formData.splitAmount
        - =.builtIn.math.toFixedNum:
            dataIn:
              num: =..formData.splitAmount.0
            dataOut: FinancialResponsibility.squareCheckout.edge.name.amount
    - actionType: evalObject
      object: .BaseComponents.getDate
    - actionType: evalObject
      object: .BaseComponents.getShow
    - =.builtIn.utils.getUrl:
        dataIn:
        dataOut: FinancialResponsibility.squareCheckout.edge.name.url
    # - =..squareCheckout.edgeAPI.store: ""
    # - actionType: evalObject
    #   object:
    #     - ..website@: =..squareCheckout.response.edge.deat.squareID
    - =..apiRequest.facilityProfile.docAPI.get: ""
    - =..apiRequest.FinancialInfo.docAPI.get: ""
    - if:
      - =..apiRequest.FinancialInfo.docQueryResp.doc.0
      - ..formData.amount@: =..apiRequest.FinancialInfo.docQueryResp.doc.0.name.data.paymentInfo.fee
      - ..formData.amount@: =.Global.roomInfo.edge.name.fee
  formData:
    splitAmount: []
    url: ""
    amount: ""
  apiRequest:
    FinancialInfo:
      docQueryResp: ""
      docQueryReq:
        id: .Global.roomInfo.edge.id
        xfname: reid
        obfname: mtime
        maxcount: "1"
        nonce: =.Global._nonce
        type: .DocType.FinancialInfo
      docAPI:
        get:
          api: rd
          dataIn: FinancialResponsibility.apiRequest.FinancialInfo.docQueryReq
          dataOut: FinancialResponsibility.apiRequest.FinancialInfo.docQueryResp
    # get facility's profile for this appointment
    facilityProfile:
      docQueryResp: ""
      docQueryReq:
        id: .Global.roomInfo.edge.name.facilityId
        xfname: ovid
        type: .DocType.FacilityProfile
        obfname: mtime
        maxcount: "1"
      docAPI:
        get:
          api: rd
          dataIn: FinancialResponsibility.apiRequest.facilityProfile.docQueryReq
          dataOut: FinancialResponsibility.apiRequest.facilityProfile.docQueryResp
  squareCheckout:
    response: ""
    # 所有与预约有关的信息都在Global.roomInfo.edge
    edge:
      .Edge: ""
      type: .EdgeType.SquareCheckout
      bvid: .Global.currentUser.vertex.id
      refid: .Global.roomInfo.edge.id
      evid: .Global.roomInfo.edge.name.facilityId
      name:
        amount: ""
        url: "https://patd3.aitmed.io/index.html?PaymentConfirmation"
        currency: "USD"
        quantity: "1"
        itemName: "Appointment fee"
        note: "for testing"
    edgeAPI:
      .EdgeAPI: ""
      store:
        api: ce
        dataIn: FinancialResponsibility.squareCheckout.edge
        dataOut: FinancialResponsibility.squareCheckout.response
  squareOrder:
    docReq:
      type: .DocType.CheckOrder
      eid: ""
      name:
        data:
          orderInfo: # 订单信息
            squareID: ""
            squareURL: ""
            amount: ""
            # balance: "" in deat
            # status: ""  in deat
            processFee: "" # 手续费
            payer: .Global.Profile.name.data.basicInfo.fullName
          appointmentInfo: # 预约信息/会议信息
            reason: .Global.roomInfo.edge.name.visitReason
            providerName: .Global.roomInfo.edge.name.providerName
            visitType: .Global.roomInfo.edge.name.visitType # appointment type: egg.Telemedicine,Office Visit
            appTime: .Global.roomInfo.edge.stime
        nonce: ""
      subtype:
        isEncrypted: "0"
        isOnServer: "1"
    docRes: ""
    docAPI:
      store:
        api: cd
        dataIn: squareOrder.docReq
        dataOut: FinancialResponsibility.squareOrder.docRes
  website: ""
  components:
    - .BaseHeader:
    - .HeaderLeftBack:
    - type: view
      style:
        top: "0.1"
        left: "0"
        width: "1"
        height: "0.9"
        overflow: scroll
      children:
        - type: label
          text: "The payment below must be paid in full before the appointment can be made"
          style:
            width: "0.9"
            marginLeft: "0.05"
            marginTop: "0.02"
            fontSize: .Nfont.h0_1
        - type: view
          style:
            width: "1"
            height: "0.04"
            marginTop: "0.02"
            backgroundColor: "0xf0f0f0"
            # padding: "1px"
          children:
            - type: label
              text: "Appointment fee"
              style:
                height: "0.04"
                fontWeight: "550"
                color: "0x666666"
                fontFamily: "Arial"
                fontSize: .Nfont.h15
                marginLeft: "0.05"
                # marginTop: "0.01"
                textAlign:
                  y: center
        - type: view
          style:
            width: "0.9"
            height: "0.15"
            marginLeft: "0.05"
            marginTop: "0.015"
            border:
              style: 2
              color: "0xdededf"
            borderWidth: "1px"
          children:
            - type: view
              style:
                marginTop: "0.01"
              children:
                - type: label
                  text: "Payment Date"
                  style:
                    width: "0.4"
                    display: "inline-block"
                    fontSize: .Nfont.h14
                    color: "0x333333"
                - type: label
                  dataKey: BaseComponents.calendarDate.todayDate
                  style:
                    width: "0.5"
                    display: "inline-block"
                    fontSize: .Nfont.h14
                    color: "0x666666"
                    fontWeight: "500"
                    textAlign:
                      x: right
            - type: view
              style:
                marginTop: "0.01"
              children:
                - type: label
                  text: "Appointment Type"
                  style:
                    width: "0.4"
                    display: "inline-block"
                    fontSize: .Nfont.h14
                    color: "0x333333"
                - type: label
                  text: "Telemedicine"
                  dataKey: Global.roomInfo.edge.name.visitType
                  style:
                    width: "0.5"
                    display: "inline-block"
                    fontSize: .Nfont.h14
                    color: "0x666666"
                    fontWeight: "500"
                    textAlign:
                      x: right
            - type: view
              style:
                marginTop: "0.01"
              children:
                - type: label
                  text: "Reason for payment"
                  style:
                    width: "0.4"
                    display: "inline-block"
                    fontSize: .Nfont.h14
                    color: "0x333333"
                - type: label
                  text: "Visit fee"
                  dataKey: Global.roomInfo.edge.name.Reason
                  style:
                    width: "0.5"
                    display: "inline-block"
                    fontSize: .Nfont.h14
                    color: "0x666666"
                    fontWeight: "500"
                    textAlign:
                      x: right
            - type: view
              style:
                marginTop: "0.01"
              children:
                - type: label
                  text: "Payment Due"
                  style:
                    width: "0.4"
                    display: "inline-block"
                    fontSize: .Nfont.h14
                    color: "0x333333"
                - type: label
                  text: ""
                  text=func: .builtIn.string.dollarFormat
                  dataKey: formData.amount
                  style:
                    width: "0.5"
                    display: "inline-block"
                    fontSize: .Nfont.h14
                    color: "0x666666"
                    fontWeight: "500"
                    textAlign:
                      x: right
        - type: view
          style:
            width: "0.9"
            marginLeft: "0.05"
            marginTop: "0.02"
          children:
            - type: label
              text: "Total Payment"
              style:
                width: "0.4"
                display: "inline-block"
                fontSize: .Nfont.h14
                fontWeight: "bold"
                color: "0x2988e6"
            - type: label
              text: ""
              text=func: .builtIn.string.dollarFormat
              dataKey: formData.amount
              style:
                width: "0.5"
                display: "inline-block"
                fontSize: .Nfont.h14
                fontWeight: "bold"
                color: "0x2988e6"
                textAlign:
                  x: right
        - type: view
          style:
            width: "0.9"
            marginLeft: "0.05"
            marginTop: "0.05"
          children:
            - type: label
              text: "Patients with medical coverage"
              style:
                fontSize: .Nfont.h12
                color: "0x333333"
                fontWeight: "600"
            - type: label
              text: "You may request for a billing statement after your visit and submit a reimbursement request through your insurance company."
              style:
                width: "0.93"
                fontSize: .Nfont.h0_1
                color: "0x666666"
                wordBreak: break-word
            - type: view
              style:
                width: "0.9"
                height: "auto"
                marginTop: "0.01"
              children:
                - type: label
                  textBoard:
                    - text: "Refunds may be requested to&nbsp;"
                      color: "0x666666"
                    - dataKey: apiRequest.facilityProfile.docQueryResp.doc.0.name.data.basicInfo.medicalFacilityName
                      color: "0x666666"
                      fontWeight: "700"
                      textDecoration: underline
                    - text: ", please contact them directly at&nbsp;"
                      color: "0x666666"
                    - dataKey: apiRequest.facilityProfile.docQueryResp.doc.0.name.data.basicInfo.phoneNumber
                      color: "0x666666"
                      textDecoration: underline
                      fontWeight: "700"
                    - text: "."
                      color: "0x666666"
                  style:
                    width: "0.9"
                    height: "auto"
                    fontSize: .Nfont.h0_1
