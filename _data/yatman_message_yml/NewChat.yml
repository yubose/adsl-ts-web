NewChat:
  init:
    - .SignInCheck
    - if:
        - =.MessageObjStore.newChatInfo.rootChat
        - actionType: evalObject
          object:
            - ..contacts.get.id@: =.MessageObjStore.newChatInfo.rootChat.id
            - =..contacts.get: ''
        - continue
    - if:
        - =.MessageObjStore.newChatInfo.bufferChat
        - actionType: evalObject
          object:
            =.builtIn.array.add: # add the bufferChat into list to display
              dataIn:
                object: =..contacts.response.edge
                value: =.MessageObjStore.newChatInfo.bufferChat
        - continue

  # data =======================================================================

  contacts:
    response:
      edge: []
    get:
      .EdgeAPI.get: ''
      id: '' # rootChat.id , updated by createGroupChatRootEdge
      type: 1091
      xfname: refid | id # root group chat edge_id.
      maxcount: '20'
      obfname: 'mtime'
      dataOut: contacts.response

  inviteToChat:
    response: ''
    edge:
      id: ''
      type: 1091
      refid: ''
      name:
        phoneNumber: ''
        firstName: ''
        lastName: ''
        fullName: ''
        InviterName: .Global.currentUser.vertex.name.userName
      subtype: 1 # 0 for 1 to 1 chat ,  1 for group chat
    edgeAPI:
      .EdgeAPI: ''
      store:
        api: ce
        dataIn: inviteToChat.edge
        dataOut: inviteToChat.response

  # UI ===========================================
  components:
    - .BaseCheckView: ''
      message: 'Invite someone first to chat'
      viewTag: noChatInvited
    - type: view
      style:
        left: '0'
        top: '0'
        width: '1'
        height: '1'
      children:
        - type: view
          style:
            left: '0'
            top: '0'
            width: '1'
            height: '0.08'
            backgroundColor: '0x388eccff'
          children:
            - type: view
              style:
                left: '0.0582'
                top: '0.01'
                width: '0.18667'
                height: '0.05'
              onClick:
                - actionType: pageJump
                  destination: ChatList
              children:
                - type: image
                  path: backWhiteArrow.png
                  style:
                    left: '0'
                    top: '0.01'
                    width: '0.053333'
                    height: '0.03'
                    color: '0xffffffff'
                    backgroundColor: '0x388eccff'
                - type: label
                  text: Back # =..backLabel ## replace local variable
                  style:
                    left: '0.0667'
                    top: '0.0'
                    width: '0.12'
                    height: '0.05'
                    fontSize: '18'
                    color: '0xffffffff'
                    backgroundColor: '0x388eccff'
            - type: label
              text: NewChat
              style:
                left: '0.25'
                top: '0.02'
                width: '0.5'
                height: '0.03405'
                fontSize: '18'
                display: inline
                color: '0xffffffff'
                backgroundColor: '0x388eccff'
                textAlign:
                  x: center
                  y: center

        - type: button
          text: Add Member
          style:
            color: '0xffffffff'
            fontSize: '16'
            fontStyle: bold
            left: '0.1'
            top: '0.15'
            width: '0.35'
            height: '0.06'
            backgroundColor: '0x388eccff'
            border:
              style: '1'
            display: inline
            textAlign:
              x: center
              y: center
          onClick:
            # first time clicked, we don't know if this is 1 to 1 or group chat, so save to buffer
            # if second time clicked (there is already a buffer), user want to create group chat
            # any other time, user want to invite people into the group
            - actionType: evalObject
              object:
                - if:
                    - =.MessageObjStore.newChatInfo.bufferChat
                    - actionType: evalObject # have a buffer, user want to create a group chat
                      object:
                        # create a 1091 edge from buffer, becomes rootEdge
                        - ..inviteToChat.edge@: =.MessageObjStore.newChatInfo.bufferChat
                        - ..inviteToChat.edge.subtype@: 1
                        - =..inviteToChat.edgeAPI.store: ''
                        - .MessageObjStore.newChatInfo.rootChat@: =..inviteToChat.response.edge
                        - .MessageObjStore.newChatInfo.bufferChat@: '' # clean buffer
                    - continue
            - goto: ChatInviteeInfo

        - type: button
          text: Start Chat
          style:
            color: '0xffffffff'
            fontSize: '16'
            fontStyle: bold
            left: '0.5'
            top: '0.15'
            width: '0.35'
            height: '0.06'
            backgroundColor: '0x388eccff'
            border:
              style: '1'
            display: inline
            textAlign:
              x: center
              y: center
          onClick:
            - actionType: evalObject
              object:
                - if:
                    - =.MessageObjStore.newChatInfo.bufferChat
                    - actionType: evalObject # just have a bufferChat, user want 1 to 1
                      object:
                        - ..inviteToChat.edge@: =.MessageObjStore.newChatInfo.bufferChat
                        - ..inviteToChat.edge.subtype@: 0
                        - =..inviteToChat.edgeAPI.store: ''
                        - .MessageObjStore.currentChatEdge@: =..inviteToChat.response.edge
                    - .MessageObjStore.currentChatEdge@: =.MessageObjStore.newChatInfo.rootChat # group chat, all edges are created
            - actionType: evalObject
              object:
                - if:
                    - =.MessageObjStore.currentChatEdge
                    - actionType: evalObject
                      object:
                        - .MessageObjStore.newChatInfo.rootChat@: ''
                        - .MessageObjStore.newChatInfo.bufferChat@: ''
                    - actionType: popUp
                      popUpView: noChatInvited
                - if:
                    - true
                    - goto: ChatPage
                    - continue

        - type: list
          contentType: listObject
          listObject: ..contacts.response.edge
          iteratorVar: itemObject
          style:
            left: '0'
            top: '0.25'
            width: '1'
            height: '0.72'
          #for loop through listObject, we got each itemObject
          children:
            - type: listItem
              itemObject: ''
              style:
                left: '0'
                top: '0'
                width: '1'
                height: '0.15'
                border:
                  style: '2'
                borderWidth: '1'
                borderColor: '0x00000011'
              children:
                - type: label
                  dataKey: itemObject.name.InviteePhoneNumber
                  style:
                    left: '0.25'
                    top: '0.06'
                    width: '0.74'
                    height: '0.03'
                    fontSize: '18'
                    color: '0x000000ff'
