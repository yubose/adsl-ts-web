ChatPage:
  init:
    - if:
        - .builtIn.SignInOk
        - continue
        - goto: SignIn
    - =..messages.get
    - =..input.inviteePhone@: ""
    - =..input.inviteeName@: ""
  chatEdge: ""
  attachInvitedDocEdgeId: ""
  senderInfo:
    senderId: .Global.currentUser.vertex.id
    senderName: .Global.currentUser.vertex.name.userName
    senderAvatar: no avatar
  input:
    inviteePhone: ""
    inviteeName: ""
    messageContent: ""
    fileData: ""
  firstMsg: ""
  lastMsg: ""
  messages:
    respond: ""
    get:
      id: ..chatEdge.refid
      api: rd
      xfname: E.refid
      obfname: D.ctime
      objType: 4
      maxcount: 50
      dataOut: messages.respond
  newMessages:
    respond: ""
    get:
      ..messages.get: ""
      dataOut: newMessages.respond
      sCondition:
        .builtIn.string.concat:
          - ctime>
          - =..firstMsg.ctime
  moreOldMessages:
    respond: ""
    get:
      ..messages: ""
      loid: ..lastMsg.id
      dataOut: moreOlderMessages.respond
  onNewMessageReceived:
    - evolve: newMessages
    - =..newMessages.get
    - =.builtIn.array.push:
        dataIn:
          object: =.ChatPage.newMessages.respond.doc
        dataOut:
          object: =.ChatPage.messages.respond.doc
    - =.firstMsg@: =.ChatPage.messages.respond.doc.0
  onPullMoreMessage:
    - evolve: moreOldMessage.get
    - =..moreOlderMessages.get
    - =.builtIn.array.append:
        dataIn:
          object: =.ChatPage.moreOldMessages.respond.doc
        dataOut:
          object: =.ChatPage.messages.respond.doc
    - =..lastMsg@:=.ChatPage.messages.respond.doc.$
  onSendMessageClicked:
    - .CreateDocInChat.fun_createMessageDoc.parameter.eid@: =..chatEdge.id
    - .CreateDocInChat.fun_createMessageDoc.parameter.data.text@: =..input.messageContent
    - .CreateDocInChat.fun_createMessageDoc.parameter.data.senderName@: =..senderInfo.senderName
    - =.CreateDocInChat.fun_createMessageDoc.execute
    - ..input.messageContent@: ""
    - =..messages.get
  onUploadClicked:
    - .CreateDocInChat.fun_createFileDoc.parameter.eid@: =..chatEdge.id
    - .CreateDocInChat.fun_createFileDoc.parameter.name.data.fileContent@: =..input.fileData
    - .CreateDocInChat.fun_createFileDoc.parameter.name.data.senderName@: =..senderInfo.senderName
    - =.CreateDocInChat.fun_createFileDoc.execute
    - ..input.fileData@: ""
  attachInviteDocToGroupRootChat:
    - .CreateDocInChat.fun_createInviteDoc.parameter.eid@: =..attachInvitedDocEdgeId
    - .CreateDocInChat.fun_createInviteDoc.parameter.data.inviteeName@: =..input.inviteeName
    - .CreateDocInChat.fun_createInviteDoc.parameter.data.inviteePhoneNumber@: =..input.inviteePhone
    - .CreateDocInChat.fun_createInviteDoc.parameter.data.senderName@: =..senderInfo.senderName
    - =.CreateDocInChat.fun_createInviteDoc.execute
    - =..messages.get
  onAddMemberClicked:
    - if:
        - =..chatEdge.subType
        - trueCase:
            - .CreateChatRelation.fun_createGroupChatInviteEdge.parameter.name.InviteePhoneNumber@: =..input.inviteePhone
            - .CreateChatRelation.fun_createGroupChatInviteEdge.parameter.refid@: =..chatEdge.refid
            - =.CreateChatRelation.fun_createGroupChatInviteEdge.execute
            - ..attachInvitedDocEdgeId@: =..chatEdge.id
        - falseCase:
            - .CreateChatRelation.fun_createGroupChatRootEdge.parameter.name@: =..chatEdge.name
            - =.CreateChatRelation.fun_createGroupChatRootEdge.execute
            - .CreateChatRelation.fun_createGroupChatInviteEdge.parameter.name.InviteePhoneNumber@: =..input.inviteePhone
            - .CreateChatRelation.fun_createGroupChatInviteEdge.parameter.refid@: =.CreateChatRelation.createChatEdge.edge.id
            - =.CreateChatRelation.fun_createGroupChatInviteEdge.execute
            - ..attachInvitedDocEdgeId@: =.CreateChatRelation.createChatEdge.edge.id
    - =..attachInviteDocToGroupRootChat
    - =..input.inviteePhone@: ""
    - =..input.inviteeName@: ""
  components:
    - type: register
      onEvent: onFCMReceived
      actions:
        - =..onNewMessageReceived
    - type: register
      onEvent: onPullDown
      actions:
        - ? =..onPullMoreMessage
    - type: view
      style:
        left: "0"
        top: "0"
        width: "1"
        height: "1"
      children:
        - type: view
          style:
            left: "0"
            top: "0"
            width: "1"
            height: "0.08"
            backgroundColor: "0x388eccff"
          children:
            - type: view
              style:
                left: "0.0582"
                top: "0.01"
                width: "0.18667"
                height: "0.05"
              onClick:
                - actionType: pageJump
                  destination: ChatList
              children:
                - type: image
                  path: ~/assets/backWhiteArrow.png
                  style:
                    left: "0"
                    top: "0.01"
                    width: "0.053333"
                    height: "0.03"
                    color: "0xffffffff"
                    backgroundColor: "0x388eccff"
                - type: label
                  text: Back
                  style:
                    left: "0.0667"
                    top: "0.0"
                    width: "0.12"
                    height: "0.05"
                    fontSize: "18"
                    color: "0xffffffff"
                    backgroundColor: "0x388eccff"
            - type: label
              text: ChatPage
              style:
                left: "0.25"
                top: "0.02"
                width: "0.5"
                height: "0.03405"
                fontSize: "18"
                display: inline
                color: "0xffffffff"
                backgroundColor: "0x388eccff"
                textAlign:
                  x: center
                  y: center
            - type: label
              text: Add a member
              style:
                left: "0.78"
                top: "0.02"
                width: "0.12"
                height: "0.03405"
                fontSize: "20"
                display: inline
                color: "0xffffffff"
                backgroundColor: "0x388eccff"
                textAlign:
                  x: center
                  y: center
              onClick:
                - actionType: popUp
                  popUpView: addMemberPopUp
        - type: chatList
          contentType: listObject
          listObject: ..messages.respond.doc
          iteratorVar: itemObject
          style:
            left: "0"
            top: "0.08"
            width: "1"
            height: "0.72"
          chatItem:
            style:
              left: "0"
              top: "0"
              width: "1"
              height: "0.15"
              border:
                style: "2"
              borderWidth: "1"
              borderColor: "0x00000011"
        - type: textField
          contentType: text
          placeholder: Write here
          dataKey: input.messageContent
          style:
            textAlign:
              x: left
            fontSize: "14"
            left: "0.1"
            top: "0.8"
            width: "0.8"
            height: "0.08"
            borderWidth: "1"
            border:
              style: "2"
        - type: button
          text: Upload
          contentType: file
          onClick:
            - actionType: updateObject
              dataObject: BLOB
              dataKey: input.fileData
            - =..onUploadClicked
          style:
            color: "0xffffffff"
            fontSize: "16"
            fontStyle: bold
            left: "0.8"
            top: "0.8"
            width: "0.15"
            height: "0.07"
            backgroundColor: "0x388eccff"
            border:
              style: "1"
            display: inline
            textAlign:
              x: center
              y: center
        - type: button
          text: Send
          style:
            color: "0xffffffff"
            fontSize: "16"
            fontStyle: bold
            left: "0.1"
            top: "0.9"
            width: "0.25"
            height: "0.07"
            backgroundColor: "0x388eccff"
            border:
              style: "1"
            display: inline
            textAlign:
              x: center
              y: center
          onClick:
            - =..onSendMessageClicked
    - type: popUp
      viewTag: addMemberPopUp
      style:
        left: "0"
        top: "0"
        width: "1"
        height: "1"
        backgroundColor: "0x00000066"
      children:
        - type: view
          style:
            left: "0.05"
            top: "0.2"
            width: "0.89333"
            height: "0.45"
            backgroundColor: "0xeeeeeeff"
            border:
              style: "5"
            borderRadius: "15"
          children:
            - type: label
              text: Create a group chat
              style:
                color: "0x000000ff"
                left: "0.1"
                top: "0.04"
                width: "0.7"
                height: "0.04"
                fontSize: "20"
                fontStyle: bold
            - type: textField
              contentType: phoneNumber
              placeholder: InviteePhoneNumber
              dataKey: input.inviteePhone
              style:
                textAlign:
                  x: left
                fontSize: "14"
                left: "0.1"
                top: "0.1"
                width: "0.6"
                height: "0.04"
                required: "true"
                borderWidth: "1"
                border:
                  style: "2"
            - type: textField
              contentType: text
              placeholder: Invitee Name
              dataKey: input.inviteeName
              style:
                textAlign:
                  x: left
                fontSize: "14"
                left: "0.1"
                top: "0.16"
                width: "0.6"
                height: "0.04"
                required: "true"
                borderWidth: "1"
                border:
                  style: "2"
            - type: button
              text: Add Member
              style:
                color: "0xffffffff"
                fontSize: "16"
                fontStyle: bold
                left: "0.1"
                top: "0.25"
                width: "0.35"
                height: "0.06"
                backgroundColor: "0x388eccff"
                border:
                  style: "1"
                display: inline
                textAlign:
                  x: center
                  y: center
              onClick:
                - =..onAddMemberClicked
                - actionType: popUpDismiss
                  popUpView: addMemberPopUp
            - type: divider
              style:
                .DividerStyle:
                  left: "0"
                  top: "0.35"
                  width: "0.89333"
                  backgroundColor: "0x00000088"
            - type: button
              onClick:
                - actionType: popUpDismiss
                  popUpView: addMemberPopUp
              text: Close
              style:
                .LabelStyle:
                  left: "0"
                  top: "0.36"
                  width: "0.89333"
                  height: "0.06812"
                  color: "0x000000ff"
                  fontSize: "17"
                  display: inline
                  textAlign:
                    x: center
                    y: center
                  border:
                    style: "5"
                  borderRadius: "15"
