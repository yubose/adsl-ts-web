ChooseProviders:
  init:
    - .SignInCheck
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    # 获取当前facility下面的providers
    - ..providers.docAPI.get
    # 筛除重复的provider
    - =.builtIn.array.keepLatestDoc:
        dataIn:
          docList: =..providers.docRes.doc
          path: bsig
        dataOut: ChooseProviders.formData.providers
    # 获取当前facility所对应的location列表
    - =..apiRequest.location.vertexAPI.get: ""
    # 将location列表的id抽取出来
    - =.builtIn.object.extract:
        dataIn:
          array: =..apiRequest.location.vertexQueryResp.vertex
          field: id
        dataOut: ChooseProviders.formData.locations
    # 获取所有location下的所有room
    - ..apiRequest.roomProfile.docQueryReq.ids@: =..formData.locations
    - =..apiRequest.roomProfile.docAPI.get: ""
    - =.builtIn.array.getOrReplaceAnArrayItem:
        dataIn:
          strArr: =.Global.formData.currentTabStatusList
          tag: false
        dataOut: ChooseProviders.formData.currentTab

    - if:
        - =.builtIn.array.judgeListLength:
            dataIn:
              array: =.Global.formData.currentTabStatusList
              len: 2
        - actionType: evalObject
          object:
            - =.builtIn.object.setProperty:
                dataIn:
                  obj: =..formDataTemp.tabData
                  label: "title"
                  text: =..formData.currentTab
                  arr: ["fontColor", "fontWeight", "block"]
                  valueArr: ["0x2988e6", "500", "block"]
                  errorArr: ["0x4b4b4b", "400", "none"]
                dataOut: ChooseProviders.formDataTemp.tabData
            - ..formData.roomBlock@: =..formDataTemp.tabData.1.block
            - ..formData.providerBlock@: =..formDataTemp.tabData.0.block
        - continue

    # 判断title状态
    - actionType: evalObject
      object:
        - if:
            - =.builtIn.string.equal:
                dataIn:
                  string1: =.Global.formData.currentTabStatusList.1
                  string2: "Service Room"
            - ..formData.title@: "Choose Service Room"
            - ..formData.title@: "Choose Providers"
  formData:
    currentTab: []
    locations: []
    providers: []
    rooms: []
    serviceRoom: []
    title: "Choose Providers"
    tempData: ""
    providerBlock: block
    roomBlock: none
  formDataTemp:
    tabData:
      - tab: Providers
        title: Choose Providers
        fontColor: "0x2988e6"
        fontWeight: "600"
        block: "block"
      - tab: Service Room
        title: Choose Service Room
        fontColor: "0x4b4b4b"
        fontWeight: "400"
        block: "none"
  providers: # 包括所有的facility和location
    docReq:
      ObjType: 12
      type: .DocType.DoctorPublicProfile
      id: .Global.currentFacility.bsig
      xfname: E.bvid|E.evid
      sCondition: E.type=10002 AND E.tage=1 AND E.subtype&0xf0000=0x30000
      maxcount: "100"
      obfname: mtime
      _nonce: =.Global._nonce
    docRes: ""
    docAPI:
      get:
        api: rd
        dataIn: ChooseProviders.providers.docReq
        dataOut: ChooseProviders.providers.docRes
  apiRequest:
    location:
      vertexQueryResp: ""
      vertexQueryReq:
        ObjType: 4
        id: .Global.currentFacility.bsig
        type: .VertexType.Location
        xfname: E.bvid
        sCondition: E.type=1100
      vertexAPI:
        get:
          api: rv
          dataIn: ChooseProviders.apiRequest.location.vertexQueryReq
          dataOut: ChooseProviders.apiRequest.location.vertexQueryResp
    roomProfile:
      docQueryResp: ""
      docQueryReq:
        ObjType: 28
        type: .DocType.RoomProfile
        ids: ""
        xfname: Bvid
        sfname: '{"join":"INNER JOIN Vertex V ON D.ovid=V.id INNER JOIN Edge E ON E.evid=V.id","result":"D.*"}'
        sCondition: E.type=1100 AND V.type=30
      docAPI:
        get:
          api: rd
          dataIn: ChooseProviders.apiRequest.roomProfile.docQueryReq
          dataOut: ChooseProviders.apiRequest.roomProfile.docQueryResp
    locationProfile:
      docQueryResp: ""
      docQueryReq:
        ObjType: 12
        id: ""
        xfname: E.evid
        sCondition: E.type=1100 AND D.ovid=E.bvid
        obfname: mtime
        maxcount: "1"
      docAPI:
        get:
          api: rd
          dataIn: ChooseProviders.apiRequest.locationProfile.docQueryReq
          dataOut: ChooseProviders.apiRequest.locationProfile.docQueryResp
  components:
    - .BasePublicHeader:
      children:
        - .BasePublicHeaderLeft:
          leftClick:
            - actionType: evalObject
              object:
                - =.builtIn.array.getOrReplaceAnArrayItem:
                    dataIn:
                      strArr: =.Global.formData.currentTabStatusList
                      tag: true
                      index: 1
                    dataOut: Global.formData.currentTabStatusList
            - actionType: builtIn
              funcName: goBack
              reload: true
        - type: label
          dataKey: formData.title
          viewTag: titleTag
          style:
            marginLeft: "0.0826"
            display: "inline-block"
            verticalAlign: middle
            height: "auto"
            width: "0.626"
            wordWrap: break-word

            fontSize: .Nfont.h16
            fontWeight: "400"
            color: "0xffffff"
            textAlign:
              x: center

    - type: view
      style:
        ..style.searchBox:
      children:
        - type: view
          style:
            ..style.search:
          onClick:
            - goto: SearchProvider
          children:
            - type: image
              path: search.svg
              style:
                ..style.searchImg:
            - type: textField
              placeholder: Search
              dataKey:
              style:
                ..style.searchInput:
              onClick:
                - goto: SearchProvider
    - type: list
      viewTag: tabTag
      contentType: listObject
      listObject: ..formDataTemp.tabData
      iteratorVar: itemObject
      style:
        ..style.tabList:
      children:
        - type: listItem
          itemObject:
          style:
            ..style.tabListItem:
          children:
            - type: label
              dataKey: itemObject.tab
              style:
                ..style.tab:
            - type: view
              style:
                ..style.emptyBox:
            - type: view
              viewTag: leftBlockTag
              style:
                ..style.tabBar:
          onClick:
            - ..event.tabClick

    # Providers
    - type: view
      viewTag: providersTag
      style:
        width: "1"
        height: "auto"
        marginTop: "0"
        display: ..formData.providerBlock
      children:
        - type: list
          contentType: listObject
          listObject: ..formData.providers
          iteratorVar: itemObject
          style:
            ..style.DataList:
          children:
            - type: listItem
              itemObject: ""
              style:
                ..style.DataItem:
              onClick:
                - ..event.providerItem
              children:
                - type: view
                  style:
                    ..style.DataBox:
                  children:
                    - type: image
                      path: ava.png
                      path=func: .builtIn.utils.prepareDocToPath
                      dataKey: itemObject.name.data.avatar
                      style:
                        ..style.listImg:
                    - type: view
                      style:
                        ..style.listValueBox:
                      children:
                        - type: label
                          textBoard:
                            - text: ""
                              dataKey: itemObject.name.data.fullName
                            - text: "&nbsp;-&nbsp;"
                            - text: ""
                              dataKey: itemObject.name.data.title
                          dataKey:
                          style:
                            ..style.listValue:
                        - type: label
                          dataKey: itemObject.name.data.selectedSpecialty.0
                          style:
                            ..style.listSpecialty:
                - type: view
                  style:
                    marginTop: "0.0198"

    # Service Room
    - type: view
      viewTag: roomTag
      style:
        width: "1"
        height: "auto"
        marginTop: "0"
        display: ..formData.roomBlock
      children:
        - type: list
          contentType: listObject
          listObject: ..apiRequest.roomProfile.docQueryResp.doc
          iteratorVar: itemObject
          style:
            ..style.DataList:
          children:
            - type: listItem
              itemObject: ""
              style:
                ..style.DataItem:
              onClick:
                - ..event.roomClick
              children:
                - type: view
                  style:
                    ..style.DataBox:
                  children:
                    - type: image
                      path: roomLogo.svg
                      style:
                        ..style.listImg:
                    - type: view
                      style:
                        ..style.listValueBox:
                      children:
                        - type: label
                          dataKey: itemObject.name.data.service
                          style:
                            ..style.listValue:
                        - type: label
                          dataKey: itemObject.name.data.roomName
                          style:
                            ..style.listSpecialty:
                - type: view
                  style:
                    marginTop: "0.0198"
  event:
    tabClick:
      - emit:
          dataKey:
            var: itemObject
          actions:
            - ..formData.tempData@: $var.tab
            - ..formData.title@: $var.title
            - =.builtIn.object.setProperty:
                dataIn:
                  obj: =..formDataTemp.tabData
                  label: "tab"
                  text: $var.tab
                  arr: ["fontColor", "fontWeight", "block"]
                  valueArr: ["0x2988e6", "600", "block"]
                  errorArr: ["0x4b4b4b", "400", "none"]
            - ..formData.roomBlock@: =..formDataTemp.tabData.1.block
            - ..formData.providerBlock@: =..formDataTemp.tabData.0.block
            - =.builtIn.array.getOrReplaceAnArrayItem:
                dataIn:
                  strArr: =.Global.formData.currentTabStatusList
                  tag: true
                  index: 1
                  value: $var.title
                dataOut: Global.formData.currentTabStatusList
      - actionType: builtIn
        funcName: redraw
        viewTag: tabTag
      - actionType: builtIn
        funcName: redraw
        viewTag: titleTag
      - actionType: builtIn
        funcName: redraw
        viewTag: providersTag
      - actionType: builtIn
        funcName: redraw
        viewTag: roomTag
      - actionType: builtIn
        funcName: redraw
        viewTag: showVT
    providerItem:
      - emit:
          dataKey:
            var: itemObject
          actions:
            - ..providerId@: $var.bsig
      - actionType: updateObject
        dataKey: Global.ActiveProvider
        dataObject: itemObject
      - goto: MobileContacts3
    roomClick:
      - emit:
          dataKey:
            var: itemObject
          actions:
            # 存放room的profile信息
            - .Global.formData.activeRoom@: $var
            # 存放room对应的location信息
            - ..apiRequest.locationProfile.docQueryReq.id@: $var.bsig
            - =..apiRequest.locationProfile.docAPI.get: ""
            - .Global.ActiveLocation@: =..apiRequest.locationProfile.docQueryResp.doc.0
      - goto: MobileContacts2
  style:
    searchBox:
      width: "1"
      height: "0.06"
      backgroundColor: "0x2988e6"
      overflow: hidden
    search:
      marginTop: "0.0123"
      marginLeft: "0.05"
      width: "0.9"
      height: "0.04"
      backgroundColor: "0xffffff"
      borderRadius: "8"
      boxSizing: "border-box"
      overflow: hidden
    searchImg:
      marginLeft: "0.02"
      display: "inline-block"
      height: "0.025"
      verticalAlign: middle
    searchInput:
      marginLeft: "0.02"
      verticalAlign: middle
      display: "inline-block"
      border:
        style: 1
      height: "0.04"
      boxSizing: "border-box"
      width: "0.8"
    tabList:
      width: "1"
      margin: "0"
      axis: horizontal
      height: "auto"
      overflow: hidden
      marginTop: "0.02"
    tabListItem:
      width: "0.5"
      height: "auto"
    tab:
      color: itemObject.fontColor
      height: "auto"
      width: "0.5"
      fontWeight: itemObject.fontWeight
      textAlign:
        x: center
      fontSize: .Nfont.h16
    emptyBox:
      marginTop: "0.005"
      height: "0.0025"
      width: "0.5"
      backgroundColor: "0xdededf"
    tabBar:
      display: itemObject.block
      top: "0.031"
      left: "0.2"
      width: "0.08"
      height: "0.0025"
      backgroundColor: "0x2988e6"
      zIndex: 10
    DataList:
      width: "1"
      height: "0.8226"
      overflow: scroll
    DataItem:
      width: "1"
      height: "auto"
      margin: "0"
      border:
        style: "2"
      borderWidth: "1"
      borderColor: "0xdededf"
      overflow: hidden
    DataBox:
      marginTop: "0.0198" #16.08px
      marginLeft: "0.0427" #16.01px
      height: "auto"
      width: "0.91"
    listImg:
      verticalAlign: middle
      display: "inline-block"
      height: "0.0554"
      width: "0.12"
    listValueBox:
      verticalAlign: middle
      marginLeft: "0.064"
      display: "inline-block"
      height: "auto"
      width: "0.71"
      overflow: hidden
    listValue:
      width: "0.71"
      height: "auto"

      wordWrap: break-word
      fontSize: .Nfont.h16
      fontWeight: "600"
      color: "#333333"
    listSpecialty:
      marginTop: "0.005"
      width: "0.71"
      height: "auto"
      fontSize: .Nfont.h14
      color: "#333333"

      verticalAlign: middle
      wordWrap: break-word
