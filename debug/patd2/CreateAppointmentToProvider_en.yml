CreateAppointmentToProvider:
  title: "Create Appointment"
  init:
    - .SignInCheck
    - actionType: evalObject
      object:
        .Global._nonce@:
          =.builtIn.math.random: ""
    # 获取预约原因对应的文档数量
    - =.builtIn.array.getListLength:
        dataIn:
          object: =.Global.formData.appointment.docu
        dataOut: CreateAppointmentToProvider.formDataTemp.localDocuLength
    # 获取已经填完的文档数量
    - =.builtIn.array.getListLength:
        dataIn:
          object: =.Global.vaccine
        dataOut: CreateAppointmentToProvider.formDataTemp.globalDocuLength
    # 设置预约类别，是面向provider还是room
    - .Global.formData.selectCategory@: CreateAppointmentToProvider
    # 进行页面编辑状态转换
    - =.builtIn.array.transformArray:
        dataIn:
          array: =.Global.formData.appointment.docu
        dataOut: CreateAppointmentToProvider.formData.formList
    # 获取转换后的文档列表
    - =.builtIn.array.transformPage:
        dataIn:
          array: =..formData.formList
          type: "Edit"
          dataKey: "key"
        dataOut: CreateAppointmentToProvider.formData.docList
    # 拼接展示信息
    - =.builtIn.string.concat:
        dataIn:
          - =.Global.ActiveProvider.name.data.fullName
          - " - "
          - =.Global.ActiveProvider.name.data.specialty.0.specialty
        dataOut: CreateAppointmentToProvider.apiRequest.appointment.edgeCreateReq.name.providerFullInfo
    #judge the appointment subtype
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.formData.appointment.visitType
              string2: Telemedicine
        - actionType: evalObject
          object:
            # 根据不同的waiting room type类型来给E2的subtype赋值
            - =.builtIn.array.getValueByKey:
                dataIn:
                  array: =.AppointmentType
                  key1: text
                  value: =.Global.formData.appointment.visitType
                  key2: type
                dataOut: CreateAppointmentToProvider.apiRequest.appointment.edgeCreateReq.subtype
            - =.builtIn.math.add:
                dataIn:
                  num1: =..apiRequest.appointment.edgeCreateReq.subtype
                  num2: 2
                dataOut: CreateAppointmentToProvider.apiRequest.appointment.edgeCreateReq.subtype
            # 当类型为telemedicine，把facility name赋值给机构名字
            - ..formData.facilityName@: =.Global.currentFacility.name.data.basicInfo.medicalFacilityName
            # 当类型为telemedicine，把facility location赋值给地址
            - ..formData.location@: =.Global.currentFacility.name.data.basicInfo.location
        - continue
    - if:
        - =.builtIn.string.equal:
            dataIn:
              string1: =.Global.formData.appointment.visitType
              string2: Office Visit
        - actionType: evalObject
          object:
            - ..apiRequest.appointment.edgeCreateReq.name.data.fontColor@: "0xff8c00"
            # 当类型为office visit，把location地址赋值给地址
            - ..formData.location@: =.Global.ActiveLocation.name.data.basicInfo.location
            # 当类型为office visit，把location name赋值给机构名字
            - ..formData.facilityName@: =.Global.ActiveLocation.name.data.basicInfo.medicalFacilityName
            # 展示 location控件
            - ..formData.locationDisplay@: "block"
            - ..formData.tempHeight@: "0.38"
            # 根据不同的waiting room type类型来给E2的subtype赋值
            - =.builtIn.array.getValueByKey:
                dataIn:
                  array: =.AppointmentType
                  key1: text
                  value: =.Global.formData.appointment.visitType
                  key2: type
                dataOut: CreateAppointmentToProvider.apiRequest.appointment.edgeCreateReq.subtype
            - =.builtIn.math.add:
                dataIn:
                  num1: =..apiRequest.appointment.edgeCreateReq.subtype
                  num2: 2
                dataOut: CreateAppointmentToProvider.apiRequest.appointment.edgeCreateReq.subtype
        - continue
    # 表示进入patient chart后是本地的patient chart
    - .Global.flag.isMeetingPatientchart@: false
    # duplicate removal
    - =.builtIn.array.elementUnique:
        dataIn:
          arr: =.Global.optionalForms
        dataOut: Global.optionalForms
    # get 10002 edge to judge whether the patient and provider is already friend
    - ..apiRequest.relation.edgeAPI.get
    # get 10002 edge to judge whether the patient and facility is already friend
    - ..apiRequest.relation_patientToFacility.edgeAPI.get
    - =..apiRequest.insurance.docAPI.get: ""
    - =.builtIn.string.concat:
        dataIn:
          - =.Global.ActiveProvider.name.data.fullName
          - " - "
          - =.Global.ActiveProvider.name.data.title
        dataOut: CreateAppointmentToProvider.apiRequest.appointment.edgeCreateReq.name.providerName
  formData:
    financialForm: ""
    insurance: ""
    profile: ""
    # when visit type is telemedicine, loaction and facilityName show facility's name and location. When type is Office Visit, show location's name and location
    location: ""
    facilityName: ""
    patientProfile_shared: ""
    docList: []
    formList: []
    docMustCommitNum: -1
    docHaveCommitNum: -2
    #judge the locaion option is display or not
    locationDisplay: none
    tempHeight: "0.43103"
    appointmentLink: #如果当前是一个 related 预约，则从Global去拿
      eid: ""
      fid: ""
      reid: ""
  formDataTemp:
    localDocuLength: ""
    globalDocuLength: ""
    generalInfo: true
    generalInfoForms: true
    optionalForms:
      - title: Patient Chart
        pageName: PatientChart
    appointmentTitle:
      - title: Visit Questionnaire
  apiRequest:
    insurance:
      docQueryResp: ""
      docQueryReq:
        id:
          - .Global.rootNotebookID
          - .Global.Profile.id
        xfname: eid,fid
        type: .DocType.InsuranceCard
        _nonce: =.Global._nonce
      docAPI:
        get:
          api: rd
          dataIn: CreateAppointmentToProvider.apiRequest.insurance.docQueryReq
          dataOut: CreateAppointmentToProvider.apiRequest.insurance.docQueryResp
    acceptInvite:
      edgeCreateResp: ""
      edgeCreateReq:
        type: .EdgeType.Accept
        bvid: .Global.currentUser.vertex.id
        evid: .Global.ActiveProvider.bsig
        refid: ""
      edgeAPI:
        store:
          api: ce
          dataIn: CreateAppointmentToProvider.apiRequest.acceptInvite.edgeCreateReq
          dataOut: CreateAppointmentToProvider.apiRequest.acceptInvite.edgeCreateResp
    acceptInviteFacility:
      edgeCreateResp: ""
      edgeCreateReq:
        type: .EdgeType.Accept
        bvid: .Global.currentUser.vertex.id
        evid: .Global.currentFacility.bsig
        refid: ""
      edgeAPI:
        store:
          api: ce
          dataIn: CreateAppointmentToProvider.apiRequest.acceptInviteFacility.edgeCreateReq
          dataOut: CreateAppointmentToProvider.apiRequest.acceptInviteFacility.edgeCreateResp
    # provider's add friend request to this patient
    inviteFromProvider:
      edgeQueryResp: ""
      edgeQueryReq:
        type: .EdgeType.InviteInfo
        id:
          - .Global.currentUser.vertex.id
          - .Global.ActiveProvider.bsig
        xfname: Bvid,Evid
        _nonce: =.Global._nonce
      edgeAPI:
        get:
          api: re
          dataIn: CreateAppointmentToProvider.apiRequest.inviteFromProvider.edgeQueryReq
          dataOut: CreateAppointmentToProvider.apiRequest.inviteFromProvider.edgeQueryResp
    inviteFromFacility:
      edgeQueryResp: ""
      edgeQueryReq:
        type: .EdgeType.InviteInfo
        id:
          - .Global.currentUser.vertex.id
          - .Global.currentFacility.bsig
        xfname: Bvid,Evid
        _nonce: =.Global._nonce
      edgeAPI:
        get:
          api: re
          dataIn: CreateAppointmentToProvider.apiRequest.inviteFromFacility.edgeQueryReq
          dataOut: CreateAppointmentToProvider.apiRequest.inviteFromFacility.edgeQueryResp
    # patient and facility auto be friend
    relation_patientToFacility:
      edgeCreateResp: ""
      edgeQueryResp:
        edge: []
      edgeQueryReq:
        id:
          - .Global.currentUser.vertex.id
          - .Global.currentFacility.bsig
        xfname: Bvid,Evid
        sCondition: "subtype=131072 AND tage>0"
        type: 10002
        _nonce: =.Global._nonce
      edgeCreateReq:
        tage: 1
        type: 10002
        bvid: .Global.currentUser.vertex.id
        evid: .Global.currentFacility.bsig
        subtype: 131072
        name:
          isEncrypted: "1"
      edgeAPI:
        store:
          api: ce
          dataIn: CreateAppointmentToProvider.apiRequest.relation_patientToFacility.edgeCreateReq
          dataOut: CreateAppointmentToProvider.apiRequest.relation_patientToFacility.edgeCreateResp
        get:
          api: re
          dataIn: CreateAppointmentToProvider.apiRequest.relation_patientToFacility.edgeQueryReq
          dataOut: CreateAppointmentToProvider.apiRequest.relation_patientToFacility.edgeQueryResp
    # patient and provider auto be friend
    relation:
      edgeCreateResp: ""
      edgeQueryResp: ""
      edgeQueryReq:
        id:
          - .Global.currentUser.vertex.id
          - .Global.ActiveProvider.bsig
        xfname: Bvid,Evid
        sCondition: "subtype=65536 AND tage>0"
        type: 10002
        obfname: mtime
        maxcount: "1"
        _nonce: =.Global._nonce
      edgeCreateReq:
        tage: 1
        type: 10002
        bvid: .Global.currentUser.vertex.id
        evid: .Global.ActiveProvider.bsig
        subtype: 65536
        name:
          isEncrypted: "1"
      edgeAPI:
        store:
          api: ce
          dataIn: CreateAppointmentToProvider.apiRequest.relation.edgeCreateReq
          dataOut: CreateAppointmentToProvider.apiRequest.relation.edgeCreateResp
        get:
          api: re
          dataIn: CreateAppointmentToProvider.apiRequest.relation.edgeQueryReq
          dataOut: CreateAppointmentToProvider.apiRequest.relation.edgeQueryResp
    # appointment struct design
    appointment:
      edgeCreateResp: ""
      edgeCreateReq:
        # the provider id
        evid: .Global.ActiveProvider.bsig
        # the patient id
        bvid: .Global.currentUser.vertex.id
        #E3 id
        refid: .Global.clock.refid
        subtype: ""
        type: .EdgeType.WaitingRoom
        stime: .Global.clock.stime
        etime: .Global.clock.etime
        tage: 3
        name:
          fee: .Global.formData.fee
          Reason: .Global.formData.appointment.reason
          patientName: .Global.Profile.name.data.basicInfo.fullName
          patientPhoneNumber: .Global.currentUser.vertex.uid
          providerName: ""
          patientAvatarId: .Global.Profile.name.data.avatar
          visitType: .Global.formData.appointment.visitType
          visitReason: .Global.formData.appointment.reason
          location: .Global.currentFacility.name.data.basicInfo.location
          locationName: .Global.currentFacility.name.data.basicInfo.medicalFacilityName
          facilityId: .Global.currentFacility.bsig
          document: .Global.formData.appointment.docu
          finishDoc: []
          optionalForms: []
          duration: .Global.formData.appointment.duration
          fontColor: "#30b354"
          # show the border color in the waiting room
          borderColor: "0xdededf"
          providerId: .Global.ActiveProvider.bsig
          providerFullInfo: ""
          providerAvatar: .Global.ActiveProvider.name.data.avatar
      edgeAPI:
        store:
          api: ce
          dataIn: CreateAppointmentToProvider.apiRequest.appointment.edgeCreateReq
          dataOut: CreateAppointmentToProvider.apiRequest.appointment.edgeCreateResp
    approveAppointment:
      response: ""
      edge:
        bvid: .Global.currentUser.vertex.id
        evid: ""
        refid: ""
        type: 40000
        _handledCode: 40003
        subtype: 5
      edgeAPI:
        store:
          api: ce
          dataIn: apiRequest.approveAppointment.edge
          dataOut: apiRequest.approveAppointment.response
    inviteFacility:
      response: ""
      edge:
        bvid: .Global.currentUser.vertex.id
        evid: .Global.currentFacility.bsig
        refid: ""
        type: .EdgeType.InviteInfo
        name:
          role: Facility
          roleName: .Global.currentFacility.name.data.basicInfo.medicalFacilityName
      edgeAPI:
        store:
          api: ce
          dataIn: apiRequest.inviteFacility.edge
          dataOut: apiRequest.inviteFacility.response
    financialInfo:
      docStoreResp: ""
      docStoreReq:
        type: .DocType.FinancialInfo
        reid: ""
        eid: ""
        name:
          data:
            paymentInfo:
              fee: ""
              checkoutBalance: "" # due to other medical balance
            payerInfo:
              employerInfo: ""
              attorneyInfo: ""
              insuranceInfo: ""
              individualInfo: ""
      docAPI:
        store:
          api: cd
          dataIn: CreateAppointmentToProvider.apiRequest.financialInfo.docStoreReq
          dataOut: CreateAppointmentToProvider.apiRequest.financialInfo.docStoreResp
    # 用来做关联预约的tag
    appointmentListTag:
      docCreateResp: ""
      docCreateReq:
        subtype:
          isEncrypted: "0"
          isOnServer: "0"
        type: .DocType.RelatedAppTag
        # 创建时  eid 和 reid 都指向 当前房间的边，
        # 创建 related appointment 时， 需要一个reid 指向上一个小尾巴，fid指向跟边，所以eid和fid都需要根据情况判断
        eid: =..formData.appointmentLink.eid
        fid: =..formData.appointmentLink.fid
        reid: =..formData.appointmentLink.reid
        name:
          data: ""
      docAPI:
        store:
          api: cd
          dataIn: apiRequest.appointmentListTag.docCreateReq
          dataOut: CreateAppointmentToProvider.apiRequest.appointmentListTag.docCreateResp
  sendNotification:
    document:
      .Document: ""
      subtype:
        isOnServer: 1
        isZipped: 0
        isBinary: 0
        isEncrypted: 0
        isExtraKeyNeeded: 0
        isEditable: 0
        applicationDataType: 0
        # 7 th bit
        notification: 1
        ringToneNotify: 0
        sendtoSelf: 0
        # 10 bit
        textMessage: 0
        mediaType: 8
      type: .DocType.Notification
      tage: 5
      eid: ""
      name:
        data: ""
        notification:
          title: Appointment Reminder
          context: Click to check your appointment
          body: Click to check your appointment
          onClickLandingPage: AppointmentLobby
    docAPI:
      store:
        api: cd
        dataIn: sendNotification.document
  sendRingtoneNotification:
    document:
      .Document: ""
      eid: ""
      subtype:
        isOnServer: 1
        isZipped: 0
        isBinary: 0
        isEncrypted: 0
        isExtraKeyNeeded: 0
        isEditable: 0
        applicationDataType: 0
        # 7 th bit
        notification: 1
        ringToneNotify: 1
        sendtoSelf: 0
        # 10 bit
        textMessage: 0
        mediaType: 8
      type: .DocType.Notification
      tage: 5 # seconds
      name:
        data: ""
        notification:
          title: Patient In Virtual Room
          context: Click to jump to Appointment Lobby
          body: Click to jump to Appointment Lobby
          landingPage: RingTonePage
          onClickLandingPage: RingTonePage
          caller: =.Global.Profile.name.data.basicInfo.fullName
    docAPI:
      store:
        api: cd
        dataIn: sendRingtoneNotification.document
  components:
    - .TipsMultiLine:
      message: "You have not filled in the other forms"
      viewTag: judgeOtherForm
    - .TipsMultiLine:
      message: "You have not filled in the Financial Responsibility Form"
      viewTag: tag_notFillFinancialForm
    - type: popUp
      viewTag: scheduleFail
      message: "Your appointment time is already occupied. You can change your appointment time, then the forms you filled in will be retained Warning: If you make an appointment later, you will lose all your forms you filled in "
      style:
        top: "0"
        left: "0"
        width: "1"
        height: "1"
        backgroundColor: "0x00000066"
        zIndex: "50"
        textAlign:
          y: center
      leftButton:
        - goto: PatientDashboard
      rightButton:
        - actionType: evalObject
          object:
            - .Global.roomInfo.edge@: =..apiRequest.appointment.edgeCreateResp.edge
        - goto: CreateAppointmentNew
      children:
        - type: view
          style:
            width: "0.7"
            marginLeft: "0.15"
            backgroundColor: "0xE6E6E6"
            borderRadius: "14px"
            overflow: hidden
          children:
            - type: view
              style:
                width: "0.7"
                height: "auto"
                backgroundColor: "0xd81e06"
                borderRadius: "14px 14px 0 0"
                overflow: hidden
              children:
                - type: view
                  style:
                    marginTop: "0.006"
                    width: "0.7"
                    height: "auto"
                  children:
                    - type: image
                      path: aboutWhite.svg
                      style:
                        display: inline-block
                        verticalAlign: middle
                        marginLeft: "0.23"
                        width: "0.045"
                    - type: label
                      text: Warning
                      style:
                        fontSize: .Nfont.h14
                        marginLeft: "0.02"
                        color: "0xFFFFFF"
                        display: inline-block
                        verticalAlign: middle

            - type: view
              style:
                height: "0.01"
                backgroundColor: "0xd81e06"
            - type: label
              text: ___.message
              style:
                width: "0.576"
                marginLeft: "0.062"
                marginTop: "0.027"
                fontSize: .Nfont.h14

                textAlign:
                  x: center
                color: "0x333333"
            - type: view
              style:
                height: "0.027"
                width: "0.7"
                border:
                  style: 2
                  color: "0x919192"
                borderWidth: "1"
            - type: view
              style:
                width: "0.7"
              children:
                - type: button
                  text: "Later"
                  style:
                    color: "0x007AFF"
                    display: inline-block
                    width: "0.349"
                    borderRadius: "0 0 0 14px"
                    height: "0.054"
                    backgroundColor: "0xE6E6E6"
                    border:
                      style: "1"
                  onClick: ____.leftButton
                - type: view
                  style:
                    width: "0.002"
                    backgroundColor: "0x919192"
                    display: inline-block
                    height: "0.054"
                    zIndex: "50"
                - type: button
                  text: "Change"
                  style:
                    color: "0x007AFF"
                    fontWeight: "850"
                    display: inline-block
                    width: "0.349"
                    borderRadius: "0 0 14px 0"
                    height: "0.054"
                    backgroundColor: "0xE6E6E6"
                    border:
                      style: "1"
                  onClick: ____.rightButton
    - .TipsMultiLine:
      viewTag: judgeVisitQuestionnaire
      message: "You have not filled in the Visit Questionnaire"
    - .SuccessfulOneLine:
      viewTag: createSuccessView
      message: "Create Successfully!"
    - .ProgressCheckView:
      message: "loading ..."
      viewTag: uploading
    - type: view
      style:
        width: "1"
        height: "0.1"
        backgroundColor: "0x2988e6ff"
      children:
        - type: label
          text: =..title
          style:
            left: "0.15"
            width: "0.7"
            fontWeight: 300
            height: "0.1"
            fontSize: .Nfont.h3
            color: "0xffffffff"
            textAlign:
              x: center
              y: center
            backgroundColor: "0x2988e6ff"
            border:
              style: "1"
    - type: view
      onClick:
        - goto: MobileContacts3
      style:
        top: "0.04"
        left: "0.05"
        width: "0.1"
        height: "0.02"
        backgroundColor: "0x2988e6"
        zIndex: 10
        border:
          style: "1"
        textAlign:
          x: center
          y: center
      children:
        - type: image
          path: falseWhite.svg
          style:
            left: "0.02"
            height: "0.02"
            zIndex: 11
    #  body
    - type: view
      style:
        top: "0.1"
        width: "1"
        height: "0.9"
      children:
        - type: view
          viewTag: blockImageTag
          style:
            width: "1"
            marginTop: "0"
            height: "auto"
            backgroundColor: "0x2988e6"
            overflow: hidden
          children:
            - type: view
              style:
                width: "0.9"
                height: "auto"
                marginLeft: "0.05"
                borderRadius: "6"
                backgroundColor: "0xffffff"
              children:
                - type: view
                  style:
                    width: "0.84"
                    height: "auto"
                    # marginTop: "0.015"
                    marginLeft: "0.03"
                    fontSize: .Nfont.n1
                  children:
                    - type: view
                      style:
                        width: "0.82"
                        height: "0.05"
                        marginLeft: "0.01"
                        border:
                          style: "2"
                        borderWidth: "1"
                        borderColor: "0xf8f8f8"
                      children:
                        - type: label
                          text: "Appointment Info"
                          style:
                            fontWeight: "600"
                            fontSize: .Nfont.n2
                            width: "0.75"
                            height: "0.05"
                            display: "inline-block"
                            lineHeight: "5vh"
                        - type: image
                          path: editBlue.svg
                          style:
                            width: "0.05"
                            display: "inline-block"
                            marginTop: "0.015"
                          onClick:
                            - actionType: builtIn
                              funcName: goBack
                              reload: true
                    - type: view
                      style:
                        width: "0.82"
                        height: "0.04"
                        marginLeft: "0.01"
                        marginTop: "0.015"
                      children:
                        - type: label
                          text: "Date"
                          style:
                            fontWeight: "600"
                            fontSize: .Nfont.n2
                            width: "0.1"
                            height: "0.04"
                            display: "inline-block"
                            lineHeight: "4vh"
                        - type: label
                          text=func: .builtIn.string.formatUnixtimeL_en
                          dataKey: Global.clock.stime
                          style:
                            fontSize: .Nfont.n2
                            textAlign:
                              x: right
                            width: "0.72"
                            height: "0.04"
                            display: "inline-block"
                            lineHeight: "4vh"
                    - type: view
                      style:
                        width: "0.82"
                        height: "0.035"
                        marginLeft: "0.01"
                      children:
                        - type: label
                          text: "Time"
                          style:
                            fontWeight: "600"
                            fontSize: .Nfont.n2
                            width: "0.1"
                            height: "0.035"
                            display: "inline-block"
                            lineHeight: "3.5vh"
                        - type: label
                          text: "9:45am-10:00am"
                          text=func: .builtIn.date.ShowTimeSpan
                          dataKey: Global.clock
                          style:
                            fontSize: .Nfont.n2
                            textAlign:
                              x: right
                            width: "0.72"
                            height: "0.035"
                            display: "inline-block"
                            lineHeight: "3.5vh"
                    - type: view
                      style:
                        width: "0.82"
                        height: "0.035"
                        marginLeft: "0.01"
                      children:
                        - type: label
                          text: "Reason for Visit"
                          style:
                            fontWeight: "600"
                            fontSize: .Nfont.n2
                            width: "0.3"
                            height: "0.035"
                            display: "inline-block"
                            lineHeight: "3.5vh"
                        - type: label
                          text: "Fever"
                          dataKey: Global.formData.appointment.reason
                          style:
                            fontSize: .Nfont.n2
                            textAlign:
                              x: right
                            width: "0.52"
                            height: "0.035"
                            display: "inline-block"
                            lineHeight: "3.5vh"
                    - type: view
                      style:
                        width: "0.82"
                        height: "0.035"
                        marginLeft: "0.01"
                      children:
                        - type: label
                          text: "Appointment Type"
                          style:
                            fontWeight: "600"
                            fontSize: .Nfont.n2
                            width: "0.35"
                            height: "0.035"
                            display: "inline-block"
                            lineHeight: "3.5vh"
                        - type: label
                          text: "Office Visit"
                          dataKey: Global.formData.appointment.visitType
                          style:
                            fontSize: .Nfont.n2
                            textAlign:
                              x: right
                            width: "0.47"
                            height: "0.035"
                            display: "inline-block"
                            lineHeight: "3.5vh"
                    - type: view
                      style:
                        width: "0.82"
                        height: "0.035"
                        marginLeft: "0.01"
                      children:
                        - type: label
                          text: "Provider"
                          style:
                            fontWeight: "600"
                            fontSize: .Nfont.n2
                            width: "0.16"
                            height: "0.035"
                            display: "inline-block"
                            lineHeight: "3.5vh"
                        - type: label
                          text: "Aomas Mueller"
                          dataKey: Global.ActiveProvider.name.data.fullName
                          style:
                            fontSize: .Nfont.n2
                            textAlign:
                              x: right
                            width: "0.66"
                            height: "0.035"
                            display: "inline-block"
                            lineHeight: "3.5vh"
                    - type: view
                      style:
                        width: "0.82"
                        height: "0.035"
                        marginLeft: "0.01"
                      children:
                        - type: label
                          text: "Facility"
                          style:
                            fontWeight: "600"
                            fontSize: .Nfont.n2
                            width: "0.14"
                            height: "0.035"
                            display: "inline-block"
                            lineHeight: "3.5vh"
                        - type: label
                          dataKey: formData.facilityName
                          style:
                            fontSize: .Nfont.n2
                            textAlign:
                              x: right
                            width: "0.68"
                            height: "0.035"
                            display: "inline-block"
                            lineHeight: "3.5vh"
                    - type: view
                      style:
                        width: "0.82"
                        height: "auto"
                        marginLeft: "0.01"
                        display: ..formData.locationDisplay
                        overflow: hidden
                      children:
                        - type: label
                          text: "Location"
                          style:
                            fontSize: .Nfont.n2
                            fontWeight: "600"
                            width: "0.82"
                            height: "0.035"
                            lineHeight: "3.5vh"
                        - type: label
                          dataKey: formData.location
                          style:
                            fontSize: .Nfont.n2
                            textAlign:
                              x: left
                            width: "0.82"
                            height: "auto"
                            wordWrap: break-word
                        - type: view
                          style:
                            marginTop: "0.01"
                    - type: view
                      style:
                        width: "0.82"
                        height: "0.001"
                        marginLeft: "0.01"
                        marginTop: "0.01"
                        backgroundColor: "0xcccccc"
                    - type: view
                      style:
                        width: "0.82"
                        height: "0.04"
                        marginLeft: "0.01"
                      children:
                        - type: label
                          text: "Fee"
                          style:
                            fontSize: .Nfont.n2
                            width: "0.14"
                            height: "0.035"
                            display: "inline-block"
                            lineHeight: "3.5vh"
                            fontWeight: "700"
                        - type: label
                          text: ""
                          text=func: .builtIn.string.dollarFormat
                          dataKey: Global.formData.fee
                          style:
                            fontSize: .Nfont.n2
                            textAlign:
                              x: right
                            width: "0.68"
                            height: "0.035"
                            display: "inline-block"
                            fontWeight: "700"
                            lineHeight: "3.5vh"
            - type: view
              style:
                marginTop: "0.03"
                width: "1"
                height: "auto"
        - type: scrollView
          style:
            width: "1"
            marginTop: "0.01"
            height: ..formData.tempHeight
          children:
            - type: label
              text: "Please Complete Forms Below"
              style:
                fontWeight: "600"
                lineHeight: "5vh"
                width: "0.82"
                marginLeft: "0.04"
                height: "0.05"
                color: "0x333333"
                fontSize: .Nfont.h16
            - type: view
              onClick:
                - goto: VisitQuestionnaire
              style:
                width: "0.82"
                marginLeft: "0.04"
                marginTop: "0.01"
              children:
                - type: image
                  path:
                    emit:
                      actions:
                        - if:
                            - =.Global.visitQuestionnaireDoc
                            - selectOnBlue.svg
                            - selectOff.svg
                  style:
                    width: "0.05"
                    display: "inline-block"
                    verticalAlign: middle
                - type: label
                  text: Visit Questionnaire
                  style:
                    display: "inline-block"
                    fontSize: .Nfont.n2
                    width: "0.67"
                    verticalAlign: middle
                    marginLeft: "0.02"
            - type: view
              onClick:
                - goto: FinancialFormEditPage1
              style:
                width: "0.82"
                marginLeft: "0.04"
                marginTop: "0.025"
              children:
                - type: image
                  path:
                    emit:
                      actions:
                        - if:
                            - =.Global.formData.patientDoc.status.shareFinancialForm
                            - selectOnBlue.svg
                            - selectOff.svg
                  style:
                    width: "0.05"
                    display: "inline-block"
                    verticalAlign: middle
                - type: label
                  text: Financial Responsibility Form
                  style:
                    display: "inline-block"
                    fontSize: .Nfont.n2
                    width: "0.67"
                    verticalAlign: middle
                    marginLeft: "0.02"
            - type: list
              viewTag: appointmentListTag
              contentType: listObject
              listObject: ..formData.docList
              iteratorVar: itemObject
              style:
                width: "0.92"
                height: "auto"
                overflow: hidden
              children:
                - type: listItem
                  itemObject:
                  style:
                    width: "0.9"
                    marginLeft: "0.04"
                    overflow: hidden
                  children:
                    - type: view
                      style:
                        width: auto
                        height: auto
                        marginTop: "0.025"
                      children:
                        - type: image
                          path:
                            emit:
                              dataKey:
                                var: itemObject
                              actions:
                                - if:
                                    - =.builtIn.array.has:
                                        dataIn:
                                          object: =.Global.vaccine
                                          value: $var.key
                                    - selectOnBlue.svg
                                    - selectOff.svg
                          style:
                            width: "0.05"
                            verticalAlign: middle
                            display: "inline-block"
                        - type: label
                          dataKey: itemObject.key
                          style:
                            display: "inline-block"
                            fontSize: .Nfont.n2
                            verticalAlign: middle
                            width: "0.72"
                            marginLeft: "0.02"
                  onClick:
                    - emit:
                        dataKey:
                          var: itemObject
                        actions:
                          - if:
                              - =.Global.visitQuestionnaireDoc
                              - goto: $var.pageName
                              - continue
                    - actionType: popUp
                      popUpView: judgeVisitQuestionnaire
                      wait: true
            - type: label
              text: "Optional Forms"
              style:
                fontWeight: "600"
                marginLeft: "0.04"
                height: "0.05"
                color: "0x333333"
                fontSize: .Nfont.h16
                marginTop: "0.02"
            - type: view
              style:
                width: "0.82"
                margin: "0"
                height: "auto"
              children:
                - type: view
                  style:
                    width: "0.82"
                    height: "auto"
                    marginLeft: "0.04"
                  onClick:
                    - actionType: evalObject
                      object:
                        - .Global.isShare@: true
                    - goto: PatientChart
                  children:
                    - type: image
                      path:
                        emit:
                          actions:
                            - if:
                                - =.Global.formData.patientDoc.status.sharePatientChart
                                - selectOnBlue.svg
                                - selectOff.svg
                      style:
                        width: "0.05"
                        verticalAlign: middle
                        display: "inline-block"
                    - type: label
                      text: "Patient Chart"
                      style:
                        display: "inline-block"
                        fontSize: .Nfont.n2
                        width: "0.67"
                        verticalAlign: middle
                        marginLeft: "0.02"
    - type: view
      style:
        top: "0.9"
        width: "0.9"
        height: "0.09"
        left: "0.05"
      children:
        - type: button
          viewTag: buttonView
          text: "Create Appointment"
          style:
            width: "0.9"
            height: "0.05"
            color: "0xffffff"
            fontSize: .Nfont.n2
            marginTop: "0.025"
            textAlign:
              x: center
            lineHeight: "5vh"
            border:
              style: "3"
            borderWidth: "1"
            backgroundColor: "0x2988e6"
            boxShadow: "0 0 1px 1px #7bb3f2"
            borderColor: "0x65a9ee"
            borderRadius: "5"
          onClick:
            - actionType: evalObject
              object:
                #judge the visit questionnaire is fill or not
                - if:
                    - =.Global.visitQuestionnaireDoc
                    - continue
                    - actionType: popUp
                      popUpView: judgeVisitQuestionnaire
                      wait: true
                      popUpDismiss: 2000
                - if:
                    - =.Global.formData.patientDoc.status.shareFinancialForm
                    - continue
                    - actionType: popUp
                      popUpView: tag_notFillFinancialForm
                      wait: true
                      popUpDismiss: 2000
                # get the length of the documents which user have to commit
                - =.builtIn.array.getListLength:
                    dataIn:
                      object: =.Global.formData.appointment.docu
                    dataOut: CreateAppointmentToProvider.formData.docMustCommitNum
                # get the length of the documents which user have commited
                - =.builtIn.array.getListLength:
                    dataIn:
                      object: =.Global.vaccine
                    dataOut: CreateAppointmentToProvider.formData.docHaveCommitNum
                #judge the other form is fill or not
                - if:
                    - =.builtIn.string.equal:
                        dataIn:
                          string1: =..formData.docMustCommitNum
                          string2: =..formData.docHaveCommitNum
                    - continue
                    - actionType: popUp
                      popUpView: judgeOtherForm
                      wait: true
                      popUpDismiss: 2000
            #popup the uploading popUp
            - actionType: popUp
              popUpView: uploading
            - actionType: evalObject
              object:
                - ..apiRequest.appointment.edgeCreateReq.name.finishDoc@: =.Global.vaccine
                - ..apiRequest.appointment.edgeCreateReq.name.optionalForms@: =.Global.optionalForms
                - =.builtIn.array.add:
                    dataIn:
                      object: =..apiRequest.appointment.edgeCreateReq.name.finishDoc
                      value: Visit Questionnaire
                - =.builtIn.array.pushAny:
                    dataIn:
                      newMessage: "Financial Responsibility Form"
                      messages: =..apiRequest.appointment.edgeCreateReq.name.finishDoc
                    dataOut: CreateAppointmentToProvider.apiRequest.appointment.edgeCreateReq.name.finishDoc
                # 开启不提示admin更改patient profile的功能
                - if:
                    - =.Global.formData.meetingStatus.notRemind
                    - ..apiRequest.appointment.edgeCreateReq.tage@: 7346545013
                    - continue
                # make appointment, create E2
                - =..apiRequest.appointment.edgeAPI.store: ""
                # auto approve appointment and create E5
                - .CreateAppointmentToProvider.apiRequest.approveAppointment.edge.refid@: =.CreateAppointmentToProvider.apiRequest.appointment.edgeCreateResp.edge.id
                - .CreateAppointmentToProvider.apiRequest.approveAppointment.edge.evid@: =.CreateAppointmentToProvider.apiRequest.appointment.edgeCreateResp.edge.evid
                - =.CreateAppointmentToProvider.apiRequest.approveAppointment.edgeAPI.store: ""
                # auto approve appointment and create E10
                - .CreateAppointmentToProvider.apiRequest.inviteFacility.edge.refid@: =.CreateAppointmentToProvider.apiRequest.appointment.edgeCreateResp.edge.id
                - =.CreateAppointmentToProvider.apiRequest.inviteFacility.edgeAPI.store: ""
                # share doc
                - =.builtIn.array.add:
                    dataIn:
                      object: =.Global.vaccineDoc
                      value: =.Global.formData.visitQuestionnaireDoc.doc
                - if:
                    - =.Global.formData.patientDoc.status.sharePatientChart
                    - =.builtIn.ecos.shareDoc:
                        dataIn:
                          sourceDoc: =.Global.formData.patientChartInfo
                          targetEdgeID: =..apiRequest.appointment.edgeCreateResp.edge.id
                    - continue
                - if:
                    - =.Global.formData.newPatientForm.id
                    - =.builtIn.array.add:
                        dataIn:
                          object: =.Global.vaccineDoc
                          value: =.Global.formData.newPatientForm
                    - continue
                - if:
                    - =.Global.formData.pifzerVaccineFirDoseForm.id
                    - =.builtIn.array.add:
                        dataIn:
                          object: =.Global.vaccineDoc
                          value: =.Global.formData.pifzerVaccineFirDoseForm
                    - continue
                - if:
                    - =.Global.formData.pifzerVaccineSecDoseForm.id
                    - =.builtIn.array.add:
                        dataIn:
                          object: =.Global.vaccineDoc
                          value: =.Global.formData.pifzerVaccineSecDoseForm
                    - continue
                - if:
                    - =.Global.formData.cov19TestNewPatForm.id
                    - =.builtIn.array.add:
                        dataIn:
                          object: =.Global.vaccineDoc
                          value: =.Global.formData.cov19TestNewPatForm
                    - continue
                - if:
                    - =.Global.formData.cov19TestForm.id
                    - =.builtIn.array.add:
                        dataIn:
                          object: =.Global.vaccineDoc
                          value: =.Global.formData.cov19TestForm
                    - continue
                - if:
                    - =.Global.formData.modernaVaccineFirDoseForm.id
                    - =.builtIn.array.add:
                        dataIn:
                          object: =.Global.vaccineDoc
                          value: =.Global.formData.modernaVaccineFirDoseForm
                    - continue
                - if:
                    - =.Global.formData.modernaVaccineSecDoseForm.id
                    - =.builtIn.array.add:
                        dataIn:
                          object: =.Global.vaccineDoc
                          value: =.Global.formData.modernaVaccineSecDoseForm
                    - continue
                - if:
                    - =.Global.formData.fluVaccinationConsentForm.id
                    - =.builtIn.array.add:
                        dataIn:
                          object: =.Global.vaccineDoc
                          value: =.Global.formData.fluVaccinationConsentForm
                    - continue
                - =.builtIn.ecos.shareDocList:
                    dataIn:
                      sourceDocList: =.Global.vaccineDoc
                      targetEdgeID: =..apiRequest.appointment.edgeCreateResp.edge.id
                      reid: =..apiRequest.appointment.edgeCreateResp.edge.id
                - =.builtIn.ecos.shareDoc:
                    dataIn:
                      sourceDoc: =.Global.Profile
                      targetEdgeID: =..apiRequest.appointment.edgeCreateResp.edge.id
                      reid: =..apiRequest.appointment.edgeCreateResp.edge.id
                    dataOut: CreateAppointmentToProvider.formData.profile
                - if:
                    - =.Global.formData.hashTag.id
                    - =.builtIn.ecos.shareDoc:
                        dataIn:
                          sourceDoc: =.Global.formData.hashTag
                          targetEdgeID: =..apiRequest.appointment.edgeCreateResp.edge.id
                          reid: =..formData.profile.doc.id
                    - continue
                - =.builtIn.ecos.shareDoc:
                    dataIn:
                      sourceDoc: =.Global.formData.patientDoc.financialForm
                      targetEdgeID: =..apiRequest.appointment.edgeCreateResp.edge.id
                      reid: =..apiRequest.appointment.edgeCreateResp.edge.id
                    dataOut: CreateAppointmentToProvider.formData.financialForm
                - =.builtIn.ecos.shareDocList:
                    dataIn:
                      sourceDocList: =..apiRequest.insurance.docQueryResp.doc
                      targetEdgeID: =..apiRequest.appointment.edgeCreateResp.edge.id
                      reid: =..formData.profile.doc.id
            - actionType: evalObject
              object:
                .Global._nonce@:
                  =.builtIn.math.random: ""
            - actionType: evalObject
              object:
                # if patient and provider not friend, to be friend
                - if:
                    # Testing new logic to fix not auto add friend  -Eric 11/18/2021
                    # Issue is this branch is going to true because this api call does not filter for tage == 1, but i think tage should be == 1 to show friends
                    # Now, will only be true if there is an edge with tage 1.
                    # - =.builtIn.string.equal:
                    #     dataIn:
                    #       string1: =..apiRequest.relation.edgeQueryResp.edge.0.tage
                    #       string2: "1"
                    # Old code below:

                    # reply to Eric —— Kai Yao 1/4/2022
                    # I add the new query conditions which include the tage judge, thx.
                    - =..apiRequest.relation.edgeQueryResp.edge.0 #10002
                    - continue
                    - actionType: evalObject
                      object:
                        # judge if provider sent a friend request to this patient
                        - =..apiRequest.inviteFromProvider.edgeAPI.get: "" #1053
                        - if:
                            - =..apiRequest.inviteFromProvider.edgeQueryResp.edge.0
                            - actionType: evalObject
                              object:
                                - ..apiRequest.acceptInvite.edgeCreateReq.refid@: =..apiRequest.inviteFromProvider.edgeQueryResp.edge.0.id
                                - =..apiRequest.acceptInvite.edgeAPI.store: ""
                                - =.builtIn.utils.setTimer:
                                    dataIn:
                                      timeUnix: 2000
                                - =..apiRequest.relation.edgeAPI.get: ""
                                - =.builtIn.ecos.shareDoc:
                                    dataIn:
                                      sourceDoc: =.Global.Profile
                                      targetEdgeID: =..apiRequest.relation.edgeQueryResp.edge.0.id
                                    dataOut: CreateAppointmentToProvider.formData.patientProfile_shared
                                - if:
                                    - =.Global.formData.hashTag.id
                                    - =.builtIn.ecos.shareDoc:
                                        dataIn:
                                          sourceDoc: =.Global.formData.hashTag
                                          targetEdgeID: =..apiRequest.appointment.edgeCreateResp.edge.id
                                          reid: =..formData.patientProfile_shared.doc.id
                                    - continue
                            - actionType: evalObject
                              object:
                                - =..apiRequest.relation.edgeAPI.store: ""
                                - =.builtIn.ecos.shareDoc:
                                    dataIn:
                                      sourceDoc: =.Global.Profile
                                      targetEdgeID: =..apiRequest.relation.edgeCreateResp.edge.id
                                    dataOut: CreateAppointmentToProvider.formData.patientProfile_shared
                                - if:
                                    - =.Global.formData.hashTag.id
                                    - =.builtIn.ecos.shareDoc:
                                        dataIn:
                                          sourceDoc: =.Global.formData.hashTag
                                          targetEdgeID: =..apiRequest.relation.edgeCreateResp.edge.id
                                          reid: =..formData.patientProfile_shared.doc.id
                                    - continue
                # if patient and facility not friend,to be friend
                - if:
                    - =..apiRequest.relation_patientToFacility.edgeQueryResp.edge.0 #10002
                    - continue
                    - actionType: evalObject
                      object:
                        - =..apiRequest.relation_patientToFacility.edgeAPI.store: ""
                        - =.builtIn.ecos.shareDoc:
                            dataIn:
                              sourceDoc: =.Global.Profile
                              targetEdgeID: =..apiRequest.relation_patientToFacility.edgeCreateResp.edge.id
                            dataOut: CreateAppointmentToProvider.formData.insurance
                        - if:
                            - =.Global.formData.hashTag.id
                            - =.builtIn.ecos.shareDoc:
                                dataIn:
                                  sourceDoc: =.Global.formData.hashTag
                                  targetEdgeID: =..apiRequest.relation_patientToFacility.edgeCreateResp.edge.id
                                  reid: =..formData.insurance.doc.id
                            - continue
                        - =.builtIn.ecos.shareDocList:
                            dataIn:
                              sourceDocList: =.Global.formData.module_insurance.insuranceList
                              targetEdgeID: =..apiRequest.relation_patientToFacility.edgeCreateResp.edge.id
                              reid: =..formData.insurance.doc.id
                    - continue
            # 创建完预约之后打 appointment link 的tag,回头需要加判断
            - actionType: evalObject
              object:
                # fid 指向 房间
                - ..formData.appointmentLink.eid@: =..apiRequest.appointment.edgeCreateResp.edge.id
                - ..formData.appointmentLink.fid@: ""
                - ..formData.appointmentLink.reid@: =..apiRequest.appointment.edgeCreateResp.edge.id
                # 创建 tag
                - =..apiRequest.appointmentListTag.docAPI.store: ""
            - actionType: evalObject
              object:
                - ..sendNotification.document.fid@: =.Global.prodAPPID
                - ..sendNotification.document.eid@: =..apiRequest.appointment.edgeCreateResp.edge.id
                # send to Doctor
                - ..sendNotification.document.name.notification.title@: "Appointment Reminder"
                - ..sendNotification.document.name.notification.context@: "Click to check your appointment"
                - =..sendNotification.docAPI.store: ""
                # remind appointment time to provider 提醒会议开始了
                - =.builtIn.notification.delayCalculation:
                    dataIn:
                      stime: =..apiRequest.appointment.edgeCreateResp.edge.stime
                      period: 5
                    dataOut: CreateAppointmentToProvider.sendNotification.document.tage
                - ..sendNotification.document.name.notification.title@: "The meeting is about to begin"
                - ..sendNotification.document.name.notification.context@: "Click to enter the appointment"
                - =..sendNotification.docAPI.store: ""
            # if the appointment is telemedicine then schedule the ringtone notification otherwise do nothing
            # moved the scheduled ring-tone notification to the patient check in
            # - if:
            #     - =.builtIn.string.equal:
            #         dataIn:
            #           string1: =.Global.formData.appointment.visitType
            #           string2: Telemedicine
            #     - actionType: evalObject
            #       object:
            #         # ringtone notification to provider 提醒会议开始了
            #         - ..sendRingtoneNotification.document.fid@: =.Global.prodAPPID
            #         - ..sendRingtoneNotification.document.eid@: =..apiRequest.appointment.edgeCreateResp.edge.id
            #         - ..sendRingtoneNotification.document.name.notification.caller@: =..apiRequest.appointment.edgeCreateResp.edge.name.patientName
            #         - =.builtIn.notification.delayCalculation:
            #             dataIn:
            #               stime: =..apiRequest.appointment.edgeCreateResp.edge.stime
            #               period: 5 # 5 seconds
            #             dataOut: sendRingtoneNotification.document.tage
            #         - ..sendRingtoneNotification.document.name.notification.title@: "Ringtone The meeting is about to begin"
            #         - ..sendRingtoneNotification.document.name.notification.context@: "Ringtone Click to enter the appointment"
            #         - =..sendRingtoneNotification.docAPI.store: ""
            #         # ringtone notification to patient 提醒会议开始了
            #         - ..sendRingtoneNotification.document.fid@: =.Global.patdAPPID
            #         - ..sendRingtoneNotification.document.eid@: =..apiRequest.appointment.edgeCreateResp.edge.id
            #         - ..sendRingtoneNotification.document.name.notification.caller@: =..apiRequest.appointment.edgeCreateResp.edge.name.providerName
            #         - =.builtIn.notification.delayCalculation:
            #             dataIn:
            #               stime: =..apiRequest.appointment.edgeCreateResp.edge.stime
            #               period: 5 # 5 seconds
            #             dataOut: sendRingtoneNotification.document.tage
            #         - ..sendRingtoneNotification.document.name.notification.title@: "Ringtone The meeting is about to begin"
            #         - ..sendRingtoneNotification.document.name.notification.context@: "Ringtone Click to enter the appointment"
            #         - =..sendRingtoneNotification.docAPI.store: ""
            #     - continue
            - actionType: evalObject
              object:
                - ..sendNotification.document.fid@: =.Global.patdAPPID
                - ..sendNotification.document.eid@: =..apiRequest.appointment.edgeCreateResp.edge.id
                # send to Patient to check in
                - =.builtIn.notification.delayCalculation:
                    dataIn:
                      stime: =..apiRequest.appointment.edgeCreateResp.edge.stime
                      period: 43200
                    dataOut: CreateAppointmentToProvider.sendNotification.document.tage
                - ..sendNotification.document.name.notification.title@: "Start check-in now"
                - ..sendNotification.document.name.notification.context@: "Click to check in appointment"
                - =..sendNotification.docAPI.store: ""
                # send to Patient for get apppointment
                - ..sendNotification.document.tage@: 5
                - ..sendNotification.document.name.notification.title@: "Appointment Reminder"
                - ..sendNotification.document.name.notification.context@: "Click to check your appointment"
                - =..sendNotification.docAPI.store: ""
                # remind appointment time to patient
                - =.builtIn.notification.delayCalculation:
                    dataIn:
                      stime: =..apiRequest.appointment.edgeCreateResp.edge.stime
                      period: 5
                    dataOut: CreateAppointmentToProvider.sendNotification.document.tage
                - ..sendNotification.document.name.notification.title@: "The meeting is about to begin"
                - ..sendNotification.document.name.notification.context@: "Click to enter the appointment"
                - =..sendNotification.docAPI.store: ""
            - actionType: popUpDismiss
              popUpView: uploading
            - actionType: evalObject
              object:
                - if:
                    - =.builtIn.string.equal:
                        dataIn:
                          string1: =..apiRequest.approveAppointment.response.code
                          string2: 40003
                    - actionType: popUp
                      popUpView: scheduleFail
                      wait: true
                    - actionType: popUp
                      popUpView: createSuccessView
                      wait: 1000
            - goto: PatientDashboard
