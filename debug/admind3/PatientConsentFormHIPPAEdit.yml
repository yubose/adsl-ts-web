PatientConsentFormHIPPAEdit:
  title: "Patient Consent Form - HIPPA"
  pageNumber:
  init:
    #Page initialization
    - .SignInCheck
    # macro 复现
    - if:
        - =.Global.formData.providerNotesForm.id
        - ..apiRequest.patientConsentForm.docReq@: =.Global.formData.providerNotesForm
        - actionType: evalObject
          object:
            - =..apiRequest.patientConsentForm.docAPI.store: ""
            - ..apiRequest.patientConsentForm.docReq@: =..apiRequest.patientConsentForm.docResp.doc
    # 判断是否签名
    - if:
        - =..apiRequest.patientConsentForm.docReq.name.data.whetherSign
        - continue
        # 非空修改显示的标识,刷新签名区域
        - actionType: evalObject
          object:
            - ..formData.temporarySignature@: =..apiRequest.patientConsentForm.docReq.name.data.signatureId
            - ..formData.signShow@: "block"
            - ..formData.canvasShow@: "none"
  formData:
    #Input data here
    temporarySignature: ""
    whetherSign: ""
    signShow: "none"
    canvasShow: "block"
  formDataTemp:
    #Input data temp here, datatemp should not mix with formData
    privateTag:
      display: "block"
      backgroundColor: "0xececee"
      fontColor: "0x4c5264"
      name: "Private"
    publicTag:
      display: "block"
      backgroundColor: "0xdfedfc"
      fontColor: "0x2988e6"
      name: "Released"
  apiRequest:
    #Input data request here
    patientConsentForm:
      deleteReq:
        id: ""
      docResp: ""
      docReq:
        eid: .Global.formData.meetingDocEid
        reid: ""
        type: .DocType.PatientConsentForm
        name:
          data:
            facilityInfo:
              facilityAvatarID: .Global.facilityAvatarID
              facilityName: .Global.currentFacility.name.basicInfo.medicalFacilityName
              address: .Global.currentFacility.name.basicInfo.location
              email: .Global.currentFacility.name.basicInfo.email
              website: .Global.currentFacility.name.basicInfo.website
              phoneNumber: .Global.currentFacility.name.basicInfo.phoneNumber
              fax: .Global.currentFacility.name.basicInfo.fax
            patientInfo:
              examDate: .Global.formData.appointment.stime
              patientName: .Global.formData.patientInfo.name.data.basicInfo.fullName
              dob: .Global.formData.patientInfo.name.data.basicInfo.dateOfBirth
              phone: .Global.formData.patientInfo.name.data.basicInfo.phone
              email: .Global.formData.patientInfo.name.data.contactInfo.email
              address: .Global.formData.patientInfo.name.data.contactInfo.address.fullAddress
            classTag:
              name: Admin
              fontColor: "0x005795"
              backgroundColor: "0xe9f2fc"
              display: block
            statusTag:
              name: Private
              fontColor: "0x4c5264"
            signatureId: ""
            signatureTime: ""
            whetherSign: true
            proxyInfo: ""
          title: "Patient Consent Form - HIPPA"
          user: .Global.currentFacility.name.basicInfo.medicalFacilityName
          type: "application/json"
      docAPI:
        store:
          api: cd
          dataIn: PatientConsentFormHIPPAEdit.apiRequest.patientConsentForm.docReq
          dataOut: PatientConsentFormHIPPAEdit.apiRequest.patientConsentForm.docResp
        delete:
          api: dx
          dataIn: PatientConsentFormHIPPAEdit.apiRequest.patientConsentForm.deleteReq
    newSign:
      docRes: ""
      document:
        #DOC
        type: .DocType.DocumentSignature
        name:
          title: ""
          type: ..apiRequest.newSign.document.subtype.mediaType
          data: ""
        eid: .Global.formData.meetingDocEid
        subtype:
          mediaType: "" # mediaType : "image/jpeg"              
      docAPI:
        # DOCAPI 
        store:
          api: cd
          dataIn: apiRequest.newSign.document
          dataOut: PatientConsentFormHIPPAEdit.apiRequest.newSign.docRes
  style: #Input style fragment here

  components:
    - type: view
      style:
        width: '1'
        height: '1'
        margin: auto
      children:
        - .SideMenuBar:
          children:
            - .aitLogo:
            - .MenuBar:
        - .TopBar:
        - .BodyView:
          style:
            height: "0.93"
          children:
            - .AppointmentLobby:
            - .GotoBack:
            - type: view
              style:
                left: "0.008"
                width: "0.824"
                height: "0.74"
                top: "0.1"
                overflow: hidden
                backgroundColor: "0xffffff"
              children:
                - type: view
                  style:
                    width: "0.39"
                    height: "1"
                    margin: "auto"
                  children:
                    - .FormsTypeTitle:
                    - type: scrollView
                      style:
                        marginTop: "0.01"
                        width: "0.39"
                        height: "0.614"
                        overflow: scroll
                      children:
                        - .ProFormsBaseView:
                          style:
                            marginTop: "0.03"
                            height: "0.1"
                          children:
                            - .ProFormsBaseView:
                              style:
                                width: "0.135"
                                display: inline-block
                              children:
                                - type: image
                                  path: "office-building.svg"
                                  path=func: .builtIn.utils.prepareDocToPath
                                  dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.facilityAvatarID
                                  style:
                                    marginTop: "0.005"
                                    width: "0.025"
                                    height: "0.04416"
                                    display: inline-block
                                - type: view
                                  style:
                                    marginTop: "0"
                                    marginLeft: "0.01"
                                    width: "0.1"
                                    display: inline-block
                                  children:
                                    - .ProFormsLabel:
                                      dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.medicalFacilityName
                                      style:
                                        marginTop: "0"
                                        fontSize: .Nfont.nf4
                                    - .ProFormsLabel:
                                      dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.address
                                      style:
                                        marginTop: "0.01"
                                        fontSize: .Nfont.nf1
                            - .ProFormsBaseView:
                              style:
                                marginLeft: "0.035"
                                width: "0.12"
                                display: inline-block
                              children:
                                - .ProFormsBaseView:
                                  children:
                                    - .ProFormsLabelLeft:
                                      text: Email
                                    - .ProFormsLabelRight:
                                      dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.email
                                - .ProFormsBaseView:
                                  children:
                                    - .ProFormsLabelLeft:
                                      text: "Website"
                                    - .ProFormsLabelRight:
                                      dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.website
                            - .ProFormsBaseView:
                              style:
                                marginLeft: "0"
                                width: "0.1"
                                display: inline-block
                              children:
                                - .ProFormsBaseView:
                                  children:
                                    - .ProFormsLabelLeft:
                                      text: "Main #"
                                    - .ProFormsLabelRight:
                                      dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.phoneNumber
                                - .ProFormsBaseView:
                                  children:
                                    - .ProFormsLabelLeft:
                                      text: "Fax #"
                                    - .ProFormsLabelRight:
                                      dataKey: apiRequest.patientConsentForm.docReq.name.data.facilityInfo.fax
                        - .ProFormsBaseView:
                          children:
                            - .ProFormsBaseView:
                              children:
                                - .ProFormsLabelLeft:
                                  text: Exam Date
                                - .ProFormsLabelRight:
                                  text=func: .builtIn.string.formatUnixtime_en
                                  dataKey: apiRequest.patientConsentForm.docReq.name.data.patientInfo.examDate
                            - .ProFormsBaseView:
                              children:
                                - .ProFormsLabelLeft:
                                  text: Patient Name
                                - .ProFormsLabelRight:
                                  dataKey: apiRequest.patientConsentForm.docReq.name.data.patientInfo.patientName
                            - .ProFormsBaseView:
                              children:
                                - .ProFormsLabelLeft:
                                  text: Date of Birth
                                - .ProFormsLabelRight:
                                  dataKey: apiRequest.patientConsentForm.docReq.name.data.patientInfo.dob
                            - .ProFormsBaseView:
                              children:
                                - .ProFormsLabelLeft:
                                  text: "Phone #"
                                - .ProFormsLabelRight:
                                  dataKey: apiRequest.patientConsentForm.docReq.name.data.patientInfo.phone
                            - .ProFormsBaseView:
                              children:
                                - .ProFormsLabelLeft:
                                  text: "Email"
                                - .ProFormsLabelRight:
                                  dataKey: apiRequest.patientConsentForm.docReq.name.data.patientInfo.email
                            - .ProFormsBaseView:
                              children:
                                - .ProFormsLabelLeft:
                                  text: Patient Address
                                - .ProFormsLabelRight:
                                  dataKey: apiRequest.patientConsentForm.docReq.name.data.patientInfo.address
                        - .ProFormsDivider:
                        - type: view
                          style:
                            width: "0.39"
                            marginTop: "0.03"
                            color: "0x333333"
                            height: "auto"
                            fontSize: "Arial"
                          children:
                            - .FormsBlockText:
                              text: The Department of Health and Human Services has established a "Privacy
                                Rule" to help insure that personal health care
                                information is protected for privacy. The
                                Privacy Rule was also created in order to
                                provide a standard for certain health care
                                providers to obtain their patients' consent for
                                uses and disclosures of health information about
                                the patient to carry out treatment, payment or
                                health care operations.
                              style:
                                marginTop: "0"
                            - .FormsBlockText:
                              text: As our patient we want you to know that we respect the privacy of your
                                personal medical records and will do all we can
                                to secure and protect that privacy. We strive to
                                always take reasonable precautions to protect
                                your privacy. When it is appropriate and
                                necessary, we provide the minimum necessary
                                information to only those we feel are in need of
                                your healthcare information and information
                                about treatment, payment or health care
                                operations, in order to provide health care that
                                is in your best interest.
                              style:
                            - .FormsBlockText:
                              text: We also want you to know that we support your full access to your personal
                                medical records. We may have indirect treatments
                                relationships with you (such as laboratories
                                that only interact with physicians and not
                                patients), and may have to disclose personal
                                health information for purposes of treatment,
                                payment, or health operations, These entities
                                are most often not required to obtain patient
                                consent.
                              style:
                            - .FormsBlockText:
                              text: You may refuse to consent to the use or disclosure of your personal health
                                information but this must be in writing. Under
                                this law, we have the right to refuse to treat
                                you should you choose to refuse to disclose your
                                Personal Health Information (PIH). If you choose
                                to give consent in this document, at some future
                                time you may request to refuse all or part of
                                your PHI. You may not revoke actions that have
                                already been taken which relied on this or a
                                previously signed consent.
                              style:
                            - .FormsBlockText:
                              text: If your have objections to this form, please ask to speak with out HIPPA
                                Compliance Officer.
                              style:
                            - .FormsBlockText:
                              text: You have the right to review our privacy notice to request restrictions
                                and revoke consent in writing after you have
                                reviewed our privacy notice.
                              style:
                            - .FormsBlockText:
                              text: "HIPPA Notice of Privacy Practices"
                              style:
                                fontSize: .Nfont.nf2
                                color: "0x333333"
                            - .FormsBlockText:
                              text: "Signature below is only acknowledgement that you have received this
                                Notice of our Privacy Practices:"
                              style:
                                marginTop: "0.01"
                                fontSize: .Nfont.nf1
                                color: "0x666666"
                        - type: view
                          style:
                            marginTop: "0.03"
                            width: "0.39"
                            display: flex
                            flexDirection: column
                            flexWrap: wrap
                            alignContent: space-around
                            justifyContent: center
                          children:
                            # Name of Recipient/Healthcare Proxy
                            - .RecipientName:
                              style:
                                width: "0.39"
                              children:
                                - .RecipientNameLabel:
                                  style:
                                    fontWeight: "500"
                                    fontSize: .Nfont.nf1
                                - .ProFormsTextField:
                                  dataKey: apiRequest.patientConsentForm.docReq.name.data.proxyInfo
                                  style:
                                    width: "0.18928"
                                    height: "0.04048"
                        - .ProFormsBaseView:
                          style:
                            marginTop: "0.03"
                            width: "0.275"
                            display: flex
                            justifyContent: space-between
                          children:
                            - .ProFormsLabel:
                              text: Signature
                              style:
                                display: inline-block
                            - .ProFormsLabel:
                              text: "Clear"
                              style:
                                fontWeight: ""
                                # marginLeft: "0.23"
                                color: "0xe24445"
                                display: inline-block
                              onClick:
                                # 移除签名
                                - actionType: removeSignature
                                  dataObject: BLOB
                                  dataKey: apiRequest.newSign.document.name.data
                                  viewTag: signatureTag
                                - actionType: evalObject
                                  object:
                                    - ..formData.temporarySignature@: ""
                                    - ..formData.signShow@: "none"
                                    - ..formData.canvasShow@: "block"
                                    - ..apiRequest.patientConsentForm.docReq.name.data.signatureId@: ""
                                    - ..apiRequest.patientConsentForm.docReq.name.data.signatureTime@: ""
                                    - ..apiRequest.patientConsentForm.docReq.name.data.whetherSign@: true
                                - actionType: builtIn
                                  funcName: redraw
                                  viewTag: signatureShowTag
                                - actionType: builtIn
                                  funcName: redraw
                                  viewTag: signatureTag
                        - .SignAreaView:
                          style:
                            marginTop: "0.008"
                          children:
                            - type: canvas
                              viewTag: signatureTag
                              dataKey: apiRequest.newSign.document.name.data
                              style:
                                display: ..formData.canvasShow
                                .SignCanvasStyle:
                            - type: label
                              text: "X"
                              style:
                                .SignLabelStyle:
                            - type: image
                              viewTag: signatureShowTag
                              path: null.png
                              dataKey: formData.temporarySignature
                              path=func: =.builtIn.utils.prepareDocToPath
                              style:
                                display: ..formData.signShow
                                .SignCanvasStyle:
                        - .ProFormsBaseView:
                          viewTag: signatureShowTag
                          style:
                            display: ..formData.signShow
                          children:
                            - .ProFormsLabelLeft:
                              text=func: .builtIn.string.formatUnixtime_en
                              dataKey: apiRequest.patientConsentForm.docReq.name.data.signatureTime
                              style:
                                display: inline
                            - .ProFormsLabelLeft:
                              text: " Digitally Signed"
                              style:
                                marginLeft: "0.0046"
                                display: inline
                        - .ProFormsBaseView:
                          style:
                            marginTop: "0.03"
                          children:
                            - .ProFormsLabelLeft:
                              text: "Date"
                              style:
                                display: inline
                            - .ProFormsLabelRight:
                              text=func: .builtIn.string.formatUnixtimeL_en
                              dataKey: apiRequest.patientConsentForm.docReq.ctime
                              style:
                                marginLeft: "0.0046"
                                display: inline
                        - .ProFormsDivider:
            - .FormsBottomView:
              children:
                - .FormsBottomButtons:
                  children:
                    - .FormsBottomLeftButton:
                      onClick:
                        - actionType: saveSignature
                          dataObject: BLOB
                          dataKey: apiRequest.newSign.document.name.data
                          isEmpty: formData.whetherSign
                        - actionType: evalObject
                          object:
                            - if:
                                - =..formData.temporarySignature
                                - continue
                                - actionType: evalObject
                                  object:
                                    - if:
                                        - =..formData.whetherSign
                                        - continue
                                        - actionType: evalObject
                                          object:
                                            #签名的reid指向patient Consent Form doc的id
                                            - ..apiRequest.newSign.document.reid@: =..apiRequest.patientConsentForm.docReq.id
                                            - =..apiRequest.newSign.docAPI.store: ""
                                            # 存放签名的id 到patientConsentForm
                                            - ..apiRequest.patientConsentForm.docReq.name.data.signatureId@:
                                                =..apiRequest.newSign.docRes.doc.id
                                            - ..apiRequest.patientConsentForm.docReq.name.data.signatureTime@:
                                                =..apiRequest.newSign.docRes.doc.ctime
                                            - ..apiRequest.patientConsentForm.docReq.name.data.whetherSign@: =..formData.whetherSign
                          # 指定 eid 
                        - actionType: evalObject
                          object:
                            - ..apiRequest.patientConsentForm.docReq.reid@: =.Global.formData.meetingDocReid
                        # 修改type
                        - actionType: evalObject
                          object:
                            - =.builtIn.number.inhx:
                                dataIn:
                                  intHex: =..apiRequest.patientConsentForm.docReq.type
                                  index: 1
                                  hex: 0
                                dataOut: PatientConsentFormHIPPAEdit.apiRequest.patientConsentForm.docReq.type
                        # 保存patientConsentForm
                        - actionType: evalObject
                          object:
                            - ..apiRequest.patientConsentForm.docReq.name.data.statusTag@: =..formDataTemp.privateTag
                            - =..apiRequest.patientConsentForm.docAPI.store: ""
                        # 清缓存
                        - actionType: evalObject
                          object:
                            .Global._nonce@:
                              =.builtIn.math.random: ""
                        - actionType: builtIn
                          funcName: goBack
                          reload: true
                    # release button
                    - .FormsBottomRightButton:
                      onClick:
                        # 签名处理
                        - actionType: saveSignature
                          dataObject: BLOB
                          dataKey: apiRequest.newSign.document.name.data
                          isEmpty: formData.whetherSign
                        # 保存签名
                        - actionType: evalObject
                          object:
                            - if:
                                - =..formData.temporarySignature
                                - continue
                                - actionType: evalObject
                                  object:
                                    - if:
                                        - =..formData.whetherSign
                                        - actionType: popUp
                                          popUpView: signatureWarningTag
                                          wait: true
                                        - actionType: evalObject
                                          object:
                                            # 签名的reid指向文档的id
                                            - ..apiRequest.newSign.document.reid@: =..apiRequest.patientConsentForm.docReq.doc.id
                                            - =..apiRequest.newSign.docAPI.store: ""
                                            - ..apiRequest.patientConsentForm.docReq.name.data.signatureId@:
                                                =..apiRequest.newSign.docRes.doc.id
                                            - ..apiRequest.patientConsentForm.docReq.name.data.signatureTime@:
                                                =..apiRequest.newSign.docRes.doc.ctime
                                            - ..apiRequest.patientConsentForm.docReq.name.data.whetherSign@: =..formData.whetherSign
                        - actionType: evalObject
                          object:
                            - ..apiRequest.patientConsentForm.docReq.reid@: =.Global.formData.meetingDocReid
                            - ..apiRequest.patientConsentForm.docReq.name.data.statusTag@: =..formDataTemp.publicTag
                            - =..apiRequest.patientConsentForm.docAPI.store: ""
                        - actionType: evalObject
                          object:
                            .Global._nonce@:
                              =.builtIn.math.random: ""
                        - actionType: builtIn
                          funcName: goBack
                          reload: true
            - .FormsRightButtonsView:
              style:
                top: "0.1"
              children:
                - .FormsRightButton:
                  img: keyboard.svg
                  msg: "Macro"
                  style:
                    marginTop: "0.002"
                    backgroundColor: "0x1263a8"
                  onClick:
                    # 提前保存页面数据用于复现
                    - actionType: saveSignature
                      dataObject: BLOB
                      dataKey: apiRequest.newSign.document.name.data
                      isEmpty: formData.whetherSign
                    - actionType: evalObject
                      object:
                        - if:
                            # 是否是上次签名
                            - =..formData.temporarySignature
                            - continue # 旧签名
                            - actionType: evalObject
                              object:
                                # 新签名
                                - if:
                                    # 是否签名
                                    - =..formData.whetherSign
                                    - continue
                                    - actionType: evalObject
                                      object:
                                        # 创建签名
                                        - ..apiRequest.newSign.document.reid@: =..apiRequest.patientConsentForm.docReq.id
                                        - =..apiRequest.newSign.docAPI.store: ""
                                        # 更改文档中签名信息
                                        - ..apiRequest.patientConsentForm.docReq.name.data.signatureId@: =..apiRequest.newSign.docRes.doc.id
                                        - ..apiRequest.patientConsentForm.docReq.name.data.signatureTime@:
                                            =..apiRequest.newSign.docRes.doc.ctime
                                        - ..apiRequest.patientConsentForm.docReq.name.data.whetherSign@: =..formData.whetherSign
                    # 弹窗
                    - actionType: builtIn
                      funcName: redraw
                      viewTag: macroTag
                    - actionType: popUp
                      popUpView: macroTag
                    - actionType: updateObject
                      dataKey: Global.formData.providerNotesForm
                      dataObject: {}
                    - actionType: evalObject
                      object:
                        - .Global.formData.providerNotesForm@: =..apiRequest.patientConsentForm.docReq
                        - if:
                            - =.Global.macro.resp.doc.0.id
                            - actionType: evalObject
                              object:
                                - actionType: builtIn
                                  funcName: show
                                  viewTag: macroDataTag
                                - actionType: builtIn
                                  funcName: hide
                                  viewTag: noMacroDataTag
                            - actionType: evalObject
                              object:
                                - actionType: builtIn
                                  funcName: hide
                                  viewTag: macroDataTag
                                - actionType: builtIn
                                  funcName: show
                                  viewTag: noMacroDataTag
        - .MacroPopUp:
        - .CopyMacroSucPromptRight:
        - .BaseWarningView:
          msg2: "You haven't signed the form."
          viewTag: signatureWarningTag
